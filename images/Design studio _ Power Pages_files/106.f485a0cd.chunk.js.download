/*! For license information please see 106.f485a0cd.chunk.js.LICENSE.txt */
(window.webpackJsonp=window.webpackJsonp||[]).push([[106],{17935:function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var i,n=s(17970),r=s(17982),a=s(17937),o=s(17991),c=s(18030),l=s(17936);class u{get type(){return u.Type}get attributes(){return u.Attributes}async load(e,t,s,i){const n=new h(t,e,i);return await n.load(s),n}create(e,t){const s=new h(t,e,u.Attributes);return s.initializeLocal(),s}}u.Type="https://graph.microsoft.com/types/map",u.Attributes={type:u.Type,snapshotFormatVersion:"0.2",packageVersion:l.a};class h extends a.a{constructor(e,t,s){super(e,t,s,"fluid_map_"),this[i]="SharedMap",this.kernel=new c.a(this.serializer,this.handle,(e,t)=>this.submitLocalMessage(e,t),()=>this.isAttached(),this)}static create(e,t){return e.createChannel(t,u.Type)}static getFactory(){return new u}keys(){return this.kernel.keys()}entries(){return this.kernel.entries()}values(){return this.kernel.values()}[(i=Symbol.toStringTag,Symbol.iterator)](){return this.kernel.entries()}get size(){return this.kernel.size}forEach(e){this.kernel.forEach(e)}get(e){return this.kernel.get(e)}has(e){return this.kernel.has(e)}set(e,t){return this.kernel.set(e,t),this}delete(e){return this.kernel.delete(e)}clear(){this.kernel.clear()}summarizeCore(e,t){let s=0,i=0,n={};const r=[],a=new o.a,c=this.kernel.getSerializedStorage(e);for(const o of Object.keys(c)){const e=c[o];if(e.value&&e.value.length>=8192){const t="blob"+i;i++,r.push(t);const s={[o]:{type:e.type,value:JSON.parse(e.value)}};a.addBlob(t,JSON.stringify(s))}else{if(s+=e.type.length+21,e.value&&(s+=e.value.length),s>16384){const e="blob"+i;i++,r.push(e),a.addBlob(e,JSON.stringify(n)),n={},s=0}n[o]={type:e.type,value:void 0===e.value?void 0:JSON.parse(e.value)}}}const l={blobs:r,content:n};return a.addBlob("header",JSON.stringify(l)),a.getSummaryTree()}async loadCore(e){const t=await Object(r.a)(e,"header"),s=t;Array.isArray(s.blobs)?(this.kernel.populateFromSerializable(s.content),await Promise.all(s.blobs.map(async t=>{const s=await Object(r.a)(e,t);this.kernel.populateFromSerializable(s)}))):this.kernel.populateFromSerializable(t)}onDisconnect(){}reSubmitCore(e,t){this.kernel.trySubmitMessage(e,t)}applyStashedOp(e){return this.kernel.tryProcessMessage(e,!1,void 0),this.kernel.tryGetStashedOpLocalMetadata(e)}processCore(e,t,s){e.type===n.a.Operation&&this.kernel.tryProcessMessage(e.contents,t,s)}rollback(e,t){this.kernel.rollback(e,t)}}},17936:function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));const i="1.3.1"},17937:function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var i=s(17946),n=s(17940),r=s(17959),a=s(17963),o=s(17938),c=s(17944),l=s(17952),u=s(17956),h=s(17957),d=s(17960),m=s(17941),g=s(18029);class p extends o.a{constructor(e,t,s){super((e,t)=>this.eventListenerErrorHandler(e,t)),this.id=e,this.runtime=t,this.attributes=s,this._connected=!1,this._isBoundToContext=!1,Object(n.a)(!e.includes("/"),772),this.handle=new m.a(this,e,t.IFluidHandleContext),this.logger=c.a.create(t.logger,void 0,{all:{sharedObjectId:Object(i.a)(),ddsType:{value:this.attributes.type,tag:c.e.CodeArtifact}}}),this.mc=Object(l.c)(this.logger),[this.opProcessingHelper,this.callbacksHelper]=this.setUpSampledTelemetryHelpers(),this.attachListeners()}get IFluidLoadable(){return this}get connected(){return this._connected}setUpSampledTelemetryHelpers(){var e,t;Object(n.a)(void 0!==this.mc&&void 0!==this.logger,"this.mc and/or this.logger has not been set");const s=new u.a({eventName:"ddsOpProcessing",category:"performance"},this.logger,null!==(e=this.mc.config.getNumber("Fluid.SharedObject.OpProcessingTelemetrySampling"))&&void 0!==e?e:100,!0,new Map([["local",{localOp:!0}],["remote",{localOp:!1}]])),i=new u.a({eventName:"ddsEventCallbacks",category:"performance"},this.logger,null!==(t=this.mc.config.getNumber("Fluid.SharedObject.DdsCallbacksTelemetrySampling"))&&void 0!==t?t:100,!0);return this.runtime.once("dispose",()=>{this.callbacksHelper.dispose(),this.opProcessingHelper.dispose()}),[s,i]}closeWithError(e){void 0===this.closeError&&(this.closeError=e)}verifyNotClosed(){if(void 0!==this.closeError)throw this.closeError}eventListenerErrorHandler(e,t){const s=h.c.wrapIfUnrecognized(t,"SharedObjectEventListenerException");throw s.addTelemetryProperties({emittedEventName:String(e)}),this.closeWithError(s),s}attachListeners(){this.isAttached()||this.runtime.once("attaching",()=>{this.didAttach()})}async load(e){this.runtime.attachState!==r.a.Detached&&(this.services=e),await this.loadCore(e.objectStorage),this.runtime.attachState!==r.a.Detached&&this.attachDeltaHandler()}initializeLocal(){this.initializeLocalCore()}bindToContext(){this._isBoundToContext||(this._isBoundToContext=!0,this.runtime.bindChannel(this))}connect(e){this.services=e,this.attachDeltaHandler()}isAttached(){return void 0!==this.services&&this.runtime.attachState!==r.a.Detached}handleDecoded(e){var t,s,i;this.isAttached()&&(null===(i=null===(t=this.services)||void 0===t?void 0:(s=t.deltaConnection).addedGCOutboundReference)||void 0===i||i.call(s,this.handle,e))}initializeLocalCore(){}didAttach(){}submitLocalMessage(e,t){this.verifyNotClosed(),this.isAttached()&&this.services.deltaConnection.submit(e,t)}dirty(){this.isAttached()&&this.services.deltaConnection.dirty()}onConnect(){}reSubmitCore(e,t){this.submitLocalMessage(e,t)}async newAckBasedPromise(e){let t;return new Promise((s,i)=>{t=()=>i(new Error("FluidDataStoreRuntime disposed while this ack-based Promise was pending")),this.runtime.disposed?t():(this.runtime.on("dispose",t),e(s,i))}).finally(()=>{this.runtime.off("dispose",t)})}attachDeltaHandler(){Object(n.a)(void 0!==this.services,122),this._isBoundToContext=!0,this.didAttach(),this.services.deltaConnection.attach({process:(e,t,s)=>{this.process(e,t,s)},setConnectionState:e=>{this.setConnectionState(e)},reSubmit:(e,t)=>{this.reSubmit(e,t)},applyStashedOp:e=>this.applyStashedOp(e),rollback:(e,t)=>{this.rollback(e,t)}}),this.setConnectionState(this.services.deltaConnection.connected)}setConnectionState(e){this._connected!==e&&(this._connected=e,e?this.onConnect():this.onDisconnect())}process(e,t,s){this.verifyNotClosed(),this.emitInternal("pre-op",e,t,this),this.opProcessingHelper.measure(()=>{this.processCore(e,t,s)},t?"local":"remote"),this.emitInternal("op",e,t,this)}reSubmit(e,t){this.reSubmitCore(e,t)}rollback(e,t){throw new Error("rollback not supported")}emit(e,...t){return this.callbacksHelper.measure(()=>super.emit(e,...t))}emitInternal(e,...t){return super.emit(e,...t)}}class f extends p{constructor(e,t,s,i){super(e,t,s),this.telemetryContextPrefix=i,this._isGCing=!1,this._serializer=new d.a(this.runtime.channelsRoutingContext,e=>this.handleDecoded(e))}get serializer(){return Object(n.a)(!this._isGCing,117),this._serializer}getAttachSummary(e=!1,t=!1,s){const i=this.summarizeCore(this.serializer,s);return this.incrementTelemetryMetric(a.blobCountPropertyName,i.stats.blobNodeCount,s),this.incrementTelemetryMetric(a.totalBlobSizePropertyName,i.stats.totalBlobSize,s),i}async summarize(e=!1,t=!1,s){const i=this.summarizeCore(this.serializer,s);return this.incrementTelemetryMetric(a.blobCountPropertyName,i.stats.blobNodeCount,s),this.incrementTelemetryMetric(a.totalBlobSizePropertyName,i.stats.totalBlobSize,s),i}getGCData(e=!1){let t;Object(n.a)(!this._isGCing,120),this._isGCing=!0;try{const e=new g.a(this.runtime.channelsRoutingContext,e=>this.handleDecoded(e));this.processGCDataCore(e),t={gcNodes:{"/":e.getSerializedRoutes()}},Object(n.a)(this._isGCing,121)}finally{this._isGCing=!1}return t}processGCDataCore(e){this.summarizeCore(e)}incrementTelemetryMetric(e,t,s){var i;const n=null!==(i=null==s?void 0:s.get(this.telemetryContextPrefix,e))&&void 0!==i?i:0;null==s||s.set(this.telemetryContextPrefix,e,n+t)}}},17938:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));var i=s(17939);class n extends i.a{constructor(e){super(),this.errorHandler=e}emit(e,...t){try{return super.emit(e,...t)}catch(s){return this.errorHandler(e,s),!0}}}},17939:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));var i=s(15576);class n extends i.EventEmitter{constructor(){super(),this.addListener=super.addListener.bind(this),this.on=super.on.bind(this),this.once=super.once.bind(this),this.prependListener=super.prependListener.bind(this),this.prependOnceListener=super.prependOnceListener.bind(this),this.removeListener=super.removeListener.bind(this),this.off=super.off.bind(this)}}},17940:function(e,t,s){"use strict";function i(e,t){if(!e)throw new Error("number"==typeof t?"0x"+t.toString(16).padStart(3,"0"):t)}s.d(t,"a",(function(){return i}))},17941:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));var i=s(17942);class n extends i.a{get isAttached(){return this.value.isAttached()}constructor(e,t,s){super(e,t,s)}attachGraph(){this.value.bindToContext(),super.attachGraph()}}},17942:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));var i=s(17943);class n{constructor(e,t,s){this.value=e,this.path=t,this.routeContext=s,this.pendingHandlesToMakeVisible=new Set,this.locallyVisible=!1,this.absolutePath=Object(i.a)(t,this.routeContext)}get IFluidHandle(){return this}get isAttached(){return this.routeContext.isAttached}get visible(){return this.isAttached||this.locallyVisible}async get(){return this.value}attachGraph(){this.visible||(this.locallyVisible=!0,this.pendingHandlesToMakeVisible.forEach(e=>{e.attachGraph()}),this.pendingHandlesToMakeVisible.clear(),this.routeContext.attachGraph())}bind(e){this.visible?e.attachGraph():this.pendingHandlesToMakeVisible.add(e)}}},17943:function(e,t,s){"use strict";function i(e,t){if(""===e)return void 0===t?"":t.absolutePath;{let s=e.startsWith("/")?e.slice(1):e;return s=s.endsWith("/")?s.slice(0,-1):s,void 0===t?"/"+s:`${"/"===t.absolutePath?"":t.absolutePath}/${s}`}}s.d(t,"a",(function(){return i}))},17944:function(e,t,s){"use strict";s.d(t,"e",(function(){return i})),s.d(t,"f",(function(){return c})),s.d(t,"d",(function(){return l})),s.d(t,"a",(function(){return u})),s.d(t,"b",(function(){return h})),s.d(t,"c",(function(){return d}));var i,n=s(17954),r=s(17955),a=s(17952),o=s(17945);!function(e){e.PackageData="PackageData",e.CodeArtifact="CodeArtifact",e.UserData="UserData"}(i||(i={}));class c{constructor(e,t){this.namespace=e,this.properties=t}static formatTick(e){return Math.floor(e)}static numberFromString(e){if(null==e)return;const t=Number(e);return Number.isNaN(t)?e:t}static sanitizePkgName(e){return e.replace("@","").replace("/","-")}static prepareErrorObject(e,t,s){const{message:i,errorType:n,stack:r}=Object(o.b)(t,!0);if(e.stack=r,e.error=i,e.errorType=n,Object(o.g)(t)){const s=t.getTelemetryProperties();for(const t of Object.keys(s))void 0===e[t]&&(e[t]=s[t])}void 0===e.stack&&s&&(e.stack=Object(o.d)())}sendTelemetryEvent(e,t){var s;this.sendTelemetryEventCore(Object.assign(Object.assign({},e),{category:null!==(s=e.category)&&void 0!==s?s:"generic"}),t)}sendTelemetryEventCore(e,t){const s=Object.assign({},e);void 0!==t&&c.prepareErrorObject(s,t,!1),"number"==typeof s.duration&&(s.duration=c.formatTick(s.duration)),this.send(s)}sendErrorEvent(e,t){this.sendTelemetryEventCore(Object.assign(Object.assign({error:e.eventName},e),{category:"error"}),t)}sendPerformanceEvent(e,t){var s;const i=Object.assign(Object.assign({},e),{category:null!==(s=e.category)&&void 0!==s?s:"performance"});this.sendTelemetryEventCore(i,t)}prepareEvent(e){const t="error"===e.category||void 0!==e.error,s=Object.assign({},e);if(void 0!==this.namespace&&(s.eventName=`${this.namespace}${c.eventNamespaceSeparator}${s.eventName}`),this.properties){const i=[];i.push(this.properties.all),t&&i.push(this.properties.error);for(const t of i)if(void 0!==t)for(const i of Object.keys(t)){if(void 0!==e[i])continue;const n=t[i],r="function"==typeof n?n():n;void 0!==r&&(s[i]=r)}}return s}}c.eventNamespaceSeparator=":";class l{constructor(e){this.logger=e}send(e){const t={category:e.category,eventName:e.eventName};for(const s of Object.keys(e)){const n=e[s],{value:r,tag:a}="object"==typeof n?n:{value:n,tag:void 0};switch(a){case void 0:case i.PackageData:t[s]=r;break;case i.UserData:t[s]="REDACTED (UserData)";break;default:t[s]="REDACTED (unknown tag)"}}this.logger.send(t)}}class u extends c{constructor(e,t,s){super(t,s),this.baseLogger=e,Object(a.b)(e)&&Object(a.d)(this,new a.a(e.config))}static create(e,t,s){if(e instanceof u){const i={};for(const t of[e.properties,s])void 0!==t&&(void 0!==t.all&&(i.all=Object.assign(Object.assign({},i.all),t.all)),void 0!==t.error&&(i.error=Object.assign(Object.assign({},i.error),t.error)));const n=void 0===e.namespace?t:void 0===t?e.namespace:`${e.namespace}${c.eventNamespaceSeparator}${t}`;return new u(e.baseLogger,n,i)}return new u(e||new n.a,t,s)}send(e){this.baseLogger.send(this.prepareEvent(e))}}class h extends c{constructor(e,t){super(e,t),this.loggers=[]}addLogger(e){null!=e&&this.loggers.push(e)}send(e){const t=this.prepareEvent(e);this.loggers.forEach(e=>{e.send(t)})}}class d{constructor(e,t,s={end:!0,cancel:"generic"}){this.logger=e,this.markers=s,this.startTime=r.a.now(),this.event=Object.assign({},t),this.markers.start&&this.reportEvent("start"),"object"==typeof window&&null!=window&&window.performance&&(this.startMark=t.eventName+"-start",window.performance.mark(this.startMark))}static start(e,t,s){return new d(e,t,s)}static timedExec(e,t,s,i){const n=d.start(e,t,i);try{const e=s(n);return n.autoEnd(),e}catch(r){throw n.cancel(void 0,r),r}}static async timedExecAsync(e,t,s,i){const n=d.start(e,t,i);try{const e=await s(n);return n.autoEnd(),e}catch(r){throw n.cancel(void 0,r),r}}get duration(){return r.a.now()-this.startTime}reportProgress(e,t="update"){this.reportEvent(t,e)}autoEnd(){this.event&&this.markers.end&&this.reportEvent("end"),this.performanceEndMark(),this.event=void 0}end(e){this.reportEvent("end",e),this.performanceEndMark(),this.event=void 0}performanceEndMark(){if(this.startMark&&this.event){const e=this.event.eventName+"-end";window.performance.mark(e),window.performance.measure(""+this.event.eventName,this.startMark,e),this.startMark=void 0}}cancel(e,t){void 0!==this.markers.cancel&&this.reportEvent("cancel",Object.assign({category:this.markers.cancel},e),t),this.event=void 0}reportEvent(e,t,s){if(!this.event)return;const i=Object.assign(Object.assign({},this.event),t);i.eventName=`${i.eventName}_${e}`,"start"!==e&&(i.duration=this.duration),this.logger.sendPerformanceEvent(i,s)}}},17945:function(e,t,s){"use strict";s.d(t,"b",(function(){return r})),s.d(t,"g",(function(){return a})),s.d(t,"h",(function(){return o})),s.d(t,"c",(function(){return l})),s.d(t,"d",(function(){return u})),s.d(t,"i",(function(){return h})),s.d(t,"j",(function(){return d})),s.d(t,"f",(function(){return g})),s.d(t,"e",(function(){return p})),s.d(t,"a",(function(){return f}));var i=s(17946),n=s(17951);function r(e,t){const s={message:"string"==typeof(null==e?void 0:e.message)?e.message:String(e)};if(null!==(i=e)&&!Array.isArray(i)&&"object"==typeof i){const{errorType:i,stack:n,name:r}=e;if("string"==typeof i&&(s.errorType=i),"string"==typeof n){const e="string"==typeof r?r:void 0;s.stack=((e,s)=>{if(!t)return e;const i=e.split("\n");return i.shift(),void 0!==s&&i.unshift(s),i.join("\n")})(n,e)}}var i;return s}const a=e=>"function"==typeof(null==e?void 0:e.getTelemetryProperties);function o(e,t={}){var s;if(Object(n.c)(e)&&function(e){const t=e;void 0===t.errorInstanceId&&(t.errorInstanceId=Object(i.a)())}(e),Object(n.b)(e))return e.addTelemetryProperties(null!==(s=t.props)&&void 0!==s?s:{}),e;const{message:c,stack:l}=r(e,!1),u=new b({message:c,stack:l});if("object"==typeof e&&null!==e){const{canRetry:t,retryAfterSeconds:s}=e;Object.assign(o,{canRetry:t,retryAfterSeconds:s})}"object"!=typeof e&&u.addTelemetryProperties({typeofError:typeof e});const h=a(e)?e.getTelemetryProperties():{};return u.addTelemetryProperties(Object.assign(Object.assign(Object.assign({},h),t.props),{untrustedOrigin:1})),u}let c;function l(){const e=new Error("<<generated stack>>");if(void 0===c&&(c=void 0!==e.stack),c)return e;try{throw e}catch(t){return t}}function u(){return l().stack}function h(e,t){const{message:s,stack:i}=r(e,!1),o=t(s);return void 0!==i&&m(o,i),g(e)&&o.addTelemetryProperties({untrustedOrigin:1}),Object(n.a)(e)&&(o.overwriteErrorInstanceId(e.errorInstanceId),o.addTelemetryProperties({innerErrorInstanceId:e.errorInstanceId})),a(e)&&o.addTelemetryProperties(e.getTelemetryProperties()),o}function d(e,t,s){const i=h(e,t),n=i.errorInstanceId,r=n;return s.sendTelemetryEvent({eventName:"WrapError",errorInstanceId:n,wrappedByErrorInstanceId:r},e),i}function m(e,t){try{Object.assign(e,{stack:t})}catch(s){e.addTelemetryProperties({stack2:t})}}function g(e){return!Object(n.c)(e)||1===e.getTelemetryProperties().untrustedOrigin&&e.errorType===b.normalizedErrorType}const p=()=>{const e=new WeakSet;return(t,s)=>{if("object"==typeof s&&null!==s){if(e.has(s))return"<removed/circular>";e.add(s)}return s}};class f extends Error{constructor(e,t,s=new Set){super(e),this.omitPropsFromLogging=s,this._errorInstanceId=Object(i.a)(),this.fluidErrorCode="-",s.add("omitPropsFromLogging"),s.add("_errorInstanceId"),t&&this.addTelemetryProperties(t)}get errorInstanceId(){return this._errorInstanceId}overwriteErrorInstanceId(e){this._errorInstanceId=e}addTelemetryProperties(e){!function(e,t){for(const s of Object.keys(t))void 0===e[s]&&(e[s]=t[s])}(this,e)}getTelemetryProperties(){const e=function(e,t){const s={};for(const n of Object.keys(e)){if(t.has(n))continue;const r=e[n];switch(typeof r){case"string":case"number":case"boolean":case"undefined":s[n]=r;break;default:"object"!=typeof(null==(i=r)?void 0:i.value)&&"string"==typeof(null==i?void 0:i.tag)?s[n]=r:s[n]="REDACTED (arbitrary object)"}}var i;return s}(this,this.omitPropsFromLogging);return Object.assign(Object.assign({},e),{stack:this.stack,message:this.message,errorInstanceId:this._errorInstanceId})}}class b extends f{constructor(e){super(e.message),this.errorType=b.normalizedErrorType,void 0!==e.stack&&m(this,e.stack)}}b.normalizedErrorType="genericError"},17946:function(e,t,s){"use strict";var i=s(17947),n=s(17948);t.a=function(e,t,s){var r=(e=e||{}).random||(e.rng||i.a)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){s=s||0;for(var a=0;a<16;++a)t[s+a]=r[a];return t}return Object(n.a)(r)}},17947:function(e,t,s){"use strict";var i;s.d(t,"a",(function(){return r}));var n=new Uint8Array(16);function r(){if(!i&&!(i="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return i(n)}},17948:function(e,t,s){"use strict";for(var i=s(17949),n=[],r=0;r<256;++r)n.push((r+256).toString(16).substr(1));t.a=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=(n[e[t+0]]+n[e[t+1]]+n[e[t+2]]+n[e[t+3]]+"-"+n[e[t+4]]+n[e[t+5]]+"-"+n[e[t+6]]+n[e[t+7]]+"-"+n[e[t+8]]+n[e[t+9]]+"-"+n[e[t+10]]+n[e[t+11]]+n[e[t+12]]+n[e[t+13]]+n[e[t+14]]+n[e[t+15]]).toLowerCase();if(!Object(i.a)(s))throw TypeError("Stringified UUID is invalid");return s}},17949:function(e,t,s){"use strict";var i=s(17950);t.a=function(e){return"string"==typeof e&&i.a.test(e)}},17950:function(e,t,s){"use strict";t.a=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i},17951:function(e,t,s){"use strict";s.d(t,"a",(function(){return n})),s.d(t,"b",(function(){return r})),s.d(t,"c",(function(){return a}));const i=e=>"function"==typeof(null==e?void 0:e.getTelemetryProperties)&&"function"==typeof(null==e?void 0:e.addTelemetryProperties),n=e=>"string"==typeof(null==e?void 0:e.errorInstanceId);function r(e){return"string"==typeof(null==e?void 0:e.errorType)&&"string"==typeof(null==e?void 0:e.message)&&n(e)&&i(e)}function a(e){return"string"==typeof(null==e?void 0:e.errorType)&&"string"==typeof(null==e?void 0:e.message)&&i(e)}},17952:function(e,t,s){"use strict";s.d(t,"e",(function(){return i})),s.d(t,"a",(function(){return l})),s.d(t,"b",(function(){return u})),s.d(t,"c",(function(){return h})),s.d(t,"d",(function(){return d}));const i=new(s(17953).a)(()=>r(c())),n={getRawConfig:()=>{}},r=e=>null!=e?new l({getRawConfig:t=>{var s,i;try{return null===(i=o(null!==(s=e.getItem(t))&&void 0!==s?s:void 0))||void 0===i?void 0:i.raw}catch(n){}}}):n;function a(e){switch(e){case"boolean":case"number":case"string":return!0;default:return!1}}function o(e){let t,s=e;if("string"==typeof e)try{s=JSON.parse(e),t={raw:e,string:e}}catch(n){}if(void 0===s)return t;const i=typeof s;if(a(i))return Object.assign(Object.assign({},t),{raw:e,[i]:s});if(Array.isArray(s)){const i=typeof s[0];if(!a(i))return t;for(const e of s)if(typeof e!==i)return t;return Object.assign(Object.assign({},t),{raw:e,[i+"[]"]:s})}return t}const c=()=>{try{return null!==sessionStorage?sessionStorage:void 0}catch(e){return}};class l{constructor(...e){this.configCache=new Map,this.orderedBaseProviders=[];const t=new Set,s=[...e];for(;s.length>0;){const e=s.shift();void 0!==e&&m(e)&&!t.has(e)&&(t.add(e),e instanceof l?s.push(...e.orderedBaseProviders):this.orderedBaseProviders.push(e))}}getBoolean(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.boolean}getNumber(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.number}getString(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.string}getBooleanArray(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t["boolean[]"]}getNumberArray(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t["number[]"]}getStringArray(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t["string[]"]}getRawConfig(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.raw}getCacheEntry(e){if(!this.configCache.has(e)){for(const t of this.orderedBaseProviders){const s=o(null==t?void 0:t.getRawConfig(e));if(void 0!==s)return this.configCache.set(e,s),s}this.configCache.set(e,{raw:void 0})}return this.configCache.get(e)}}function u(e){const t=e;return m(null==t?void 0:t.config)&&void 0!==(null==t?void 0:t.logger)}function h(e){return u(e)?e:d(e,i.value)}function d(e,...t){if(u(e))throw new Error("Logger is already a monitoring context");const s=e;return s.config=new l(...t),s.logger=e,s}function m(e){const t=e;return"function"==typeof(null==t?void 0:t.getRawConfig)}},17953:function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));class i{constructor(e){this.valueGenerator=e,this._evaluated=!1}get evaluated(){return this._evaluated}get value(){return this._evaluated||(this._evaluated=!0,this._value=this.valueGenerator()),this._value}}},17954:function(e,t,s){"use strict";s.d(t,"a",(function(){return i})),s.d(t,"b",(function(){return n})),s.d(t,"c",(function(){return r}));class i{send(e){}}class n{send(e){}sendTelemetryEvent(e,t){}sendErrorEvent(e,t){}sendPerformanceEvent(e,t){}}function r(e){const t={message:"string"==typeof(null==e?void 0:e.message)?e.message:String(e)};if(null!==(s=e)&&!Array.isArray(s)&&"object"==typeof s){const{errorType:s,stack:i,name:n}=e;if("string"==typeof s&&(t.errorType=s),"string"==typeof i){const e="string"==typeof n?n:void 0;t.stack=((e,t)=>{const s=e.split("\n");return s.shift(),void 0!==t&&s.unshift(t),s.join("\n")})(i,e)}}var s;return t}},17955:function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));const i=window.performance},17956:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));var i=s(17955);class n{constructor(e,t,s,i=!1,n=new Map){this.eventBase=e,this.logger=t,this.sampleThreshold=s,this.includeAggregateMetrics=i,this.perBucketProperties=n,this.disposed=!1,this.measurementsMap=new Map}measure(e,t=""){var s,n,r;const a=i.a.now(),o=e(),c=i.a.now()-a;let l=this.measurementsMap.get(t);return void 0===l&&(l={count:0,duration:-1},this.measurementsMap.set(t,l)),l.count++,l.duration=c,this.includeAggregateMetrics&&(l.totalDuration=(null!==(s=l.totalDuration)&&void 0!==s?s:0)+c,l.minDuration=Math.min(null!==(n=l.minDuration)&&void 0!==n?n:c,c),l.maxDuration=Math.max(null!==(r=l.maxDuration)&&void 0!==r?r:0,c)),l.count>=this.sampleThreshold&&this.flushBucket(t),o}flushBucket(e){const t=this.measurementsMap.get(e);if(void 0!==t&&0!==t.count){const s=this.perBucketProperties.get(e),i=Object.assign(Object.assign(Object.assign({},this.eventBase),s),t);this.logger.sendPerformanceEvent(i),this.measurementsMap.delete(e)}}dispose(e){this.measurementsMap.forEach((e,t)=>this.flushBucket(t))}}},17957:function(e,t,s){"use strict";s.d(t,"d",(function(){return r})),s.d(t,"e",(function(){return a})),s.d(t,"f",(function(){return o})),s.d(t,"a",(function(){return c})),s.d(t,"b",(function(){return l})),s.d(t,"c",(function(){return u})),s.d(t,"g",(function(){return h}));var i=s(17958),n=s(17945);class r extends n.a{constructor(e,t,s){super(e,s,new Set(["error"])),this.error=t,this.errorType=i.a.genericError}}class a extends n.a{constructor(e,t,s){super(e,s),this.retryAfterSeconds=t,this.errorType=i.a.throttlingError}static wrap(e,t,s){return Object(n.j)(e,e=>new a(e,t),s)}}class o extends n.a{constructor(e){super(e,{usageError:!0}),this.errorType="usageError"}}class c extends n.a{constructor(e,t){super(e,{timeoutMs:t}),this.expiryMs=t,this.errorType=i.a.clientSessionExpiredError}}class l extends n.a{constructor(e,t){super(e,Object.assign(Object.assign({},t),{dataProcessingError:1})),this.errorType=i.a.dataCorruptionError,this.canRetry=!1}}class u extends n.a{constructor(e){super(e),this.errorType=i.a.dataProcessingError,this.canRetry=!1}static create(e,t,s,i={}){const n=u.wrapIfUnrecognized(e,t,s);return n.addTelemetryProperties(i),n}static wrapIfUnrecognized(e,t,s){const i=Object.assign({dataProcessingError:1,dataProcessingCodepath:t},void 0===s?void 0:h(s)),r=Object(n.h)(e,{props:i});if(!Object(n.f)(r))return r;const a=Object(n.i)(r,e=>new u(e));return a.addTelemetryProperties(r.getTelemetryProperties()),a}}const h=e=>({messageClientId:e.clientId,messageSequenceNumber:e.sequenceNumber,messageClientSequenceNumber:e.clientSequenceNumber,messageReferenceSequenceNumber:e.referenceSequenceNumber,messageMinimumSequenceNumber:e.minimumSequenceNumber,messageTimestamp:e.timestamp})},17958:function(e,t,s){"use strict";var i;s.d(t,"a",(function(){return i})),function(e){e.genericError="genericError",e.throttlingError="throttlingError",e.dataCorruptionError="dataCorruptionError",e.dataProcessingError="dataProcessingError",e.usageError="usageError",e.clientSessionExpiredError="clientSessionExpiredError"}(i||(i={}))},17959:function(e,t,s){"use strict";var i,n;s.d(t,"a",(function(){return i})),s.d(t,"b",(function(){return n})),function(e){e.Detached="Detached",e.Attaching="Attaching",e.Attached="Attached"}(i||(i={})),function(e){e.NotBound="NotBound",e.Binding="Binding",e.Bound="Bound"}(n||(n={}))},17960:function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var i=s(17943),n=s(17961);class r{constructor(e,t){for(this.context=e,this.handleParsedCb=t,this.encodeValue=(e,t)=>{const s=null==e?void 0:e.IFluidHandle;return void 0!==s?this.serializeHandle(s,t):e},this.decodeValue=e=>{if((e=>"__fluid_handle__"===(null==e?void 0:e.type))(e)){const t=e.url.startsWith("/")?e.url:Object(i.a)(e.url,this.context),s=new n.a(t,this.root);return this.handleParsedCb(s),s}return e},this.root=this.context;void 0!==this.root.routeContext;)this.root=this.root.routeContext}get IFluidSerializer(){return this}encode(e,t){return e&&"object"==typeof e?this.recursivelyReplace(e,this.encodeValue,t):e}decode(e){return e&&"object"==typeof e?this.recursivelyReplace(e,this.decodeValue):e}stringify(e,t){return JSON.stringify(e,(e,s)=>this.encodeValue(s,t))}parse(e){return JSON.parse(e,(e,t)=>this.decodeValue(t))}recursivelyReplace(e,t,s){const i=t(e,s);if(i!==e)return i;let n;for(const r of Object.keys(e)){const i=e[r];if(i&&"object"==typeof i){const a=this.recursivelyReplace(i,t,s);a!==i&&(n=null!=n?n:Array.isArray(e)?[...e]:Object.assign({},e),n[r]=a)}}return null!=n?n:e}serializeHandle(e,t){return t.bind(e),{type:"__fluid_handle__",url:e.absolutePath}}}},17961:function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var i=s(17940),n=s(17962),r=s(17997);class a{constructor(e,t){this.absolutePath=e,this.routeContext=t,this.isAttached=!0,Object(i.a)(e.startsWith("/"),413)}get IFluidRouter(){return this}get IFluidHandleContext(){return this}get IFluidHandle(){return this}async get(){if(void 0===this.objectP){const e={url:this.absolutePath,headers:{[n.b.viaHandle]:!0}};this.objectP=this.routeContext.resolveHandle(e).then(t=>{if("fluid/object"===t.mimeType){return t.value}throw Object(r.e)(t,e)})}return this.objectP}attachGraph(){}bind(e){e.attachGraph()}async request(e){try{const t=(await this.get()).IFluidRouter;return void 0!==t?t.request(e):Object(r.a)(e)}catch(t){return Object(r.c)(t)}}}},17962:function(e,t,s){"use strict";s.d(t,"b",(function(){return Q})),s.d(t,"a",(function(){return te}));var i,n=s(17959),r=s(18013),a=s(17940),o=s(17955),c=s(17939),l=s(17989),u=s(18027),h=s(17944),d=s(17952),m=s(18026),g=s(18014),p=s(17971),f=s(17982),b=s(17957),v=s(17970),S=s(17981),y=s(17963),C=s(18e3),O=s(18025),w=s(17997),T=s(17991),k=s(18028),N=s(17998),j=s(17946),M=s(17976),q=s(18024),R=s(18008),P=s(18019),I=s(17974),L=s(17972),E=s(18004),A=s(17973),x=s(18003),D=s(17984),z=s(17980),B=s(18006),F=s(18007),_=s(17975),G=s(18020),U=s(18018),W=s(17977),H=s(17996),V=s(18021),$=s(18023),J=s(18022);!function(e){e.FluidDataStoreOp="component",e.Attach="attach",e.ChunkedOp="chunkedOp",e.BlobAttach="blobAttach",e.Rejoin="rejoin",e.Alias="alias"}(i||(i={}));const K={state:"enabled",idleTime:15e3,maxTime:6e4,maxOps:100,minOpsForLastSummaryAttempt:10,maxAckWaitTime:6e4,maxOpsSinceLastSummary:7e3,initialSummarizerDelayMs:5e3,summarizerClientElection:!1};var Q;!function(e){e.wait="wait",e.externalRequest="externalRequest",e.viaHandle="viaHandle"}(Q||(Q={}));const X=y.FlushMode.TurnBased;var Y;!function(e){e.FluidDataStoreOp="component",e.Attach="attach",e.ChunkedOp="chunkedOp",e.BlobAttach="blobAttach",e.Rejoin="rejoin",e.Alias="alias",e.Operation="op"}(Y||(Y={}));class Z{constructor(e,t){this.deltaManager=e,this.logger=t,this.localPaused=!1,this.timePaused=0,this.batchCount=0,this.deltaManager.on("prepareSend",e=>{if(0===e.length)return;const t=e[0].metadata;if(!(null==t?void 0:t.batch))return;if(1===e.length)return void delete t.batch;const s=e[e.length-1];s.metadata=Object.assign(Object.assign({},s.metadata),{batch:!1})}),this.deltaManager.inbound.on("push",e=>{this.trackPending(e)}),Object(a.a)(!this.localPaused,659);const s=this.deltaManager.inbound.toArray();for(const i of s)this.trackPending(i);this.deltaManager.on("op",e=>this.afterOpProcessing(e.sequenceNumber))}afterOpProcessing(e){Object(a.a)(!this.localPaused,660),0!==this.deltaManager.inbound.length?void 0!==this.pauseSequenceNumber&&(Object(a.a)(e<this.pauseSequenceNumber,662),e+1===this.pauseSequenceNumber&&this.pauseQueue()):Object(a.a)(void 0===this.pauseSequenceNumber,661)}pauseQueue(){Object(a.a)(!this.localPaused,663),this.localPaused=!0,this.timePaused=o.a.now(),this.deltaManager.inbound.pause()}resumeQueue(e,t){const s=t.sequenceNumber,i=this.localPaused?o.a.now()-this.timePaused:void 0;this.batchCount++,this.batchCount%1e3==1&&this.logger.sendTelemetryEvent({eventName:"BatchStats",sequenceNumber:s,length:s-e+1,msnDistance:s-t.minimumSequenceNumber,duration:i,batchCount:this.batchCount,interrupted:this.localPaused}),this.localPaused&&(this.localPaused=!1,void 0!==i&&i>L.b&&this.logger.sendErrorEvent({eventName:"MaxBatchWaitTimeExceeded",duration:i,sequenceNumber:s,length:s-e}),this.deltaManager.inbound.resume())}trackPending(e){Object(a.a)(0!==this.deltaManager.inbound.length,664),Object(a.a)(void 0===this.currentBatchClientId==(void 0===this.pauseSequenceNumber),665);const t=e.metadata,s=null==t?void 0:t.batch;if(!Object(p.c)(e))return Object(a.a)(void 0===this.currentBatchClientId,666),Object(a.a)(void 0===s,667),void Object(a.a)(!this.localPaused,668);if(void 0!==this.currentBatchClientId||void 0!==s){if((void 0!==this.currentBatchClientId||!1===s)&&this.currentBatchClientId!==e.clientId)throw new b.b("OpBatchIncomplete",Object.assign({runtimeVersion:A.a,batchClientId:this.currentBatchClientId},Object(b.g)(e)));s?(Object(a.a)(void 0===this.currentBatchClientId,670),Object(a.a)(!this.localPaused,671),this.pauseSequenceNumber=e.sequenceNumber,this.currentBatchClientId=e.clientId,1===this.deltaManager.inbound.length&&this.pauseQueue()):!1===s?(Object(a.a)(void 0!==this.pauseSequenceNumber,672),this.resumeQueue(this.pauseSequenceNumber,e),this.pauseSequenceNumber=void 0,this.currentBatchClientId=void 0):Object(a.a)(void 0!==this.currentBatchClientId,673)}else Object(a.a)(!this.localPaused,669)}}class ee{constructor(e,t,s){this.deltaManager=e,this.emitter=t,this.logger=s,this.hitError=!1,this.deltaScheduler=new I.a(this.deltaManager,h.a.create(this.logger,"DeltaScheduler")),new Z(e,s)}beforeOpProcessing(e){var t;if(this.batchClientId!==e.clientId){Object(a.a)(void 0===this.batchClientId,674),this.emitter.emit("batchBegin",e),this.deltaScheduler.batchBegin(e);const s=null===(t=null==e?void 0:e.metadata)||void 0===t?void 0:t.batch;this.batchClientId=s?e.clientId:void 0}}afterOpProcessing(e,t){var s;if(Object(a.a)(!this.hitError,675),e)return this.hitError=!0,this.batchClientId=void 0,this.emitter.emit("batchEnd",e,t),void this.deltaScheduler.batchEnd(t);const i=null===(s=null==t?void 0:t.metadata)||void 0===s?void 0:s.batch;return void 0===this.batchClientId||!1===i?(this.batchClientId=void 0,this.emitter.emit("batchEnd",void 0,t),void this.deltaScheduler.batchEnd(t)):void 0}}class te extends c.a{constructor(e,t,s,r,o,c,l,u,m,g,p,S,y,O){var w,T,k,N,j,q,I,z,H;void 0===O&&(O=Object.assign(Object.assign({},K),null===(w=l.summaryOptions)||void 0===w?void 0:w.summaryConfigOverrides)),super(),this.context=e,this.registry=t,this.runtimeOptions=l,this.containerScope=u,this.logger=m,this._storage=S,this.requestHandler=y,this.summaryConfiguration=O,this.defaultMaxConsecutiveReconnects=15,this._orderSequentiallyCalls=0,this.needsFlush=!1,this.flushTrigger=!1,this.savedOps=[],this.consecutiveReconnects=0,this._disposed=!1,this.emitDirtyDocumentEvent=!0,this.defaultTelemetrySignalSampleCount=100,this._perfSignalData={signalsLost:0,signalSequenceNumber:0,signalTimestamp:0,trackingSignalSequenceNumber:void 0},this.summarizeOnDemand=(...e)=>{if(this.clientDetails.type===_.b)return this.summarizer.summarizeOnDemand(...e);if(void 0!==this.summaryManager)return this.summaryManager.summarizeOnDemand(...e);throw new b.f("Can't summarize, disableSummaries: "+this.summariesDisabled)},this.enqueueSummarize=(...e)=>{if(this.clientDetails.type===_.b)return this.summarizer.enqueueSummarize(...e);if(void 0!==this.summaryManager)return this.summaryManager.enqueueSummarize(...e);throw new b.f("Can't summarize, disableSummaries: "+this.summariesDisabled)},this.messageAtLastSummary=null==s?void 0:s.message,this.disableIsolatedChannels=null!==(T=this.runtimeOptions.summaryOptions.disableIsolatedChannels)&&void 0!==T&&T,this._connected=this.context.connected,this.chunkMap=new Map(o),this.handleContext=new M.a("",this),this.mc=Object(d.c)(h.a.create(this.logger,"ContainerRuntime")),this.summariesDisabled=this.isSummariesDisabled(),this.heuristicsDisabled=this.isHeuristicsDisabled(),this.summarizerClientElectionEnabled=this.isSummarizerClientElectionEnabled(),this.maxOpsSinceLastSummary=this.getMaxOpsSinceLastSummary(),this.initialSummarizerDelayMs=this.getInitialSummarizerDelayMs(),this._aliasingEnabled=null!==(k=this.mc.config.getBoolean("Fluid.ContainerRuntime.UseDataStoreAliasing"))&&void 0!==k&&k||null!==(N=l.useDataStoreAliasing)&&void 0!==N&&N,this._maxOpSizeInBytes=null!==(j=this.mc.config.getNumber("Fluid.ContainerRuntime.MaxOpSizeInBytes"))&&void 0!==j?j:768e3,this.maxConsecutiveReconnects=null!==(q=this.mc.config.getNumber("Fluid.ContainerRuntime.MaxConsecutiveReconnects"))&&void 0!==q?q:this.defaultMaxConsecutiveReconnects,this._flushMode=l.flushMode;const $=e.pendingLocalState,Q=null!==(I=null==$?void 0:$.baseSnapshot)&&void 0!==I?I:e.baseSnapshot;this.garbageCollector=W.b.create({runtime:this,gcOptions:this.runtimeOptions.gcOptions,baseSnapshot:Q,baseLogger:this.mc.logger,existing:g,metadata:s,isSummarizerClient:this.context.clientDetails.type===_.b,getNodePackagePath:async e=>this.getGCNodePackagePath(e),getLastSummaryTimestampMs:()=>{var e;return null===(e=this.messageAtLastSummary)||void 0===e?void 0:e.timestamp},readAndParseBlob:async e=>Object(f.a)(this.storage,e)});const X=this.deltaManager.initialSequenceNumber;if(this.summarizerNode=Object(C.a)(h.a.create(this.logger,"SummarizerNode"),async(e,t,s)=>this.summarizeInternal(e,t,s),X,Q?X:void 0,{canReuseHandle:!1,throwOnFailure:!0,gcDisabled:!this.garbageCollector.shouldRunGC}),Q&&this.summarizerNode.loadBaseSummaryWithoutDifferential(Q),this.dataStores=new D.a(Object(D.b)(Q,s),this,e=>this.submit(i.Attach,e),(e,t)=>(s,i,n)=>this.summarizerNode.createChild(s,e,t,void 0,i,n),e=>this.summarizerNode.deleteChild(e),this.mc.logger,async()=>this.garbageCollector.getBaseGCDetails(),(e,t,s)=>this.garbageCollector.nodeUpdated(e,"Changed",t,s),new Map(c),this.garbageCollector.writeDataAtRoot),this.blobManager=new x.a(this.handleContext,p,()=>this.storage,e=>this.submit(i.BlobAttach,void 0,void 0,{blobId:e}),e=>this.garbageCollector.nodeUpdated(e,"Loaded"),this,this.logger),this.scheduleManager=new ee(e.deltaManager,this,h.a.create(this.logger,"ScheduleManager")),this.deltaSender=this.deltaManager,this.pendingStateManager=new E.a({applyStashedOp:this.applyStashedOp.bind(this),clientId:()=>this.clientId,close:this.closeFn,connected:()=>this.connected,flush:this.flush.bind(this),flushMode:()=>this.flushMode,reSubmit:this.reSubmit.bind(this),rollback:this.rollback.bind(this),setFlushMode:e=>this.setFlushMode(e)},this._flushMode,null==$?void 0:$.pending),this.context.quorum.on("removeMember",e=>{this.clearPartialChunks(e)}),this.summaryCollection=new B.a(this.deltaManager,this.logger),this.dirtyContainer=this.context.attachState!==n.a.Attached||this.pendingStateManager.hasPendingMessages(),this.context.updateDirtyContainerState(this.dirtyContainer),this.summariesDisabled)this.mc.logger.sendTelemetryEvent({eventName:"SummariesDisabled"});else{const e=h.a.create(this.logger,"OrderedClientElection"),t=new F.a(e,this.context.deltaManager,this.context.quorum),s=new F.b(e,t,null!=r?r:this.context.deltaManager.lastSequenceNumber,_.a.isClientEligible);if(this.summarizerClientElection=new _.a(e,this.summaryCollection,s,this.maxOpsSinceLastSummary,this.summarizerClientElectionEnabled),this.context.clientDetails.type===_.b)this._summarizer=new R.a("/_summarizer",this,()=>this.summaryConfiguration,this,this.handleContext,this.summaryCollection,async e=>U.a.create(e));else if(_.a.clientDetailsPermitElection(this.context.clientDetails)){const e=()=>{this.summaryCollection.opsSinceLastAck>this.maxOpsSinceLastSummary&&(this.logger.sendErrorEvent({eventName:"SummaryStatus:Behind"}),this.summaryCollection.once(v.a.SummaryAck,()=>{this.logger.sendTelemetryEvent({eventName:"SummaryStatus:CaughtUp"}),this.summaryCollection.on("default",e)}),this.summaryCollection.off("default",e))};this.summaryCollection.on("default",e),this.summaryManager=new P.a(this.summarizerClientElection,this,this.summaryCollection,this.logger,this.formRequestSummarizerFn(this.context.loader),new G.a(6e4,3e4,Object(G.b)({coefficient:20,initialDelay:0})),{initialDelayMs:this.initialSummarizerDelayMs},this.heuristicsDisabled),this.summaryManager.start()}}let Y;this.deltaManager.on("readonly",e=>{Object(a.a)(e===this.deltaManager.readOnlyInfo.readonly,292),Object(a.a)(!e||!this.connected,293),this.replayPendingStates()}),m.sendTelemetryEvent(Object.assign({eventName:"DeviceSpec"},function(){try{if("object"==typeof navigator&&null!==navigator)return{deviceMemory:navigator.deviceMemory,hardwareConcurrency:navigator.hardwareConcurrency}}catch(w){}return{}}())),g?(this.createContainerMetadata={createContainerRuntimeVersion:null==s?void 0:s.createContainerRuntimeVersion,createContainerTimestamp:null==s?void 0:s.createContainerTimestamp},Y=null!==(H=null!==(z=null==s?void 0:s.summaryNumber)&&void 0!==z?z:null==s?void 0:s.summaryCount)&&void 0!==H?H:0):(this.createContainerMetadata={createContainerRuntimeVersion:A.a,createContainerTimestamp:Date.now()},Y=0),this.nextSummaryNumber=Y+1,this.logger.sendTelemetryEvent(Object.assign(Object.assign(Object.assign({eventName:"ContainerLoadStats"},this.createContainerMetadata),this.dataStores.containerLoadStats),{summaryNumber:Y,summaryFormatVersion:null==s?void 0:s.summaryFormatVersion,disableIsolatedChannels:null==s?void 0:s.disableIsolatedChannels,gcVersion:null==s?void 0:s.gcFeature})),Object(L.a)(this.context.clientId,this.deltaManager,this.logger),Object(V.a)(this,this.logger),this.opTracker=new J.a(this.deltaManager,!0===this.mc.config.getBoolean("Fluid.ContainerRuntime.DisableOpTracking"))}get IContainerRuntime(){return this}get IFluidRouter(){return this}static async load(e,t,s,i={},n=e.scope,r){var o,c,l;const u=e,d=null!==(o=u.taggedLogger)&&void 0!==o?o:new h.d(u.logger),m=h.a.create(d,void 0,{all:{runtimeVersion:A.a}}),{summaryOptions:g={},gcOptions:p={},loadSequenceNumberVerification:v="close",useDataStoreAliasing:S=!1,flushMode:y=X,enableOfflineLoad:C=!1}=i,O=e.pendingLocalState,w=null!==(c=null==O?void 0:O.baseSnapshot)&&void 0!==c?c:e.baseSnapshot,T=O?new $.a(()=>e.storage,O.snapshotBlobs):e.storage,k=new q.a(t),N=async e=>{const t=null==w?void 0:w.blobs[e];if(w&&t)return Object(a.a)(void 0!==T,501),Object(f.a)(T,t)},[j,M,R,P]=await Promise.all([N(z.c),N(z.k),N(z.e),N(z.a)]),I=!0===r||!0===e.existing,L=await x.a.load(null==w?void 0:w.trees[z.b],async e=>(Object(a.a)(void 0!==T,598),Object(f.a)(T,e))),E=null===(l=null==M?void 0:M.message)||void 0===l?void 0:l.sequenceNumber;if(!O&&void 0!==E){const t=e.deltaManager.initialSequenceNumber;if("bypass"!==v&&E!==t){const s=new b.b("Summary metadata mismatch",{runtimeVersion:A.a,runtimeSequenceNumber:E,protocolSequenceNumber:t});"log"===v?m.sendErrorEvent({eventName:"SequenceNumberMismatch"},s):e.closeFn(s)}}const D=new te(e,k,M,R,null!=j?j:[],null!=P?P:[],{summaryOptions:g,gcOptions:p,loadSequenceNumberVerification:v,useDataStoreAliasing:S,flushMode:y,enableOfflineLoad:C},n,m,I,L,T,s);return O&&(await D.processSavedOps(O),O.savedOps=[]),await D.getSnapshotBlobs(),D}get options(){return this.context.options}get clientId(){return this.context.clientId}get clientDetails(){return this.context.clientDetails}get deltaManager(){return this.context.deltaManager}get storage(){return this._storage}get reSubmitFn(){return this.reSubmit}get closeFn(){return this.context.closeFn}get flushMode(){return this._flushMode}get scope(){return this.containerScope}get IFluidDataStoreRegistry(){return this.registry}get attachState(){return this.context.attachState}get IFluidHandleContext(){return this.handleContext}get connected(){return this._connected}get summarizerClientId(){var e;return null===(e=this.summarizerClientElection)||void 0===e?void 0:e.electedClientId}get disposed(){return this._disposed}get summarizer(){return Object(a.a)(void 0!==this._summarizer,599),this._summarizer}isSummariesDisabled(){return!0===this.runtimeOptions.summaryOptions.disableSummaries||"disabled"===this.summaryConfiguration.state}isHeuristicsDisabled(){var e;return!0===(null===(e=this.runtimeOptions.summaryOptions.summarizerOptions)||void 0===e?void 0:e.disableHeuristics)||"disableHeuristics"===this.summaryConfiguration.state}isSummarizerClientElectionEnabled(){var e;return this.mc.config.getBoolean("Fluid.ContainerRuntime.summarizerClientElection")?null===(e=this.mc.config.getBoolean("Fluid.ContainerRuntime.summarizerClientElection"))||void 0===e||e:!0===this.runtimeOptions.summaryOptions.summarizerClientElection||"disabled"!==this.summaryConfiguration.state&&!0===this.summaryConfiguration.summarizerClientElection}getMaxOpsSinceLastSummary(){return void 0!==this.runtimeOptions.summaryOptions.maxOpsSinceLastSummary?this.runtimeOptions.summaryOptions.maxOpsSinceLastSummary:"disabled"!==this.summaryConfiguration.state?this.summaryConfiguration.maxOpsSinceLastSummary:0}getInitialSummarizerDelayMs(){return void 0!==this.runtimeOptions.summaryOptions.initialSummarizerDelayMs?this.runtimeOptions.summaryOptions.initialSummarizerDelayMs:"disabled"!==this.summaryConfiguration.state?this.summaryConfiguration.initialSummarizerDelayMs:0}dispose(e){var t;this._disposed||(this._disposed=!0,this.logger.sendTelemetryEvent({eventName:"ContainerRuntimeDisposed",isDirty:this.isDirty,lastSequenceNumber:this.deltaManager.lastSequenceNumber,attachState:this.attachState},e),void 0!==this.summaryManager&&this.summaryManager.dispose(),this.garbageCollector.dispose(),null===(t=this._summarizer)||void 0===t||t.dispose(),this.dataStores.dispose(),this.pendingStateManager.dispose(),this.emit("dispose"),this.removeAllListeners())}get IFluidTokenProvider(){var e;if(null===(e=this.options)||void 0===e?void 0:e.intelligence)return{intelligence:this.options.intelligence}}async request(e){try{const t=O.a.create(e);return"_summarizer"===t.pathParts[0]&&1===t.pathParts.length?void 0!==this._summarizer?{status:200,mimeType:"fluid/object",value:this.summarizer}:Object(w.a)(e):void 0!==this.requestHandler?this.requestHandler(t,this):Object(w.a)(e)}catch(t){return Object(w.c)(t)}}async resolveHandle(e){try{const t=O.a.create(e),s=t.pathParts[0];if("_channels"===s)return this.resolveHandle(t.createSubRequest(1));if(s===x.a.basePath&&t.isLeaf(2)){const s=await this.blobManager.getBlob(t.pathParts[1]);return s?{status:200,mimeType:"fluid/object",value:s.get()}:Object(w.a)(e)}if(t.pathParts.length>0){const i=await this.getDataStoreFromRequest(s,e),n=t.createSubRequest(1);return Object(a.a)(n.url.startsWith("/"),294),i.IFluidRouter.request(n)}return Object(w.a)(e)}catch(t){return Object(w.c)(t)}}internalId(e){var t;return null!==(t=this.dataStores.aliases().get(e))&&void 0!==t?t:e}async getDataStoreFromRequest(e,t){var s,i,n;const r="boolean"!=typeof(null===(s=t.headers)||void 0===s?void 0:s[Q.wait])||(null===(i=t.headers)||void 0===i?void 0:i[Q.wait]),a=this.internalId(e),o=await this.dataStores.getDataStore(a,r);if((null===(n=t.headers)||void 0===n?void 0:n[Q.externalRequest])&&this.garbageCollector.shouldRunGC){const e=(await o.getBaseGCDetails()).usedRoutes;if(void 0!==e&&!e.includes("")&&!e.includes("/"))throw Object(w.e)(Object(w.a)(t),t)}const c=await o.realize(),l=Object(N.f)(t.url.split("?")[0]);return this.garbageCollector.nodeUpdated("/"+l,"Loaded",void 0,o.packagePath,null==t?void 0:t.headers),c}addMetadataToSummary(e){var t;const s=Object.assign(Object.assign(Object.assign(Object.assign({},this.createContainerMetadata),{summaryCount:this.nextSummaryNumber,summaryNumber:this.nextSummaryNumber++,summaryFormatVersion:1,disableIsolatedChannels:this.disableIsolatedChannels||void 0}),this.garbageCollector.getMetadata()),{message:null!==(t=Object(z.f)(this.deltaManager.lastMessage))&&void 0!==t?t:this.messageAtLastSummary});Object(T.c)(e,z.k,JSON.stringify(s))}addContainerStateToSummary(e,t,s,i){var n;if(this.addMetadataToSummary(e),this.chunkMap.size>0){const t=JSON.stringify([...this.chunkMap]);Object(T.c)(e,z.c,t)}const r=this.dataStores.aliases();if(r.size>0&&Object(T.c)(e,z.a,JSON.stringify([...r])),this.summarizerClientElection){const t=JSON.stringify(null===(n=this.summarizerClientElection)||void 0===n?void 0:n.serialize());Object(T.c)(e,z.e,t)}const a=this.blobManager.summarize();if(Object.keys(a.summary.tree).length>0&&Object(T.e)(e,z.b,a),this.garbageCollector.writeDataAtRoot){const n=this.garbageCollector.summarize(t,s,i);void 0!==n&&Object(T.d)(e,W.c,n)}}shouldContinueReconnecting(){return this.maxConsecutiveReconnects<=0||(this.pendingStateManager.hasPendingMessages()?(this.consecutiveReconnects===Math.floor(this.maxConsecutiveReconnects/2)&&this.mc.logger.sendTelemetryEvent({eventName:"ReconnectsWithNoProgress",attempts:this.consecutiveReconnects,pendingMessages:this.pendingStateManager.pendingMessagesCount}),this.consecutiveReconnects<this.maxConsecutiveReconnects):(this.resetReconnectCount(),!0))}resetReconnectCount(){this.consecutiveReconnects=0}replayPendingStates(){if(!this.canSendOps())return;const e=this.dirtyContainer;let t;this.dirtyContainer=!1,Object(a.a)(this.emitDirtyDocumentEvent,295),this.emitDirtyDocumentEvent=!1;try{this.pendingStateManager.replayPendingStates()}finally{t=this.dirtyContainer,this.dirtyContainer=e,this.emitDirtyDocumentEvent=!0}this.updateDocumentDirtyState(t)}async applyStashedOp(e,t){switch(e){case i.FluidDataStoreOp:return this.dataStores.applyStashedOp(t);case i.Attach:return this.dataStores.applyStashedAttachOp(t);case i.Alias:case i.BlobAttach:return;case i.ChunkedOp:throw new Error("chunkedOp not expected here");case i.Rejoin:throw new Error("rejoin not expected here");default:Object(l.a)(e,"Unknown ContainerMessageType: "+e)}}setConnectionState(e,t){this.verifyNotClosed();const s=this._connected!==e,i=s&&e;this._connected=e,e||(this._perfSignalData.signalsLost=0,this._perfSignalData.signalTimestamp=0,this._perfSignalData.trackingSignalSequenceNumber=void 0),!i||(this.consecutiveReconnects++,this.shouldContinueReconnecting())?(s&&this.replayPendingStates(),this.dataStores.setConnectionState(e,t),Object(m.c)(this.mc.logger,this,e,t)):this.closeFn(b.c.create("Runtime detected too many reconnects with no progress syncing local ops","setConnectionState",void 0,{dataLoss:1,attempts:this.consecutiveReconnects,pendingMessages:this.pendingStateManager.pendingMessagesCount}))}process(e,t){var s,n;if(this.verifyNotClosed(),!Object(p.c)(e))return;(null!==(s=this.mc.config.getBoolean("enableOfflineLoad"))&&void 0!==s?s:this.runtimeOptions.enableOfflineLoad)&&this.savedOps.push(e);let r=Object.assign({},e);this.scheduleManager.beforeOpProcessing(r);try{let e;switch(r=function(e){if(e.type===v.a.Operation){if(void 0!==e.contents.address&&void 0===e.contents.type)e.type=i.FluidDataStoreOp;else{const t=e.contents;Object(a.a)(void 0!==t.type,289),e.type=t.type,e.contents=t.contents}Object(a.a)(Object(p.c)(e),290)}return e}(r),r=this.processRemoteChunkedMessage(r),t&&r.type!==i.ChunkedOp&&(e=this.pendingStateManager.processPendingLocalMessage(r)),this.pendingStateManager.hasPendingMessages()||this.updateDocumentDirtyState(!1),r.type){case i.Attach:this.dataStores.processAttachMessage(r,t);break;case i.Alias:this.processAliasMessage(r,e,t);break;case i.FluidDataStoreOp:this.dataStores.processFluidDataStoreOp(r,t,e);break;case i.BlobAttach:Object(a.a)(null===(n=null==r?void 0:r.metadata)||void 0===n?void 0:n.blobId,298),this.blobManager.processBlobAttachOp(r.metadata.blobId,t)}this.emit("op",r),this.scheduleManager.afterOpProcessing(void 0,r),t&&this.resetReconnectCount()}catch(o){throw this.scheduleManager.afterOpProcessing(o,r),o}}processAliasMessage(e,t,s){this.dataStores.processAliasMessage(e,t,s)}sendSignalTelemetryEvent(e){const t=Date.now()-this._perfSignalData.signalTimestamp;this.logger.sendPerformanceEvent({eventName:"SignalLatency",duration:t,signalsLost:this._perfSignalData.signalsLost}),this._perfSignalData.signalsLost=0,this._perfSignalData.signalTimestamp=0}processSignal(e,t){const s=e.content,i={clientId:e.clientId,content:s.contents.content,type:s.contents.type};e.clientId===this.clientId&&this.connected&&(void 0!==this._perfSignalData.trackingSignalSequenceNumber&&s.clientSignalSequenceNumber>this._perfSignalData.trackingSignalSequenceNumber?(this._perfSignalData.signalsLost++,this._perfSignalData.trackingSignalSequenceNumber=void 0,this.logger.sendErrorEvent({eventName:"SignalLost",type:s.contents.type,signalsLost:this._perfSignalData.signalsLost,trackingSequenceNumber:this._perfSignalData.trackingSignalSequenceNumber,clientSignalSequenceNumber:s.clientSignalSequenceNumber})):s.clientSignalSequenceNumber===this._perfSignalData.trackingSignalSequenceNumber&&(this.sendSignalTelemetryEvent(s.clientSignalSequenceNumber),this._perfSignalData.trackingSignalSequenceNumber=void 0)),void 0!==s.address?this.dataStores.processSignal(s.address,i,t):this.emit("signal",i,t)}async getRootDataStore(e,t=!0){const s=this.internalId(e),i=await this.dataStores.getDataStore(s,t);return Object(a.a)(await i.isRoot(),299),i.realize()}setFlushMode(e){e!==this._flushMode&&(this.mc.logger.sendTelemetryEvent({eventName:"FlushMode Updated",old:this._flushMode,new:e}),e===y.FlushMode.Immediate&&this.flush(),this._flushMode=e,this.pendingStateManager.onFlushModeUpdated(e))}flush(){if(Object(a.a)(0===this._orderSequentiallyCalls,588),this.deltaSender&&(this.pendingStateManager.onFlush(),this.needsFlush&&(this.needsFlush=!1,this.canSendOps())))return this.deltaSender.flush()}orderSequentially(e){if(this.flushMode===y.FlushMode.TurnBased)return void this.trackOrderSequentiallyCalls(e);const t=this.flushMode;this.setFlushMode(y.FlushMode.TurnBased);try{this.trackOrderSequentiallyCalls(e),this.flush()}finally{this.setFlushMode(t)}}trackOrderSequentiallyCalls(e){let t;this.mc.config.getBoolean("Fluid.ContainerRuntime.EnableRollback")&&(t=this.pendingStateManager.checkpoint());try{this._orderSequentiallyCalls++,e()}catch(s){throw t?t.rollback():this.closeFn(new b.d("orderSequentially callback exception",s)),s}finally{this._orderSequentiallyCalls--}}async createDataStore(e){const t=Object(j.a)();return Object(H.a)(await this._createDataStore(e,!1,t),t,this,this.dataStores,this.mc.logger)}async createRootDataStoreLegacy(e,t){const s=await this._createDataStore(e,!0,t);return void 0!==s.makeVisibleAndAttachGraph?s.makeVisibleAndAttachGraph():s.bindToContext(),s}async createRootDataStore(e,t){if(t.includes("/"))throw new b.f(`Id cannot contain slashes: '${t}'`);return!0===this._aliasingEnabled?this.createAndAliasDataStore(e,t):this.createRootDataStoreLegacy(e,t)}async createAndAliasDataStore(e,t,s){const i=Object(j.a)(),n=await this._createDataStore(e,!1,i,s),r=Object(H.a)(n,i,this,this.dataStores,this.mc.logger),a=await r.trySetAlias(t);if("Success"!==a)throw new b.d("dataStoreAliasFailure",void 0,{alias:{value:t,tag:h.e.UserData},internalId:{value:i,tag:h.e.PackageData},aliasResult:a});return r}createDetachedRootDataStore(e,t){if(t.includes("/"))throw new b.f(`Id cannot contain slashes: '${t}'`);return this.dataStores.createDetachedDataStoreCore(e,!0,t)}createDetachedDataStore(e){return this.dataStores.createDetachedDataStoreCore(e,!1)}async _createDataStoreWithPropsLegacy(e,t,s=Object(j.a)(),i=!1){const n=await this.dataStores._createFluidDataStoreContext(Array.isArray(e)?e:[e],s,i,t).realize();return i&&(void 0!==n.makeVisibleAndAttachGraph?n.makeVisibleAndAttachGraph():n.bindToContext(),this.logger.sendTelemetryEvent({eventName:"Root datastore with props",hasProps:void 0!==t})),Object(H.a)(n,s,this,this.dataStores,this.mc.logger)}async _createDataStoreWithProps(e,t,s=Object(j.a)(),i=!1){return!0===this._aliasingEnabled&&i?this.createAndAliasDataStore(e,s,t):this._createDataStoreWithPropsLegacy(e,t,s,i)}async _createDataStore(e,t,s=Object(j.a)(),i){return this.dataStores._createFluidDataStoreContext(Array.isArray(e)?e:[e],s,t,i).realize()}canSendOps(){return this.connected&&!this.deltaManager.readOnlyInfo.readonly}getQuorum(){return this.context.quorum}getAudience(){return this.context.audience}get isDirty(){return this.dirtyContainer}isContainerMessageDirtyable(e,t){if(e===i.Attach){if("_scheduler"===t.id)return!1}else if(e===i.FluidDataStoreOp){if("_scheduler"===t.address)return!1}return!0}createNewSignalEnvelope(e,t,s){const i=++this._perfSignalData.signalSequenceNumber,n={address:e,clientSignalSequenceNumber:i,contents:{type:t,content:s}};return i%this.defaultTelemetrySignalSampleCount==1&&void 0===this._perfSignalData.trackingSignalSequenceNumber&&(this._perfSignalData.signalTimestamp=Date.now(),this._perfSignalData.trackingSignalSequenceNumber=i),n}submitSignal(e,t){this.verifyNotClosed();const s=this.createNewSignalEnvelope(void 0,e,t);return this.context.submitSignalFn(s)}submitDataStoreSignal(e,t,s){const i=this.createNewSignalEnvelope(e,t,s);return this.context.submitSignalFn(i)}setAttachState(e){e===n.a.Attaching?Object(a.a)(this.attachState===n.a.Attaching,301):(Object(a.a)(this.attachState===n.a.Attached,302),this.emit("attached")),e!==n.a.Attached||this.pendingStateManager.hasPendingMessages()||this.updateDocumentDirtyState(!1),this.dataStores.setAttachState(e)}createSummary(e,t){e&&this.blobManager.setRedirectTable(e);const s=this.dataStores.createSummary(t);return this.disableIsolatedChannels||Object(z.n)(s),this.addContainerStateToSummary(s,!0,!1,t),s.summary}async getAbsoluteUrl(e){if(void 0===this.context.getAbsoluteUrl)throw new Error("Driver does not implement getAbsoluteUrl");if(this.attachState===n.a.Attached)return this.context.getAbsoluteUrl(e)}async summarizeInternal(e,t,s){const i=await this.dataStores.summarize(e,t,s);let n;return this.disableIsolatedChannels||(Object(z.n)(i),n=[y.channelsTreeName]),this.addContainerStateToSummary(i,e,t,s),Object.assign(Object.assign({},i),{id:"",pathPartsForChildren:n})}async summarize(e){this.verifyNotClosed();const{fullTree:t=!1,trackState:s=!0,summaryLogger:i=this.mc.logger,runGC:n=this.garbageCollector.shouldRunGC,runSweep:r,fullGC:o}=e;let c;n&&(c=await this.collectGarbage({logger:i,runSweep:r,fullGC:o}));const l=new T.b,{stats:u,summary:h}=await this.summarizerNode.summarize(t,s,l);return this.logger.sendTelemetryEvent({eventName:"SummarizeTelemetry",details:l.serialize()}),Object(a.a)(h.type===S.a.Tree,303),{stats:u,summary:h,gcStats:c}}async updateStateBeforeGC(){return this.dataStores.updateStateBeforeGC()}async getGCData(e){const t=new N.a,s=await this.dataStores.getGCData(e);t.addNodes(s.gcNodes);const i=this.blobManager.getGCData(e);return t.addNodes(i.gcNodes),t.getGCData()}updateUsedRoutes(e,t){this.summarizerNode.updateUsedRoutes([""]);const s=[];for(const i of e)i.split("/")[1]!==x.a.basePath&&s.push(i);return this.dataStores.updateUsedRoutes(s,t)}deleteUnusedRoutes(e){const t=[],s=[];for(const i of e)this.isBlobPath(i)?t.push(i):s.push(i);this.blobManager.deleteUnusedRoutes(t),this.dataStores.deleteUnusedRoutes(s)}getCurrentReferenceTimestampMs(){var e,t,s;return null!==(t=null===(e=this.deltaManager.lastMessage)||void 0===e?void 0:e.timestamp)&&void 0!==t?t:null===(s=this.messageAtLastSummary)||void 0===s?void 0:s.timestamp}getNodeType(e){var t;return this.isBlobPath(e)?W.a.Blob:null!==(t=this.dataStores.getGCNodeType(e))&&void 0!==t?t:W.a.Other}async getGCNodePackagePath(e){switch(this.getNodeType(e)){case W.a.Blob:return["_blobs"];case W.a.DataStore:case W.a.SubDataStore:return this.dataStores.getDataStorePackagePath(e);default:Object(a.a)(!1,734)}}isBlobPath(e){const t=e.split("/");return!(t.length<2||t[1]!==x.a.basePath)}async collectGarbage(e){return this.garbageCollector.collectGarbage(e)}addedGCOutboundReference(e,t){this.garbageCollector.addedOutboundReference(e.absolutePath,t.absolutePath)}async submitSummary(e){var t,s,i;const{fullTree:n,refreshLatestAck:r,summaryLogger:o}=e,c=this.nextSummaryNumber,l=h.a.create(o,void 0,{all:{summaryNumber:c}});let d;if(r){const e=await this.refreshLatestSummaryAckFromServer(h.a.create(l,void 0,{all:{safeSummary:!0}})),t=e.latestSnapshotRefSeq;d=e.latestSnapshotVersionId,t>this.deltaManager.lastSequenceNumber&&await h.c.timedExecAsync(l,{eventName:"WaitingForSeq",lastSequenceNumber:this.deltaManager.lastSequenceNumber,targetSequenceNumber:t,lastKnownSeqNumber:this.deltaManager.lastKnownSeqNumber},async()=>se(this.deltaManager,t),{start:!0,end:!0,cancel:"error"})}try{await this.deltaManager.inbound.pause();const r=this.deltaManager.lastSequenceNumber,o=this.deltaManager.minimumSequenceNumber,h=`Summary @${r}:${this.deltaManager.minimumSequenceNumber}`;r!==(null===(t=this.deltaManager.lastMessage)||void 0===t?void 0:t.sequenceNumber)&&l.sendErrorEvent({eventName:"LastSequenceMismatch",error:h}),this.summarizerNode.startSummary(r,l);const g=()=>e.cancellationToken.cancelled?{continue:!1,error:"disconnected"}:(Object(a.a)(this.connected,600),this.deltaManager.lastSequenceNumber!==r?{continue:!1,error:`lastSequenceNumber changed before uploading to storage. ${this.deltaManager.lastSequenceNumber} !== ${r}`}:{continue:!0});let p=g();if(!p.continue)return{stage:"base",referenceSequenceNumber:r,minimumSequenceNumber:o,error:p.error};const f=u.a.start();let b;const C=this.garbageCollector.summaryStateNeedsReset;try{b=await this.summarize({fullTree:n||C,trackState:!0,summaryLogger:l,runGC:this.garbageCollector.shouldRunGC})}catch(m){return{stage:"base",referenceSequenceNumber:r,minimumSequenceNumber:o,error:m}}const{summary:O,stats:w}=b;this.messageAtLastSummary=this.deltaManager.lastMessage;const k=this.disableIsolatedChannels?O:O.tree[y.channelsTreeName];Object(a.a)(k.type===S.a.Tree,508);const N=Object.values(k.tree).filter(e=>e.type===S.a.Handle).length,j=O.tree[W.c]?Object(T.f)(O.tree[W.c]):void 0,M=Object.assign({dataStoreCount:this.dataStores.size,summarizedDataStoreCount:this.dataStores.size-N,gcStateUpdatedDataStoreCount:null===(s=b.gcStats)||void 0===s?void 0:s.updatedDataStoreCount,gcBlobNodeCount:null==j?void 0:j.blobNodeCount,gcTotalBlobsSize:null==j?void 0:j.totalBlobSize,opsSizesSinceLastSummary:this.opTracker.opsSizeAccumulator,nonSystemOpsSinceLastSummary:this.opTracker.nonSystemOpCount,summaryNumber:c},w),q={referenceSequenceNumber:r,minimumSequenceNumber:o,summaryTree:O,summaryStats:M,generateDuration:f.trace().duration,forcedFullTree:C};if(p=g(),!p.continue)return Object.assign(Object.assign({stage:"generate"},q),{error:p.error});const R=this.summaryCollection.latestAck;let P,I;P=(null==R?void 0:R.summaryAck.contents.handle)!==d&&void 0!==d?{proposalHandle:void 0,ackHandle:d,referenceSequenceNumber:r}:void 0===R?{proposalHandle:void 0,ackHandle:null===(i=this.context.getLoadedFromVersion())||void 0===i?void 0:i.id,referenceSequenceNumber:r}:{proposalHandle:R.summaryOp.contents.handle,ackHandle:R.summaryAck.contents.handle,referenceSequenceNumber:r};try{I=await this.storage.uploadSummaryWithContext(b.summary,P)}catch(m){return Object.assign(Object.assign({stage:"generate"},q),{error:m})}const L=P.ackHandle,E={handle:I,head:L,message:h,parents:L?[L]:[]},A=Object.assign(Object.assign({},q),{handle:I,uploadDuration:f.trace().duration});if(p=g(),!p.continue)return Object.assign(Object.assign({stage:"upload"},A),{error:p.error});let x;try{x=this.submitSystemMessage(v.a.Summarize,E)}catch(m){return Object.assign(Object.assign({stage:"upload"},A),{error:m})}const D=Object.assign(Object.assign({stage:"submit"},A),{clientSequenceNumber:x,submitOpDuration:f.trace().duration});return this.summarizerNode.completeSummary(I),this.opTracker.reset(),D}finally{this.summarizerNode.clearSummary(),this.deltaManager.inbound.resume()}}processRemoteChunkedMessage(e){if(e.type!==i.ChunkedOp)return e;const t=e.clientId,s=e.contents;if(this.addChunk(t,s),s.chunkId===s.totalChunks){const i=Object.assign({},e),n=this.chunkMap.get(t).join("");return i.contents=JSON.parse(n),i.type=s.originalType,this.clearPartialChunks(t),i}return e}addChunk(e,t){let s=this.chunkMap.get(e);void 0===s&&(s=[],this.chunkMap.set(e,s)),Object(a.a)(t.chunkId===s.length+1,305),s.push(t.contents)}clearPartialChunks(e){this.chunkMap.has(e)&&this.chunkMap.delete(e)}updateDocumentDirtyState(e){this.dirtyContainer!==e&&(this.dirtyContainer=e,this.emitDirtyDocumentEvent&&(this.emit(e?"dirty":"saved"),this.context.updateDirtyContainerState(e)))}submitDataStoreOp(e,t,s){const n={address:e,contents:t};this.submit(i.FluidDataStoreOp,n,s)}submitDataStoreAliasOp(e,t){const s=e;if(!Object(H.b)(s))throw new b.f("malformedDataStoreAliasMessage");this.submit(i.Alias,e,t)}async uploadBlob(e){return this.verifyNotClosed(),this.blobManager.createBlob(e)}submit(e,t,s,i){this.verifyNotClosed(),Object(a.a)(this.attachState!==n.a.Detached,306);let r=-1,o=i;if(this.canSendOps()){const s=JSON.stringify(t),n=this.context.deltaManager.maxMessageSize;this.flushMode!==y.FlushMode.TurnBased||this.needsFlush||(o=Object.assign(Object.assign({},i),{batch:!0}),this.needsFlush=!0,this.flushTrigger||Promise.resolve().then(()=>{this.flushTrigger=!1,this.flush()})),r=this.submitMaybeChunkedMessages(e,t,s,n,this._flushMode===y.FlushMode.TurnBased,o)}this.pendingStateManager.onSubmitMessage(e,r,this.deltaManager.lastSequenceNumber,t,s,o),this.isContainerMessageDirtyable(e,t)&&this.updateDocumentDirtyState(!0)}submitMaybeChunkedMessages(e,t,s,i,n,r){return this._maxOpSizeInBytes>=0?!s||s.length<=this._maxOpSizeInBytes?this.submitRuntimeMessage(e,t,n,r):(this.closeFn(new b.d("OpTooLarge",void 0,{length:{value:s.length,tag:h.e.PackageData},limit:{value:this._maxOpSizeInBytes,tag:h.e.PackageData}})),-1):!s||s.length<=i?this.submitRuntimeMessage(e,t,n,r):this.submitChunkedMessage(e,s,i)}submitChunkedMessage(e,t,s){const n=t.length,r=Math.floor((n-1)/s)+1;let a=0,o=0;for(let c=1;c<=r;c+=1){const n={chunkId:c,contents:t.substr(a,s),originalType:e,totalChunks:r};a+=s,o=this.submitRuntimeMessage(i.ChunkedOp,n,!1)}return o}submitSystemMessage(e,t){this.verifyNotClosed(),Object(a.a)(this.connected,307);const s=this.flushMode===y.FlushMode.TurnBased&&this.needsFlush;return s&&this.mc.logger.sendErrorEvent({eventName:"submitSystemMessageError",type:e}),this.context.submitFn(e,t,s)}submitRuntimeMessage(e,t,s,i){this.verifyNotClosed(),Object(a.a)(this.connected,601);const n={type:e,contents:t};return this.context.submitFn(v.a.Operation,n,s,i)}verifyNotClosed(){if(this._disposed)throw new Error("Runtime is closed")}reSubmit(e,t,s,n){switch(e){case i.FluidDataStoreOp:this.dataStores.resubmitDataStoreOp(t,s);break;case i.Attach:case i.Alias:this.submit(e,t,s);break;case i.ChunkedOp:throw new Error("chunkedOp not expected here");case i.BlobAttach:this.submit(e,t,s,n);break;case i.Rejoin:this.submit(e,t);break;default:Object(l.a)(e,"Unknown ContainerMessageType: "+e)}}rollback(e,t,s){switch(e){case i.FluidDataStoreOp:this.dataStores.rollbackDataStoreOp(t,s);break;default:throw new Error("Can't rollback "+e)}}async refreshLatestSummaryAck(e,t,s,i){const n=async e=>Object(f.a)(this.storage,e),{snapshotTree:r}=await this.fetchSnapshotFromStorage(t,i,{eventName:"RefreshLatestSummaryGetSnapshot",ackHandle:t,summaryRefSeq:s,fetchLatest:!1}),a=await this.summarizerNode.refreshLatestSummary(e,s,async()=>r,n,i);await this.garbageCollector.latestSummaryStateRefreshed(a,n)}async refreshLatestSummaryAckFromServer(e){const{snapshotTree:t,versionId:s}=await this.fetchSnapshotFromStorage(null,e,{eventName:"RefreshLatestSummaryGetSnapshot",fetchLatest:!0}),i=async e=>Object(f.a)(this.storage,e),n=await Object(k.a)(t,i),r=await this.summarizerNode.refreshLatestSummary(void 0,n,async()=>t,i,e);return await this.garbageCollector.latestSummaryStateRefreshed(r,i),{latestSnapshotRefSeq:n,latestSnapshotVersionId:s}}async fetchSnapshotFromStorage(e,t,s){return h.c.timedExecAsync(t,s,async t=>{const s={},i=u.a.start(),n=await this.storage.getVersions(e,1);Object(a.a)(!!n&&!!n[0],311),s.getVersionDuration=i.trace().duration;const r=await this.storage.getSnapshotTree(n[0]);return Object(a.a)(!!r,312),s.getSnapshotDuration=i.trace().duration,t.end(s),{snapshotTree:r,versionId:n[0].id}})}notifyAttaching(e){var t;(null!==(t=this.mc.config.getBoolean("enableOfflineLoad"))&&void 0!==t?t:this.runtimeOptions.enableOfflineLoad)&&(this.baseSnapshotBlobs=$.a.serializeTreeWithBlobContents(e))}async getSnapshotBlobs(){var e;(null!==(e=this.mc.config.getBoolean("enableOfflineLoad"))&&void 0!==e?e:this.runtimeOptions.enableOfflineLoad)&&this.attachState===n.a.Attached&&!this.context.pendingLocalState&&(Object(a.a)(!!this.context.baseSnapshot,741),this.baseSnapshotBlobs=await $.a.serializeTree(this.context.baseSnapshot,this.storage))}getPendingLocalState(){var e;if(!(null!==(e=this.mc.config.getBoolean("enableOfflineLoad"))&&void 0!==e?e:this.runtimeOptions.enableOfflineLoad))throw new b.f("can't get state when offline load disabled");const t=this.context.pendingLocalState;return t?{pending:this.pendingStateManager.getLocalState(),snapshotBlobs:t.snapshotBlobs,baseSnapshot:t.baseSnapshot,savedOps:this.savedOps}:(Object(a.a)(!!this.context.baseSnapshot,742),Object(a.a)(!!this.baseSnapshotBlobs,743),{pending:this.pendingStateManager.getLocalState(),snapshotBlobs:this.baseSnapshotBlobs,baseSnapshot:this.context.baseSnapshot,savedOps:this.savedOps})}formRequestSummarizerFn(e){return async()=>{const t={headers:{[r.a.cache]:!1,[r.a.clientDetails]:{capabilities:{interactive:!1},type:_.b},[g.a.summarizingClient]:!0,[r.a.reconnect]:!1},url:"/_summarizer"},s=(await Object(w.d)(e,t)).ISummarizer;if(!s)throw new b.f("Fluid object does not implement ISummarizer");return s}}async processSavedOps(e){for(const t of e.savedOps)this.process(t,!1),await this.pendingStateManager.applyStashedOpsAt(t.sequenceNumber);await this.pendingStateManager.applyStashedOpsAt()}}const se=async(e,t)=>new Promise((s,i)=>{e.on("closed",i);const n=i=>{i.sequenceNumber>=t&&(s(),e.off("op",n))};e.on("op",n)})},17963:function(e,t,s){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,s,i){void 0===i&&(i=s),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,i){void 0===i&&(i=s),e[i]=t[s]}),n=this&&this.__exportStar||function(e,t){for(var s in e)"default"===s||Object.prototype.hasOwnProperty.call(t,s)||i(t,e,s)};Object.defineProperty(t,"__esModule",{value:!0}),n(s(17964),t),n(s(17965),t),n(s(17966),t),n(s(17967),t),n(s(17968),t),n(s(17969),t)},17964:function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IFluidDataStoreFactory=void 0,t.IFluidDataStoreFactory="IFluidDataStoreFactory"},17965:function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IFluidDataStoreRegistry=void 0,t.IFluidDataStoreRegistry="IFluidDataStoreRegistry"},17966:function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VisibilityState=t.FlushMode=void 0,function(e){e[e.Immediate=0]="Immediate",e[e.TurnBased=1]="TurnBased"}(t.FlushMode||(t.FlushMode={})),t.VisibilityState={NotVisible:"NotVisible",LocallyVisible:"LocallyVisible",GloballyVisible:"GloballyVisible"}},17967:function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.gcBlobKey=void 0,t.gcBlobKey="gc"},17968:function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},17969:function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.totalBlobSizePropertyName=t.blobCountPropertyName=t.channelsTreeName=t.CreateSummarizerNodeSource=void 0,function(e){e[e.FromSummary=0]="FromSummary",e[e.FromAttach=1]="FromAttach",e[e.Local=2]="Local"}(t.CreateSummarizerNodeSource||(t.CreateSummarizerNodeSource={})),t.channelsTreeName=".channels",t.blobCountPropertyName="BlobCount",t.totalBlobSizePropertyName="TotalBlobSize"},17970:function(e,t,s){"use strict";var i,n;s.d(t,"a",(function(){return i})),function(e){e.NoOp="noop",e.ClientJoin="join",e.ClientLeave="leave",e.Propose="propose",e.Reject="reject",e.Summarize="summarize",e.SummaryAck="summaryAck",e.SummaryNack="summaryNack",e.Operation="op",e.RemoteHelp="remoteHelp",e.NoClient="noClient",e.RoundTrip="tripComplete",e.Control="control"}(i||(i={})),function(e){e.ThrottlingError="ThrottlingError",e.InvalidScopeError="InvalidScopeError",e.BadRequestError="BadRequestError",e.LimitExceededError="LimitExceededError"}(n||(n={}))},17971:function(e,t,s){"use strict";s.d(t,"a",(function(){return r})),s.d(t,"b",(function(){return a})),s.d(t,"c",(function(){return o}));var i,n=s(17970);function r(e){if(a(e))return!0;switch(e.type){case n.a.Propose:case n.a.Reject:case n.a.NoOp:return!0;default:return!1}}function a(e){return e.type===n.a.Operation||e.type===n.a.Summarize}function o(e){return!!Object.values(i).includes(e.type)}!function(e){e.FluidDataStoreOp="component",e.Attach="attach",e.ChunkedOp="chunkedOp",e.BlobAttach="blobAttach",e.Rejoin="rejoin",e.Alias="alias",e.Operation="op"}(i||(i={}))},17972:function(e,t,s){"use strict";s.d(t,"b",(function(){return o})),s.d(t,"a",(function(){return l}));var i=s(17944),n=s(17970),r=s(17955),a=s(17940);const o=5e3;class c{constructor(e,t,s){this.clientId=e,this.deltaManager=t,this.pongCount=0,this.msnTrackingTimestamp=0,this.opProcessingTimes={},this.opPerfData={},this.firstConnection=!0,this.bootTime=r.a.now(),this.connectionStartTime=0,this.gap=0,this.logger=i.a.create(s,"OpPerf"),this.deltaManager.on("pong",e=>this.recordPingTime(e)),this.deltaManager.on("submitOp",e=>this.beforeOpSubmit(e)),this.deltaManager.on("op",e=>this.afterProcessingOp(e)),this.deltaManager.on("connect",(e,t)=>{this.clientId=e.clientId,void 0!==t&&(this.connectionOpSeqNumber=this.deltaManager.lastKnownSeqNumber,this.gap=t,this.connectionStartTime=r.a.now(),this.gap<=0&&this.reportGettingUpToDate())}),this.deltaManager.on("disconnect",()=>{this.sequenceNumberForMsnTracking=void 0,this.clientSequenceNumberForLatencyStatistics=void 0,this.opProcessingTimes={},this.opPerfData={},this.connectionOpSeqNumber=void 0,this.firstConnection=!1,this.pongCount=0}),this.deltaManager.outbound.on("push",e=>{for(const t of e)t.type===n.a.Operation&&this.clientSequenceNumberForLatencyStatistics===t.clientSequenceNumber&&(Object(a.a)(void 0===this.opProcessingTimes.outboundPushEventTime,712),Object(a.a)(void 0===this.opPerfData.durationNetwork,713),this.opProcessingTimes.outboundPushEventTime=Date.now(),Object(a.a)(void 0===this.opPerfData.durationOutboundBatching,714),Object(a.a)(void 0!==this.opProcessingTimes.submitOpEventTime,715),this.opPerfData.durationOutboundBatching=this.opProcessingTimes.outboundPushEventTime-this.opProcessingTimes.submitOpEventTime)}),this.deltaManager.inbound.on("push",e=>{this.clientId===e.clientId&&e.type===n.a.Operation&&this.clientSequenceNumberForLatencyStatistics===e.clientSequenceNumber&&void 0!==this.opProcessingTimes.outboundPushEventTime&&(this.opProcessingTimes.inboundPushEventTime=Date.now(),this.opPerfData.durationNetwork=this.opProcessingTimes.inboundPushEventTime-this.opProcessingTimes.outboundPushEventTime,this.opProcessingTimes.outboundPushEventTime=void 0,this.opPerfData.lengthInboundQueue=this.deltaManager.inbound.length)}),this.deltaManager.inbound.on("idle",(e,t)=>{"number"==typeof e&&e>=100&&this.logger.sendPerformanceEvent({eventName:"GetDeltas_OpProcessing",count:e,duration:t})})}reportGettingUpToDate(){this.connectionOpSeqNumber=void 0,this.logger.sendPerformanceEvent({eventName:"ConnectionSpeed",duration:r.a.now()-this.connectionStartTime,ops:this.gap,timeToConnect:this.firstConnection?i.f.formatTick(this.connectionStartTime-this.bootTime):void 0,firstConnection:this.firstConnection})}recordPingTime(e){this.pingLatency=e,this.pongCount%100==0&&this.deltaManager.active&&this.logger.sendPerformanceEvent({eventName:"DeltaLatency",duration:e}),this.pongCount++}beforeOpSubmit(e){void 0===this.clientSequenceNumberForLatencyStatistics&&e.clientSequenceNumber%500==1&&(Object(a.a)(void 0===this.opProcessingTimes.outboundPushEventTime,716),Object(a.a)(void 0===this.opPerfData.durationNetwork,717),this.opProcessingTimes.submitOpEventTime=Date.now(),this.clientSequenceNumberForLatencyStatistics=e.clientSequenceNumber)}afterProcessingOp(e){const t=e.sequenceNumber;if(t===this.connectionOpSeqNumber&&this.reportGettingUpToDate(),void 0===this.sequenceNumberForMsnTracking&&t%1e3==0&&(this.sequenceNumberForMsnTracking=t,this.msnTrackingTimestamp=e.timestamp),void 0!==this.sequenceNumberForMsnTracking&&e.minimumSequenceNumber>=this.sequenceNumberForMsnTracking&&(Object(a.a)(void 0!==this.msnTrackingTimestamp,718),this.logger.sendPerformanceEvent({eventName:"MsnStatistics",sequenceNumber:t,msnDistance:t-this.sequenceNumberForMsnTracking,duration:e.timestamp-this.msnTrackingTimestamp}),this.sequenceNumberForMsnTracking=void 0),this.clientId===e.clientId&&this.clientSequenceNumberForLatencyStatistics===e.clientSequenceNumber){Object(a.a)(void 0!==this.opProcessingTimes.submitOpEventTime,288);const s=Date.now();void 0!==this.opProcessingTimes.inboundPushEventTime&&(this.opPerfData.durationInboundToProcessing=s-this.opProcessingTimes.inboundPushEventTime);const i=s-this.opProcessingTimes.submitOpEventTime,n=i>o?"error":"performance";this.logger.sendPerformanceEvent(Object.assign({eventName:"OpRoundtripTime",sequenceNumber:t,referenceSequenceNumber:e.referenceSequenceNumber,duration:i,category:n,pingLatency:this.pingLatency,msnDistance:this.deltaManager.lastSequenceNumber-this.deltaManager.minimumSequenceNumber},this.opPerfData)),this.clientSequenceNumberForLatencyStatistics=void 0,this.opPerfData={}}}}function l(e,t,s){new c(e,t,s)}},17973:function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));const i="1.3.6"},17974:function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var i=s(17955),n=s(17944);class r{constructor(e,t){this.logger=t,this.processingTimeIncrement=10,this.currentAllowedProcessingTimeForTurn=r.processingTime,this.schedulingCount=0,this.deltaManager=e,this.deltaManager.inbound.on("idle",()=>{this.inboundQueueIdle()})}batchBegin(e){this.processingStartTime||(this.processingStartTime=i.a.now()),void 0===this.schedulingLog&&this.schedulingCount%500==0&&(this.schedulingLog={opsRemainingToProcess:0,numberOfTurns:1,totalProcessingTime:0,numberOfBatchesProcessed:0,firstSequenceNumber:e.sequenceNumber,lastSequenceNumber:e.sequenceNumber,startTime:i.a.now()})}batchEnd(e){if(this.schedulingLog&&(this.schedulingLog.numberOfBatchesProcessed++,this.schedulingLog.lastSequenceNumber=e.sequenceNumber,this.schedulingLog.opsRemainingToProcess=this.deltaManager.inbound.length),this.shouldRunScheduler()){const e=i.a.now(),t=e-this.processingStartTime;t>this.currentAllowedProcessingTimeForTurn&&(this.deltaManager.inbound.pause(),this.currentAllowedProcessingTimeForTurn+=this.processingTimeIncrement,this.schedulingLog&&(this.schedulingLog.numberOfTurns++,this.schedulingLog.totalProcessingTime+=t),setTimeout(()=>{this.schedulingLog&&this.logger.sendTelemetryEvent({eventName:"InboundOpsPartialProcessingTime",duration:n.f.formatTick(t),opsProcessed:this.schedulingLog.lastSequenceNumber-this.schedulingLog.firstSequenceNumber+1,opsRemainingToProcess:this.deltaManager.inbound.length,processingTime:n.f.formatTick(this.schedulingLog.totalProcessingTime),numberOfTurns:this.schedulingLog.numberOfTurns,batchesProcessed:this.schedulingLog.numberOfBatchesProcessed,timeToResume:n.f.formatTick(i.a.now()-e)}),this.deltaManager.inbound.resume()}),this.processingStartTime=void 0)}}inboundQueueIdle(){if(this.schedulingLog){const e=i.a.now();this.schedulingLog.totalProcessingTime+=e-this.processingStartTime,this.logger.sendTelemetryEvent({eventName:"InboundOpsProcessingTime",opsRemainingToProcess:this.schedulingLog.opsRemainingToProcess,numberOfTurns:this.schedulingLog.numberOfTurns,processingTime:n.f.formatTick(this.schedulingLog.totalProcessingTime),opsProcessed:this.schedulingLog.lastSequenceNumber-this.schedulingLog.firstSequenceNumber+1,batchesProcessed:this.schedulingLog.numberOfBatchesProcessed,duration:n.f.formatTick(e-this.schedulingLog.startTime),schedulingCount:this.schedulingCount}),this.schedulingLog=void 0}this.schedulingCount++,this.processingStartTime=void 0,this.currentAllowedProcessingTimeForTurn=r.processingTime}shouldRunScheduler(){return this.deltaManager.inbound.length>0}}r.processingTime=50},17975:function(e,t,s){"use strict";s.d(t,"b",(function(){return r})),s.d(t,"a",(function(){return a}));var i=s(17939),n=s(17970);const r="summarizer";class a extends i.a{constructor(e,t,s,i,r){super(),this.logger=e,this.summaryCollection=t,this.clientElection=s,this.maxOpsSinceLastSummary=i,this.electionEnabled=r,this.lastReportedSeq=0,this.summaryCollection.on("default",({sequenceNumber:e})=>{var t,s,n;const r=this.electedClientId;if(void 0===r)return void(this.clientElection.eligibleCount>0&&this.clientElection.resetElectedClient(e));let a=this.clientElection.electionSequenceNumber;if(e-(null!==(t=this.lastSummaryAckSeqForClient)&&void 0!==t?t:a)>this.maxOpsSinceLastSummary){const t=e-this.lastReportedSeq;if(t>this.maxOpsSinceLastSummary&&(this.logger.sendErrorEvent({eventName:"ElectedClientNotSummarizing",electedClientId:r,lastSummaryAckSeqForClient:this.lastSummaryAckSeqForClient,electionSequenceNumber:a,nextElectedClientId:null===(s=this.clientElection.peekNextElectedClient())||void 0===s?void 0:s.clientId,electionEnabled:this.electionEnabled}),this.lastReportedSeq=e),this.electionEnabled){const s=this.electedParentId;this.clientElection.incrementElectedClient(e),a=this.clientElection.electionSequenceNumber,e>(null!==(n=this.lastSummaryAckSeqForClient)&&void 0!==n?n:a)&&t>this.maxOpsSinceLastSummary&&this.logger.sendErrorEvent({eventName:"UnexpectedElectionSequenceNumber",lastSummaryAckSeqForClient:this.lastSummaryAckSeqForClient,electionSequenceNumber:a,sequenceNumber:e,previousClientId:r,previousParentId:s,electedParentId:this.electedParentId,electedClientId:this.electedClientId,opsSinceLastReport:t,maxOpsSinceLastSummary:i})}}}),this.summaryCollection.on(n.a.SummaryAck,e=>{this.lastSummaryAckSeqForClient=e.sequenceNumber}),this.clientElection.on("election",(e,t)=>{this.lastSummaryAckSeqForClient=void 0,void 0===e&&this.clientElection.eligibleCount>0&&this.clientElection.resetElectedClient(t),this.emit("electedSummarizerChanged")})}get electedClientId(){var e;return null===(e=this.clientElection.electedClient)||void 0===e?void 0:e.clientId}get electedParentId(){var e;return null===(e=this.clientElection.electedParent)||void 0===e?void 0:e.clientId}serialize(){var e;const{electedClientId:t,electedParentId:s,electionSequenceNumber:i}=this.clientElection.serialize();return{electedClientId:t,electedParentId:s,electionSequenceNumber:null!==(e=this.lastSummaryAckSeqForClient)&&void 0!==e?e:i}}static isClientEligible(e){const t=e.client.details;return void 0===t||a.clientDetailsPermitElection(t)}}a.clientDetailsPermitElection=e=>e.capabilities.interactive||e.type===r},17976:function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var i=s(17959),n=s(17943);class r{constructor(e,t,s){this.path=e,this.runtime=t,this.routeContext=s,this.absolutePath=Object(n.a)(e,this.routeContext)}get IFluidHandleContext(){return this}attachGraph(){throw new Error("can't attach container runtime form within container!")}get isAttached(){return this.runtime.attachState!==i.a.Detached}async resolveHandle(e){return this.runtime.resolveHandle(e)}}},17977:function(e,t,s){"use strict";s.d(t,"c",(function(){return v})),s.d(t,"a",(function(){return S})),s.d(t,"b",(function(){return T}));var i=s(17978),n=s(17979),r=s(17940),a=s(17957),o=s(17999),c=s(17998),l=s(17981),u=s(17963),h=s(17991),d=s(17952),m=s(17944),g=s(17962),p=s(17984),f=s(17980),b=function(e,t){var s={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(s[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(i=Object.getOwnPropertySymbols(e);n<i.length;n++)t.indexOf(i[n])<0&&Object.prototype.propertyIsEnumerable.call(e,i[n])&&(s[i[n]]=e[i[n]])}return s};const v="gc",S={DataStore:"DataStore",SubDataStore:"SubDataStore",Blob:"Blob",Other:"Other"},y="Active",C="Inactive",O="SweepReady";class w{constructor(e,t,s,i){this.unreferencedTimestampMs=e,this.inactiveTimeoutMs=t,this.sweepTimeoutMs=s,this._state=y,void 0!==i&&this.updateTracking(i)}get state(){return this._state}updateTracking(e){const t=e-this.unreferencedTimestampMs;if(void 0!==this.sweepTimeoutMs&&t>=this.sweepTimeoutMs)return this._state=O,void this.clearTimers();if(t>=this.inactiveTimeoutMs)return this._state=C,this.clearTimers(),void(void 0!==this.sweepTimeoutMs&&j(this.sweepTimeoutMs-t,()=>{this._state=O},e=>{this.sweepTimer=e}));const s=this.inactiveTimeoutMs-t;if(void 0===this.inactiveTimer){const e=()=>{this._state=C,void 0!==this.sweepTimeoutMs&&j(this.sweepTimeoutMs-this.inactiveTimeoutMs,()=>{this._state=O},e=>{this.sweepTimer=e})};this.inactiveTimer=new i.b(s,()=>e())}this.inactiveTimer.restart(s)}clearTimers(){var e;null===(e=this.inactiveTimer)||void 0===e||e.clear(),void 0!==this.sweepTimer&&clearTimeout(this.sweepTimer)}stopTracking(){this.clearTimers(),this._state=y}}class T{constructor(e){var t,s,i,l,h,g,b;this._writeDataAtRoot=!0,this.initialStateNeedsReset=!1,this.currentGCVersion=1,this.newReferencesSinceLastRun=new Map,this.unreferencedNodesState=new Map,this.loggedUnreferencedEvents=new Set,this.pendingEventsQueue=[],this.completedRuns=0,this.runtime=e.runtime,this.isSummarizerClient=e.isSummarizerClient,this.gcOptions=e.gcOptions,this.getNodePackagePath=e.getNodePackagePath,this.getLastSummaryTimestampMs=e.getLastSummaryTimestampMs;const S=e.baseSnapshot,y=e.metadata,C=e.readAndParseBlob;let O;if(this.mc=Object(d.c)(m.a.create(e.baseLogger,"GarbageCollector",{all:{completedGCRuns:()=>this.completedRuns}})),e.existing)O=Object(f.i)(y),this.gcEnabled=O>0,this.sweepEnabled=null!==(t=null==y?void 0:y.sweepEnabled)&&void 0!==t&&t,this.sessionExpiryTimeoutMs=null==y?void 0:y.sessionExpiryTimeoutMs;else{if(this.gcOptions.sweepAllowed&&!1===this.gcOptions.gcAllowed)throw new a.f("GC sweep phase cannot be enabled without enabling GC mark phase");this.gcEnabled=!1!==this.gcOptions.gcAllowed,this.sweepEnabled=!0===this.gcOptions.sweepAllowed,this.mc.config.getBoolean("Fluid.GarbageCollection.RunSessionExpiry")&&this.gcEnabled&&(this.sessionExpiryTimeoutMs=2592e6)}if(void 0!==this.sessionExpiryTimeoutMs&&!0!==this.mc.config.getBoolean("Fluid.GarbageCollection.DisableSessionExpiry")){const t=this.mc.config.getNumber("Fluid.GarbageCollection.TestOverride.SessionExpiryMs"),s=null!=t?t:this.sessionExpiryTimeoutMs;j(s,()=>{this.runtime.closeFn(new a.a("Client session expired.",s))},e=>{this.sessionExpiryTimer=e}),void 0!==e.snapshotCacheExpiryMs&&(this.sweepTimeoutMs=this.sessionExpiryTimeoutMs+e.snapshotCacheExpiryMs+864e5)}if(this.latestSummaryGCVersion=null!=O?O:this.currentGCVersion,this.shouldRunGC=null!==(s=this.mc.config.getBoolean("Fluid.GarbageCollection.RunGC"))&&void 0!==s?s:this.gcEnabled&&!this.gcOptions.disableGC,this.shouldRunSweep=this.shouldRunGC&&void 0!==this.sweepTimeoutMs&&(null!==(i=this.mc.config.getBoolean("Fluid.GarbageCollection.RunSweep"))&&void 0!==i?i:this.sweepEnabled),this.trackGCState=!0===this.mc.config.getBoolean("Fluid.GarbageCollection.TrackGCState"),this.inactiveTimeoutMs=null!==(h=null!==(l=this.mc.config.getNumber("Fluid.GarbageCollection.TestOverride.InactiveTimeoutMs"))&&void 0!==l?l:this.gcOptions.inactiveTimeoutMs)&&void 0!==h?h:6048e5,void 0!==this.sweepTimeoutMs&&this.inactiveTimeoutMs>this.sweepTimeoutMs)throw new a.f("inactive timeout should not be greated than the sweep timeout");if(this.testMode=null!==(g=this.mc.config.getBoolean("Fluid.GarbageCollection.GCTestMode"))&&void 0!==g?g:!0===this.gcOptions.runGCInTestMode,this._writeDataAtRoot=null===(b=this.mc.config.getBoolean("Fluid.GarbageCollection.WriteDataAtRoot"))||void 0===b||b,this._writeDataAtRoot){const e=void 0!==(null==S?void 0:S.trees[v]);this.initialStateNeedsReset=e!==this.shouldRunGC}const T=new n.b(async()=>{var e;if(void 0===S)return;const t=S.trees[v];if(void 0!==t){this._writeDataAtRoot=!0;const e=await k(t,C);return this.trackGCState&&(this.latestSerializedSummaryState=JSON.stringify(N(e))),e}const s={gcNodes:{"/":{outboundRoutes:[]}}},i=Object(p.b)(S,y);Object(r.a)(void 0!==i,680);for(const[n,a]of Object.entries(i.trees)){const t=a.blobs[u.gcBlobKey];if(void 0===t)continue;const i=await C(t);if(void 0===(null===(e=i.gcData)||void 0===e?void 0:e.gcNodes))continue;const o="/"+n;(await C(a.blobs[f.d])).isRootDataStore&&s.gcNodes["/"].outboundRoutes.push(o);for(const[e,n]of Object.entries(i.gcData.gcNodes)){const t="/"===e?o:`${o}${e}`;s.gcNodes[t]={outboundRoutes:Array.from(n)}}Object(r.a)(void 0!==s.gcNodes[o],681),s.gcNodes[o].unreferencedTimestampMs=i.unrefTimestamp}return 1===Object.keys(s.gcNodes).length?void 0:s});this.initializeBaseStateP=new n.b(async()=>{const e=this.runtime.getCurrentReferenceTimestampMs(),t=await T;if(void 0===t)return;const s={};for(const[i,n]of Object.entries(t.gcNodes))void 0!==n.unreferencedTimestampMs&&this.unreferencedNodesState.set(i,new w(n.unreferencedTimestampMs,this.inactiveTimeoutMs,this.sweepTimeoutMs,e)),s[i]=Array.from(n.outboundRoutes);this.previousGCDataFromLastRun={gcNodes:s}}),this.baseGCDetailsP=new n.b(async()=>{const e=await T;if(void 0===e)return new Map;const t={};for(const[n,r]of Object.entries(e.gcNodes))t[n]=Array.from(r.outboundRoutes);const s=Object(o.a)(t,["/"]).referencedNodeIds,i=Object(c.g)({gcData:{gcNodes:t},usedRoutes:s});for(const[n,r]of Object.entries(e.gcNodes))if(void 0!==r.unreferencedTimestampMs){const e=i.get(n.slice(1));void 0!==e&&(e.unrefTimestamp=r.unreferencedTimestampMs)}return i});const M=JSON.stringify(Object.assign({gcEnabled:this.gcEnabled,sweepEnabled:this.sweepEnabled,runGC:this.shouldRunGC,runSweep:this.shouldRunSweep,writeAtRoot:this._writeDataAtRoot,testMode:this.testMode,sessionExpiry:this.sessionExpiryTimeoutMs,inactiveTimeout:this.inactiveTimeoutMs,existing:e.existing,trackGCState:this.trackGCState},this.gcOptions));this.isSummarizerClient&&this.mc.logger.sendTelemetryEvent({eventName:"GarbageCollectorLoaded",gcConfigs:M}),this.shouldRunGC&&this.initializeBaseStateP.catch(e=>{const t=a.c.wrapIfUnrecognized(e,"FailedToInitializeGC");throw t.addTelemetryProperties({gcConfigs:M}),t})}static create(e){return new T(e)}get summaryStateNeedsReset(){return this.initialStateNeedsReset||this.shouldRunGC&&this.latestSummaryGCVersion!==this.currentGCVersion}get writeDataAtRoot(){return this._writeDataAtRoot}async collectGarbage(e){const{fullGC:t=!0===this.gcOptions.runFullGC||this.summaryStateNeedsReset}=e,s=e.logger?m.a.create(e.logger,void 0,{all:{completedGCRuns:()=>this.completedRuns}}):this.mc.logger;return m.c.timedExecAsync(s,{eventName:"GarbageCollection"},async e=>{await this.runPreGCSteps();const i=await this.runtime.getGCData(t),n=Object(o.a)(i.gcNodes,["/"]),r=await this.runPostGCSteps(i,n,s);return e.end(Object.assign({},r)),this.completedRuns++,r},{end:!0,cancel:"error"})}async runPreGCSteps(){await this.initializeBaseStateP,await this.runtime.updateStateBeforeGC()}async runPostGCSteps(e,t,s){const i=this.generateStats(t);this.updateStateSinceLastRun(e,s);const n=this.runtime.getCurrentReferenceTimestampMs();return this.updateCurrentState(e,t,n),this.runtime.updateUsedRoutes(t.referencedNodeIds,n),this.logSweepEvents(s,n),this.testMode&&this.runtime.deleteUnusedRoutes(t.deletedNodeIds),await this.logUnreferencedEvents(s),i}summarize(e,t,s){var i;if(!this.shouldRunGC||void 0===this.previousGCDataFromLastRun)return;const n={gcNodes:{}};for(const[o,c]of Object.entries(this.previousGCDataFromLastRun.gcNodes))n.gcNodes[o]={outboundRoutes:c,unreferencedTimestampMs:null===(i=this.unreferencedNodesState.get(o))||void 0===i?void 0:i.unreferencedTimestampMs};const r=JSON.stringify(N(n));if(this.trackGCState&&(this.pendingSerializedSummaryState=r,void 0!==this.latestSerializedSummaryState&&this.latestSerializedSummaryState===r&&!e&&t)){const e=Object(h.j)();return e.handleNodeCount++,{summary:{type:l.a.Handle,handle:"/"+v,handleType:l.a.Tree},stats:e}}const a=new h.a;return a.addBlob("__gc_root",r),a.getSummaryTree()}getMetadata(){return{gcFeature:this.gcEnabled?this.currentGCVersion:0,sessionExpiryTimeoutMs:this.sessionExpiryTimeoutMs,sweepEnabled:this.sweepEnabled}}async getBaseGCDetails(){return this.baseGCDetailsP}async latestSummaryStateRefreshed(e,t){if(!this.shouldRunGC||!e.latestSummaryUpdated)return;if(e.wasSummaryTracked)return this.latestSummaryGCVersion=this.currentGCVersion,this.initialStateNeedsReset=!1,void(this.trackGCState&&(this.latestSerializedSummaryState=this.pendingSerializedSummaryState,this.pendingSerializedSummaryState=void 0));const s=e.snapshot,i=s.blobs[f.k];if(i){const e=await t(i);this.latestSummaryGCVersion=Object(f.i)(e)}const n=s.trees[v];if(void 0!==n&&this.trackGCState){const e=await k(n,t);this.latestSerializedSummaryState=JSON.stringify(N(e))}else this.latestSerializedSummaryState=void 0;this.pendingSerializedSummaryState=void 0}nodeUpdated(e,t,s,i,n){if(!this.shouldRunGC)return;const r=this.unreferencedNodesState.get(e);r&&r.state!==y&&this.inactiveNodeUsed(t,e,r,void 0,i,s,n)}addedOutboundReference(e,t){var s;if(!this.shouldRunGC)return;const i=null!==(s=this.newReferencesSinceLastRun.get(e))&&void 0!==s?s:[];i.push(t),this.newReferencesSinceLastRun.set(e,i);const n=this.unreferencedNodesState.get(t);n&&n.state!==y&&this.inactiveNodeUsed("Revived",t,n,e)}dispose(){void 0!==this.sessionExpiryTimer&&(clearTimeout(this.sessionExpiryTimer),this.sessionExpiryTimer=void 0)}updateCurrentState(e,t,s){this.previousGCDataFromLastRun=Object(c.b)(e),this.newReferencesSinceLastRun.clear();for(const i of t.referencedNodeIds){const e=this.unreferencedNodesState.get(i);void 0!==e&&(e.stopTracking(),this.unreferencedNodesState.delete(i))}if(void 0!==s)for(const i of t.deletedNodeIds){const e=this.unreferencedNodesState.get(i);void 0===e?this.unreferencedNodesState.set(i,new w(s,this.inactiveTimeoutMs,this.sweepTimeoutMs,s)):e.updateTracking(s)}}updateStateSinceLastRun(e,t){if(void 0===this.previousGCDataFromLastRun)return;const s=this.findMissingExplicitReferences(e,this.previousGCDataFromLastRun,this.newReferencesSinceLastRun);if(this.writeDataAtRoot&&s.length>0&&s.forEach(e=>{const s={eventName:"gcUnknownOutboundReferences",gcNodeId:e[0],gcRoutes:JSON.stringify(e[1])};t.sendPerformanceEvent(s)}),0===this.newReferencesSinceLastRun.size)return;const i=Object(c.c)(this.previousGCDataFromLastRun,e);this.newReferencesSinceLastRun.forEach((e,t)=>{void 0===i.gcNodes[t]?i.gcNodes[t]=e:i.gcNodes[t].push(...e)});const n=Object(o.a)(i.gcNodes,["/"]);for(const r of n.referencedNodeIds){const e=this.unreferencedNodesState.get(r);void 0!==e&&(e.stopTracking(),this.unreferencedNodesState.delete(r))}}findMissingExplicitReferences(e,t,s){Object(r.a)(void 0!==t,695);const i=Object.entries(e.gcNodes),n=[];return i.forEach(([e,i])=>{var r,a;const o=null!==(r=t.gcNodes[e])&&void 0!==r?r:[],c=null!==(a=s.get(e))&&void 0!==a?a:[],l=[];i.forEach(t=>{const s=this.runtime.getNodeType(t)===S.Blob||this.runtime.getNodeType(t)===S.DataStore,i=!e.startsWith(t);s&&i&&!o.includes(t)&&!c.includes(t)&&l.push(t)}),l.length>0&&n.push([e,l])}),n}generateStats(e){const t={nodeCount:0,dataStoreCount:0,attachmentBlobCount:0,unrefNodeCount:0,unrefDataStoreCount:0,unrefAttachmentBlobCount:0,updatedNodeCount:0,updatedDataStoreCount:0,updatedAttachmentBlobCount:0},s=(e,s)=>{t.nodeCount++;const i=void 0===this.previousGCDataFromLastRun||this.unreferencedNodesState.has(e)===s;i&&t.updatedNodeCount++,s||t.unrefNodeCount++,this.runtime.getNodeType(e)===S.DataStore&&(t.dataStoreCount++,i&&t.updatedDataStoreCount++,s||t.unrefDataStoreCount++),this.runtime.getNodeType(e)===S.Blob&&(t.attachmentBlobCount++,i&&t.updatedAttachmentBlobCount++,s||t.unrefAttachmentBlobCount++)};for(const i of e.referencedNodeIds)s(i,!0);for(const i of e.deletedNodeIds)s(i,!1);return t}logSweepEvents(e,t){!0!==this.mc.config.getBoolean("Fluid.GarbageCollection.DisableSweepLog")&&void 0!==t&&void 0!==this.sweepTimeoutMs&&this.unreferencedNodesState.forEach((s,i)=>{if(s.state!==O)return;const n=this.runtime.getNodeType(i);if(n!==S.DataStore&&n!==S.Blob)return;const r="Deleted-"+i;this.loggedUnreferencedEvents.has(r)||(this.loggedUnreferencedEvents.add(r),e.sendTelemetryEvent({eventName:"GCObjectDeleted",id:i,type:n,age:t-s.unreferencedTimestampMs,timeout:this.sweepTimeoutMs,completedGCRuns:this.completedRuns,lastSummaryTime:this.getLastSummaryTimestampMs()}))})}inactiveNodeUsed(e,t,s,i,n,r=this.runtime.getCurrentReferenceTimestampMs(),a){if(void 0===r||s.state===y)return;if(!this.isSummarizerClient&&"Loaded"!==e)return;const o=this.runtime.getNodeType(t);if(o!==S.DataStore&&o!==S.Blob)return;const c=s.state,l=`${c}-${t}-${e}`;if(this.loggedUnreferencedEvents.has(l))return;this.loggedUnreferencedEvents.add(l);const u={id:t,type:o,unrefTime:s.unreferencedTimestampMs,age:r-s.unreferencedTimestampMs,timeout:s.state===C?this.inactiveTimeoutMs:this.sweepTimeoutMs,completedGCRuns:this.completedRuns,lastSummaryTime:this.getLastSummaryTimestampMs(),externalRequest:null==a?void 0:a[g.b.externalRequest],viaHandle:null==a?void 0:a[g.b.viaHandle],fromId:i};this.isSummarizerClient?this.pendingEventsQueue.push(Object.assign(Object.assign({},u),{usageType:e,state:c})):this.mc.logger.sendErrorEvent(Object.assign(Object.assign({},u),{eventName:`${c}Object_${e}`,pkg:n?{value:n.join("/"),tag:m.e.CodeArtifact}:void 0}))}async logUnreferencedEvents(e){for(const t of this.pendingEventsQueue){const{usageType:s,state:i}=t,n=b(t,["usageType","state"]),r=this.unreferencedNodesState.get(t.id);if("Revived"===s===(void 0===r||r.state===y)){const r=await this.getNodePackagePath(t.id),a=t.fromId?await this.getNodePackagePath(t.fromId):void 0;e.sendErrorEvent(Object.assign(Object.assign({},n),{eventName:`${i}Object_${s}`,pkg:r?{value:r.join("/"),tag:m.e.CodeArtifact}:void 0,fromPkg:a?{value:a.join("/"),tag:m.e.CodeArtifact}:void 0}))}}this.pendingEventsQueue=[]}}async function k(e,t){let s={gcNodes:{}};for(const i of Object.keys(e.blobs)){if(!i.startsWith("__gc"))continue;const n=e.blobs[i];if(void 0===n)continue;const a=await t(n);Object(r.a)(void 0!==a,685),s=Object(c.d)(s,a)}return s}function N(e){const t=Object.entries(e.gcNodes);t.sort(([e],[t])=>e.localeCompare(t));const s={gcNodes:{}};for(const[i,n]of t)n.outboundRoutes.sort(),s.gcNodes[i]=n;return s}function j(e,t,s){let i;if(e>2147483647){const n=e-2147483647;i=setTimeout(()=>j(n,t,s),2147483647)}else i=setTimeout(()=>t(),e);s(i)}},17978:function(e,t,s){"use strict";s.d(t,"b",(function(){return r})),s.d(t,"a",(function(){return a}));var i=s(17940),n=s(17979);class r{constructor(e,t,s=(()=>Date.now())){this.defaultTimeout=e,this.defaultHandler=t,this.getCurrentTick=s}get hasTimer(){return!!this.runningState}start(e=this.defaultTimeout,t=this.defaultHandler){this.startCore(e,t,e)}clear(){this.runningState&&(clearTimeout(this.runningState.timeout),this.runningState=void 0)}restart(e,t){var s,i;if(this.runningState){const n=null!=e?e:this.runningState.intendedDuration,r=null!==(i=null!=t?t:null===(s=this.runningState.restart)||void 0===s?void 0:s.handler)&&void 0!==i?i:this.runningState.handler,a=this.calculateRemainingTime(this.runningState);n<a?this.start(n,r):n===a?(this.runningState.handler=r,this.runningState.restart=void 0,this.runningState.intendedDuration=n):this.runningState.restart={startTick:this.getCurrentTick(),duration:n,handler:r}}else this.start(e,t)}startCore(e,t,s){this.clear(),this.runningState={startTick:this.getCurrentTick(),duration:e,intendedDuration:s,handler:t,timeout:setTimeout(()=>this.handler(),e)}}handler(){Object(i.a)(!!this.runningState,10);const e=this.runningState.restart;if(void 0!==e){const t=this.calculateRemainingTime(e);this.startCore(t,()=>e.handler(),e.duration)}else{const e=this.runningState.handler;this.clear(),e()}}calculateRemainingTime(e){const t=this.getCurrentTick()-e.startTick;return e.duration-t}}class a{constructor(e,t){this.timer=new r(e,()=>this.wrapHandler(t))}get hasTimer(){return this.timer.hasTimer}async start(e,t){return this.clear(),this.deferred=new n.a,this.timer.start(e,t?()=>this.wrapHandler(t):void 0),this.deferred.promise}clear(){this.timer.clear(),this.deferred&&(this.deferred.resolve({timerResult:"cancel"}),this.deferred=void 0)}wrapHandler(e){e(),Object(i.a)(!!this.deferred,11),this.deferred.resolve({timerResult:"timeout"}),this.deferred=void 0}}},17979:function(e,t,s){"use strict";s.d(t,"a",(function(){return i})),s.d(t,"b",(function(){return n}));class i{constructor(){this.completed=!1,this.p=new Promise((e,t)=>{this.res=e,this.rej=t})}get isCompleted(){return this.completed}get promise(){return this.p}resolve(e){void 0!==this.res&&(this.completed=!0,this.res(e))}reject(e){void 0!==this.rej&&(this.completed=!0,this.rej(e))}}class n{constructor(e){this.execute=e}get[Symbol.toStringTag](){return this.getPromise()[Symbol.toStringTag]}async then(e,t){return this.getPromise().then(...arguments)}async catch(e){return this.getPromise().catch(...arguments)}async finally(e){return this.getPromise().finally(...arguments)}async getPromise(){return void 0===this.result&&(this.result=this.execute()),this.result}}},17980:function(e,t,s){"use strict";s.d(t,"g",(function(){return c})),s.d(t,"j",(function(){return l})),s.d(t,"f",(function(){return u})),s.d(t,"a",(function(){return h})),s.d(t,"k",(function(){return d})),s.d(t,"c",(function(){return m})),s.d(t,"e",(function(){return g})),s.d(t,"b",(function(){return p})),s.d(t,"m",(function(){return f})),s.d(t,"i",(function(){return b})),s.d(t,"l",(function(){return v})),s.d(t,"d",(function(){return S})),s.d(t,"n",(function(){return y})),s.d(t,"h",(function(){return C}));var i=s(17940),n=s(17982),r=s(17981),a=s(17963),o=s(17977);function c(e){return e.summaryFormatVersion?e.summaryFormatVersion:"0.1"===e.snapshotFormatVersion?1:0}function l(e){return!!e.summaryFormatVersion&&!e.disableIsolatedChannels}const u=e=>void 0===e?void 0:{clientId:e.clientId,clientSequenceNumber:e.clientSequenceNumber,minimumSequenceNumber:e.minimumSequenceNumber,referenceSequenceNumber:e.referenceSequenceNumber,sequenceNumber:e.sequenceNumber,timestamp:e.timestamp,type:e.type};const h=".aliases",d=".metadata",m=".chunks",g=".electedSummarizer",p=".blobs";function f(e){return!!e&&!e.disableIsolatedChannels}function b(e){var t;return e&&null!==(t=e.gcFeature)&&void 0!==t?t:0}const v=[".protocol",".logTail",".serviceProtocol",p,o.c],S=".component";function y(e){e.summary={type:r.a.Tree,tree:{[a.channelsTreeName]:e.summary}},e.stats.treeNodeCount++}async function C(e,t){const s=await Object(n.a)(e,t.blobs[S]),r=c(s);return Object(i.a)(r>0,469),s}},17981:function(e,t,s){"use strict";var i;s.d(t,"a",(function(){return i})),function(e){e.Tree=1,e.Blob=2,e.Handle=3,e.Attachment=4}(i||(i={}))},17982:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));var i=s(17983);async function n(e,t){const s=await e.readBlob(t),n=Object(i.c)(s,"utf8");return JSON.parse(n)}},17983:function(e,t,s){"use strict";s.d(t,"b",(function(){return r})),s.d(t,"d",(function(){return a})),s.d(t,"c",(function(){return o})),s.d(t,"a",(function(){return l}));var i=s(14398),n=s(17940);function r(e,t){switch(t){case"base64":return i.fromByteArray(e);case"utf8":case"utf-8":case void 0:return(new TextDecoder).decode(e);default:throw new Error("invalid/unsupported encoding")}}const a=(e,t)=>l.from(e,t).buffer,o=(e,t)=>l.from(e).toString(t);function c(e){const t=e;return e instanceof ArrayBuffer||"object"==typeof t&&null!==t&&"number"==typeof t.byteLength&&"function"==typeof t.slice&&void 0===t.byteOffset&&void 0===t.buffer}class l extends Uint8Array{toString(e){return r(this,e)}static from(e,t,s){if("string"==typeof e)return l.fromString(e,t);if(null!==e&&"object"==typeof e&&c(e.buffer))return Object(n.a)(0===e.byteOffset,0),Object(n.a)(e.byteLength===e.buffer.byteLength,1),l.fromArrayBuffer(e.buffer,t,s);if(c(e))return l.fromArrayBuffer(e,t,s);throw new TypeError}static fromArrayBuffer(e,t,s){const i=null!=t?t:0,n=null!=s?s:e.byteLength-i;if(i<0||i>e.byteLength||n<0||n+i>e.byteLength)throw new RangeError;return new l(e,i,n)}static fromString(e,t){switch(t){case"base64":{const t=this.sanitizeBase64(e),s=i.toByteArray(t);return new l(s.buffer)}case"utf8":case"utf-8":case void 0:{const t=(new TextEncoder).encode(e);return new l(t.buffer)}default:throw new Error("invalid/unsupported encoding")}}static isBuffer(e){throw new Error("unimplemented")}static sanitizeBase64(e){let t=e;if(t=t.split("=")[0],t=t.replace(/[^\w+-/]/g,""),t.length%4!=0){t+=["","===","==","="][t.length%4]}return t}}},17984:function(e,t,s){"use strict";s.d(t,"a",(function(){return w})),s.d(t,"b",(function(){return T}));var i=s(17957),n=s(17942),r=s(17963),a=s(17997),o=s(17991),c=s(17944),l=s(17945),u=s(17959),h=s(17993),d=s(17994),m=s(17953),g=s(17979),p=s(17940),f=s(17946),b=s(17998),v=s(17985),S=s(17986),y=s(17980),C=s(17996),O=s(17977);class w{constructor(e,t,s,i,a,o,h,d,p,f,b=new v.a(o)){this.baseSnapshot=e,this.runtime=t,this.submitAttachFn=s,this.getCreateChildSummarizerNodeFn=i,this.deleteChildSummarizerNodeFn=a,this.gcNodeUpdated=d,this.aliasMap=p,this.writeGCDataAtRoot=f,this.contexts=b,this.pendingAttach=new Map,this.attachOpFiredForDataStore=new Set,this.disposeOnce=new m.a(()=>this.contexts.dispose()),this.dataStoresSinceLastGC=[],this.dispose=()=>this.disposeOnce.value,this.logger=c.a.create(o),this.containerRuntimeHandle=new n.a(this.runtime,"/",this.runtime.IFluidHandleContext);const y=new g.b(async()=>h()),C=async e=>(await y).get(e),O=new Map;if(e)for(const[n,r]of Object.entries(e.trees))O.set(n,r);let w=0;for(const[n,c]of O){let e;if(c.unreferenced&&w++,this.runtime.attachState!==u.a.Detached)e=new S.c({id:n,snapshotTree:c,getBaseGCDetails:async()=>C(n),runtime:this.runtime,storage:this.runtime.storage,scope:this.runtime.scope,createSummarizerNodeFn:this.getCreateChildSummarizerNodeFn(n,{type:r.CreateSummarizerNodeSource.FromSummary}),writeGCDataAtRoot:this.writeGCDataAtRoot,disableIsolatedChannels:this.runtime.disableIsolatedChannels});else{if("object"!=typeof c)throw new l.a("Snapshot should be there to load from!!");const t=c;e=new S.b({id:n,pkg:void 0,runtime:this.runtime,storage:this.runtime.storage,scope:this.runtime.scope,createSummarizerNodeFn:this.getCreateChildSummarizerNodeFn(n,{type:r.CreateSummarizerNodeSource.FromSummary}),makeLocallyVisibleFn:()=>this.makeDataStoreLocallyVisible(n),snapshotTree:t,isRootDataStore:void 0,writeGCDataAtRoot:this.writeGCDataAtRoot,disableIsolatedChannels:this.runtime.disableIsolatedChannels})}this.contexts.addBoundOrRemoted(e)}this.containerLoadStats={containerLoadDataStoreCount:O.size,referencedDataStoreCount:O.size-w}}aliases(){return this.aliasMap}processAttachMessage(e,t){var s,n;const a=e.contents;if(this.dataStoresSinceLastGC.push(a.id),t)return Object(p.a)(this.pendingAttach.has(a.id),350),null===(s=this.contexts.get(a.id))||void 0===s||s.emit("attached"),void this.pendingAttach.delete(a.id);if(this.alreadyProcessed(a.id)){throw new i.b("Duplicate DataStore created with existing id",Object.assign(Object.assign({},Object(i.g)(e)),{dataStoreId:{value:a.id,tag:c.e.PackageData}}))}const o=new Map;let l;a.snapshot&&(l=Object(h.a)(a.snapshot.entries,o));const u=[a.type],m=new S.c({id:a.id,snapshotTree:l,getBaseGCDetails:async()=>({}),runtime:this.runtime,storage:new d.a(this.runtime.storage,o),scope:this.runtime.scope,createSummarizerNodeFn:this.getCreateChildSummarizerNodeFn(a.id,{type:r.CreateSummarizerNodeSource.FromAttach,sequenceNumber:e.sequenceNumber,snapshot:null!==(n=a.snapshot)&&void 0!==n?n:{entries:[Object(S.d)(u,!0,this.runtime.disableIsolatedChannels)]}}),writeGCDataAtRoot:this.writeGCDataAtRoot,disableIsolatedChannels:this.runtime.disableIsolatedChannels,pkg:u});this.contexts.addBoundOrRemoted(m)}processAliasMessage(e,t,s){const n=e.contents;if(!Object(C.b)(n))throw new i.b("malformedDataStoreAliasMessage",Object.assign({},Object(i.g)(e)));const r=t,a=this.processAliasMessageCore(n);s&&r(a)}processAliasMessageCore(e){if(this.alreadyProcessed(e.alias))return!1;const t=this.contexts.get(e.internalId);if(void 0===t)return this.logger.sendErrorEvent({eventName:"AliasFluidDataStoreNotFound",fluidDataStoreId:e.internalId}),!1;const s=new n.a(t,e.internalId,this.runtime.IFluidHandleContext);return this.runtime.addedGCOutboundReference(this.containerRuntimeHandle,s),this.aliasMap.set(e.alias,t.id),t.setInMemoryRoot(),!0}alreadyProcessed(e){return void 0!==this.aliasMap.get(e)||void 0!==this.contexts.get(e)}makeDataStoreLocallyVisible(e){const t=this.contexts.getUnbound(e);if(Object(p.a)(!!t,351),this.runtime.attachState!==u.a.Detached){t.emit("attaching");const s=t.generateAttachMessage();this.pendingAttach.set(e,s),this.submitAttachFn(s),this.attachOpFiredForDataStore.add(e)}this.contexts.bind(e)}createDetachedDataStoreCore(e,t,s=Object(f.a)()){Object(p.a)(!s.includes("/"),780);const i=new S.a({id:s,pkg:e,runtime:this.runtime,storage:this.runtime.storage,scope:this.runtime.scope,createSummarizerNodeFn:this.getCreateChildSummarizerNodeFn(s,{type:r.CreateSummarizerNodeSource.Local}),makeLocallyVisibleFn:()=>this.makeDataStoreLocallyVisible(s),snapshotTree:void 0,isRootDataStore:t,writeGCDataAtRoot:this.writeGCDataAtRoot,disableIsolatedChannels:this.runtime.disableIsolatedChannels});return this.contexts.addUnbound(i),i}_createFluidDataStoreContext(e,t,s,i){Object(p.a)(!t.includes("/"),781);const n=new S.b({id:t,pkg:e,runtime:this.runtime,storage:this.runtime.storage,scope:this.runtime.scope,createSummarizerNodeFn:this.getCreateChildSummarizerNodeFn(t,{type:r.CreateSummarizerNodeSource.Local}),makeLocallyVisibleFn:()=>this.makeDataStoreLocallyVisible(t),snapshotTree:void 0,isRootDataStore:s,writeGCDataAtRoot:this.writeGCDataAtRoot,disableIsolatedChannels:this.runtime.disableIsolatedChannels,createProps:i});return this.contexts.addUnbound(n),n}get disposed(){return this.disposeOnce.evaluated}resubmitDataStoreOp(e,t){const s=e,i=this.contexts.get(s.address);Object(p.a)(!!i,352),i.reSubmit(s.contents,t)}rollbackDataStoreOp(e,t){const s=e,i=this.contexts.get(s.address);Object(p.a)(!!i,744),i.rollback(s.contents,t)}async applyStashedOp(e){const t=e,s=this.contexts.get(t.address);return Object(p.a)(!!s,353),s.applyStashedOp(t.contents)}async applyStashedAttachOp(e){this.pendingAttach.set(e.id,e),this.processAttachMessage({contents:e},!1)}processFluidDataStoreOp(e,t,s){const i=e.contents,n=Object.assign(Object.assign({},e),{contents:i.contents}),r=this.contexts.get(i.address);Object(p.a)(!!r,354),r.process(n,t,s),this.gcNodeUpdated("/"+i.address,e.timestamp,r.isLoaded?r.packagePath:void 0)}async getDataStore(e,t){const s=await this.contexts.getBoundOrRemoted(e,t);if(void 0===s){const t={url:e};throw Object(a.e)(Object(a.a)(t),t)}return s}processSignal(e,t,s){const i=this.contexts.get(e);if(!i)return Object(p.a)(!s,355),void this.logger.sendTelemetryEvent({eventName:"SignalFluidDataStoreNotFound",fluidDataStoreId:{value:e,tag:c.e.PackageData}});i.processSignal(t,s)}setConnectionState(e,t){for(const[i,n]of this.contexts)try{n.setConnectionState(e,t)}catch(s){this.logger.sendErrorEvent({eventName:"SetConnectionStateError",clientId:t,fluidDataStore:i},s)}}setAttachState(e){let t;t=e===u.a.Attaching?"attaching":"attached";for(const[,s]of this.contexts)this.contexts.isNotBound(s.id)||s.emit(t)}get size(){return this.contexts.size}async summarize(e,t,s){const i=new o.a;return await Promise.all(Array.from(this.contexts).filter(([e,t])=>(Object(p.a)(t.attachState!==u.a.Attaching,357),t.attachState===u.a.Attached)).map(async([n,r])=>{const a=await r.summarize(e,t,s);i.addWithStats(n,a)})),i.getSummaryTree()}createSummary(e){const t=new o.a;let s;do{const e=t.summary.tree;s=this.contexts.notBoundLength(),Array.from(this.contexts).filter(([t,s])=>!(this.contexts.isNotBound(t)||e[t]||this.attachOpFiredForDataStore.has(t))).map(([e,s])=>{let i;if(s.isLoaded){const e=s.generateAttachMessage().snapshot;i=Object(o.i)(e,!0)}else Object(p.a)(!!this.baseSnapshot,358),i=Object(o.g)(this.baseSnapshot.trees[e]);t.addWithStats(e,i)})}while(s!==this.contexts.notBoundLength());return t.getSummaryTree()}async updateStateBeforeGC(){for(const e of this.dataStoresSinceLastGC){const t=this.contexts.get(e);if(Object(p.a)(void 0!==t,694),await t.isRoot()){const s=new n.a(t,e,this.runtime.IFluidHandleContext);this.runtime.addedGCOutboundReference(this.containerRuntimeHandle,s)}}this.dataStoresSinceLastGC=[]}async getGCData(e=!1){const t=new b.a;return await Promise.all(Array.from(this.contexts).filter(([e,t])=>t.attachState===u.a.Attached).map(async([s,i])=>{const n=await i.getGCData(e);t.prefixAndAddNodes(s,n.gcNodes)})),t.addNode("/",await this.getOutboundRoutes()),t.getGCData()}updateUsedRoutes(e,t){var s;const i=Object(b.h)(e);for(const[n]of i)Object(p.a)(this.contexts.has(n),359);for(const[n,r]of this.contexts)r.updateUsedRoutes(null!==(s=i.get(n))&&void 0!==s?s:[],t)}deleteUnusedRoutes(e){for(const t of e){const e=t.split("/");if(e.length>2)continue;const s=e[1];Object(p.a)(this.contexts.has(s),727),this.contexts.delete(s),this.deleteChildSummarizerNodeFn(s)}}async getOutboundRoutes(){const e=[];for(const[t,s]of this.contexts){await s.isRoot()&&e.push("/"+t)}return e}async getDataStorePackagePath(e){var t;const s=this.contexts.get(e.split("/")[1]);return null===(t=await(null==s?void 0:s.getInitialSnapshotDetails()))||void 0===t?void 0:t.pkg}getGCNodeType(e){const t=e.split("/");if(this.contexts.has(t[1]))return 2===t.length?O.a.DataStore:O.a.SubDataStore}}function T(e,t){if(e){if(Object(y.m)(t)){const t=e.trees[r.channelsTreeName];return Object(p.a)(!!t,360),t}{const t={};for(const[s,i]of Object.entries(e.trees))y.l.includes(s)||(t[s]=i);return Object.assign(Object.assign({},e),{trees:t})}}}},17985:function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var i=s(17953),n=s(17940),r=s(17979),a=s(17944);class o{constructor(e){this.notBoundContexts=new Set,this._contexts=new Map,this.deferredContexts=new Map,this.disposeOnce=new i.a(()=>{for(const[e,t]of this.deferredContexts)t.promise.then(e=>{e.dispose()}).catch(t=>{this._logger.sendErrorEvent({eventName:"FluidDataStoreContextDisposeError",fluidDataStoreId:e},t)})}),this.dispose=()=>this.disposeOnce.value,this._logger=a.a.create(e)}[Symbol.iterator](){return this._contexts.entries()}get size(){return this._contexts.size}get disposed(){return this.disposeOnce.evaluated}notBoundLength(){return this.notBoundContexts.size}isNotBound(e){return this.notBoundContexts.has(e)}has(e){return this._contexts.has(e)}get(e){return this._contexts.get(e)}delete(e){return this.deferredContexts.delete(e),this.notBoundContexts.delete(e),this._contexts.delete(e)}getUnbound(e){if(void 0!==this._contexts.get(e)&&this.notBoundContexts.has(e))return this._contexts.get(e)}addUnbound(e){const t=e.id;Object(n.a)(!this._contexts.has(t),344),this._contexts.set(t,e),this.notBoundContexts.add(t),this.ensureDeferred(t)}async getBoundOrRemoted(e,t){const s=this.ensureDeferred(e);if(t||s.isCompleted)return s.promise}ensureDeferred(e){const t=this.deferredContexts.get(e);if(t)return t;const s=new r.a;return this.deferredContexts.set(e,s),s}bind(e){const t=this.notBoundContexts.delete(e);Object(n.a)(t,345),this.resolveDeferred(e)}resolveDeferred(e){const t=this._contexts.get(e);Object(n.a)(!!t,346),Object(n.a)(!this.notBoundContexts.has(e),347);const s=this.deferredContexts.get(e);Object(n.a)(!!s,348),s.resolve(t)}addBoundOrRemoted(e){const t=e.id;Object(n.a)(!this._contexts.has(t),349),this._contexts.set(t,e),this.ensureDeferred(t),this.resolveDeferred(t)}}},17986:function(e,t,s){"use strict";s.d(t,"d",(function(){return b})),s.d(t,"c",(function(){return S})),s.d(t,"b",(function(){return C})),s.d(t,"a",(function(){return O}));var i=s(17959),n=s(17939),r=s(17940),a=s(17979),o=s(17982),c=s(17987),l=s(17963),u=s(17991),h=s(17944),d=s(17990),m=s(17945),g=s(17957),p=s(17980);function f(e,t,s){const i=JSON.stringify(e);return s?{pkg:i,snapshotFormatVersion:"0.1",isRootDataStore:t}:{pkg:i,summaryFormatVersion:2,isRootDataStore:t}}function b(e,t,s){const i=f(e,t,s);return new c.b(p.d,JSON.stringify(i))}class v extends n.a{constructor(e,t,s,n,a){super(),this.existing=t,this.bindState=s,this.isLocalDataStore=n,this.makeLocallyVisibleFn=a,this._disposed=!1,this.detachedRuntimeCreation=!1,this.loaded=!1,this.pending=[],this._isInMemoryRoot=!1,this._containerRuntime=e.runtime,this.id=e.id,this.storage=e.storage,this.scope=e.scope,this.writeGCDataAtRoot=e.writeGCDataAtRoot,this.disableIsolatedChannels=e.disableIsolatedChannels,this.pkg=e.pkg,Object(r.a)(!this.id.includes("/"),314),this._attachState=this.containerRuntime.attachState!==i.a.Detached&&this.existing?this.containerRuntime.attachState:i.a.Detached,this.bindToContext=()=>{Object(r.a)(this.bindState===i.b.NotBound,315),this.bindState=i.b.Binding,Object(r.a)(void 0!==this.channel,316),this.makeLocallyVisible(),this.bindState=i.b.Bound};this.summarizerNode=e.createSummarizerNodeFn(async(e,t,s)=>this.summarizeInternal(e,t,s),async e=>this.getGCDataInternal(e),async()=>this.getBaseGCDetails()),this.subLogger=h.a.create(this.logger,"FluidDataStoreContext"),this.thresholdOpsCounter=new d.a(v.pendingOpsCountThreshold,this.subLogger)}get packagePath(){return Object(r.a)(void 0!==this.pkg,313),this.pkg}get options(){return this._containerRuntime.options}get clientId(){return this._containerRuntime.clientId}get clientDetails(){return this._containerRuntime.clientDetails}get logger(){return this._containerRuntime.logger}get deltaManager(){return this._containerRuntime.deltaManager}get connected(){return this._containerRuntime.connected}get IFluidHandleContext(){return this._containerRuntime.IFluidHandleContext}get containerRuntime(){return this._containerRuntime}get isLoaded(){return this.loaded}get baseSnapshot(){return this._baseSnapshot}get disposed(){return this._disposed}get attachState(){return this._attachState}get IFluidDataStoreRegistry(){return this.registry}async isRoot(){return this.isInMemoryRoot()||(await this.getInitialSnapshotDetails()).isRootDataStore}isInMemoryRoot(){return this._isInMemoryRoot}dispose(){this._disposed||(this._disposed=!0,this.channelDeferred&&this.channelDeferred.promise.then(e=>{e.dispose()}).catch(e=>{}))}rejectDeferredRealize(e,t){throw new m.a(e,{packageName:{value:t,tag:h.e.PackageData}})}async realize(){return Object(r.a)(!this.detachedRuntimeCreation,317),this.channelDeferred||(this.channelDeferred=new a.a,this.realizeCore(this.existing).catch(e=>{var t;const s=g.c.wrapIfUnrecognized(e,"realizeFluidDataStoreContext");s.addTelemetryProperties({fluidDataStoreId:{value:this.id,tag:"PackageData"}}),null===(t=this.channelDeferred)||void 0===t||t.reject(s),this.logger.sendErrorEvent({eventName:"RealizeError"},s)})),this.channelDeferred.promise}async factoryFromPackagePath(e){let t;Object(r.a)(this.pkg===e,318),void 0===e&&this.rejectDeferredRealize("packages is undefined");let s,i=this._containerRuntime.IFluidDataStoreRegistry;for(const r of e)i||this.rejectDeferredRealize("No registry for package",s),s=r,t=await i.get(r),t||this.rejectDeferredRealize("Registry does not contain entry for the package",r),i=t.IFluidDataStoreRegistry;const n=null==t?void 0:t.IFluidDataStoreFactory;return void 0===n&&this.rejectDeferredRealize("Can't find factory for package",s),{factory:n,registry:i}}async realizeCore(e){const t=await this.getInitialSnapshotDetails();this._baseSnapshot=t.snapshot;const s=t.pkg,{factory:i,registry:n}=await this.factoryFromPackagePath(s);Object(r.a)(void 0===this.registry,319),this.registry=n;const a=await i.instantiateDataStore(this,e);Object(r.a)(void 0!==a,320),this.bindRuntime(a)}setConnectionState(e,t){this.verifyNotClosed(),this.loaded&&(Object(r.a)(this.connected===e,321),this.channel.setConnectionState(e,t))}process(e,t,s){var i;this.verifyNotClosed();const n=e.contents,a=Object.assign(Object.assign({},e),{type:n.type,contents:n.content});if(this.summarizerNode.recordChange(a),this.loaded)return null===(i=this.channel)||void 0===i?void 0:i.process(a,t,s);Object(r.a)(!t,322),Object(r.a)(void 0!==this.pending,573),this.pending.push(a),this.thresholdOpsCounter.sendIfMultiple("StorePendingOps",this.pending.length)}processSignal(e,t){var s;this.verifyNotClosed(),this.loaded&&(null===(s=this.channel)||void 0===s||s.processSignal(e,t))}getQuorum(){return this._containerRuntime.getQuorum()}getAudience(){return this._containerRuntime.getAudience()}async summarize(e=!1,t=!0,s){return this.summarizerNode.summarize(e,t,s)}async summarizeInternal(e,t,s){await this.realize();const i=await this.channel.summarize(e,t,s);let n;this.disableIsolatedChannels||(Object(p.n)(i),n=[l.channelsTreeName]);const{pkg:r}=await this.getInitialSnapshotDetails(),a=f(r,await this.isRoot(),this.disableIsolatedChannels);return Object(u.c)(i,p.d,JSON.stringify(a)),this.writeGCDataAtRoot||Object(u.c)(i,l.gcBlobKey,JSON.stringify(this.summarizerNode.getGCSummaryDetails())),this.summarizerNode.isReferenced()||(i.summary.unreferenced=!0,i.stats.unreferencedBlobSize=i.stats.totalBlobSize),Object.assign(Object.assign({},i),{id:this.id,pathPartsForChildren:n})}async getGCData(e=!1){return this.summarizerNode.getGCData(e)}async getGCDataInternal(e=!1){return await this.realize(),Object(r.a)(void 0!==this.channel,323),this.channel.getGCData(e)}updateUsedRoutes(e,t){this.summarizerNode.updateUsedRoutes(e,t),this.lastUsedState={usedRoutes:e,gcTimestamp:t},this.loaded&&this.updateChannelUsedRoutes()}addedGCOutboundReference(e,t){this._containerRuntime.addedGCOutboundReference(e,t)}updateChannelUsedRoutes(){if(Object(r.a)(this.loaded,324),Object(r.a)(void 0!==this.channel,325),void 0===this.lastUsedState)return;const e=this.lastUsedState.usedRoutes.filter(e=>"/"!==e&&""!==e);this.channel.updateUsedRoutes(e,this.lastUsedState.gcTimestamp)}async request(e){return(await this.realize()).request(e)}submitMessage(e,t,s){this.verifyNotClosed(),Object(r.a)(!!this.channel,326);const i={content:t,type:e};this._containerRuntime.submitDataStoreOp(this.id,i,s)}setChannelDirty(e){this.verifyNotClosed();const t=this.deltaManager.lastSequenceNumber;this.summarizerNode.invalidate(t);const s=this.summarizerNode.getChild(e);s&&s.invalidate(t)}submitSignal(e,t){return this.verifyNotClosed(),Object(r.a)(!!this.channel,327),this._containerRuntime.submitDataStoreSignal(this.id,e,t)}makeLocallyVisible(){Object(r.a)(void 0!==this.channel,719),this.makeLocallyVisibleFn()}bindRuntime(e){var t;if(this.channel)throw new Error("Runtime already bound");try{Object(r.a)(!this.detachedRuntimeCreation,328),Object(r.a)(void 0!==this.channelDeferred,329),Object(r.a)(void 0!==this.pkg,330);const t=this.pending;for(const s of t)e.process(s,!1,void 0);this.thresholdOpsCounter.send("ProcessPendingOps",t.length),this.pending=void 0,this.loaded=!0,this.channel=e,Object.freeze(this.pkg),this.updateChannelUsedRoutes(),this.channelDeferred.resolve(this.channel)}catch(s){null===(t=this.channelDeferred)||void 0===t||t.reject(s),this.logger.sendErrorEvent({eventName:"BindRuntimeError",fluidDataStoreId:{value:this.id,tag:"PackageData"}},s)}}async getAbsoluteUrl(e){if(this.attachState===i.a.Attached)return this._containerRuntime.getAbsoluteUrl(e)}setInMemoryRoot(){this._isInMemoryRoot=!0}reSubmit(e,t){Object(r.a)(!!this.channel,331);const s=e;this.channel.reSubmit(s.type,s.content,t)}rollback(e,t){if(!this.channel)throw new Error("Channel must exist when rolling back ops");if(!this.channel.rollback)throw new Error("Channel doesn't support rollback");const s=e;this.channel.rollback(s.type,s.content,t)}async applyStashedOp(e){this.channel||await this.realize(),Object(r.a)(!!this.channel,332);const t=e;return this.channel.applyStashedOp(t.content)}verifyNotClosed(){if(this._disposed)throw new Error("Context is closed")}getCreateChildSummarizerNodeFn(e,t){return(s,i,n)=>this.summarizerNode.createChild(s,e,t,{throwOnFailure:!0},i,n)}async uploadBlob(e){return this.containerRuntime.uploadBlob(e)}}v.pendingOpsCountThreshold=1e3;class S extends v{constructor(e){super(e,!0,i.b.Bound,!1,()=>{throw new Error("Already attached")}),this.initialSnapshotDetailsP=new a.b(async()=>{var e,t;let s,i=!0;if("string"==typeof this.initSnapshotValue){const t=(await this.storage.getVersions(this.initSnapshotValue,1))[0];s=null!==(e=await this.storage.getSnapshotTree(t))&&void 0!==e?e:void 0}else s=this.initSnapshotValue;const n=async e=>Object(o.a)(this.storage,e);if(s){const e=await this.summarizerNode.loadBaseSummary(s,n);s=e.baseSummary,this.pending=e.outstandingOps.concat(this.pending)}if(s&&void 0!==s.blobs[p.d]){const e=await n(s.blobs[p.d]);let a;a=Object(p.g)(e)<1?e.pkg.startsWith('["')&&e.pkg.endsWith('"]')?JSON.parse(e.pkg):[e.pkg]:JSON.parse(e.pkg),this.pkg=a,i=null===(t=e.isRootDataStore)||void 0===t||t,Object(p.j)(e)&&(s=s.trees[l.channelsTreeName],Object(r.a)(void 0!==s,510))}return{pkg:this.pkg,isRootDataStore:i,snapshot:s}}),this.initSnapshotValue=e.snapshotTree,this.baseGCDetailsP=new a.b(async()=>{var t;return null!==(t=await e.getBaseGCDetails())&&void 0!==t?t:{}})}async getInitialSnapshotDetails(){return this.initialSnapshotDetailsP}async getInitialGCSummaryDetails(){return this.getBaseGCDetails()}async getBaseGCDetails(){return this.baseGCDetailsP}generateAttachMessage(){throw new Error("Cannot attach remote store")}}class y extends v{constructor(e){super(e,void 0!==e.snapshotTree,e.snapshotTree?i.b.Bound:i.b.NotBound,!0,e.makeLocallyVisibleFn),this.snapshotTree=e.snapshotTree,!0===e.isRootDataStore&&this.setInMemoryRoot(),this.createProps=e.createProps,this.attachListeners()}attachListeners(){this.once("attaching",()=>{Object(r.a)(this.attachState===i.a.Detached,333),this._attachState=i.a.Attaching}),this.once("attached",()=>{Object(r.a)(this.attachState===i.a.Attaching,334),this._attachState=i.a.Attached})}generateAttachMessage(){Object(r.a)(void 0!==this.channel,335),Object(r.a)(void 0!==this.pkg,336);const e=this.channel.getAttachSummary();this.disableIsolatedChannels||Object(p.n)(e);const t=f(this.pkg,this.isInMemoryRoot(),this.disableIsolatedChannels);Object(u.c)(e,p.d,JSON.stringify(t));const s=Object(u.h)(e.summary);return{id:this.id,snapshot:s,type:this.pkg[this.pkg.length-1]}}async getInitialSnapshotDetails(){var e;let t,s=this.snapshotTree,i=!1;return void 0!==s&&(t=await Object(p.h)(this.storage,s),Object(p.j)(t)&&(s=s.trees[l.channelsTreeName],Object(r.a)(void 0!==s,511)),void 0===this.pkg&&(this.pkg=JSON.parse(t.pkg),(null===(e=t.isRootDataStore)||void 0===e||e)&&(i=!0,this.setInMemoryRoot()))),Object(r.a)(void 0!==this.pkg,338),{pkg:this.pkg,isRootDataStore:i,snapshot:s}}async getInitialGCSummaryDetails(){return{}}async getBaseGCDetails(){return{}}}class C extends y{constructor(e){super(e)}}class O extends y{constructor(e){super(e),this.detachedRuntimeCreation=!0}async attachRuntime(e,t){Object(r.a)(this.detachedRuntimeCreation,340),Object(r.a)(void 0===this.channelDeferred,341);const s=e.IFluidDataStoreFactory,i=await this.factoryFromPackagePath(this.pkg);Object(r.a)(i.factory===s,342),Object(r.a)(void 0===this.registry,343),this.registry=i.registry,this.detachedRuntimeCreation=!1,this.channelDeferred=new a.a,super.bindRuntime(t),await this.isRoot()&&(void 0!==t.makeVisibleAndAttachGraph?t.makeVisibleAndAttachGraph():t.bindToContext())}async getInitialSnapshotDetails(){if(this.detachedRuntimeCreation)throw new Error("Detached Fluid Data Store context can't be realized! Please attach runtime first!");return super.getInitialSnapshotDetails()}}},17987:function(e,t,s){"use strict";s.d(t,"e",(function(){return a})),s.d(t,"f",(function(){return o})),s.d(t,"d",(function(){return c})),s.d(t,"b",(function(){return l})),s.d(t,"c",(function(){return u})),s.d(t,"a",(function(){return h}));var i=s(17981),n=s(17988),r=s(17989);function a(e){const t=e.type===i.a.Handle?e.handleType:e.type;switch(t){case i.a.Blob:case i.a.Attachment:return n.a.File;case i.a.Tree:return n.a.Directory;default:Object(r.a)(t,"Unknown type: "+t)}}function o(e){const t=e.type===i.a.Handle?e.handleType:e.type;switch(t){case i.a.Blob:case i.a.Attachment:return"blob";case i.a.Tree:return"tree";default:Object(r.a)(t,"Unknown type: "+t)}}function c(e,t=new Map,s=!1){const i={},n={id:e.sha,blobs:{},trees:{}};i[""]=n;for(const r of e.tree){const e=s?r.path.replace(/^\.app\//,""):r.path,n=e.lastindexOf("/"),a=e.slice(0,Math.max(0,n)),o=e.slice(n+1),c=i[a];if("tree"===r.type){const t={id:r.sha,blobs:{},commits:{},trees:{}};c.trees[decodeURIComponent(o)]=t,i[e]=t}else{if("blob"!==r.type)throw new Error("Unknown entry type!!");c.blobs[decodeURIComponent(o)]=r.sha,t.set(r.sha,"/"+e)}}return n}class l{constructor(e,t,s="utf-8"){this.path=e,this.mode=n.a.File,this.type=n.b.Blob,this.value={contents:t,encoding:s}}}class u{constructor(e,t){this.path=e,this.value=t,this.mode=n.a.Directory,this.type=n.b.Tree}}class h{constructor(e,t){this.path=e,this.id=t,this.mode=n.a.File,this.type=n.b.Attachment,this.value={id:t}}}},17988:function(e,t,s){"use strict";var i,n;s.d(t,"a",(function(){return i})),s.d(t,"b",(function(){return n})),function(e){e.File="100644",e.Executable="100755",e.Directory="040000",e.Symlink="120000"}(i||(i={})),function(e){e.Blob="Blob",e.Tree="Tree",e.Attachment="Attachment"}(n||(n={}))},17989:function(e,t,s){"use strict";function i(e,t="Unreachable Case"){throw new Error(t)}s.d(t,"a",(function(){return i}))},17990:function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));class i{constructor(e,t,s=e){this.threshold=e,this.logger=t,this.thresholdMultiple=s}send(e,t){t<this.threshold||this.logger.sendPerformanceEvent({eventName:e,value:t})}sendIfMultiple(e,t){t===this.thresholdMultiple&&(this.logger.sendPerformanceEvent({eventName:e,value:t}),this.thresholdMultiple=2*this.thresholdMultiple)}}},17991:function(e,t,s){"use strict";s.d(t,"j",(function(){return l})),s.d(t,"f",(function(){return h})),s.d(t,"c",(function(){return d})),s.d(t,"e",(function(){return m})),s.d(t,"d",(function(){return g})),s.d(t,"a",(function(){return p})),s.d(t,"i",(function(){return f})),s.d(t,"g",(function(){return b})),s.d(t,"h",(function(){return v})),s.d(t,"b",(function(){return S}));var i=s(17983),n=s(17992),r=s(17989),a=s(17987),o=s(17981),c=s(17988);function l(...e){const t={treeNodeCount:0,blobNodeCount:0,handleNodeCount:0,totalBlobSize:0,unreferencedBlobSize:0};for(const s of e)t.treeNodeCount+=s.treeNodeCount,t.blobNodeCount+=s.blobNodeCount,t.handleNodeCount+=s.handleNodeCount,t.totalBlobSize+=s.totalBlobSize,t.unreferencedBlobSize+=s.unreferencedBlobSize;return t}function u(e){return"string"==typeof e?function(e){let t=e.length;for(let s=e.length-1;s>=0;s--){const i=e.charCodeAt(s);i>127&&i<=2047?t++:i>2047&&i<=65535&&(t+=2),i>=56320&&i<=57343&&s--}return t}(e):e.byteLength}function h(e){const t=l();return function e(t,s){switch(t.type){case o.a.Tree:s.treeNodeCount++;for(const i of Object.values(t.tree))e(i,s);return;case o.a.Handle:return void s.handleNodeCount++;case o.a.Blob:return s.blobNodeCount++,void(s.totalBlobSize+=u(t.content));default:return}}(e,t),t}function d(e,t,s){const i={type:o.a.Blob,content:s};e.summary.tree[t]=i,e.stats.blobNodeCount++,e.stats.totalBlobSize+=u(s)}function m(e,t,s){e.summary.tree[t]=s.summary,e.stats=l(e.stats,s.stats)}function g(e,t,s){e.summary.tree[t]=s.summary,e.stats=l(e.stats,s.stats)}class p{constructor(){this.attachmentCounter=0,this.summaryTree={},this.summaryStats=l(),this.summaryStats.treeNodeCount++}get summary(){return{type:o.a.Tree,tree:Object.assign({},this.summaryTree)}}get stats(){return Object.assign({},this.summaryStats)}addBlob(e,t){d({summary:{type:o.a.Tree,tree:this.summaryTree},stats:this.summaryStats},e,t)}addHandle(e,t,s){this.summaryTree[e]={type:o.a.Handle,handleType:t,handle:s},this.summaryStats.handleNodeCount++}addWithStats(e,t){this.summaryTree[e]=t.summary,this.summaryStats=l(this.summaryStats,t.stats)}addAttachment(e){this.summaryTree[this.attachmentCounter++]={id:e,type:o.a.Attachment}}getSummaryTree(){return{summary:this.summary,stats:this.stats}}}function f(e,t=!1){if(e.id&&!t){const t=l();return t.handleNodeCount++,{summary:{handle:e.id,handleType:o.a.Tree,type:o.a.Handle},stats:t}}return function(e,t=!1){const s=new p;for(const r of e.entries)switch(r.type){case c.b.Blob:{const e=r.value;let t;t="base64"===e.encoding?i.a.from(e.contents,"base64"):e.contents,s.addBlob(r.path,t);break}case c.b.Tree:{const e=f(r.value,t);s.addWithStats(r.path,e);break}case c.b.Attachment:{const e=r.value.id;s.addAttachment(e);break}default:throw new Error("Unexpected TreeEntry type")}const n=s.getSummaryTree();return n.summary.unreferenced=e.unreferenced,n}(e,t)}function b(e){const t=new p;for(const[r,a]of Object.entries(e.blobs)){let s;if(void 0!==e.blobsContents){const t=e.blobsContents[a];void 0!==t&&(s=Object(i.c)(t,"utf-8"))}else void 0!==e.blobs[a]&&(s=Object(n.a)(e.blobs[a]));void 0!==s&&t.addBlob(r,s)}for(const[i,n]of Object.entries(e.trees)){const e=b(n);t.addWithStats(i,e)}const s=t.getSummaryTree();return s.summary.unreferenced=e.unreferenced,s}function v(e){const t=[];for(const[s,n]of Object.entries(e.tree))switch(n.type){case o.a.Blob:{let e,r="utf-8";"string"==typeof n.content?e=n.content:(e=Object(i.b)(n.content,"base64"),r="base64"),t.push(new a.b(s,e,r));break}case o.a.Tree:t.push(new a.c(s,v(n)));break;case o.a.Attachment:t.push(new a.a(s,n.id));break;case o.a.Handle:throw new Error("Should not have Handle type in summary tree");default:Object(r.a)(n,"Unexpected summary tree type")}return{entries:t,unreferenced:e.unreferenced}}class S{constructor(){this.telemetry=new Map}set(e,t,s){this.telemetry.set(`${e}${t}`,s)}get(e,t){return this.telemetry.get(`${e}${t}`)}serialize(){const e={};return this.telemetry.forEach((t,s)=>{e[s]=t}),JSON.stringify(e)}}},17992:function(e,t,s){"use strict";s.d(t,"a",(function(){return n})),s.d(t,"b",(function(){return r}));var i=s(17983);const n=e=>i.a.from(e,"base64").toString("utf-8"),r=e=>i.a.from(e,"utf8").toString("base64")},17993:function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var i=s(17983),n=s(17940),r=s(17988),a=s(17987),o=s(17946);function c(e,t){return{sha:"",tree:function e(t,s,a){const c=[];for(const l of s){const s=`${t}${l.path}`;if(l.type===r.b.Blob){const e=l.value,t=Object(i.d)(e.contents,e.encoding),n=Object(o.a)();a.set(n,t);const u={mode:r.a[l.mode],path:s,sha:n,size:0,type:"blob",url:""};c.push(u)}else if(l.type===r.b.Tree){Object(n.a)(l.type===r.b.Tree,257);const t=l.value,i={mode:r.a[l.mode],path:s,sha:"",size:-1,type:"tree",url:""};c.push(i);const o=e(s+"/",t.entries,a);c.push(...o)}}return c}("",e,t),url:""}}function l(e,t){const s=c(e,t);return Object(a.d)(s)}},17994:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));var i=s(17995);class n extends i.a{constructor(e,t){super(e),this.blobs=t}get policies(){return this.internalStorageService.policies}async readBlob(e){const t=this.blobs.get(e);return void 0!==t?t:this.internalStorageService.readBlob(e)}}},17995:function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));class i{constructor(e){this.internalStorageService=e}set policies(e){this._policies=e}get policies(){var e;return null!==(e=this._policies)&&void 0!==e?e:this.internalStorageService.policies}get repositoryUrl(){return this.internalStorageService.repositoryUrl}async getSnapshotTree(e,t){return this.internalStorageService.getSnapshotTree(e,t)}async getVersions(e,t,s){return this.internalStorageService.getVersions(e,t,s)}async uploadSummaryWithContext(e,t){return this.internalStorageService.uploadSummaryWithContext(e,t)}async downloadSummary(e){return this.internalStorageService.downloadSummary(e)}async createBlob(e){return this.internalStorageService.createBlob(e)}async readBlob(e){return this.internalStorageService.readBlob(e)}}},17996:function(e,t,s){"use strict";s.d(t,"b",(function(){return c})),s.d(t,"a",(function(){return l}));var i=s(17940),n=s(17989),r=s(17959),a=s(17957),o=s(17944);const c=e=>"string"==typeof(null==e?void 0:e.internalId)&&"string"==typeof(null==e?void 0:e.alias),l=(e,t,s,i,n)=>new h(e,t,s,i,n);var u;!function(e){e.Aliased="Aliased",e.Aliasing="Aliasing",e.None="None"}(u||(u={}));class h{constructor(e,t,s,i,n){this.fluidDataStoreChannel=e,this.internalId=t,this.runtime=s,this.datastores=i,this.logger=n,this.aliasState=u.None}async trySetAlias(e){if(e.includes("/"))throw new a.f(`The alias cannot contain slashes: '${e}'`);switch(this.aliasState){case u.Aliasing:return Object(i.a)(void 0!==this.aliasResult,790),await this.aliasResult,this.alias===e?"Success":"AlreadyAliased";case u.Aliased:return this.alias===e?"Success":"AlreadyAliased";case u.None:break;default:Object(n.a)(this.aliasState)}return this.aliasState=u.Aliasing,this.aliasResult=this.trySetAliasInternal(e),this.aliasResult}async trySetAliasInternal(e){const t={internalId:this.internalId,alias:e};if(void 0!==this.fluidDataStoreChannel.makeVisibleAndAttachGraph?this.fluidDataStoreChannel.makeVisibleAndAttachGraph():this.fluidDataStoreChannel.bindToContext(),this.runtime.attachState===r.a.Detached){const e=this.datastores.processAliasMessageCore(t);return this.aliasState=u.Aliased,e?"Success":"Conflict"}return await this.ackBasedPromise(e=>{this.runtime.submitDataStoreAliasOp(t,e)}).then(t=>(this.aliasState=u.Aliased,t&&(this.alias=e),t)).catch(t=>(this.logger.sendErrorEvent({eventName:"AliasingException",alias:{value:e,tag:o.e.UserData},internalId:{value:this.internalId,tag:o.e.PackageData}},t),this.aliasState=u.None,!1))?"Success":"Conflict"}async request(e){return this.fluidDataStoreChannel.request(e)}get IFluidRouter(){return this.fluidDataStoreChannel}async ackBasedPromise(e){let t;return new Promise((s,i)=>{t=()=>i(new Error("ContainerRuntime disposed while this ack-based Promise was pending")),this.runtime.disposed?t():(this.runtime.on("dispose",t),e(s,i))}).finally(()=>{this.runtime.off("dispose",t)})}}},17997:function(e,t,s){"use strict";s.d(t,"c",(function(){return r})),s.d(t,"e",(function(){return a})),s.d(t,"d",(function(){return o})),s.d(t,"a",(function(){return c})),s.d(t,"b",(function(){return l}));var i=s(17940),n=s(17945);function r(e){if(null!==e&&"object"==typeof e&&!0===e.errorFromRequestFluidObject){const t=e;return{mimeType:"text/plain",status:t.code,value:t.message,get stack(){return t.stack}}}const t=Object(n.c)();return{mimeType:"text/plain",status:500,value:""+e,get stack(){var s;return null!==(s=null==e?void 0:e.stack)&&void 0!==s?s:t.stack}}}function a(e,t){const s=e.value,i=Object(n.c)();return{errorFromRequestFluidObject:!0,message:s,name:"Error",code:e.status,get stack(){var t;return null!==(t=e.stack)&&void 0!==t?t:i.stack}}}async function o(e,t){const s="string"==typeof t?{url:t}:t,n=await e.request(s);if(200!==n.status||"fluid/object"!==n.mimeType)throw a(n);return Object(i.a)(n.value,410),n.value}const c=e=>l(404,"not found",e);function l(e,t,s){var r;Object(i.a)(200!==e,411);const a=null===(r=s.url)||void 0===r?void 0:r.split("?")[0],o=Object(n.c)();return{mimeType:"text/plain",status:e,value:void 0===a?t:`${t}: ${a}`,get stack(){return o.stack}}}},17998:function(e,t,s){"use strict";s.d(t,"f",(function(){return n})),s.d(t,"b",(function(){return a})),s.d(t,"g",(function(){return o})),s.d(t,"h",(function(){return c})),s.d(t,"e",(function(){return l})),s.d(t,"d",(function(){return u})),s.d(t,"c",(function(){return h})),s.d(t,"a",(function(){return d}));var i=s(17940);function n(e){return e.replace(/^\/+|\/+$/g,"")}function r(e){return e.replace(/\/+$/g,"")}function a(e){const t={};for(const[s,i]of Object.entries(e.gcNodes))t[s]=Array.from(i);return{gcNodes:t}}function o(e){const t=new Map;if(void 0===e.gcData)return t;const s=e.gcData.gcNodes;delete s["/"];for(const[r,a]of Object.entries(s)){Object(i.a)(r.startsWith("/"),686);const e=r.split("/")[1];let s=r.slice(e.length+1);""===s&&(s="/");let n=t.get(e);void 0===n&&(n={gcData:{gcNodes:{}},usedRoutes:[]}),Object(i.a)(void 0!==n.gcData,687),n.gcData.gcNodes[s]=[...new Set(a)],t.set(e,n)}if(void 0===e.usedRoutes)return t;const n=e.usedRoutes.filter(e=>""!==e&&"/"!==e);for(const r of n){Object(i.a)(r.startsWith("/"),688);const e=r.split("/")[1],s=r.slice(e.length+1),n=t.get(e);Object(i.a)(void 0!==(null==n?void 0:n.usedRoutes),689),n.usedRoutes.push(s),t.set(e,n)}return t}function c(e){const t=e.filter(e=>""!==e&&"/"!==e),s=new Map;for(const n of t){Object(i.a)(n.startsWith("/"),408);const e=n.split("/")[1],t=n.slice(e.length+1),r=s.get(e);void 0!==r?r.push(t):s.set(e,[t])}return s}function l(e,t){const s=Object.entries(e);for(const[i,n]of s){const s=new Set(n);s.delete(t),e[i]=[...s]}}function u(e,t){var s;const n={};for(const[i,r]of Object.entries(e.gcNodes))n[i]={outboundRoutes:Array.from(r.outboundRoutes),unreferencedTimestampMs:r.unreferencedTimestampMs};for(const[r,a]of Object.entries(t.gcNodes)){let e=n[r];void 0===e?e={outboundRoutes:Array.from(a.outboundRoutes),unreferencedTimestampMs:a.unreferencedTimestampMs}:(void 0!==a.unreferencedTimestampMs&&void 0!==e.unreferencedTimestampMs&&Object(i.a)(a.unreferencedTimestampMs===e.unreferencedTimestampMs,690),e={outboundRoutes:[...new Set([...a.outboundRoutes,...e.outboundRoutes])],unreferencedTimestampMs:null!==(s=a.unreferencedTimestampMs)&&void 0!==s?s:e.unreferencedTimestampMs}),n[r]=e}return{gcNodes:n}}function h(e,t){const s=a(e);for(const[i,n]of Object.entries(t.gcNodes))if(void 0===s.gcNodes[i])s.gcNodes[i]=Array.from(n);else{const e=[...n,...s.gcNodes[i]];s.gcNodes[i]=[...new Set(e)]}return s}class d{constructor(){this.gcNodesSet={}}get gcNodes(){const e={};for(const[t,s]of Object.entries(this.gcNodesSet))e[t]=[...s];return e}addNode(e,t){this.gcNodesSet[e]=new Set(t)}prefixAndAddNodes(e,t){for(const[s,i]of Object.entries(t)){let t=s.replace(/^\/+/g,"");t=`/${e}/${t}`,t=r(t),this.gcNodesSet[t]=new Set(i)}}addNodes(e){for(const[t,s]of Object.entries(e))this.gcNodesSet[t]=new Set(s)}addRouteToAllNodes(e){for(const t of Object.values(this.gcNodesSet))t.add(e)}getGCData(){return{gcNodes:this.gcNodes}}}},17999:function(e,t,s){"use strict";function i(e,t){const s=new Set,i=[...t];for(const a of i){if(s.has(a))continue;s.add(a);const t=e[a];void 0!==t&&i.push(...t)}const n=[],r=[];for(const a of Object.keys(e))s.has(a)?n.push(a):r.push(a);return{referencedNodeIds:n,deletedNodeIds:r}}s.d(t,"a",(function(){return i}))},18e3:function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var i=s(17979),n=s(17940),r=s(17998),a=s(17963),o=s(18002),c=s(18001);class l extends c.b{constructor(e,t){super(t),this.serializedUsedRoutes=e}}class u extends o.a{constructor(e,t,s,n,r,a,o,c,l){super(e,async(e,s,i)=>t(e,!0,i),s,n,r,a,o),this.summarizeFn=t,this.getGCDataFn=c,this.baseGCDetailsLoaded=!1,this.usedRoutes=[""],this.gcDisabled=!0===s.gcDisabled,this.baseGCDetailsP=new i.b(async()=>{var e;return null!==(e=await(null==l?void 0:l()))&&void 0!==e?e:{usedRoutes:[]}})}getGCSummaryDetails(){return this.getBaseGCDetails()}getBaseGCDetails(){return{gcData:this.gcData,usedRoutes:this.usedRoutes,unrefTimestamp:this.unreferencedTimestampMs}}async loadBaseGCDetails(){var e;const t=await this.baseGCDetailsP;this.baseGCDetailsLoaded||(this.baseGCDetailsLoaded=!0,void 0!==t.gcData&&(this.gcData=Object(r.b)(t.gcData)),this.referenceUsedRoutes=null===(e=t.usedRoutes)||void 0===e?void 0:e.sort(),this.unreferencedTimestampMs=t.unrefTimestamp)}async summarize(e,t=!0,s){return!this.gcDisabled&&this.isTrackingInProgress()&&Object(n.a)(void 0!==this.wipSerializedUsedRoutes,433),t?super.summarize(e,!0,s):this.summarizeFn(e,t,s)}async getGCData(e=!1){if(Object(n.a)(!this.gcDisabled,434),Object(n.a)(void 0!==this.getGCDataFn,435),await this.loadBaseGCDetails(),!e&&!this.hasDataChanged()&&void 0!==this.gcData)return Object(r.b)(this.gcData);const t=await this.getGCDataFn(e);return this.gcData=Object(r.b)(t),t}startSummary(e,t){this.gcDisabled||Object(n.a)(void 0===this.wipSerializedUsedRoutes,436),super.startSummary(e,t)}completeSummaryCore(e,t,s){let i;if(this.gcDisabled||(i=this.wipSerializedUsedRoutes,Object(n.a)(void 0!==i,437)),super.completeSummaryCore(e,t,s),!this.gcDisabled){const t=this.pendingSummaries.get(e);if(void 0!==t){const s=new l(i,t);this.pendingSummaries.set(e,s)}}}clearSummary(){this.wipSerializedUsedRoutes=void 0,super.clearSummary()}refreshLatestSummaryFromPending(e,t){if(!this.gcDisabled){const t=this.pendingSummaries.get(e);void 0!==t&&(this.referenceUsedRoutes=JSON.parse(t.serializedUsedRoutes))}return super.refreshLatestSummaryFromPending(e,t)}async refreshLatestSummaryFromSnapshot(e,t,s,i,n,r){if(!this.gcDisabled){const s=t.blobs[a.gcBlobKey];if(void 0!==s){const t=await r(s);if(this.referenceSequenceNumber>=e)return;this.referenceUsedRoutes=t.usedRoutes}}return super.refreshLatestSummaryFromSnapshot(e,t,s,i,n,r)}createChild(e,t,s,i={},r,a){var o;Object(n.a)(!this.children.has(t),438);const c=this.getCreateDetailsForChild(t,s),l=new u(this.defaultLogger,e,Object.assign(Object.assign({},i),{gcDisabled:null!==(o=i.gcDisabled)&&void 0!==o?o:this.gcDisabled}),c.changeSequenceNumber,c.latestSummary,c.initialSummary,this.wipSummaryLogger,r,a);return this.maybeUpdateChildState(l),this.children.set(t,l),l}deleteChild(e){this.children.delete(e)}getChild(e){return this.children.get(e)}isReferenced(){return this.usedRoutes.includes("")||this.usedRoutes.includes("/")}updateUsedRoutes(e,t){this.usedRoutes=e.sort(),!this.gcDisabled&&this.isTrackingInProgress()&&(this.wipSerializedUsedRoutes=JSON.stringify(this.usedRoutes)),this.isReferenced()?this.unreferencedTimestampMs=void 0:void 0===this.unreferencedTimestampMs&&(this.unreferencedTimestampMs=t)}hasChanged(){return this.hasDataChanged()||this.hasUsedStateChanged()}hasDataChanged(){return super.hasChanged()}hasUsedStateChanged(){return!this.gcDisabled&&(void 0===this.referenceUsedRoutes||JSON.stringify(this.usedRoutes)!==JSON.stringify(this.referenceUsedRoutes))}}const h=(e,t,s,i,n={},r,a)=>new u(e,t,n,s,void 0===i?void 0:c.b.createForRoot(i),void 0,void 0,r,a)},18001:function(e,t,s){"use strict";s.d(t,"a",(function(){return o})),s.d(t,"b",(function(){return c})),s.d(t,"c",(function(){return l})),s.d(t,"d",(function(){return u})),s.d(t,"e",(function(){return h})),s.d(t,"f",(function(){return d}));var i=s(17940),n=s(17981),r=s(17963),a=s(17991);class o{constructor(e){this.path=e}static create(e){return new o(encodeURIComponent(e))}static createAndConcat(e){var t;let s=o.create(null!==(t=e[0])&&void 0!==t?t:"");for(let i=1;i<e.length;i++)s=s.concat(o.create(e[i]));return s}toString(){return this.path}concat(e){return new o(`${this.path}/${e.path}`)}}class c{constructor(e){this.summary=e}static createForRoot(e){return new c({referenceSequenceNumber:e,basePath:void 0,localPath:o.create("")})}get referenceSequenceNumber(){return this.summary.referenceSequenceNumber}get basePath(){return this.summary.basePath}get localPath(){return this.summary.localPath}get additionalPath(){return this.summary.additionalPath}set additionalPath(e){this.summary.additionalPath=e}get fullPath(){var e,t;return null!==(t=null===(e=this.basePath)||void 0===e?void 0:e.concat(this.localPath))&&void 0!==t?t:this.localPath}get fullPathForChildren(){return void 0!==this.additionalPath?this.fullPath.concat(this.additionalPath):this.fullPath}createForChild(e){return new c({referenceSequenceNumber:this.referenceSequenceNumber,basePath:this.fullPathForChildren,localPath:o.create(e)})}}function l(e,t){let s=e;const n=[],r=[];for(let a=0;;a++){a>100&&t.sendTelemetryEvent({eventName:"DecodeSummaryMaxDepth",maxDecodeDepth:100});const e=s.blobs._outstandingOps,o=s.trees._baseSummary;if(void 0===e&&void 0===o)return{baseSummary:s,pathParts:n,async getOutstandingOps(e){let s=[];for(const i of r){const n=await e(i);if(s.length>0&&n.length>0){const e=s[s.length-1].sequenceNumber,i=n[0].sequenceNumber;if(i<=e)for(t.sendTelemetryEvent({eventName:"DuplicateOutstandingOps",message:`newEarliestSeq <= latestSeq in decodeSummary: ${i} <= ${e}`});n.length>0&&n[0].sequenceNumber<=e;)n.shift()}s=s.concat(n)}return s}};Object(i.a)(!!e,431),Object(i.a)(void 0!==o,432),s=o,n.push("_baseSummary"),r.unshift(e)}}function u(e,t){let s=o.create("_baseSummary");const i=new a.a;if(i.addBlob("_outstandingOps",JSON.stringify(t)),e.fromSummary){const t=e.summaryNode;void 0!==t.additionalPath&&(s=s.concat(t.additionalPath)),i.addHandle("_baseSummary",n.a.Tree,t.fullPath.path)}else i.addWithStats("_baseSummary",e.initialSummary);const r=i.getSummaryTree();return Object.assign(Object.assign({},r),{additionalPath:s})}function h(e){const t=e.trees[r.channelsTreeName];return void 0!==t?{childrenTree:t,childrenPathPart:r.channelsTreeName}:{childrenTree:e,childrenPathPart:void 0}}function d(e){const t=e.tree[r.channelsTreeName];return void 0!==t?{childrenTree:t,childrenPathPart:r.channelsTreeName}:{childrenTree:e,childrenPathPart:void 0}}},18002:function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var i=s(17963),n=s(17981),r=s(17940),a=s(17989),o=s(17991),c=s(18001);class l{constructor(e,t,s,i,n,r,a){var o;this.defaultLogger=e,this.summarizeInternalFn=t,this._changeSequenceNumber=i,this._latestSummary=n,this.initialSummary=r,this.wipSummaryLogger=a,this.children=new Map,this.pendingSummaries=new Map,this.outstandingOps=[],this.wipSkipRecursion=!1,this.canReuseHandle=null===(o=s.canReuseHandle)||void 0===o||o,this.throwOnError=!0,this.trackingSequenceNumber=this._changeSequenceNumber}get referenceSequenceNumber(){var e,t;return null!==(t=null===(e=this._latestSummary)||void 0===e?void 0:e.referenceSequenceNumber)&&void 0!==t?t:0}startSummary(e,t){Object(r.a)(void 0===this.wipSummaryLogger,415),Object(r.a)(void 0===this.wipReferenceSequenceNumber,416),this.wipSummaryLogger=t;for(const s of this.children.values())s.startSummary(e,this.wipSummaryLogger);this.wipReferenceSequenceNumber=e}async summarize(e,t=!0,s){if(Object(r.a)(this.isTrackingInProgress(),417),Object(r.a)(void 0!==this.wipSummaryLogger,418),this.canReuseHandle&&!e&&!this.hasChanged()){const e=this._latestSummary;if(void 0!==e){this.wipLocalPaths={localPath:e.localPath,additionalPath:e.additionalPath},this.wipSkipRecursion=!0;const t=Object(o.j)();return t.handleNodeCount++,{summary:{type:n.a.Handle,handle:e.fullPath.path,handleType:n.a.Tree},stats:t}}}try{const t=await this.summarizeInternalFn(e,!0,s);return this.wipLocalPaths={localPath:c.a.create(t.id)},void 0!==t.pathPartsForChildren&&(this.wipLocalPaths.additionalPath=c.a.createAndConcat(t.pathPartsForChildren)),{summary:t.summary,stats:t.stats}}catch(i){if(this.throwOnError||this.trackingSequenceNumber<this._changeSequenceNumber)throw i;const e=this._latestSummary,t=this.initialSummary;let s,n;if(void 0!==e)s={fromSummary:!0,summaryNode:e},n=e.localPath;else{if(void 0===(null==t?void 0:t.summary))throw i;s={fromSummary:!1,initialSummary:t.summary},n=c.a.create(t.id)}this.wipSummaryLogger.sendErrorEvent({eventName:"SummarizingWithBasePlusOps"},i);const r=Object(c.d)(s,this.outstandingOps);return this.wipLocalPaths={localPath:n,additionalPath:r.additionalPath},this.wipSkipRecursion=!0,{summary:r.summary,stats:r.stats}}}completeSummary(e){this.completeSummaryCore(e,void 0,!1)}completeSummaryCore(e,t,s){Object(r.a)(void 0!==this.wipSummaryLogger,419),Object(r.a)(void 0!==this.wipReferenceSequenceNumber,420);let i=this.wipLocalPaths;if(s){const e=this._latestSummary;if(void 0===e)return void this.clearSummary();i={localPath:e.localPath,additionalPath:e.additionalPath}}Object(r.a)(!!i,421);const n=new c.b(Object.assign(Object.assign({},i),{referenceSequenceNumber:this.wipReferenceSequenceNumber,basePath:t})),a=n.fullPathForChildren;for(const r of this.children.values())r.completeSummaryCore(e,a,this.wipSkipRecursion||s);this.pendingSummaries.set(e,n),this.clearSummary()}clearSummary(){this.wipReferenceSequenceNumber=void 0,this.wipLocalPaths=void 0,this.wipSkipRecursion=!1,this.wipSummaryLogger=void 0;for(const e of this.children.values())e.clearSummary()}async refreshLatestSummary(e,t,s,i,n){if(void 0!==e){const t=this.pendingSummaries.get(e);if(void 0!==t)return this.refreshLatestSummaryFromPending(e,t.referenceSequenceNumber),{latestSummaryUpdated:!0,wasSummaryTracked:!0}}if(this.referenceSequenceNumber>=t)return{latestSummaryUpdated:!1};const r=await s();return await this.refreshLatestSummaryFromSnapshot(t,r,void 0,c.a.create(""),n,i),{latestSummaryUpdated:!0,wasSummaryTracked:!1,snapshot:r}}refreshLatestSummaryFromPending(e,t){const s=this.pendingSummaries.get(e);if(void 0!==s){Object(r.a)(t===s.referenceSequenceNumber,423),this.pendingSummaries.delete(e),this.refreshLatestSummaryCore(t),this._latestSummary=s;for(const s of this.children.values())s.refreshLatestSummaryFromPending(e,t)}else Object(r.a)(void 0===this._latestSummary,422)}async refreshLatestSummaryFromSnapshot(e,t,s,i,n,r){if(this.referenceSequenceNumber>=e)return;this.refreshLatestSummaryCore(e);const{baseSummary:a,pathParts:o}=Object(c.c)(t,n);this._latestSummary=new c.b({referenceSequenceNumber:e,basePath:s,localPath:i});const{childrenTree:l,childrenPathPart:u}=Object(c.e)(a);void 0!==u&&o.push(u),o.length>0&&(this._latestSummary.additionalPath=c.a.createAndConcat(o));const h=this._latestSummary.fullPathForChildren;await Promise.all(Array.from(this.children).filter(([e])=>void 0!==l.trees[e]).map(async([t,s])=>s.refreshLatestSummaryFromSnapshot(e,l.trees[t],h,c.a.create(t),n,r)))}refreshLatestSummaryCore(e){for(const[t,s]of this.pendingSummaries)s.referenceSequenceNumber<e&&this.pendingSummaries.delete(t);for(;this.outstandingOps.length>0&&this.outstandingOps[0].sequenceNumber<=e;)this.outstandingOps.shift()}loadBaseSummaryWithoutDifferential(e){const{childrenPathPart:t}=Object(c.e)(e);void 0!==t&&void 0!==this._latestSummary&&(this._latestSummary.additionalPath=c.a.create(t))}async loadBaseSummary(e,t){const s=Object(c.c)(e,this.defaultLogger),i=await s.getOutstandingOps(t),{childrenPathPart:n}=Object(c.e)(s.baseSummary);if(void 0!==n&&s.pathParts.push(n),s.pathParts.length>0&&void 0!==this._latestSummary&&(this._latestSummary.additionalPath=c.a.createAndConcat(s.pathParts)),i.length>0){const e=i[i.length-1].sequenceNumber;Object(r.a)(e<=this.trackingSequenceNumber,425)}return{baseSummary:s.baseSummary,outstandingOps:i}}recordChange(e){const t=this.outstandingOps[this.outstandingOps.length-1];void 0!==t&&Object(r.a)(t.sequenceNumber<e.sequenceNumber,426),this.invalidate(e.sequenceNumber),this.trackingSequenceNumber=e.sequenceNumber,this.outstandingOps.push(e)}invalidate(e){e>this._changeSequenceNumber&&(this._changeSequenceNumber=e)}hasChanged(){return this._changeSequenceNumber>this.referenceSequenceNumber}get latestSummary(){return this._latestSummary}createChild(e,t,s,i={}){Object(r.a)(!this.children.has(t),427);const n=this.getCreateDetailsForChild(t,s),a=new l(this.defaultLogger,e,i,n.changeSequenceNumber,n.latestSummary,n.initialSummary,this.wipSummaryLogger);return this.maybeUpdateChildState(a),this.children.set(t,a),a}getChild(e){return this.children.get(e)}getCreateDetailsForChild(e,t){var s;let l,u,h;const d=this._latestSummary;switch(t.type){case i.CreateSummarizerNodeSource.FromAttach:if(void 0!==d&&t.sequenceNumber<=d.referenceSequenceNumber)u=d.createForChild(e);else{const s=Object(o.i)(t.snapshot);l={sequenceNumber:t.sequenceNumber,id:e,summary:s}}h=t.sequenceNumber;break;case i.CreateSummarizerNodeSource.FromSummary:void 0===this.initialSummary&&Object(r.a)(!!d,428);case i.CreateSummarizerNodeSource.Local:{const a=this.initialSummary;if(void 0!==a){let s,u;if(void 0!==a.summary){const{childrenTree:t}=Object(c.f)(a.summary.summary);Object(r.a)(t.type===n.a.Tree,470),s=t.tree[e]}t.type===i.CreateSummarizerNodeSource.FromSummary&&Object(r.a)(!!s,429),void 0!==s&&(Object(r.a)(s.type===n.a.Tree,430),u={summary:s,stats:Object(o.f)(s)}),l={sequenceNumber:a.sequenceNumber,id:e,summary:u}}u=null==d?void 0:d.createForChild(e),h=null!==(s=null==d?void 0:d.referenceSequenceNumber)&&void 0!==s?s:-1;break}default:{const e=t.type;Object(a.a)(t,"Unexpected CreateSummarizerNodeSource: "+e)}}return{initialSummary:l,latestSummary:u,changeSequenceNumber:h}}maybeUpdateChildState(e){if(this.isTrackingInProgress()&&(e.wipReferenceSequenceNumber=this.wipReferenceSequenceNumber),void 0!==e._latestSummary)for(const[t,s]of this.pendingSummaries.entries()){const i=new c.b({referenceSequenceNumber:s.referenceSequenceNumber,basePath:e._latestSummary.basePath,localPath:e._latestSummary.localPath});e.addPendingSummary(t,i)}}addPendingSummary(e,t){this.pendingSummaries.set(e,t)}isTrackingInProgress(){return void 0!==this.wipReferenceSequenceNumber}}},18003:function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var i=s(17943),n=s(17991),r=s(17940),a=s(17979),o=s(17959),c=s(17944);class l{constructor(e,t,s){this.path=e,this.routeContext=t,this.get=s,this.attached=!1,this.absolutePath=Object(i.a)(e,this.routeContext)}get IFluidHandle(){return this}get isAttached(){return this.attached}attachGraph(){this.attached=!0}bind(e){throw new Error("Cannot bind to blob handle")}}class u{constructor(e,t,s,i,n,r,a){this.routeContext=e,this.getStorage=s,this.attachBlobCallback=i,this.gcNodeUpdated=n,this.runtime=r,this.logger=a,this.blobIds=new Set,this.pendingBlobIds=new Map,this.detachedBlobIds=new Set,this.runtime.once("dispose",()=>{for(const e of this.pendingBlobIds.values())e.reject(new Error("runtime disposed while blobAttach op in flight"))}),this.load(t)}hasBlob(e){return this.blobIds.has(e)||this.detachedBlobIds.has(e)}getBlobGCNodePath(e){return`/${u.basePath}/${e}`}async getBlob(e){var t,s;const i=null!==(s=null===(t=this.redirectTable)||void 0===t?void 0:t.get(e))&&void 0!==s?s:e;return Object(r.a)(this.hasBlob(i),287),this.gcNodeUpdated(this.getBlobGCNodePath(e)),new l(`${u.basePath}/${i}`,this.routeContext,async()=>c.c.timedExecAsync(this.logger,{eventName:"AttachmentReadBlob",id:i},async()=>this.getStorage().readBlob(i),{end:!0,cancel:"error"}))}async createBlob(e){var t,s;this.runtime.attachState===o.a.Attaching&&(this.logger.sendTelemetryEvent({eventName:"CreateBlobWhileAttaching"}),await new Promise(e=>this.runtime.once("attached",e))),this.runtime.connected||this.runtime.attachState!==o.a.Attached||await new Promise(e=>this.runtime.once("connected",e));const i=await c.c.timedExecAsync(this.logger,{eventName:"createBlob"},async()=>this.getStorage().createBlob(e),{end:!0,cancel:"error"}),n=new l(`${u.basePath}/${i.id}`,this.routeContext,async()=>this.getBlob(i.id).then(async e=>e.get()));return this.runtime.attachState===o.a.Detached?(this.detachedBlobIds.add(i.id),n):(this.pendingBlobIds.has(i.id)?await(null===(t=this.pendingBlobIds.get(i.id))||void 0===t?void 0:t.promise):this.blobIds.has(i.id)||(this.pendingBlobIds.set(i.id,new a.a),this.attachBlobCallback(i.id),await(null===(s=this.pendingBlobIds.get(i.id))||void 0===s?void 0:s.promise)),n)}processBlobAttachOp(e,t){if(t){const t=this.pendingBlobIds.get(e);Object(r.a)(void 0!==t,504),t.resolve(),this.pendingBlobIds.delete(e)}this.blobIds.add(e)}static async load(e,t){if(!e)return{};let s;const i=e.blobs[this.redirectTableBlobName];i&&(s=await t(i));return{ids:Object.entries(e.blobs).filter(([e,t])=>e!==this.redirectTableBlobName).map(([e,t])=>t),redirectTable:s}}load(e){var t,s,i;if(e.ids){const t=this.runtime.attachState===o.a.Detached;e.ids.map(e=>t?this.detachedBlobIds.add(e):this.blobIds.add(e))}e.redirectTable&&(this.redirectTable=new Map(e.redirectTable)),this.logger.sendTelemetryEvent({eventName:"AttachmentBlobsLoaded",count:null!==(s=null===(t=e.ids)||void 0===t?void 0:t.length)&&void 0!==s?s:0,redirectTable:null===(i=e.redirectTable)||void 0===i?void 0:i.length})}getGCData(e=!1){const t={gcNodes:{}};if(this.blobIds.forEach(e=>{t.gcNodes[this.getBlobGCNodePath(e)]=[]}),void 0!==this.redirectTable)for(const[s,i]of this.redirectTable)t.gcNodes[this.getBlobGCNodePath(s)]=[this.getBlobGCNodePath(i)];return t}deleteUnusedRoutes(e){var t;for(const s of e){const e=s.split("/");Object(r.a)(3===e.length&&e[1]===u.basePath,725);const i=e[2];(null===(t=this.redirectTable)||void 0===t?void 0:t.has(i))?this.redirectTable.delete(i):this.blobIds.delete(i)}}summarize(e){const t=!!this.redirectTable||this.runtime.attachState!==o.a.Detached?this.blobIds:this.detachedBlobIds,s=new n.a;return t.forEach(e=>{s.addAttachment(e)}),this.redirectTable&&this.redirectTable.size>0&&s.addBlob(u.redirectTableBlobName,JSON.stringify(Array.from(this.redirectTable.entries()))),s.getSummaryTree()}setRedirectTable(e){Object(r.a)(this.runtime.attachState===o.a.Detached,594),Object(r.a)(!this.redirectTable,595);for(const[t,s]of e)Object(r.a)(this.detachedBlobIds.delete(t),596),this.blobIds.add(s);Object(r.a)(0===this.detachedBlobIds.size,597),this.redirectTable=e}}u.basePath="_blobs",u.redirectTableBlobName=".redirectTable"},18004:function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var i=s(17953),n=s(17940),r=s(17957),a=s(17963),o=s(17945),c=s(18005),l=s.n(c);class u{constructor(e,t,s){var n;this.stateHandler=e,this.pendingStates=new l.a,this.disposeOnce=new i.a(()=>{this.initialStates.clear(),this.pendingStates.clear()}),this._pendingMessagesCount=0,this.isProcessingBatch=!1,this.dispose=()=>this.disposeOnce.value,this.initialStates=new l.a(null!==(n=null==s?void 0:s.pendingStates)&&void 0!==n?n:[]),this.flushModeForNextMessage=t,this.onFlushModeUpdated(t)}get pendingMessagesCount(){return this._pendingMessagesCount}hasPendingMessages(){return 0!==this._pendingMessagesCount||!this.initialStates.isEmpty()}getLocalState(){if(Object(n.a)(this.initialStates.isEmpty(),745),this.hasPendingMessages())return{pendingStates:this.pendingStates.toArray().map(e=>"message"===e.type?Object.assign(Object.assign({},e),{localOpMetadata:void 0}):e)}}get disposed(){return this.disposeOnce.evaluated}onSubmitMessage(e,t,s,i,n,r){const a={type:"message",messageType:e,clientSequenceNumber:t,referenceSequenceNumber:s,content:i,localOpMetadata:n,opMetadata:r};this.pendingStates.push(a),this._pendingMessagesCount++}onFlushModeUpdated(e){this.pendingStates.push({type:"flushMode",flushMode:e})}onFlush(){if(this.stateHandler.flushMode()===a.FlushMode.Immediate)return;const e=this.pendingStates.peekBack();"message"===(null==e?void 0:e.type)&&this.pendingStates.push({type:"flush"})}async applyStashedOpsAt(e){for(;!this.initialStates.isEmpty();){const t=this.initialStates.peekFront();if("message"===t.type){if(void 0!==e){if(t.referenceSequenceNumber>e)break;if(t.referenceSequenceNumber<e)throw new Error("loaded from snapshot too recent to apply stashed ops")}const s=await this.stateHandler.applyStashedOp(t.messageType,t.content);t.localOpMetadata=s}this.pendingStates.push(this.initialStates.shift())}}processPendingLocalMessage(e){this.maybeProcessBatchBegin(e);const t=this.peekNextPendingState();if(Object(n.a)("message"===t.type,361),this.pendingStates.shift(),t.clientSequenceNumber===e.clientSequenceNumber)return this._pendingMessagesCount--,this.maybeProcessBatchEnd(e),t.localOpMetadata;{const s=r.c.create("pending local message clientSequenceNumber mismatch","unexpectedAckReceived",e,{expectedClientSequenceNumber:t.clientSequenceNumber});this.stateHandler.close(s)}}maybeProcessBatchBegin(e){let t,s=!1,i=this.peekNextPendingState();for(;"message"!==i.type;)"flushMode"===i.type&&(t=i.flushMode),"flush"===i.type&&(s=!0),this.pendingStates.shift(),i=this.peekNextPendingState();void 0!==t&&(this.flushModeForNextMessage=t),t!==a.FlushMode.Immediate&&(t===a.FlushMode.TurnBased||s)&&(Object(n.a)(!this.isProcessingBatch&&void 0===this.pendingBatchBeginMessage,363),this.pendingBatchBeginMessage=e,this.isProcessingBatch=!0)}maybeProcessBatchEnd(e){var t,s;if(!this.isProcessingBatch)return;const i=this.peekNextPendingState();if("message"===i.type)return;Object(n.a)("flushMode"!==i.type,701),Object(n.a)(void 0!==this.pendingBatchBeginMessage,365);const r=null===(t=this.pendingBatchBeginMessage.metadata)||void 0===t?void 0:t.batch;if(this.pendingBatchBeginMessage===e)Object(n.a)(void 0===r,366);else{const t=null===(s=e.metadata)||void 0===s?void 0:s.batch;Object(n.a)(!0===r,367),Object(n.a)(!1===t,368)}this.pendingBatchBeginMessage=void 0,this.isProcessingBatch=!1}checkpoint(){const e=this.pendingStates.peekBack();return{rollback:()=>{try{for(;this.pendingStates.peekBack()!==e;)this.rollbackNextPendingState()}catch(t){const e=Object(o.i)(t,e=>r.c.create("RollbackError: "+e,"checkpointRollback",void 0));throw this.stateHandler.close(e),e}}}}peekNextPendingState(){const e=this.pendingStates.peekFront();return Object(n.a)(!!e,369),e}rollbackNextPendingState(){if(0===this.pendingStates.length)return;this._pendingMessagesCount--;const e=this.pendingStates.pop();switch(e.type){case"message":this.stateHandler.rollback(e.messageType,e.content,e.localOpMetadata);break;default:throw new Error("Can't rollback state "+e.type)}}replayPendingStates(){Object(n.a)(this.stateHandler.connected(),370),Object(n.a)(this.clientId!==this.stateHandler.clientId(),371),this.clientId=this.stateHandler.clientId(),Object(n.a)(this.initialStates.isEmpty(),372);let e=this.pendingStates.length;if(0===e)return;this._pendingMessagesCount=0;const t=this.stateHandler.flushMode();for(this.stateHandler.setFlushMode(this.flushModeForNextMessage);e>0;){const t=this.pendingStates.shift();switch(t.type){case"message":this.stateHandler.reSubmit(t.messageType,t.content,t.localOpMetadata,t.opMetadata);break;case"flushMode":this.stateHandler.setFlushMode(t.flushMode);break;case"flush":this.stateHandler.flush()}e--}this.stateHandler.setFlushMode(t)}}},18005:function(e,t,s){"use strict";function i(e){if(this._capacity=r(e),this._length=0,this._front=0,n(e)){for(var t=e.length,s=0;s<t;++s)this[s]=e[s];this._length=t}}i.prototype.toArray=function(){for(var e=this._length,t=new Array(e),s=this._front,i=this._capacity,n=0;n<e;++n)t[n]=this[s+n&i-1];return t},i.prototype.push=function(e){var t=arguments.length,s=this._length;if(t>1){var i=this._capacity;if(s+t>i){for(var n=0;n<t;++n){this._checkCapacity(s+1),this[r=this._front+s&this._capacity-1]=arguments[n],s++,this._length=s}return s}for(var r=this._front,n=0;n<t;++n)this[r+s&i-1]=arguments[n],r++;return this._length=s+t,s+t}return 0===t?s:(this._checkCapacity(s+1),this[n=this._front+s&this._capacity-1]=e,this._length=s+1,s+1)},i.prototype.pop=function(){var e=this._length;if(0!==e){var t=this._front+e-1&this._capacity-1,s=this[t];return this[t]=void 0,this._length=e-1,s}},i.prototype.shift=function(){var e=this._length;if(0!==e){var t=this._front,s=this[t];return this[t]=void 0,this._front=t+1&this._capacity-1,this._length=e-1,s}},i.prototype.unshift=function(e){var t=this._length,s=arguments.length;if(s>1){if(t+s>(n=this._capacity)){for(var i=s-1;i>=0;i--){this._checkCapacity(t+1);var n=this._capacity;this[a=(this._front-1&n-1^n)-n]=arguments[i],t++,this._length=t,this._front=a}return t}var r=this._front;for(i=s-1;i>=0;i--){var a;this[a=(r-1&n-1^n)-n]=arguments[i],r=a}return this._front=r,this._length=t+s,t+s}if(0===s)return t;this._checkCapacity(t+1);n=this._capacity;return this[i=(this._front-1&n-1^n)-n]=e,this._length=t+1,this._front=i,t+1},i.prototype.peekBack=function(){var e=this._length;if(0!==e)return this[this._front+e-1&this._capacity-1]},i.prototype.peekFront=function(){if(0!==this._length)return this[this._front]},i.prototype.get=function(e){var t=e;if(t===(0|t)){var s=this._length;if(t<0&&(t+=s),!(t<0||t>=s))return this[this._front+t&this._capacity-1]}},i.prototype.isEmpty=function(){return 0===this._length},i.prototype.clear=function(){for(var e=this._length,t=this._front,s=this._capacity,i=0;i<e;++i)this[t+i&s-1]=void 0;this._length=0,this._front=0},i.prototype.toString=function(){return this.toArray().toString()},i.prototype.valueOf=i.prototype.toString,i.prototype.removeFront=i.prototype.shift,i.prototype.removeBack=i.prototype.pop,i.prototype.insertFront=i.prototype.unshift,i.prototype.insertBack=i.prototype.push,i.prototype.enqueue=i.prototype.push,i.prototype.dequeue=i.prototype.shift,i.prototype.toJSON=i.prototype.toArray,Object.defineProperty(i.prototype,"length",{get:function(){return this._length},set:function(){throw new RangeError("")}}),i.prototype._checkCapacity=function(e){this._capacity<e&&this._resizeTo(r(1.5*this._capacity+16))},i.prototype._resizeTo=function(e){var t=this._capacity;this._capacity=e;var s=this._front,i=this._length;s+i>t&&function(e,t,s,i,n){for(var r=0;r<n;++r)s[r+i]=e[r+t],e[r+t]=void 0}(this,0,this,t,s+i&t-1)};var n=Array.isArray;function r(e){if("number"!=typeof e){if(!n(e))return 16;e=e.length}return t=Math.min(Math.max(16,e),1073741824),t>>>=0,t-=1,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,1+(t|=t>>16);var t}e.exports=i},18006:function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var i,n=s(17979),r=s(17940),a=s(17939),o=s(17970);!function(e){e[e.Local=0]="Local",e[e.Broadcast=1]="Broadcast",e[e.Acked=2]="Acked",e[e.Nacked=-1]="Nacked"}(i||(i={}));class c{constructor(e,t){this.clientId=e,this.clientSequenceNumber=t,this.state=i.Local,this.defSummaryOp=new n.a,this.defSummaryAck=new n.a}static createLocal(e,t){return new c(e,t)}static createFromOp(e){const t=new c(e.clientId,e.clientSequenceNumber);return t.broadcast(e),t}get summaryOp(){return this._summaryOp}get summaryAckNack(){return this._summaryAckNack}hasBeenAcked(){return this.state===i.Acked}broadcast(e){return Object(r.a)(this.state===i.Local,373),this._summaryOp=e,this.defSummaryOp.resolve(),this.state=i.Broadcast,!0}ackNack(e){return Object(r.a)(this.state===i.Broadcast,374),this._summaryAckNack=e,this.defSummaryAck.resolve(),this.state=e.type===o.a.SummaryAck?i.Acked:i.Nacked,!0}async waitBroadcast(){return await this.defSummaryOp.promise,this._summaryOp}async waitAckNack(){return await this.defSummaryAck.promise,this._summaryAckNack}}class l{constructor(e,t){this.clientId=e,this.summaryCollection=t,this.localSummaries=new Map,this._disposed=!1}get disposed(){return this._disposed}watchSummary(e){let t=this.localSummaries.get(e);return t||(t=c.createLocal(this.clientId,e),this.localSummaries.set(t.clientSequenceNumber,t)),t}waitFlushed(){return this.summaryCollection.waitFlushed()}tryGetSummary(e){return this.localSummaries.get(e)}setSummary(e){this.localSummaries.set(e.clientSequenceNumber,e)}dispose(){this.summaryCollection.removeWatcher(this.clientId),this._disposed=!0}}class u extends a.a{constructor(e,t){super(),this.deltaManager=e,this.logger=t,this.summaryWatchers=new Map,this.pendingSummaries=new Map,this.refreshWaitNextAck=new n.a,this.deltaManager.on("op",e=>this.handleOp(e))}get latestAck(){return this.lastAck}emit(e,...t){return super.emit(e,...t)}get opsSinceLastAck(){var e,t;return this.deltaManager.lastSequenceNumber-(null!==(t=null===(e=this.lastAck)||void 0===e?void 0:e.summaryAck.sequenceNumber)&&void 0!==t?t:this.deltaManager.initialSequenceNumber)}addOpListener(e){this.deltaManager.on("op",e)}removeOpListener(e){this.deltaManager.off("op",e)}createWatcher(e){const t=new l(e,this);return this.summaryWatchers.set(e,t),t}removeWatcher(e){this.summaryWatchers.delete(e)}setPendingAckTimerTimeoutCallback(e,t){this.maxAckWaitTime=e,this.pendingAckTimerTimeoutCallback=t}unsetPendingAckTimerTimeoutCallback(){this.maxAckWaitTime=void 0,this.pendingAckTimerTimeoutCallback=void 0}async waitFlushed(){for(;this.pendingSummaries.size>0;){const e=Array.from(this.pendingSummaries,([,e])=>e.waitAckNack());await Promise.all(e)}return this.lastAck}async waitSummaryAck(e){for(;!this.lastAck||this.lastAck.summaryOp.referenceSequenceNumber<e;)await this.refreshWaitNextAck.promise;return this.lastAck}handleOp(e){var t;switch(e.type){case o.a.Summarize:return void this.handleSummaryOp(e);case o.a.SummaryAck:return void this.handleSummaryAck(e);case o.a.SummaryNack:return void this.handleSummaryNack(e);default:{const s=e.timestamp;return void 0!==this.lastSummaryTimestamp&&void 0!==this.maxAckWaitTime&&s-this.lastSummaryTimestamp>=this.maxAckWaitTime&&(null===(t=this.pendingAckTimerTimeoutCallback)||void 0===t||t.call(this)),void this.emit("default",e)}}}handleSummaryOp(e){let t;const s=this.summaryWatchers.get(e.clientId);s&&(t=s.tryGetSummary(e.clientSequenceNumber),t&&t.broadcast(e)),t||(t=c.createFromOp(e),s&&s.setSummary(t)),this.pendingSummaries.set(e.sequenceNumber,t),this.lastSummaryTimestamp=e.timestamp,this.emit(o.a.Summarize,e)}handleSummaryAck(e){const t=e.contents.summaryProposal.summarySequenceNumber,s=this.pendingSummaries.get(t);s&&void 0!==s.summaryOp?(s.ackNack(e),this.pendingSummaries.delete(t),(!this.lastAck||t>this.lastAck.summaryAck.contents.summaryProposal.summarySequenceNumber)&&(this.lastAck={summaryOp:s.summaryOp,summaryAck:e},this.refreshWaitNextAck.resolve(),this.refreshWaitNextAck=new n.a,this.emit(o.a.SummaryAck,e))):t>=this.deltaManager.initialSequenceNumber&&this.logger.sendErrorEvent({eventName:"SummaryAckWithoutOp",sequenceNumber:e.sequenceNumber,summarySequenceNumber:t,initialSequenceNumber:this.deltaManager.initialSequenceNumber})}handleSummaryNack(e){const t=e.contents.summaryProposal.summarySequenceNumber,s=this.pendingSummaries.get(t);s&&(s.ackNack(e),this.pendingSummaries.delete(t),this.emit(o.a.SummaryNack,e))}}},18007:function(e,t,s){"use strict";s.d(t,"a",(function(){return c})),s.d(t,"b",(function(){return l}));var i=s(17939),n=s(17940),r=s(17957),a=s(17944),o=s(17975);class c extends i.a{constructor(e,t,s){super(),this.clientMap=new Map,this.rootNode={sequenceNumber:-1,olderClient:void 0,youngerClient:void 0},this._youngestClient=this.rootNode,this.logger=a.a.create(e,"OrderedClientCollection");const i=s.getMembers();for(const[n,r]of i)this.addClient(n,r);s.on("addMember",(e,s)=>{const i=this.addClient(e,s);this.emit("addClient",i,t.lastSequenceNumber)}),s.on("removeMember",e=>{const s=t.lastSequenceNumber,i=this.removeClient(e);void 0===i?this.logger.sendErrorEvent({eventName:"ClientNotFound",clientId:e,sequenceNumber:s}):this.emit("removeClient",i,s)})}get count(){return this.clientMap.size}get oldestClient(){return this.rootNode.youngerClient}addClient(e,t){Object(n.a)(t.sequenceNumber>-1,502);let s=this._youngestClient;for(;s.sequenceNumber>t.sequenceNumber;)Object(n.a)(void 0!==s.olderClient,503),s=s.olderClient;const i={clientId:e,sequenceNumber:t.sequenceNumber,client:Object.assign({},t.client),olderClient:s,youngerClient:s.youngerClient};return i.olderClient.youngerClient=i,void 0===i.youngerClient?this._youngestClient=i:i.youngerClient.olderClient=i,this.clientMap.set(e,i),i}removeClient(e){const t=this.clientMap.get(e);if(void 0!==t)return t.olderClient.youngerClient=t.youngerClient,void 0===t.youngerClient?this._youngestClient=t.olderClient:t.youngerClient.olderClient=t.olderClient,this.clientMap.delete(e),t}getAllClients(){const e=[];let t=this.rootNode;for(;void 0!==t.youngerClient;)e.push(t.youngerClient),t=t.youngerClient;return e}}class l extends i.a{constructor(e,t,s,i){let n,r;super(),this.orderedClientCollection=t,this.isEligibleFn=i,this._eligibleCount=0;for(const a of t.getAllClients())this.addClient(a,0),"number"!=typeof s&&(a.clientId===s.electedClientId&&(n=a,void 0===s.electedParentId&&a.client.details.type!==o.b&&(r=a)),a.clientId===s.electedParentId&&(r=a));t.on("addClient",(e,t)=>this.addClient(e,t)),t.on("removeClient",(e,t)=>this.removeClient(e,t)),"number"==typeof s?this._electionSequenceNumber=s:((null==n?void 0:n.clientId)!==s.electedClientId?e.sendErrorEvent({eventName:"InitialElectedClientNotFound",electionSequenceNumber:s.electionSequenceNumber,expectedClientId:s.electedClientId,electedClientId:null==n?void 0:n.clientId,clientCount:t.count}):void 0===n||i(n)||(n=r=this.findFirstEligibleParent(r),e.sendErrorEvent({eventName:"InitialElectedClientIneligible",electionSequenceNumber:s.electionSequenceNumber,expectedClientId:s.electedClientId,electedClientId:null==n?void 0:n.clientId})),this._electedParent=r,this._electedClient=n,this._electionSequenceNumber=s.electionSequenceNumber)}get eligibleCount(){return this._eligibleCount}get electionSequenceNumber(){return this._electionSequenceNumber}get electedClient(){return this._electedClient}get electedParent(){return this._electedParent}tryElectingClient(e,t){let s=!1;const i=(null==e?void 0:e.client.details.type)===o.b,n=this._electedClient;this._electedClient!==e&&(this._electionSequenceNumber=t,this._electedClient=e,s=!0),this._electedParent===e||i||(this._electedParent=e,s=!0),s&&this.emit("election",e,t,n)}tryElectingParent(e,t){this._electedParent!==e&&(this._electedParent=e,this.emit("election",this._electedClient,t,this._electedClient))}findFirstEligibleParent(e){let t=e;for(;void 0!==t&&(!this.isEligibleFn(t)||t.client.details.type===o.b);)t=t.youngerClient;return t}addClient(e,t){var s;if(this.isEligibleFn(e)){this._eligibleCount++;const i=e.client.details.type===o.b,n=(null===(s=this._electedClient)||void 0===s?void 0:s.client.details.type)===o.b;void 0===this._electedClient||!n&&i?this.tryElectingClient(e,t):void 0!==this._electedParent||i||this.tryElectingParent(e,t)}}removeClient(e,t){var s,i,n,a,c;if(this.isEligibleFn(e))if(this._eligibleCount--,this._electedClient===e)if(this._electedParent!==e){if(this._electedClient.client.details.type!==o.b)throw new r.f("Elected client should be a summarizer client 1");this.tryElectingClient(this._electedParent,t)}else{const e=null!==(i=this.findFirstEligibleParent(null===(s=this._electedParent)||void 0===s?void 0:s.youngerClient))&&void 0!==i?i:this.findFirstEligibleParent(this.orderedClientCollection.oldestClient);this.tryElectingClient(e,t)}else if(this._electedParent===e){if((null===(n=this._electedClient)||void 0===n?void 0:n.client.details.type)!==o.b)throw new r.f("Elected client should be a summarizer client 2");const e=null!==(c=this.findFirstEligibleParent(null===(a=this._electedParent)||void 0===a?void 0:a.youngerClient))&&void 0!==c?c:this.findFirstEligibleParent(this.orderedClientCollection.oldestClient);this.tryElectingParent(e,t)}}getAllEligibleClients(){return this.orderedClientCollection.getAllClients().filter(this.isEligibleFn)}incrementElectedClient(e){var t,s;const i=null!==(s=this.findFirstEligibleParent(null===(t=this._electedParent)||void 0===t?void 0:t.youngerClient))&&void 0!==s?s:this.findFirstEligibleParent(this.orderedClientCollection.oldestClient);void 0===this._electedClient||this._electedClient===this._electedParent?this.tryElectingClient(i,e):this.tryElectingParent(i,e)}resetElectedClient(e){const t=this.findFirstEligibleParent(this.orderedClientCollection.oldestClient);void 0===this._electedClient||this._electedClient===this._electedParent?this.tryElectingClient(t,e):this.tryElectingParent(t,e)}peekNextElectedClient(){var e,t;return null!==(t=this.findFirstEligibleParent(null===(e=this._electedParent)||void 0===e?void 0:e.youngerClient))&&void 0!==t?t:this.findFirstEligibleParent(this.orderedClientCollection.oldestClient)}serialize(){var e,t;return{electionSequenceNumber:this.electionSequenceNumber,electedClientId:null===(e=this.electedClient)||void 0===e?void 0:e.clientId,electedParentId:null===(t=this.electedParent)||void 0===t?void 0:t.clientId}}}},18008:function(e,t,s){"use strict";s.d(t,"a",(function(){return S}));var i=s(15576),n=s(17979),r=s(18013),a=s(17957),o=s(18014),c=s(18011),l=s(17997),u=s(17945),h=s(17944),d=s(17951),m=s(17975),g=s(18012),p=s(18015),f=s(18016),b=s(18009);class v extends u.a{constructor(e,t=!1){super(e),this.logged=t,this.errorType="summarizingError",this.canRetry=!0}static wrap(e,t=!1,s){return Object(u.j)(e,e=>new v(e,t),s)}}class S extends i.EventEmitter{constructor(e,t,s,i,r,o,c){super(),this.runtime=t,this.configurationGetter=s,this.internalsProvider=i,this.summaryCollection=o,this.runCoordinatorCreateFn=c,this._disposed=!1,this.starting=!1,this.stopDeferred=new n.a,this.summarizeOnDemand=(...e)=>{var t;try{if(this._disposed||(null===(t=this.runningSummarizer)||void 0===t?void 0:t.disposed))throw new a.f("Summarizer is already disposed.");if(void 0!==this.runtime.summarizerClientId&&this.runtime.summarizerClientId!==this.runtime.clientId)throw new a.f("On-demand summary attempted while an elected summarizer is present");const s=new b.a;if(this.runningSummarizer)return this.runningSummarizer.summarizeOnDemand(s,...e);return this.runCoordinatorCreateFn(this.runtime).then(t=>{this.start(this.runtime.clientId,t).then(async i=>{i.summarizeOnDemand(s,...e);const n=await Promise.race([this.stopDeferred.promise,t.waitCancelled]);await i.waitStop(!1),t.stop(n),this.close()}).catch(e=>{s.fail("Failed to start summarizer",e)})}).catch(e=>{s.fail("Failed to create cancellation token",e)}),s.build()}catch(s){throw v.wrap(s,!1,this.logger)}},this.enqueueSummarize=(...e)=>{if(this._disposed||void 0===this.runningSummarizer||this.runningSummarizer.disposed)throw new a.f("Summarizer is not running or already disposed.");return this.runningSummarizer.enqueueSummarize(...e)},this.logger=h.a.create(this.runtime.logger,"Summarizer"),this.innerHandle=new g.a(this,e,r)}get IFluidLoadable(){return this}get ISummarizer(){return this}get handle(){return this.innerHandle}static async create(e,t){const s={headers:{[r.a.cache]:!1,[r.a.clientDetails]:{capabilities:{interactive:!1},type:m.b},[o.a.summarizingClient]:!0,[r.a.reconnect]:!1},url:t},i=await e.resolve(s),n=await Object(l.d)(i,{url:"_summarizer"});if(void 0===n.ISummarizer)throw new a.f("Fluid object does not implement ISummarizer");return n.ISummarizer}async run(e){try{return await this.runCore(e)}catch(t){throw this.stop("summarizerException"),v.wrap(t,!1,this.logger)}finally{this.close()}}stop(e){this.stopDeferred.resolve(e)}close(){this.dispose(),this.runtime.closeFn()}async runCore(e){const t=await this.runCoordinatorCreateFn(this.runtime),s=Promise.race([t.waitCancelled,this.stopDeferred.promise]);if(s.then(t=>{this.logger.sendTelemetryEvent({eventName:"StoppingSummarizer",onBehalfOf:e,reason:t})}),t.cancelled)return t.waitCancelled;const i=await this.start(e,t),n=await s;return await i.waitStop(!t.cancelled&&S.stopReasonCanRunLastSummary(n)),t.stop(n),n}static stopReasonCanRunLastSummary(e){return"parentNotConnected"===e}async start(e,t){if(this.runningSummarizer){if(this.runningSummarizer.disposed)throw new a.f("Starting a disposed summarizer");return this.runningSummarizer}if(this.starting)throw new a.f("Attempting to start a summarizer that is already starting");this.starting=!0,this.logger.sendTelemetryEvent({eventName:"RunningSummarizer",onBehalfOf:e,initSummarySeqNumber:this.runtime.deltaManager.initialSequenceNumber,config:JSON.stringify(this.configurationGetter())});const s=this.runtime.clientId;if(void 0===s)throw new a.f("clientId should be defined if connected.");const i=await p.a.start(this.logger,this.summaryCollection.createWatcher(s),this.configurationGetter(),async(...e)=>this.internalsProvider.submitSummary(...e),new f.a(this.runtime.deltaManager.lastSequenceNumber,{refSequenceNumber:this.runtime.deltaManager.initialSequenceNumber,summaryTime:Date.now()}),e=>{this._disposed||this.logger.sendErrorEvent({eventName:"summarizingError"},((e,t)=>new v(e,t))(e,!0))},this.summaryCollection,t,e=>t.stop(e));return this.runningSummarizer=i,this.starting=!1,this.handleSummaryAcks().catch(e=>{this.logger.sendErrorEvent({eventName:"HandleSummaryAckFatalError"},e)}),this.systemOpListener=e=>i.handleSystemOp(e),this.runtime.deltaManager.inbound.on("op",this.systemOpListener),this.opListener=(e,t)=>i.handleOp(e,t),this.runtime.on("batchEnd",this.opListener),i}dispose(){this.stop("summarizerClientDisconnected"),this._disposed=!0,this.runningSummarizer&&(this.runningSummarizer.dispose(),this.runningSummarizer=void 0),this.systemOpListener&&this.runtime.deltaManager.inbound.off("op",this.systemOpListener),this.opListener&&this.runtime.removeListener("batchEnd",this.opListener)}async handleSummaryAcks(){var e,t,s,i,n;let r,a=this.runtime.deltaManager.initialSequenceNumber;for(;this.runningSummarizer;){const l=null!==(e=this.runningSummarizer.tryGetCorrelatedLogger(a))&&void 0!==e?e:this.logger;try{r=void 0,r=await this.summaryCollection.waitSummaryAck(a),a=r.summaryOp.referenceSequenceNumber;const e=r.summaryOp.contents.handle,t=r.summaryAck.contents.handle;await this.runningSummarizer.lockedRefreshSummaryAckAction(async()=>this.internalsProvider.refreshLatestSummaryAck(e,t,a,l).catch(async s=>{if(!Object(d.b)(s)||s.errorType!==c.a.fileNotFoundOrAccessDeniedError)throw s;l.sendTelemetryEvent({eventName:"HandleSummaryAckErrorIgnored",referenceSequenceNumber:a,proposalHandle:e,ackHandle:t},s)}))}catch(o){l.sendErrorEvent({eventName:"HandleSummaryAckError",referenceSequenceNumber:a,handle:null===(s=null===(t=null==r?void 0:r.summaryOp)||void 0===t?void 0:t.contents)||void 0===s?void 0:s.handle,ackHandle:null===(n=null===(i=null==r?void 0:r.summaryAck)||void 0===i?void 0:i.contents)||void 0===n?void 0:n.handle},o)}a++}}}},18009:function(e,t,s){"use strict";s.d(t,"c",(function(){return h})),s.d(t,"a",(function(){return m})),s.d(t,"b",(function(){return g}));var i=s(17979),n=s(17940),r=s(17978),a=s(17970),o=s(17944),c=s(17945),l=s(18010),u=s(18011);async function h(e,t,s){const i=[e.then(e=>({result:"done",value:e})),t.then(({timerResult:e})=>({result:e}))];return void 0!==s&&i.push(s.waitCancelled.then(()=>({result:"cancelled"}))),Promise.race(i)}const d={submitSummaryFailure:"Error while generating, uploading, or submitting summary",summaryOpWaitTimeout:"Timeout while waiting for summarize op broadcast",summaryAckWaitTimeout:"Timeout while waiting for summaryAck/summaryNack op",summaryNack:"Server rejected summary via summaryNack op",disconnect:"Summary cancelled due to summarizer or main client disconnect"};class m{constructor(){this.summarySubmitted=new i.a,this.summaryOpBroadcasted=new i.a,this.receivedSummaryAckOrNack=new i.a}fail(e,t,s,i){Object(n.a)(!this.receivedSummaryAckOrNack.isCompleted,606);const r={success:!1,message:e,data:void 0,error:t,retryAfterSeconds:i};this.summarySubmitted.resolve(r),this.summaryOpBroadcasted.resolve(r),this.receivedSummaryAckOrNack.resolve(Object.assign(Object.assign({},r),{data:s}))}build(){return{summarySubmitted:this.summarySubmitted.promise,summaryOpBroadcasted:this.summaryOpBroadcasted.promise,receivedSummaryAckOrNack:this.receivedSummaryAckOrNack.promise}}}class g{constructor(e,t,s,i,n,a,o){this.pendingAckTimer=e,this.heuristicData=t,this.submitSummaryCallback=s,this.raiseSummarizingError=i,this.successfulSummaryCallback=n,this.summaryWatcher=a,this.logger=o,this.summarizeTimer=new r.b(2e4,()=>this.summarizeTimerHandler(2e4,1))}summarize(e,t,s,i=new m){return this.summarizeCore(e,t,i,s).catch(t=>{const s="UnexpectedSummarizeError";this.logger.sendErrorEvent(Object.assign({eventName:s},e),t),i.fail(s,t)}),i.build()}async summarizeCore(e,t,s,i){const{refreshLatestAck:r,fullTree:m}=t,g=o.a.create(this.logger,void 0,{all:e});let p={fullTree:m,timeSinceLastAttempt:Date.now()-this.heuristicData.lastAttempt.summaryTime,timeSinceLastSummary:Date.now()-this.heuristicData.lastSuccessfulSummary.summaryTime};const f=o.c.start(g,Object.assign({eventName:"Summarize",refreshLatestAck:r},p)),b=(e,t,n,r)=>{this.raiseSummarizingError(d[e]);const a=Object(l.j)(t),o=i.cancelled||(null==t?void 0:t.errorType)===u.a.offlineError?"generic":"error";f.cancel(Object.assign(Object.assign({},n),{reason:e,category:o,retryAfterSeconds:a}),t),s.fail((e=>`${e}: ${d[e]}`)(e),t,r,a)};let v;this.summarizeTimer.start();try{v=await this.submitSummaryCallback({fullTree:m,refreshLatestAck:r,summaryLogger:g,cancellationToken:i});const e=v.referenceSequenceNumber,t=e-this.heuristicData.lastSuccessfulSummary.refSequenceNumber;if(p=Object.assign(Object.assign({},p),{referenceSequenceNumber:e,minimumSequenceNumber:v.minimumSequenceNumber,opsSinceLastAttempt:e-this.heuristicData.lastAttempt.refSequenceNumber,opsSinceLastSummary:t}),"base"!==v.stage&&(p=Object.assign(Object.assign(Object.assign({},p),v.summaryStats),{generateDuration:v.generateDuration}),"generate"!==v.stage&&(p=Object.assign(Object.assign({},p),{handle:v.handle,uploadDuration:v.uploadDuration}),"upload"!==v.stage&&(p=Object.assign(Object.assign({},p),{clientSequenceNumber:v.clientSequenceNumber})))),"submit"!==v.stage)return b("submitSummaryFailure",v.error,p);if(!m&&!v.forcedFullTree){const{summarizedDataStoreCount:e,gcStateUpdatedDataStoreCount:s=0}=v.summaryStats;e>s+t&&g.sendErrorEvent({eventName:"IncrementalSummaryViolation",summarizedDataStoreCount:e,gcStateUpdatedDataStoreCount:s,opsSinceLastSummary:t})}f.reportEvent("generate",Object.assign({},p)),s.summarySubmitted.resolve({success:!0,data:v})}catch(S){return b("submitSummaryFailure",S)}finally{this.heuristicData.recordAttempt(null==v?void 0:v.referenceSequenceNumber),this.summarizeTimer.clear()}try{const e=this.pendingAckTimer.start(),t=this.summaryWatcher.watchSummary(v.clientSequenceNumber),r=await h(t.waitBroadcast(),e,i);if("cancelled"===r.result)return b("disconnect");if("done"!==r.result)return b("summaryOpWaitTimeout");const o=r.value,u=Date.now()-this.heuristicData.lastAttempt.summaryTime;s.summaryOpBroadcasted.resolve({success:!0,data:{summarizeOp:o,broadcastDuration:u}}),this.heuristicData.lastAttempt.summarySequenceNumber=o.sequenceNumber,g.sendTelemetryEvent({eventName:"Summarize_Op",duration:u,referenceSequenceNumber:o.referenceSequenceNumber,summarySequenceNumber:o.sequenceNumber,handle:o.contents.handle});const d=await h(t.waitAckNack(),e,i);if("cancelled"===d.result)return b("disconnect");if("done"!==d.result)return b("summaryAckWaitTimeout");const m=d.value;this.pendingAckTimer.clear();const S=Date.now()-this.heuristicData.lastAttempt.summaryTime;if(p=Object.assign({ackWaitDuration:S,ackNackSequenceNumber:m.sequenceNumber,summarySequenceNumber:m.contents.summaryProposal.summarySequenceNumber},p),m.type!==a.a.SummaryAck){Object(n.a)(m.type===a.a.SummaryNack,628);const e=m.contents,t=null==e?void 0:e.message,s=null==e?void 0:e.retryAfter,i=new c.a("Received summaryNack: "+t,{retryAfterSeconds:s});return Object(n.a)(Object(l.j)(i)===s,607),b("summaryNack",i,Object.assign(Object.assign({},p),{nackRetryAfter:s}),{summaryNackOp:m,ackNackDuration:S})}this.heuristicData.markLastAttemptAsSuccessful(),this.successfulSummaryCallback(),f.end(Object.assign(Object.assign({},p),{handle:m.contents.handle})),s.receivedSummaryAckOrNack.resolve({success:!0,data:{summaryAckOp:m,ackNackDuration:S}})}finally{this.pendingAckTimer.clear()}}summarizeTimerHandler(e,t){if(this.logger.sendPerformanceEvent({eventName:"SummarizeTimeout",timeoutTime:e,timeoutCount:t}),t<5){const s=2*e;this.summarizeTimer.start(s,()=>this.summarizeTimerHandler(s,t+1))}}dispose(){this.summarizeTimer.clear()}}},18010:function(e,t,s){"use strict";s.d(t,"e",(function(){return n})),s.d(t,"k",(function(){return o})),s.d(t,"c",(function(){return c})),s.d(t,"b",(function(){return l})),s.d(t,"a",(function(){return u})),s.d(t,"d",(function(){return d})),s.d(t,"h",(function(){return g})),s.d(t,"g",(function(){return p})),s.d(t,"f",(function(){return f})),s.d(t,"j",(function(){return b})),s.d(t,"i",(function(){return v}));var i,n,r=s(18011),a=s(17945);function o(){return"object"==typeof navigator&&null!==navigator&&"boolean"==typeof navigator.onLine?navigator.onLine?n.Online:n.Offline:n.Unknown}!function(e){e[e.Offline=0]="Offline",e[e.Online=1]="Online",e[e.Unknown=2]="Unknown"}(n||(n={}));class c extends a.a{constructor(e,t,s){super(e,s),this.canRetry=t,this.errorType=r.a.genericNetworkError}}class l extends a.a{constructor(e,t){super(e,Object.assign(Object.assign({},t),{statusCode:400})),this.errorType=l.errorType,this.canRetry=!1}}l.errorType=null!==(i=r.a.deltaStreamConnectionForbidden)&&void 0!==i?i:"deltaStreamConnectionForbidden";class u extends a.a{constructor(e,t,s,i){super(e,i,new Set(["claims","tenantId"])),this.claims=t,this.tenantId=s,this.errorType=r.a.authorizationError,this.canRetry=!1}}class h extends a.a{constructor(e,t,s,i){super(e,i),this.errorType=t,this.canRetry=s}}class d extends h{constructor(e,t,s){super(e,t,!1,s),this.errorType=t}}class m extends a.a{constructor(e,t,s){super(e,s),this.retryAfterSeconds=t,this.errorType=r.a.throttlingError,this.canRetry=!0}}const g=(e,t)=>new d(e,r.a.writeError,t);function p(e,t,s){return void 0!==t.retryAfterMs&&t.canRetry?new m(e,t.retryAfterMs/1e3,s):new c(e,t.canRetry,s)}const f=e=>!0===(null==e?void 0:e.canRetry),b=e=>null==e?void 0:e.retryAfterSeconds,v=e=>void 0!==(null==e?void 0:e.retryAfterSeconds)?1e3*e.retryAfterSeconds:void 0},18011:function(e,t,s){"use strict";var i;s.d(t,"a",(function(){return i})),function(e){e.genericError="genericError",e.genericNetworkError="genericNetworkError",e.authorizationError="authorizationError",e.fileNotFoundOrAccessDeniedError="fileNotFoundOrAccessDeniedError",e.throttlingError="throttlingError",e.offlineError="offlineError",e.unsupportedClientProtocolVersion="unsupportedClientProtocolVersion",e.writeError="writeError",e.fetchFailure="fetchFailure",e.incorrectServerResponse="incorrectServerResponse",e.fileOverwrittenInStorage="fileOverwrittenInStorage",e.deltaStreamConnectionForbidden="deltaStreamConnectionForbidden",e.locationRedirection="locationRedirection"}(i||(i={}))},18012:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));var i=s(17942);class n extends i.a{async get(){throw Error("Do not try to get a summarizer object from the handle. Reference it directly.")}attach(){}bind(e){}}},18013:function(e,t,s){"use strict";var i;s.d(t,"a",(function(){return i})),function(e){e.cache="fluid-cache",e.clientDetails="fluid-client-details",e.loadMode="loadMode",e.reconnect="fluid-reconnect",e.sequenceNumber="fluid-sequence-number",e.version="version"}(i||(i={}))},18014:function(e,t,s){"use strict";var i;s.d(t,"a",(function(){return i})),function(e){e.summarizingClient="fluid-client-summarizer",e.createNew="createNew"}(i||(i={}))},18015:function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var i=s(17940),n=s(17978),r=s(17979),a=s(18017),o=s(17957),c=s(17970),l=s(17944),u=s(18016),h=s(18009),d=function(e,t){var s={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(s[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(i=Object.getOwnPropertySymbols(e);n<i.length;n++)t.indexOf(i[n])<0&&Object.prototype.propertyIsEnumerable.call(e,i[n])&&(s[i[n]]=e[i[n]])}return s};class m{constructor(e,t,s,r,a,o,c,d,m){this.summaryWatcher=t,this.configuration=s,this.submitSummaryCallback=r,this.heuristicData=a,this.raiseSummarizingError=o,this.summaryCollection=c,this.cancellationToken=d,this.stopSummarizerCallback=m,this.stopping=!1,this._disposed=!1,this.tryWhileSummarizing=!1,this.summarizeCount=0,this.totalSuccessfulAttempts=0,this.tryGetCorrelatedLogger=e=>this.heuristicData.lastAttempt.refSequenceNumber===e?this.logger:void 0;const g={summarizeCount:()=>this.summarizeCount,summarizerSuccessfulAttempts:()=>this.totalSuccessfulAttempts};this.logger=l.a.create(e,"Running",{all:g}),"disableHeuristics"!==s.state&&(Object(i.a)("enabled"===this.configuration.state,746),this.heuristicRunner=new u.b(a,this.configuration,e=>this.trySummarize(e),this.logger)),Object(i.a)("disabled"!==this.configuration.state,747);const p=Math.min(this.configuration.maxAckWaitTime,6e5);this.pendingAckTimer=new n.a(p,()=>{this.raiseSummarizingError("Pending summary ack not received in time"),this.logger.sendErrorEvent({eventName:"SummaryAckWaitTimeout",maxAckWaitTime:p,referenceSequenceNumber:this.heuristicData.lastAttempt.refSequenceNumber,summarySequenceNumber:this.heuristicData.lastAttempt.summarySequenceNumber,timePending:Date.now()-this.heuristicData.lastAttempt.summaryTime})}),c.setPendingAckTimerTimeoutCallback(p,()=>{this.pendingAckTimer.hasTimer&&(this.logger.sendTelemetryEvent({eventName:"MissingSummaryAckFoundByOps",referenceSequenceNumber:this.heuristicData.lastAttempt.refSequenceNumber,summarySequenceNumber:this.heuristicData.lastAttempt.summarySequenceNumber}),this.pendingAckTimer.clear())}),this.generator=new h.b(this.pendingAckTimer,this.heuristicData,this.submitSummaryCallback,this.raiseSummarizingError,()=>{this.totalSuccessfulAttempts++},this.summaryWatcher,this.logger)}static async start(e,t,s,i,n,r,a,o,c){var l;const u=new m(e,t,s,i,n,r,a,o,c);return await u.waitStart(),null===(l=u.heuristicRunner)||void 0===l||l.run(),u}get disposed(){return this._disposed}dispose(){var e;this.summaryWatcher.dispose(),null===(e=this.heuristicRunner)||void 0===e||e.dispose(),this.heuristicRunner=void 0,this.generator.dispose(),this.pendingAckTimer.clear(),this.disposeEnqueuedSummary(),this._disposed=!0,this.stopping=!0}handleSystemOp(e){switch(e.type){case c.a.ClientLeave:case c.a.ClientJoin:case c.a.Propose:return void this.handleOp(void 0,e);default:return}}handleOp(e,{sequenceNumber:t,type:s,clientId:i,contents:n}){var r;void 0===e&&(this.heuristicData.lastOpSequenceNumber=t,this.tryRunEnqueuedSummary()||null===(r=this.heuristicRunner)||void 0===r||r.run())}async waitStop(e){var t;this.stopping||(this.stopping=!0,this.disposeEnqueuedSummary(),e&&(null===(t=this.heuristicRunner)||void 0===t?void 0:t.shouldRunLastSummary())&&void 0===this.summarizingLock&&this.trySummarizeOnce({reason:"lastSummary"},{}),await this.summarizingLock)}async waitStart(){const e=await Object(h.c)(this.summaryWatcher.waitFlushed(),this.pendingAckTimer.start());this.pendingAckTimer.clear(),this.summaryCollection.unsetPendingAckTimerTimeoutCallback(),"done"===e.result&&void 0!==e.value&&this.heuristicData.updateWithLastSummaryAckInfo({refSequenceNumber:e.value.summaryOp.referenceSequenceNumber,summaryTime:Date.now(),summarySequenceNumber:e.value.summaryOp.sequenceNumber})}async lockedRefreshSummaryAckAction(e){Object(i.a)(void 0===this.refreshSummaryAckLock,"Refresh Summary Ack - Caller is responsible for checking lock");const t=new r.a;return this.refreshSummaryAckLock=t.promise,e().finally(()=>{t.resolve(),this.refreshSummaryAckLock=void 0})}async lockedSummaryAction(e){Object(i.a)(void 0===this.summarizingLock,603);const t=new r.a;return this.summarizingLock=t.promise,this.summarizeCount++,await this.refreshSummaryAckLock,e().finally(()=>{var e;t.resolve(),this.summarizingLock=void 0;const s=this.tryWhileSummarizing;this.tryWhileSummarizing=!1,this.stopping||this.tryRunEnqueuedSummary()||!s||null===(e=this.heuristicRunner)||void 0===e||e.run()})}trySummarizeOnce(e,t,s=this.cancellationToken,i=new h.a){return this.lockedSummaryAction(async()=>this.generator.summarize(e,t,s,i).receivedSummaryAckOrNack).catch(e=>{}),i.build()}trySummarize(e,t=this.cancellationToken){void 0===this.summarizingLock?this.lockedSummaryAction(async()=>{const s=[{refreshLatestAck:!1,fullTree:!1},{refreshLatestAck:!0,fullTree:!1},{refreshLatestAck:!0,fullTree:!1,delaySeconds:120},{refreshLatestAck:!0,fullTree:!0,delaySeconds:600}];let i,n,r=0,o=0;for(let c=0;c<s.length;){if(this.cancellationToken.cancelled)return;if(++r>1&&"lastSummary"===e)return;o++;const l=s[c],{delaySeconds:u=0}=l,h=d(l,["delaySeconds"]),m=null!=i?i:u,g=Object.assign({reason:e,summaryAttempts:r,summaryAttemptsPerPhase:o,summaryAttemptPhase:c+1},h);m>0&&(this.logger.sendPerformanceEvent(Object.assign({eventName:"SummarizeAttemptDelay",duration:m,summaryNackDelay:void 0!==i},g)),await Object(a.a)(1e3*m)),await this.refreshSummaryAckLock;const p=this.generator.summarize(g,h,t),f=await p.receivedSummaryAckOrNack;if(f.success)return;i=f.retryAfterSeconds,(void 0===i||o>1)&&(c++,o=0),n=f}this.logger.sendErrorEvent({eventName:"FailToSummarize",reason:e,message:null==n?void 0:n.message},null==n?void 0:n.error),this.stopSummarizerCallback("failToSummarize")}).catch(e=>{this.logger.sendErrorEvent({eventName:"UnexpectedSummarizeError"},e)}):this.tryWhileSummarizing=!0}summarizeOnDemand(e=new h.a,t){var{reason:s}=t,i=d(t,["reason"]);if(this.stopping)return e.fail("RunningSummarizer stopped or disposed",void 0),e.build();if(void 0!==this.summarizingLock)throw new o.f("Attempted to run an already-running summarizer on demand");return this.trySummarizeOnce({reason:"onDemand/"+s},i,this.cancellationToken,e)}enqueueSummarize(e){var{reason:t,afterSequenceNumber:s=0,override:i=!1}=e,n=d(e,["reason","afterSequenceNumber","override"]);const r="enqueue;"+t;let a=!1;if(void 0!==this.enqueuedSummary){if(!i)return{alreadyEnqueued:!0};this.enqueuedSummary.resultsBuilder.fail("Aborted; overridden by another enqueue summarize attempt",void 0),this.enqueuedSummary=void 0,a=!0}this.enqueuedSummary={reason:r,afterSequenceNumber:s,options:n,resultsBuilder:new h.a};const o=this.enqueuedSummary.resultsBuilder.build();return this.tryRunEnqueuedSummary(),a?Object.assign(Object.assign({},o),{alreadyEnqueued:!0,overridden:!0}):o}tryRunEnqueuedSummary(){if(this.stopping)return this.disposeEnqueuedSummary(),!1;if(void 0===this.enqueuedSummary||this.heuristicData.lastOpSequenceNumber<this.enqueuedSummary.afterSequenceNumber||void 0!==this.summarizingLock)return!1;const{reason:e,resultsBuilder:t,options:s}=this.enqueuedSummary;return this.enqueuedSummary=void 0,this.trySummarizeOnce({reason:"enqueuedSummary/"+e},s,this.cancellationToken,t),!0}disposeEnqueuedSummary(){void 0!==this.enqueuedSummary&&(this.enqueuedSummary.resultsBuilder.fail("RunningSummarizer stopped or disposed",void 0),this.enqueuedSummary=void 0)}}},18016:function(e,t,s){"use strict";s.d(t,"a",(function(){return n})),s.d(t,"b",(function(){return r}));var i=s(17978);class n{constructor(e,t){this.lastOpSequenceNumber=e,this._lastAttempt=t,this._lastSuccessfulSummary=Object.assign({},t)}get lastAttempt(){return this._lastAttempt}get lastSuccessfulSummary(){return this._lastSuccessfulSummary}updateWithLastSummaryAckInfo(e){this._lastAttempt=e,this._lastSuccessfulSummary=Object.assign({},e)}recordAttempt(e){this._lastAttempt={refSequenceNumber:null!=e?e:this.lastOpSequenceNumber,summaryTime:Date.now()}}markLastAttemptAsSuccessful(){this._lastSuccessfulSummary=Object.assign({},this.lastAttempt)}}class r{constructor(e,t,s,n){this.heuristicData=e,this.configuration=t,this.trySummarize=s,this.logger=n,this.idleTimer=new i.b(this.configuration.idleTime,()=>this.trySummarize("idle")),this.minOpsForLastSummaryAttempt=this.configuration.minOpsForLastSummaryAttempt}get opsSinceLastAck(){return this.heuristicData.lastOpSequenceNumber-this.heuristicData.lastSuccessfulSummary.refSequenceNumber}run(){const e=Date.now()-this.heuristicData.lastSuccessfulSummary.summaryTime,t=this.opsSinceLastAck;e>this.configuration.maxTime?(this.idleTimer.clear(),this.trySummarize("maxTime")):t>this.configuration.maxOps?(this.idleTimer.clear(),this.trySummarize("maxOps")):this.idleTimer.restart()}shouldRunLastSummary(){const e=this.opsSinceLastAck,t=this.minOpsForLastSummaryAttempt;return this.logger.sendTelemetryEvent({eventName:"ShouldRunLastSummary",opsSinceLastAck:e,minOpsForLastSummaryAttempt:t}),e>=t}dispose(){this.idleTimer.clear()}}},18017:function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));const i=async e=>new Promise(t=>setTimeout(()=>t(),e))},18018:function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var i=s(17979),n=s(17940);new Promise(()=>{});class r{constructor(e){this.runtime=e,this._cancelled=!1,this.stopDeferred=new i.a}get cancelled(){return this._cancelled||Object(n.a)(this.runtime.deltaManager.active,605),this._cancelled}get waitCancelled(){return this.stopDeferred.promise}static async create(e){const t=new r(e);return await t.waitStart(),t}async waitStart(){if(this.runtime.disposed)this.stop("summarizerClientDisconnected");else{if(this.runtime.once("dispose",()=>this.stop("summarizerClientDisconnected")),!this.runtime.connected){const e=new Promise(e=>this.runtime.once("connected",e));await Promise.race([e,this.waitCancelled])}this.runtime.once("disconnected",()=>this.stop("summarizerClientDisconnected"))}}stop(e){this._cancelled||(this._cancelled=!0,this.stopDeferred.resolve(e))}}},18019:function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var i=s(17940),n=s(17944),r=s(18011);var a;!function(e){e[e.Off=0]="Off",e[e.Starting=1]="Starting",e[e.Running=2]="Running",e[e.Stopping=3]="Stopping"}(a||(a={}));class o{constructor(e,t,s,i,r,o,{initialDelayMs:c=5e3,opsToBypassInitialDelay:l=4e3}={},u){this.clientElection=e,this.connectedState=t,this.summaryCollection=s,this.requestSummarizerFn=r,this.startThrottler=o,this.disableHeuristics=u,this.state=a.Off,this._disposed=!1,this.handleConnected=e=>{this.latestClientId=e,this.refreshSummarizer()},this.handleDisconnected=()=>{this.refreshSummarizer()},this.refreshSummarizer=()=>{const e=this.getShouldSummarizeState();switch(this.state){case a.Off:return void(e.shouldSummarize&&this.startSummarization());case a.Starting:return;case a.Running:return void(!1===e.shouldSummarize&&this.stop(e.stopReason));case a.Stopping:default:return}},this.summarizeOnDemand=(...e)=>{if(void 0===this.summarizer)throw Error("No running summarizer client");return this.summarizer.summarizeOnDemand(...e)},this.enqueueSummarize=(...e)=>{if(void 0===this.summarizer)throw Error("No running summarizer client");return this.summarizer.enqueueSummarize(...e)},this.logger=n.a.create(i,"SummaryManager",{all:{clientId:()=>this.latestClientId}}),this.connectedState.on("connected",this.handleConnected),this.connectedState.on("disconnected",this.handleDisconnected),this.latestClientId=this.connectedState.clientId,this.opsToBypassInitialDelay=l,this.initialDelayMs=c}get disposed(){return this._disposed}get currentState(){return this.state}start(){this.clientElection.on("electedSummarizerChanged",this.refreshSummarizer),this.refreshSummarizer()}getShouldSummarizeState(){return this.connectedState.clientId!==this.clientElection.electedParentId||this.state!==a.Running&&this.connectedState.clientId!==this.clientElection.electedClientId?{shouldSummarize:!1,stopReason:"parentShouldNotSummarize"}:this.connectedState.connected?this.disposed?void Object(i.a)(!1,608):{shouldSummarize:!0}:{shouldSummarize:!1,stopReason:"parentNotConnected"}}startSummarization(){Object(i.a)(this.state===a.Off,609),this.state=a.Starting,Object(i.a)(void 0===this.summarizer,610),this.delayBeforeCreatingSummarizer().then(async e=>{if(e&&!1===this.getShouldSummarizeState().shouldSummarize)return"early exit";Object(i.a)(this.state===a.Starting,611),this.state=a.Running;const t=await this.requestSummarizerFn();this.summarizer=t;const s=this.getShouldSummarizeState();if(!1===s.shouldSummarize)return this.state=a.Starting,t.stop(s.stopReason),"early exit after starting summarizer";const r=this.latestClientId;return n.c.timedExecAsync(this.logger,{eventName:"RunningSummarizer",attempt:this.startThrottler.numAttempts},async()=>t.run(r,this.disableHeuristics))}).then(e=>{this.logger.sendTelemetryEvent({eventName:"EndingSummarizer",reason:e})}).catch(e=>{if(this.logger.sendTelemetryEvent({eventName:"EndingSummarizer",reason:"exception"},e),this.getShouldSummarizeState().shouldSummarize||void 0!==this.summarizer){const t=(null==e?void 0:e.errorType)===r.a.offlineError?"generic":"error";this.logger.sendTelemetryEvent({eventName:"SummarizerException",category:t},e)}}).finally(()=>{var e;Object(i.a)(this.state!==a.Off,612),this.state=a.Off,null===(e=this.summarizer)||void 0===e||e.close(),this.summarizer=void 0,this.getShouldSummarizeState().shouldSummarize&&this.startSummarization()})}stop(e){var t;o.isStartingOrRunning(this.state)&&(this.state=a.Stopping,null===(t=this.summarizer)||void 0===t||t.stop(e))}async delayBeforeCreatingSummarizer(){let e=this.startThrottler.getDelay();this.logger.sendTelemetryEvent({eventName:"CreatingSummarizer",throttlerDelay:e,initialDelay:this.initialDelayMs,startThrottlerMaxDelayMs:this.startThrottler.maxDelayMs,opsSinceLastAck:this.summaryCollection.opsSinceLastAck,opsToBypassInitialDelay:this.opsToBypassInitialDelay});let t=!1;if(this.summaryCollection.opsSinceLastAck<this.opsToBypassInitialDelay&&(t=!0,e=Math.max(e,this.initialDelayMs)),e>0){let t,s;const i=()=>{this.summaryCollection.opsSinceLastAck>=this.opsToBypassInitialDelay&&(clearTimeout(t),s())},n=new Promise(s=>{t=setTimeout(()=>s(),e)}),r=new Promise(e=>{s=e});this.summaryCollection.addOpListener(i),await Promise.race([n,r]),this.summaryCollection.removeOpListener(i)}return t}dispose(){this.clientElection.off("electedSummarizerChanged",this.refreshSummarizer),this.connectedState.off("connected",this.handleConnected),this.connectedState.off("disconnected",this.handleDisconnected),this._disposed=!0}}o.isStartingOrRunning=e=>e===a.Starting||e===a.Running},18020:function(e,t,s){"use strict";s.d(t,"a",(function(){return i})),s.d(t,"b",(function(){return n}));class i{constructor(e,t,s){this.delayWindowMs=e,this.maxDelayMs=t,this.delayFn=s,this.startTimes=[]}get numAttempts(){return this.startTimes.length}getAttempts(){return[...this.startTimes]}get latestAttemptTime(){return this.startTimes.length>0?this.startTimes[this.startTimes.length-1]:void 0}getDelay(){const e=Date.now(),t=this.latestAttemptTime;if(void 0!==t){const s=t-e;s>0&&(this.startTimes=this.startTimes.map(e=>e-s))}this.startTimes=this.startTimes.filter(t=>e-t<this.delayWindowMs);const s=Math.min(this.delayFn(this.startTimes.length),this.maxDelayMs);return this.startTimes.push(e),this.startTimes=this.startTimes.map(e=>e+s),s===this.maxDelayMs&&this.startTimes.shift(),s}}const n=({multiplier:e=2,coefficient:t=1,offset:s=0,initialDelay:i}={})=>n=>Math.max(0,n<=0&&void 0!==i?i:t*Math.pow(e,n)+s)},18021:function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var i=s(17955),n=s(17940),r=s(17944);class a{constructor(e,t,s,a,o=(()=>i.a.now())){this.batchEventEmitter=e,this.trackedBatchCount=0,this.logger=r.a.create(t,"Batching"),this.batchEventEmitter.on("batchBegin",e=>{this.startBatchSequenceNumber=e.sequenceNumber,this.batchProcessingStartTimeStamp=o(),this.trackedBatchCount++}),this.batchEventEmitter.on("batchEnd",(e,t)=>{Object(n.a)(void 0!==this.startBatchSequenceNumber&&void 0!==this.batchProcessingStartTimeStamp,698);const i=t.sequenceNumber-this.startBatchSequenceNumber+1;i>=s&&this.logger.sendErrorEvent({eventName:"LengthTooBig",length:i,threshold:s,batchEndSequenceNumber:t.sequenceNumber,duration:o()-this.batchProcessingStartTimeStamp,batchError:void 0!==e}),this.trackedBatchCount%a==0&&this.logger.sendPerformanceEvent({eventName:"Length",length:i,samplingRate:a,batchEndSequenceNumber:t.sequenceNumber,duration:o()-this.batchProcessingStartTimeStamp}),this.startBatchSequenceNumber=void 0,this.batchProcessingStartTimeStamp=void 0})}}const o=(e,t,s=1e3,i=1e3)=>new a(e,t,s,i)},18022:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));var i=s(17971);class n{constructor(e,t){this.messageSize=new Map,this._nonSystemOpCount=0,this._opsSizeAccumulator=0,t||(e.inbound.on("push",e=>{var t;const s="string"==typeof e.contents?e.contents:null!==(t=JSON.stringify(e.contents))&&void 0!==t?t:"",i=n.messageHasData(e)?e.data:"";this.messageSize[n.messageId(e)]=s.length+i.length}),e.on("op",e=>{var t;this._nonSystemOpCount+=Object(i.b)(e)?1:0;const s=n.messageId(e);this._opsSizeAccumulator+=null!==(t=this.messageSize[s])&&void 0!==t?t:0,this.messageSize.delete(s)}))}get nonSystemOpCount(){return this._nonSystemOpCount}get opsSizeAccumulator(){return this._opsSizeAccumulator}static messageId(e){return e.sequenceNumber}static messageHasData(e){return void 0!==e.data}reset(){this._nonSystemOpCount=0,this._opsSizeAccumulator=0}}},18023:function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var i=s(17983),n=s(17940);class r{constructor(e,t){this.storageGetter=e,this.blobs=t}static async serializeTree(e,t){const s={};return await this.serializeTreeCore(e,s,t),s}static async serializeTreeCore(e,t,s){const n=[];for(const i of Object.values(e.trees))n.push(this.serializeTreeCore(i,t,s));for(const r of Object.values(e.blobs)){const e=await s.readBlob(r);t[r]=Object(i.c)(e,"utf8")}return Promise.all(n)}static serializeTreeWithBlobContents(e){const t={};return this.serializeTreeWithBlobContentsCore(e,t),t}static serializeTreeWithBlobContentsCore(e,t){for(const s of Object.values(e.trees))this.serializeTreeWithBlobContentsCore(s,t);for(const s of Object.values(e.blobs)){const r=e.blobsContents[s];Object(n.a)(!!r,748),t[s]=Object(i.c)(r,"utf8")}}get storage(){return this._storage||(this._storage=this.storageGetter()),this._storage}get repositoryUrl(){return this.storage.repositoryUrl}async readBlob(e){return void 0!==this.blobs[e]?Object(i.d)(this.blobs[e],"utf8"):this.storage.readBlob(e)}async getSnapshotTree(e){return this.storage.getSnapshotTree(e)}async getVersions(e,t){return this.storage.getVersions(e,t)}async createBlob(e){return this.storage.createBlob(e)}async uploadSummaryWithContext(e,t){return this.storage.uploadSummaryWithContext(e,t)}async downloadSummary(e){return this.storage.downloadSummary(e)}}},18024:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));var i=s(17957);class n{constructor(e){this.map=new Map;for(const t of e){if(this.map.has(t[0]))throw new i.f("Duplicate entry names exist");this.map.set(t[0],t[1])}}get IFluidDataStoreRegistry(){return this}async get(e){if(this.map.has(e))return this.map.get(e)}}},18025:function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));class i{constructor(e){this.request=e;const t=this.request.url.indexOf("?");this.query=t>=0?this.request.url.substring(t):""}static getPathParts(e){const t=e.indexOf("?");return e.substring(0,t<0?e.length:t).split("/").reduce((e,t)=>(void 0!==t&&t.length>0&&e.push(decodeURIComponent(t)),e),[])}static create(e){return e instanceof i?e:new i(e)}get url(){return this.request.url}get headers(){return this.request.headers}get pathParts(){return void 0===this.requestPathParts&&(this.requestPathParts=i.getPathParts(this.url)),this.requestPathParts}isLeaf(e){return""===this.query&&this.pathParts.length===e}createSubRequest(e){const t=this.pathParts.length;if(e<0||e>t)throw new Error("incorrect sub-request");if(e===t&&this.url.includes("?"))return{url:"/"+this.query,headers:this.headers};const s="/"+this.pathParts.slice(e).join("/");return{url:""===this.query?s:`${s}/${this.query}`,headers:this.headers}}}},18026:function(e,t,s){"use strict";s.d(t,"a",(function(){return i})),s.d(t,"b",(function(){return n})),s.d(t,"d",(function(){return r})),s.d(t,"c",(function(){return a}));const i="connected",n="disconnected";function r(e,t,s,...i){try{e.emit(s,...i)}catch(n){t.sendErrorEvent({eventName:"RaiseEventError",event:s},n)}}function a(e,t,s,r){try{s?t.emit(i,r):t.emit(n)}catch(a){e.sendErrorEvent({eventName:"RaiseConnectedEventError"},a)}}},18027:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));var i=s(17955);class n{constructor(e){this.startTick=e,this.lastTick=e}static start(){const e=i.a.now();return new n(e)}trace(){const e=i.a.now(),t={totalTimeElapsed:e-this.startTick,duration:e-this.lastTick,tick:e};return this.lastTick=e,t}}},18028:function(e,t,s){"use strict";async function i(e,t){const s=e.trees[".protocol"].blobs.attributes;return(await t(s)).sequenceNumber}s.d(t,"a",(function(){return i}))},18029:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));var i=s(17960);class n extends i.a{constructor(){super(...arguments),this.serializedRoutes=new Set}getSerializedRoutes(){return Array.from(this.serializedRoutes)}serializeHandle(e,t){return this.serializedRoutes.add(e.absolutePath),super.serializeHandle(e,t)}}},18030:function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var i=s(18032),n=s(17940),r=s(18031);function a(e){return void 0!==e&&"number"==typeof e.pendingMessageId&&("add"===e.type||"edit"===e.type)}function o(e){return void 0!==e&&"clear"===e.type&&"number"==typeof e.pendingMessageId}class c{constructor(e,t,s,i,n){this.serializer=e,this.handle=t,this.submitMessage=s,this.isAttached=i,this.eventEmitter=n,this.messageHandlers=new Map,this.data=new Map,this.pendingKeys=new Map,this.pendingMessageId=-1,this.pendingClearMessageIds=[],this.localValueMaker=new r.a(e),this.messageHandlers=this.getMessageHandlers()}get size(){return this.data.size}keys(){return this.data.keys()}entries(){const e=this.data.entries();return{next(){const t=e.next();return t.done?{value:void 0,done:!0}:{value:[t.value[0],t.value[1].value],done:!1}},[Symbol.iterator](){return this}}}values(){const e=this.data.values();return{next(){const t=e.next();return t.done?{value:void 0,done:!0}:{value:t.value.value,done:!1}},[Symbol.iterator](){return this}}}[Symbol.iterator](){return this.entries()}forEach(e){this.data.forEach((t,s,i)=>{e(t.value,s,i)})}get(e){const t=this.data.get(e);return void 0===t?void 0:t.value}has(e){return this.data.has(e)}set(e,t){if(null==e)throw new Error("Undefined and null keys are not supported");const s=this.localValueMaker.fromInMemory(t),i=Object(r.b)(s,this.serializer,this.handle),n=this.setCore(e,s,!0);if(!this.isAttached())return;const a={key:e,type:"set",value:i};this.submitMapKeyMessage(a,n)}delete(e){const t=this.deleteCore(e,!0);if(!this.isAttached())return void 0!==t;const s={key:e,type:"delete"};return this.submitMapKeyMessage(s,t),void 0!==t}clear(){const e=this.isAttached()?new Map(this.data):void 0;if(this.clearCore(!0),!this.isAttached())return;this.submitMapClearMessage({type:"clear"},e)}getSerializedStorage(e){const t={};return this.data.forEach((s,i)=>{t[i]=s.makeSerialized(e,this.handle)}),t}getSerializableStorage(e){const t={};return this.data.forEach((s,i)=>{t[i]=Object(r.b)(s,e,this.handle)}),t}serialize(e){return JSON.stringify(this.getSerializableStorage(e))}populateFromSerializable(e){for(const[t,s]of Object.entries(e)){const e={key:t,value:this.makeLocal(t,s)};this.data.set(e.key,e.value)}}populate(e){this.populateFromSerializable(JSON.parse(e))}trySubmitMessage(e,t){const s=this.messageHandlers.get(e.type);return void 0!==s&&(s.submit(e,t),!0)}tryGetStashedOpLocalMetadata(e){const t=this.messageHandlers.get(e.type);if(void 0===t)throw new Error("no apply stashed op handler");return t.getStashedOpLocalMetadata(e)}tryProcessMessage(e,t,s){const i=this.messageHandlers.get(e.type);return void 0!==i&&(i.process(e,t,s),!0)}rollback(e,t){if(void 0===(s=t)||"number"!=typeof s.pendingMessageId||"add"!==s.type&&"edit"!==s.type&&"clear"!==s.type)throw new Error("Invalid localOpMetadata");var s;if("clear"===e.type&&"clear"===t.type){if(void 0===t.previousMap)throw new Error("Cannot rollback without previous map");t.previousMap.forEach((e,t)=>{this.setCore(t,e,!0)});const e=this.pendingClearMessageIds.pop();if(void 0===e||e!==t.pendingMessageId)throw new Error("Rollback op does match last clear")}else{if("delete"!==e.type&&"set"!==e.type)throw new Error("Unsupported op for rollback");{if("add"===t.type)this.deleteCore(e.key,!0);else{if("edit"!==t.type||void 0===t.previousValue)throw new Error("Cannot rollback without previous value");this.setCore(e.key,t.previousValue,!0)}const s=this.pendingKeys.get(e.key),i=null==s?void 0:s.pop();if(!s||i!==t.pendingMessageId)throw new Error("Rollback op does not match last pending");0===s.length&&this.pendingKeys.delete(e.key)}}}setCore(e,t,s){const i=this.data.get(e),n=null==i?void 0:i.value;return this.data.set(e,t),this.eventEmitter.emit("valueChanged",{key:e,previousValue:n},s,this.eventEmitter),i}clearCore(e){this.data.clear(),this.eventEmitter.emit("clear",e,this.eventEmitter)}deleteCore(e,t){const s=this.data.get(e),i=null==s?void 0:s.value;return this.data.delete(e)&&this.eventEmitter.emit("valueChanged",{key:e,previousValue:i},t,this.eventEmitter),s}clearExceptPendingKeys(){const e=new Map;this.pendingKeys.forEach((t,s)=>{e.set(s,this.data.get(s))}),this.clearCore(!1),e.forEach((e,t)=>{this.setCore(t,e,!0)})}makeLocal(e,t){if(t.type===i.a[i.a.Plain]||t.type===i.a[i.a.Shared])return this.localValueMaker.fromSerializable(t);throw new Error("Unknown local value type")}needProcessKeyOperation(e,t,s){if(this.pendingClearMessageIds.length>0)return t&&Object(n.a)(void 0!==s&&a(s)&&s.pendingMessageId<this.pendingClearMessageIds[0],19),!1;if(void 0!==this.pendingKeys.get(e.key)){if(t){Object(n.a)(void 0!==s&&a(s),20);const t=this.pendingKeys.get(e.key);Object(n.a)(void 0!==t&&t[0]===s.pendingMessageId,762),t.shift(),0===t.length&&this.pendingKeys.delete(e.key)}return!1}return!t}getMessageHandlers(){const e=new Map;return e.set("clear",{process:(e,t,s)=>{if(t){Object(n.a)(o(s),21);const e=this.pendingClearMessageIds.shift();Object(n.a)(e===s.pendingMessageId,763)}else 0===this.pendingKeys.size?this.clearCore(t):this.clearExceptPendingKeys()},submit:(e,t)=>{Object(n.a)(o(t),764);const s=this.pendingClearMessageIds.shift();Object(n.a)(s===t.pendingMessageId,765),this.submitMapClearMessage(e,t.previousMap)},getStashedOpLocalMetadata:e=>({type:"clear",pendingMessageId:this.getMapClearMessageId()})}),e.set("delete",{process:(e,t,s)=>{this.needProcessKeyOperation(e,t,s)&&this.deleteCore(e.key,t)},submit:(e,t)=>{this.resubmitMapKeyMessage(e,t)},getStashedOpLocalMetadata:e=>({type:"edit",pendingMessageId:this.getMapKeyMessageId(e)})}),e.set("set",{process:(e,t,s)=>{if(!this.needProcessKeyOperation(e,t,s))return;const i=this.makeLocal(e.key,e.value);this.setCore(e.key,i,t)},submit:(e,t)=>{this.resubmitMapKeyMessage(e,t)},getStashedOpLocalMetadata:e=>({type:"edit",pendingMessageId:this.getMapKeyMessageId(e)})}),e}getMapClearMessageId(){const e=++this.pendingMessageId;return this.pendingClearMessageIds.push(e),e}submitMapClearMessage(e,t){const s={type:"clear",pendingMessageId:this.getMapClearMessageId(),previousMap:t};this.submitMessage(e,s)}getMapKeyMessageId(e){const t=++this.pendingMessageId,s=this.pendingKeys.get(e.key);return void 0!==s?s.push(t):this.pendingKeys.set(e.key,[t]),t}submitMapKeyMessage(e,t){const s=this.getMapKeyMessageId(e),i=t?{type:"edit",pendingMessageId:s,previousValue:t}:{type:"add",pendingMessageId:s};this.submitMessage(e,i)}resubmitMapKeyMessage(e,t){Object(n.a)(a(t),766);const s=this.pendingKeys.get(e.key);Object(n.a)(void 0!==s&&s[0]===t.pendingMessageId,767),s.shift(),0===s.length&&this.pendingKeys.delete(e.key);const i=this.getMapKeyMessageId(e),r="edit"===t.type?{type:"edit",pendingMessageId:i,previousValue:t.previousValue}:{type:"add",pendingMessageId:i};this.submitMessage(e,r)}}},18031:function(e,t,s){"use strict";s.d(t,"b",(function(){return r})),s.d(t,"a",(function(){return o}));var i=s(18032),n=s(18033);function r(e,t,s){const i=e.makeSerialized(t,s);return{type:i.type,value:i.value&&JSON.parse(i.value)}}class a{constructor(e){this.value=e}get type(){return i.a[i.a.Plain]}makeSerialized(e,t){const s=Object(n.d)(this.value,e,t);return{type:this.type,value:s}}}class o{constructor(e){this.serializer=e}fromSerializable(e){if(e.type===i.a[i.a.Shared]){e.type=i.a[i.a.Plain];const t={type:"__fluid_handle__",url:e.value};e.value=t}const t=Object(n.c)(e.value,this.serializer);return new a(t)}fromInMemory(e){return new a(e)}}},18032:function(e,t,s){"use strict";var i;s.d(t,"a",(function(){return i})),function(e){e[e.Shared=0]="Shared",e[e.Plain=1]="Plain"}(i||(i={}))},18033:function(e,t,s){"use strict";s.d(t,"d",(function(){return n})),s.d(t,"b",(function(){return r})),s.d(t,"c",(function(){return a})),s.d(t,"a",(function(){return o}));var i=s(17991);function n(e,t,s){return void 0!==e?t.stringify(e,s):e}function r(e,t,s){return t.encode(e,s)}function a(e,t){return void 0!==e?t.parse(JSON.stringify(e)):e}function o(e,t){const s=new i.a;return s.addBlob(e,t),s.getSummaryTree()}},18034:function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var i=s(18062),n=s(18035);class r extends n.a{constructor(e,t,s){super(e,t,s,i.b.segmentFromSpec),this.id=t}static create(e,t){return e.createChannel(t,i.b.Type)}static getFactory(){return new i.b}getRange(e,t){return this.getItems(e,t)}}},18035:function(e,t,s){"use strict";s.d(t,"b",(function(){return a})),s.d(t,"a",(function(){return o}));var i=s(18036),n=s(18047),r=s(18049);class a extends i.a{constructor(e){super(),this.items=e,this.type=a.typeString,this.cachedLength=e.length}static is(e){return e.type===a.typeString}static fromJSONObject(e){if(e&&"object"==typeof e&&"items"in e){const t=new a(e.items);return e.props&&t.addProperties(e.props),t}}toJSONObject(){const e={items:this.items};return super.addSerializedProps(e),e}clone(e=0,t){const s=this.items.slice(e,t),i=new a(s);return this.cloneInto(i),i}canAppend(e){return a.is(e)&&(this.cachedLength<=128||e.cachedLength<=128)}toString(){return this.items.toString()}append(e){if(!a.is(e))throw new Error("can only append another run segment");n.b.append(this,e),this.items=this.items.concat(e.items),this.cachedLength=this.items.length}removeRange(e,t){let s=[];const i=this.items.length;return e>0&&(s=s.concat(this.items.slice(0,e))),t<i&&(s=s.concat(this.items.slice(t))),this.items=s,this.cachedLength=this.items.length,0===this.items.length}createSplitSegmentAt(e){if(e>0){const t=this.items.slice(e);this.items=this.items.slice(0,e),this.cachedLength=this.items.length;return new a(t)}}}a.typeString="SubSequence";class o extends r.a{constructor(e,t,s,i){super(e,t,s,i),this.id=t}insert(e,t,s){const i=new a(t);s&&i.addProperties(s);const n=this.client.insertSegmentLocal(e,i);n&&this.submitSequenceMessage(n)}remove(e,t){this.removeRange(e,t)}getItemCount(){return this.getLength()}getItems(e,t){const s=[];let i;return void 0!==t&&t<=e||(this.walkSegments(e=>(a.is(e)&&(void 0===i&&(i=e),s.push(...e.items)),!0),e,t),void 0!==i&&s.splice(0,e-this.getPosition(i)),void 0!==t&&s.splice(t-e)),s}}},18036:function(e,t,s){"use strict";s.d(t,"f",(function(){return f})),s.d(t,"a",(function(){return k})),s.d(t,"b",(function(){return N})),s.d(t,"d",(function(){return R})),s.d(t,"e",(function(){return P})),s.d(t,"c",(function(){return _}));var i=s(17940),n=s(17957),r=s(18040),a=s(18037),o=s(18047),c=s(18046),l=s(18043),u=s(18039),h=s(18048),d=s(18041),m=s(18038),g=s(18042),p=s(18045);function f(e){if(void 0!==(null==e?void 0:e.removedClientIds)&&void 0!==(null==e?void 0:e.removedSeq))return e;Object(i.a)(void 0===(null==e?void 0:e.removedClientIds)&&void 0===(null==e?void 0:e.removedSeq),703)}function b(e){const t=f(e);return void 0!==t&&t.removedSeq!==a.d}class v{constructor(){this.index=0,this.ordinal="",this.cachedLength=0}isLeaf(){return!1}}function S(e,t){const s=Object(m.e)(e);if(s)for(const i of s)t[i]=e}function y(e,t){const s=Object(m.e)(e);if(s)for(const i of s)void 0===t[i]&&(t[i]=e)}function C(e,t){for(const s in t){const i=t[s];if(!i.empty()){let t=e[s];void 0===t&&(t=new r.f,e[s]=t);for(const e of i.items)O(t,e)}}}function O(e,t){if(Object(m.j)(t,u.b.NestBegin))return e.push(t),!0;{const s=e.top();return s&&Object(m.j)(s,u.b.NestBegin)?e.pop():e.push(t),!1}}class w extends v{constructor(e){super(),this.childCount=e,this.children=new Array(8)}hierBlock(){}setOrdinal(e,t){let s,n=this.childCount;8===n&&(n=7),Object(i.a)(n>=1&&n<=7,64);const r=1<<8-(n+1);if(0===t)s=r-1;else{const e=this.children[t-1].ordinal;s=e.charCodeAt(e.length-1)+r}e.ordinal=this.ordinal+String.fromCharCode(s),Object(i.a)(e.ordinal.length===this.ordinal.length+1,65),t>0&&Object(i.a)(e.ordinal>this.children[t-1].ordinal,66)}assignChild(e,t,s=!0){e.parent=this,e.index=t,s&&this.setOrdinal(e,t),this.children[t]=e}}class T extends w{constructor(e){super(e),this.rightmostTiles=Object(d.d)(),this.leftmostTiles=Object(d.d)(),this.rangeStacks=Object(d.d)()}addNodeReferences(e,t){!function(e,t,s,i,n){var a;function o(e,t){let s=n[e];void 0===s&&(s=new r.f,n[e]=s),O(s,t)}if(t.isLeaf()){const n=t;if((null!==(a=e.localNetLength(n))&&void 0!==a?a:0)>0)if(N.is(n)){const t=n.getId();if(t&&e.mapIdToSegment(t,n),Object(m.j)(n,u.b.Tile)&&(S(n,s),y(n,i)),n.refType&(u.b.NestBegin|u.b.NestEnd)){const e=Object(m.d)(n);if(e)for(const t of e)o(t,n)}}else{const e=t;if(e.localRefs&&void 0!==e.localRefs.hierRefCount&&e.localRefs.hierRefCount>0)for(const t of e.localRefs)if(Object(m.j)(t,u.b.Tile)&&(S(t,s),y(t,i)),t.refType&(u.b.NestBegin|u.b.NestEnd))for(const e of Object(m.d)(t))o(e,t)}}else{const e=t;C(n,e.rangeStacks),Object(d.e)(s,e.rightmostTiles),Object(d.f)(i,e.leftmostTiles)}}(e,t,this.rightmostTiles,this.leftmostTiles,this.rangeStacks)}hierBlock(){return this}hierToString(e){let t="";for(const s in this.rangeStacks){const i=this.rangeStacks[s];t+=L(e),t+=s+": ";for(const e of i.items)t+=e.toString()+" ";t+="\n"}return t}}class k extends v{constructor(){super(...arguments),this.clientId=a.a,this.seq=a.e,this.segmentGroups=new g.a(this),this.trackingCollection=new l.a(this)}addProperties(e,t,s,i){return this.propertyManager||(this.propertyManager=new p.a),this.properties||(this.properties=Object(d.d)()),this.propertyManager.addProperties(this.properties,e,t,s,i&&i.collaborating)}hasProperty(e){return!!this.properties&&void 0!==this.properties[e]}isLeaf(){return!0}cloneInto(e){var t;e.clientId=this.clientId,e.properties=Object(d.b)(this.properties),e.removedClientIds=null===(t=this.removedClientIds)||void 0===t?void 0:t.slice(),e.removedSeq=this.removedSeq,e.seq=this.seq}canAppend(e){return!1}addSerializedProps(e){this.properties&&(e.props=this.properties)}ack(e,t,s){const n=this.segmentGroups.dequeue();switch(Object(i.a)(n===e,67),t.op.type){case u.a.ANNOTATE:return Object(i.a)(!!this.propertyManager,68),this.propertyManager.ackPendingProperties(t.op),!0;case u.a.INSERT:return Object(i.a)(this.seq===a.d,69),this.seq=t.sequencedMessage.sequenceNumber,this.localSeq=void 0,!0;case u.a.REMOVE:const e=f(this);return Object(i.a)(void 0!==e,70),this.localRemovedSeq=void 0,e.removedSeq===a.d&&(e.removedSeq=t.sequencedMessage.sequenceNumber,!0);default:throw new Error(t.op.type+" is in unrecognized operation type")}}splitAt(e){var t;if(e>0){const s=this.createSplitSegmentAt(e);return s&&(this.copyPropertiesTo(s),s.parent=this.parent,s.ordinal=this.ordinal+String.fromCharCode(0),s.removedClientIds=null===(t=this.removedClientIds)||void 0===t?void 0:t.slice(),s.removedSeq=this.removedSeq,s.localRemovedSeq=this.localRemovedSeq,s.seq=this.seq,s.localSeq=this.localSeq,s.clientId=this.clientId,this.segmentGroups.copyTo(s),this.trackingCollection.copyTo(s),this.localRefs&&this.localRefs.split(e,s)),s}}copyPropertiesTo(e){this.propertyManager&&this.properties&&(e.propertyManager=new p.a,e.properties=this.propertyManager.copyTo(this.properties,e.properties,e.propertyManager))}}class N extends k{constructor(e){super(),this.refType=e,this.type=N.type,this.cachedLength=1}static is(e){return e.type===N.type}static make(e,t){const s=new N(e);return t&&s.addProperties(t),s}toJSONObject(){const e={marker:{refType:this.refType}};return super.addSerializedProps(e),e}static fromJSONObject(e){if(e&&"object"==typeof e&&"marker"in e)return N.make(e.marker.refType,e.props)}clone(){const e=N.make(this.refType,this.properties);return this.cloneInto(e),e}getSegment(){return this}getOffset(){return 0}hasSimpleType(e){return!!this.properties&&this.properties.markerSimpleType===e}getProperties(){return this.properties}getId(){if(this.properties&&this.properties.markerId)return this.properties.markerId}hasTileLabels(){return Object(m.i)(this)}hasRangeLabels(){return Object(m.g)(this)}hasTileLabel(e){return Object(m.h)(this,e)}hasRangeLabel(e){return Object(m.f)(this,e)}getTileLabels(){return Object(m.e)(this)}getRangeLabels(){return Object(m.d)(this)}toString(){let e="";Object(m.j)(this,u.b.Tile)&&(e+="Tile"),Object(m.j)(this,u.b.NestBegin)&&(e.length>0&&(e+="; "),e+="RangeBegin"),Object(m.j)(this,u.b.NestEnd)&&(e.length>0&&(e+="; "),e+="RangeEnd");let t="";const s=this.getId();s&&(e+=` (${s}) `);const i=Object(m.e)(this);if(i){t+="tile -- ";for(let e=0,s=i.length;e<s;e++){e>0&&(t+="; "),t+=i[e]}}const n=Object(m.d)(this);if(n){let e="begin";Object(m.j)(this,u.b.NestEnd)&&(e="end"),i&&(t+=" "),t+=`range ${e} -- `;const s=n;for(let i=0,n=s.length;i<n;i++){i>0&&(t+="; "),t+=s[i]}}let r="";return this.properties&&(r+=JSON.stringify(this.properties,(e,t)=>{const s=!!t&&t.IFluidHandle;return s?`#Handle(${s.routeContext.path}/${s.path})`:t})),`M ${e}: ${t} ${r}`}createSplitSegmentAt(e){}canAppend(e){return!1}append(){throw new Error("Can not append to marker")}}var j;N.type="Marker",function(e){e[e.Go=0]="Go",e[e.Stop=1]="Stop",e[e.Yield=2]="Yield"}(j||(j={}));class M{constructor(e,t,s,i,n,r,a,o,c=0){this.block=e,this.actions=t,this.pos=s,this.refSeq=i,this.clientId=n,this.context=r,this.start=a,this.end=o,this.childindex=c,this.op=j.Go}}class q{constructor(){this.clientId=a.a,this.collaborating=!1,this.minSeq=0,this.currentSeq=0,this.localSeq=0}loadFrom(e){this.clientId=e.clientId,this.collaborating=e.collaborating,this.minSeq=e.minSeq,this.currentSeq=e.currentSeq}}const R=(e,t)=>e-t,P=(e,t)=>e.localeCompare(t),I=[""," ","  "];function L(e){if(void 0===I[e]){I[e]="";for(let t=0;t<e;t++)I[e]+=" "}return I[e]}const E={min:{maxSeq:-2},compare:(e,t)=>e.maxSeq-t.maxSeq};function A(e,t){for(const s of t.rangeLabels)if(Object(m.f)(e,s)){let i=t.stacks[s];void 0===i&&(i=new r.f,t.stacks[s]=i),O(i,e)}}function x(e,t,s,i,n,r,a){return N.is(e)&&e.refType&(u.b.NestBegin|u.b.NestEnd)&&A(e,a),!1}function D(e,t,s,i,n,r,a){var o;if(e.isLeaf()){const t=e;(null!==(o=a.mergeTree.localNetLength(t))&&void 0!==o?o:0)>0&&N.is(t)&&t.refType&(u.b.NestBegin|u.b.NestEnd)&&A(t,a)}else{const t=e;C(a.stacks,t.rangeStacks)}return!0}function z(e,t,s,i,n,r,a){return N.is(e)&&Object(m.h)(e,a.tileLabel)&&(a.tile=e),!1}function B(e,t,s,i,n,r,a){if(e.isLeaf()){const t=e;a.mergeTree.localNetLength(t)>0&&N.is(t)&&Object(m.h)(t,a.tileLabel)&&(a.tile=t)}else{const t=e;let s;s=a.posPrecedesTile?t.rightmostTiles[a.tileLabel]:t.leftmostTiles[a.tileLabel],void 0!==s&&(a.tile=s)}return!0}const F={min:{minRequired:Number.MIN_VALUE,onMinGE:()=>{Object(i.a)(!1,72)}},compare:(e,t)=>e.minRequired-t.minRequired};class _{constructor(e){this.options=e,this.blockUpdateActions=_.initBlockUpdateActions,this.collabWindow=new q,this.idToSegment=new Map,this.splitLeafSegment=(e,t)=>{if(!(t>0&&e))return{};const s=e.splitAt(t);return this.mergeTreeMaintenanceCallback&&this.mergeTreeMaintenanceCallback({operation:c.a.SPLIT,deltaSegments:[{segment:e},{segment:s}]},void 0),{next:s}},this.root=this.makeBlock(0)}makeBlock(e){const t=new T(e);return t.ordinal="",t}clone(){const e=new _(this.options);e.root=e.blockClone(this.root)}blockClone(e,t){const s=this.makeBlock(e.childCount);for(let i=0;i<e.childCount;i++){const n=e.children[i];if(n.isLeaf()){const e=this.segmentClone(n);s.assignChild(e,i),t&&t.push(e)}else s.assignChild(this.blockClone(n,t),i)}return this.nodeUpdateLengthNewStructure(s),this.nodeUpdateOrdinals(s),s}segmentClone(e){return e.clone()}localNetLength(e){return void 0!==f(e)?0:e.cachedLength}mapIdToSegment(e,t){this.idToSegment.set(e,t)}addNode(e,t){const s=e.childCount++;return e.assignChild(t,s,!1),s}reloadFromSegments(e){Object(i.a)(!this.collabWindow.collaborating,73);const t=e=>{const s=Math.ceil(e.length/7),i=new Array(s);for(let t=0,n=0;n<s;n++){const s=i[n]=this.makeBlock(0);for(let i=0;i<7&&t<e.length;i++,t++)this.addNode(s,e[t]);this.blockUpdate(s)}return 1===i.length?i[0]:t(i)};e.length>0?(this.root=t(e),this.nodeUpdateOrdinals(this.root)):this.root=this.makeBlock(0)}startCollaboration(e,t,s){this.collabWindow.clientId=e,this.collabWindow.minSeq=t,this.collabWindow.collaborating=!0,this.collabWindow.currentSeq=s,this.segmentsToScour=new r.a([],E),this.pendingSegments=Object(r.c)(),this.nodeUpdateLengthNewStructure(this.root,!0)}addToLRUSet(e,t){!0!==e.parent.needsScour&&t>this.collabWindow.currentSeq&&(e.parent.needsScour=!0,this.segmentsToScour.add({segment:e,maxSeq:t}))}underflow(e){return e.childCount<4}scourNode(e,t){let s;for(let i=0;i<e.childCount;i++){const n=e.children[i];if(n.isLeaf()){const e=n;if(e.segmentGroups.empty)if(void 0!==e.removedSeq)e.removedSeq>this.collabWindow.minSeq?t.push(e):e.trackingCollection.empty?(this.mergeTreeMaintenanceCallback&&this.mergeTreeMaintenanceCallback({operation:c.a.UNLINK,deltaSegments:[{segment:e}]},void 0),e.parent=void 0):t.push(e),s=void 0;else if(e.seq<=this.collabWindow.minSeq){s&&s.canAppend(e)&&Object(d.g)(s.properties,e.properties)&&s.trackingCollection.matches(e.trackingCollection)&&this.localNetLength(e)>0?(s.append(e),this.mergeTreeMaintenanceCallback&&this.mergeTreeMaintenanceCallback({operation:c.a.APPEND,deltaSegments:[{segment:s},{segment:e}]},void 0),e.parent=void 0,e.trackingCollection.trackingGroups.forEach(t=>t.unlink(e))):(t.push(e),s=this.localNetLength(e)>0?e:void 0)}else t.push(e),s=void 0;else t.push(e),s=void 0}else t.push(n),s=void 0}}packParent(e){const t=e.children;let s,i;const n=[];for(s=0;s<e.childCount;s++)i=t[s],this.scourNode(i,n),i.parent=void 0;const r=n.length;let o=Math.min(7,Math.floor(r/4));o<1&&(o=1);const c=Math.floor(r/o);let l=r%o;const u=new Array(8);let h=0;for(let a=0;a<o;a++){let t=c;l>0&&(t++,l--);const s=this.makeBlock(t);for(let e=0;e<t;e++){const t=n[h++];s.assignChild(t,e,!1)}s.parent=e,u[a]=s,this.nodeUpdateLengthNewStructure(s)}e.children=u;for(let a=0;a<o;a++)e.assignChild(u[a],a,!1);e.childCount=o,this.underflow(e)&&e.parent?this.packParent(e.parent):(this.nodeUpdateOrdinals(e),this.blockUpdatePathLengths(e,a.d,-1,!0))}zamboniSegments(e=_.zamboniSegmentsMaxCount){if(this.collabWindow.collaborating)for(let t=0;t<e;t++){let e=this.segmentsToScour.peek();if(!e||e.maxSeq>this.collabWindow.minSeq)break;if(e=this.segmentsToScour.get(),e.segment.parent&&!1!==e.segment.parent.needsScour){const t=e.segment.parent,s=[];this.scourNode(t,s),t.needsScour=!1;const i=s.length;if(i<t.childCount){t.childCount=i,t.children=s;for(let e=0;e<i;e++)t.assignChild(s[e],e,!1);this.underflow(t)&&t.parent?this.packParent(t.parent):(this.nodeUpdateOrdinals(t),this.blockUpdatePathLengths(t,a.d,-1,!0))}}}}getCollabWindow(){return this.collabWindow}getStats(){const e=t=>{const s={maxHeight:0,nodeCount:0,leafCount:0,removedLeafCount:0,liveCount:0,histo:[]};for(let e=0;e<8;e++)s.histo[e]=0;for(let i=0;i<t.childCount;i++){const n=t.children[i];let r=1;if(n.isLeaf()){s.leafCount++;void 0!==n.removedSeq&&s.removedLeafCount++}else{const t=e(n);r=1+t.maxHeight,s.nodeCount+=t.nodeCount,s.leafCount+=t.leafCount,s.removedLeafCount+=t.removedLeafCount,s.liveCount+=t.liveCount;for(let e=0;e<8;e++)s.histo[e]+=t.histo[e]}r>s.maxHeight&&(s.maxHeight=r)}return s.histo[t.childCount]++,s.nodeCount++,s.liveCount+=t.childCount,s};return e(this.root)}getLength(e,t){return this.blockLength(this.root,e,t)}get length(){return this.root.cachedLength}getPosition(e,t,s){var i;let n,r=0,a=e.parent;for(;a;){const o=a.children;for(let c=0;c<a.childCount;c++){const a=o[c];if(n&&a===n||a===e)break;r+=null!==(i=this.nodeLength(a,t,s))&&void 0!==i?i:0}n=a,a=a.parent}return r}getContainingSegment(e,t,s){let i,n;return this.searchBlock(this.root,e,0,t,s,{leaf:(e,t,s,r,a)=>(i=e,n=a,!1)},void 0),{segment:i,offset:n}}_getSlideToSegment(e){if(!e.segment||!b(e.segment))return e;let t;const s=e=>!(e.seq!==a.d&&!b(e))||(t=e,!1);return this.rightExcursion(e.segment,s),t?{segment:t,offset:0}:(this.leftExcursion(e.segment,s),t=t,t?{segment:t,offset:t.cachedLength-1}:{segment:void 0,offset:0})}slideReferences(e,t){var s,n,r,c,l;Object(i.a)(b(e),753),Object(i.a)(!!e.localRefs,754);const u=this._getSlideToSegment({segment:e,offset:0}),h=u.segment;h&&!h.localRefs&&(h.localRefs=new o.b(h));for(const a of t){null===(n=null===(s=a.callbacks)||void 0===s?void 0:s.beforeSlide)||void 0===n||n.call(s);const t=e.localRefs.removeLocalRef(a);Object(i.a)(a===t,755),h?(a.segment=h,a.offset=null!==(r=u.offset)&&void 0!==r?r:0,Object(i.a)(!!h.localRefs,756),h.localRefs.addLocalRef(a)):(a.segment=void 0,a.offset=0),null===(l=null===(c=a.callbacks)||void 0===c?void 0:c.afterSlide)||void 0===l||l.call(c)}h&&this.blockUpdatePathLengths(h.parent,a.c,a.a)}updateSegmentRefsAfterMarkRemoved(e,t){if(!e.localRefs||e.localRefs.empty)return;const s=[],i=[];for(const n of e.localRefs)Object(m.j)(n,u.b.StayOnRemove)?i.push(n):Object(m.j)(n,u.b.SlideOnRemove)&&(t?i.push(n):s.push(n));t||this.slideReferences(e,s),e.localRefs.clear();for(const n of i)n.segment=e,e.localRefs.addLocalRef(n)}blockLength(e,t,s){return this.collabWindow.collaborating&&s!==this.collabWindow.clientId?e.partialLengths.getPartialLength(t,s):e.cachedLength}nodeLength(e,t,s){if(this.collabWindow.collaborating&&this.collabWindow.clientId!==s){if(e.isLeaf()){const i=e,n=f(i);if(void 0!==n&&n.removedSeq!==a.d&&n.removedSeq<=t)return;if(i.clientId===s||i.seq!==a.d&&i.seq<=t)return void 0!==n&&n.removedClientIds.includes(s)?0:i.cachedLength;if(void 0!==n&&n.removedSeq!==a.d)return;return 0}return e.partialLengths.getPartialLength(t,s)}return e.isLeaf()?this.localNetLength(e):e.cachedLength}addMinSeqListener(e,t){this.minSeqListeners||(this.minSeqListeners=new r.a([],F)),this.minSeqListeners.add({minRequired:e,onMinGE:t})}notifyMinSeqListeners(){if(this.minSeqListeners)for(;this.minSeqListeners.count()>0&&this.minSeqListeners.peek().minRequired<=this.collabWindow.minSeq;){this.minSeqListeners.get().onMinGE(this.collabWindow.minSeq)}}setMinSeq(e){Object(i.a)(e<=this.collabWindow.currentSeq,78),Object(i.a)(this.collabWindow.minSeq<=e,79),e>this.collabWindow.minSeq&&(this.collabWindow.minSeq=e,_.options.zamboniSegments&&this.zamboniSegments(),this.notifyMinSeqListeners())}referencePositionToLocalPosition(e,t=this.collabWindow.currentSeq,s=this.collabWindow.clientId){const i=e.getSegment();if(i&&i.parent){return(i.removedSeq?0:e.getOffset())+this.getPosition(i,t,s)}return o.a.DetachedPosition}getStackContext(e,t,s){const i={mergeTree:this,stacks:Object(d.d)(),rangeLabels:s};return this.search(e,a.e,t,{leaf:x,shift:D},i),i.stacks}findTile(e,t,s,i=!0){const n={mergeTree:this,posPrecedesTile:i,tileLabel:s};if(i?this.search(e,a.e,t,{leaf:z,shift:B},n):this.backwardSearch(e,a.e,t,{leaf:z,shift:B},n),n.tile){let e;if(n.tile.isLeaf()){const s=n.tile;e=this.getPosition(s,a.e,t)}else{e=n.tile.toPosition()}return{tile:n.tile,pos:e}}}search(e,t,s,i,n){return this.searchBlock(this.root,e,0,t,s,i,n)}searchBlock(e,t,s,i,n,r,a){var o;let c=t,l=s;const u=e.children;r&&r.pre&&r.pre(e,l,i,n,void 0,void 0,a);const h=r&&r.contains;for(let d=0;d<e.childCount;d++){const e=u[d],t=null!==(o=this.nodeLength(e,i,n))&&void 0!==o?o:0;if(!h&&c<t||h&&h(e,c,i,n,void 0,void 0,a))return e.isLeaf()?(r&&r.leaf&&r.leaf(e,l,i,n,c,-1,a),e):this.searchBlock(e,c,l,i,n,r,a);r&&r.shift&&r.shift(e,l,i,n,c,void 0,a),c-=t,l+=t}r&&r.post&&r.post(e,l,i,n,void 0,void 0,a)}backwardSearch(e,t,s,i,n){const r=this.getLength(t,s);if(!(e>r))return this.backwardSearchBlock(this.root,e,r,t,s,i,n)}backwardSearchBlock(e,t,s,i,n,r,a){var o;let c=s;const l=e.children;r&&r.pre&&r.pre(e,c,i,n,void 0,void 0,a);const u=r&&r.contains;for(let h=e.childCount-1;h>=0;h--){const e=l[h],s=c-(null!==(o=this.nodeLength(e,i,n))&&void 0!==o?o:0);if(!u&&t>=s||u&&u(e,t,i,n,void 0,void 0,a))return e.isLeaf()?(r&&r.leaf&&r.leaf(e,s,i,n,t,-1,a),e):this.backwardSearchBlock(e,t,c,i,n,r,a);r&&r.shift&&r.shift(e,s,i,n,t,void 0,a),c=s}r&&r.post&&r.post(e,c,i,n,void 0,void 0,a)}updateRoot(e){if(void 0!==e){const t=this.makeBlock(2);t.assignChild(this.root,0,!1),t.assignChild(e,1,!1),this.root=t,this.nodeUpdateOrdinals(this.root),this.nodeUpdateLengthNewStructure(this.root)}}ackPendingSegment(e){const t=e.sequencedMessage.sequenceNumber,s=this.pendingSegments.dequeue(),i=[];let n=!1;if(void 0!==s){const r=[];s.segments.map(a=>{const o=!a.ack(s,e,this);n=o||n,o||e.op.type!==u.a.REMOVE||this.updateSegmentRefsAfterMarkRemoved(a,!1),_.options.zamboniSegments&&this.addToLRUSet(a,t),i.includes(a.parent)||i.push(a.parent),r.push({segment:a})}),this.mergeTreeMaintenanceCallback&&this.mergeTreeMaintenanceCallback({deltaSegments:r,operation:c.a.ACKNOWLEDGED},e);const a=this.collabWindow.clientId;for(const e of i)this.blockUpdatePathLengths(e,t,a,n)}_.options.zamboniSegments&&this.zamboniSegments()}addToPendingList(e,t,s){let i=t;return void 0===i&&(i={segments:[],localSeq:s},this.pendingSegments.enqueue(i)),e.segmentGroups.enqueue(i),i}getMarkerFromId(e){return this.idToSegment.get(e)}posFromRelativePos(e,t=this.collabWindow.currentSeq,s=this.collabWindow.clientId){let i,n=-1;return e.id&&(i=this.getMarkerFromId(e.id)),i&&(n=this.getPosition(i,t,s),e.before?void 0!==e.offset&&(n-=e.offset):(n+=i.cachedLength,void 0!==e.offset&&(n+=e.offset))),n}insertSegments(e,t,s,i,n,r){this.ensureIntervalBoundary(e,s,i);const o=n===a.d?++this.collabWindow.localSeq:void 0;this.blockInsert(e,s,i,n,o,t),this.mergeTreeDeltaCallback&&void 0!==r&&this.mergeTreeDeltaCallback(r,{operation:u.a.INSERT,deltaSegments:t.map(e=>({segment:e}))}),this.collabWindow.collaborating&&_.options.zamboniSegments&&n!==a.d&&this.zamboniSegments()}insertAtReferencePosition(e,t,s){if(0===t.cachedLength)return;if(t.parent||t.removedSeq||t.seq!==a.e)throw new Error("Cannot insert segment that has already been inserted.");const n=e=>{let t=e.parent,s=t;for(;void 0!==t;){if(t.childCount>=8){const e=this.split(t);t===this.root?(this.updateRoot(e),s=void 0):(this.insertChildNode(t.parent,e,t.index+1),s=e.parent,this.blockUpdateLength(t.parent,a.d,r))}else this.blockUpdateLength(t,a.d,r);t=t.parent}s&&this.nodeUpdateOrdinals(s)},r=this.collabWindow.clientId,o=e.getSegment(),c=e.getOffset(),l=this.nodeLength(o,this.collabWindow.currentSeq,r);let h=o;if(0!==c&&void 0!==l&&0!==l){const e=this.splitLeafSegment(o,c);Object(i.a)(!!e.next,80),this.insertChildNode(o.parent,e.next,o.index+1),n(e.next),h=e.next}if(this.leftExcursion(h,e=>{if(!e.isLeaf())return!0;const t=this.nodeLength(e,this.collabWindow.currentSeq,r);return void 0===t||0===t&&(this.breakTie(0,e,a.d)&&(h=e),!0)}),this.collabWindow.collaborating?(t.localSeq=++this.collabWindow.localSeq,t.seq=a.d):t.seq=a.e,t.clientId=r,N.is(t)){const e=t.getId();e&&this.mapIdToSegment(e,t)}this.insertChildNode(h.parent,t,h.index),n(t),this.mergeTreeDeltaCallback&&this.mergeTreeDeltaCallback(s,{deltaSegments:[{segment:t}],operation:u.a.INSERT}),this.collabWindow.collaborating&&this.addToPendingList(t,void 0,t.localSeq)}resolveRemoteClientPosition(e,t,s){if(t<this.collabWindow.minSeq)return;const i=this.getContainingSegment(e,t,s),n=this.getCollabWindow();if(i&&i.segment){return this.getPosition(i.segment,n.currentSeq,n.clientId)+i.offset}return e===this.getLength(t,s)?this.getLength(n.currentSeq,n.clientId):void 0}insertChildNode(e,t,s){Object(i.a)(e.childCount<8,81);for(let i=e.childCount;i>s;i--)e.children[i]=e.children[i-1],e.children[i].index=i;e.childCount++,e.assignChild(t,s,!1)}blockInsert(e,t,s,i,n,r){let o=!1;const c=e=>(e.seq===a.d&&(o=!0),!1),l=e=>(o=!1,this.rightExcursion(e,c),o);let u;const h=e=>{this.collabWindow.collaborating&&(e.seq===a.d&&s===this.collabWindow.clientId?u=this.addToPendingList(e,u,n):e.seq>this.collabWindow.minSeq&&_.options.zamboniSegments&&this.addToLRUSet(e,e.seq))},d=(e,t,s)=>{const i={};return e?(i.replaceCurrent=s.candidateSegment,i.next=e):i.next=s.candidateSegment,i};let m=e;for(const a of r)if(o=!1,a.cachedLength>0){if(a.seq=i,a.localSeq=n,a.clientId=s,N.is(a)){const e=a.getId();e&&this.mapIdToSegment(e,a)}const e=this.insertingWalk(this.root,m,t,s,i,{leaf:d,candidateSegment:a,continuePredicate:l});if(void 0===a.parent)throw new Error("MergeTree insert failed: "+JSON.stringify({currentSeq:this.collabWindow.currentSeq,minSeq:this.collabWindow.minSeq,segSeq:a.seq}));this.updateRoot(e),h(a),m+=a.cachedLength}}ensureIntervalBoundary(e,t,s){const i=this.insertingWalk(this.root,e,t,s,a.c,{leaf:this.splitLeafSegment});this.updateRoot(i)}breakTie(e,t,s){var i;if(t.isLeaf()){if(0===e){return(s===a.d?Number.MAX_SAFE_INTEGER:s)>(t.seq===a.d?Number.MAX_SAFE_INTEGER-1:null!==(i=t.seq)&&void 0!==i?i:0)}return!1}return!0}leftExcursion(e,t){let s=!0,i=e,n=i.parent;for(;n;){const e=n.children;let r,o,c=!1;for(r=n.childCount-1;r>=0;r--)if(o=e[r],c){if(o.isLeaf())s=t(o,0,a.e,this.collabWindow.clientId,0,0,void 0);else{const e=o;s=this.nodeMapReverse(e,t,0,a.e,this.collabWindow.clientId)}if(!s)return}else c=i===o;i=n,n=n.parent}}rightExcursion(e,t){let s=!0,i=e,n=i.parent;for(;n;){const e=n.children;let r,a,o=!1;for(r=0;r<n.childCount;r++)if(a=e[r],o){if(a.isLeaf())s=t(a);else{const e=a;s=this.walkAllSegments(e,t)}if(!s)return}else o=i===a;i=n,n=n.parent}}insertingWalk(e,t,s,i,n,r){let o=t;const c=e.children;let l,u,h,d;for(l=0;l<e.childCount;l++){u=c[l];const t=this.nodeLength(u,s,i);if(void 0!==t){if(o<t||o===t&&this.breakTie(o,u,n)){if(u.isLeaf()){const t=u,s=r.leaf(t,o,r);if(s.replaceCurrent&&(e.assignChild(s.replaceCurrent,l,!1),s.replaceCurrent.ordinal=u.ordinal),!s.next)return void(r.structureChange&&this.nodeUpdateLengthNewStructure(e));h=s.next,l++}else{const a=u,c=this.insertingWalk(a,o,s,i,n,r);if(void 0===c)return void(r.structureChange?this.nodeUpdateLengthNewStructure(e):this.blockUpdateLength(e,n,i));if(c===_.theUnfinishedNode){o-=t;continue}h=c,d=c,l++}break}o-=t}}if(!h&&0===o){if(n!==a.d&&r.continuePredicate&&r.continuePredicate(e))return _.theUnfinishedNode;h=r.leaf(void 0,o,r).next}if(h){for(let t=e.childCount;t>l;t--)e.children[t]=e.children[t-1],e.children[t].index=t;return e.assignChild(h,l,!1),e.childCount++,e.setOrdinal(h,l),e.childCount<8?(d&&this.nodeUpdateOrdinals(d),void(r.structureChange?this.nodeUpdateLengthNewStructure(e):this.blockUpdateLength(e,n,i))):this.split(e)}}split(e){const t=this.makeBlock(4);e.childCount=4,this.nodeUpdateOrdinals(e);for(let s=0;s<4;s++)t.assignChild(e.children[4+s],s,!1),e.children[4+s]=void 0;return this.nodeUpdateLengthNewStructure(e),this.nodeUpdateLengthNewStructure(t),t}nodeUpdateOrdinals(e){for(let t=0;t<e.childCount;t++){const s=e.children[t];e.setOrdinal(s,t),s.isLeaf()||this.nodeUpdateOrdinals(s)}}annotateRange(e,t,s,i,n,r,o,c){this.ensureIntervalBoundary(e,n,r),this.ensureIntervalBoundary(t,n,r);const l=[],h=o===a.d?++this.collabWindow.localSeq:void 0;let d;this.mapRange({leaf:e=>{const t=e.addProperties(s,i,o,this.collabWindow);return l.push({segment:e,propertyDeltas:t}),this.collabWindow.collaborating&&(o===a.d?d=this.addToPendingList(e,d,h):_.options.zamboniSegments&&this.addToLRUSet(e,o)),!0}},n,r,void 0,e,t),this.mergeTreeDeltaCallback&&l.length>0&&this.mergeTreeDeltaCallback(c,{operation:u.a.ANNOTATE,deltaSegments:l}),this.collabWindow.collaborating&&o!==a.d&&_.options.zamboniSegments&&this.zamboniSegments()}markRangeRemoved(e,t,s,i,n,r=!1,o){let c,l=r;this.ensureIntervalBoundary(e,s,i),this.ensureIntervalBoundary(t,s,i);const h=[],d=[],m=n===a.d?++this.collabWindow.localSeq:void 0;this.mapRange({leaf:(e,t,s,r)=>{const o=f(e);return void 0!==o?(l=!0,o.removedSeq===a.d?(o.removedClientIds.unshift(i),o.removedSeq=n,e.localRemovedSeq=void 0):o.removedClientIds.push(i)):(e.removedClientIds=[i],e.removedSeq=n,e.localRemovedSeq=m,h.push({segment:e})),e.localRefs&&!e.localRefs.empty&&d.push(e),this.collabWindow.collaborating&&(e.removedSeq===a.d&&i===this.collabWindow.clientId?c=this.addToPendingList(e,c,m):_.options.zamboniSegments&&this.addToLRUSet(e,n)),!0},post:(e,t,s,r)=>(l?this.nodeUpdateLengthNewStructure(e):this.blockUpdateLength(e,n,i),!0)},s,i,void 0,e,t);const g=this.collabWindow.collaborating&&i===this.collabWindow.clientId;for(const a of d)this.updateSegmentRefsAfterMarkRemoved(a,g);this.mergeTreeDeltaCallback&&h.length>0&&this.mergeTreeDeltaCallback(o,{operation:u.a.REMOVE,deltaSegments:h}),this.collabWindow.collaborating&&n!==a.d&&_.options.zamboniSegments&&this.zamboniSegments()}nodeUpdateLengthNewStructure(e,t=!1){this.blockUpdate(e),this.collabWindow.collaborating&&(e.partialLengths=h.a.combine(this,e,this.collabWindow,t))}removeLocalReferencePosition(e){var t;const s=e.getSegment();if(s){const i=null===(t=null==s?void 0:s.localRefs)||void 0===t?void 0:t.removeLocalRef(e);return void 0!==i&&this.blockUpdatePathLengths(s.parent,a.c,a.a),i}}createLocalReferencePosition(e,t,s,i,r){var c;if(function(e){return void 0!==f(e)}(e)&&!Object(m.j)(s,u.b.SlideOnRemove|u.b.Transient))throw new n.f("Can only create SlideOnRemove or Transient local reference position on a removed segment");const l=null!==(c=e.localRefs)&&void 0!==c?c:new o.b(e);e.localRefs=l;const h=l.createLocalRef(t,s,i,r);return this.blockUpdatePathLengths(e.parent,a.c,a.a),h}removeLocalReference(e,t){if(e.localRefs){e.localRefs.removeLocalRef(t)&&this.blockUpdatePathLengths(e.parent,a.c,a.a)}}addLocalReference(e){const t=e.segment;let s=t.localRefs;s||(s=new o.b(t),t.localRefs=s),s.addLocalRef(e),this.blockUpdatePathLengths(t.parent,a.c,a.a)}blockUpdate(e){var t;let s=0;const i=e.hierBlock();i&&(i.rightmostTiles=Object(d.d)(),i.leftmostTiles=Object(d.d)(),i.rangeStacks={});for(let a=0;a<e.childCount;a++){const o=e.children[a];s+=null!==(n=this,t=(r=o).isLeaf()?n.localNetLength(r):r.cachedLength)&&void 0!==t?t:0,i&&i.addNodeReferences(this,o),this.blockUpdateActions&&this.blockUpdateActions.child(e,a)}var n,r;e.cachedLength=s}blockUpdatePathLengths(e,t,s,i=!1){let n=e;for(;void 0!==n;)i?this.nodeUpdateLengthNewStructure(n):this.blockUpdateLength(n,t,s),n=n.parent}blockUpdateLength(e,t,s){this.blockUpdate(e),this.collabWindow.collaborating&&t!==a.d&&t!==a.c&&(void 0!==e.partialLengths&&_.options.incrementalUpdate&&s!==a.b?e.partialLengths.update(this,e,t,s,this.collabWindow):e.partialLengths=h.a.combine(this,e,this.collabWindow))}map(e,t,s,i){this.nodeMap(this.root,e,0,t,s,i)}mapRange(e,t,s,i,n,r,a=!1){a&&(n&&this.ensureIntervalBoundary(n,t,s),r&&this.ensureIntervalBoundary(r,t,s)),this.nodeMap(this.root,e,0,t,s,i,n,r)}incrementalBlockMap(e){for(var t;!e.empty();){const s=e.top();if(s.op!==j.Go)return;if(0===s.childindex&&(void 0===s.start&&(s.start=0),void 0===s.end&&(s.end=this.blockLength(s.block,s.refSeq,s.clientId)),s.actions.pre&&s.actions.pre(s)),s.op===j.Go&&s.childindex<s.block.childCount){const i=s.block.children[s.childindex],n=null!==(t=this.nodeLength(i,s.refSeq,s.clientId))&&void 0!==t?t:0;if(n>0&&s.start<n&&s.end>0)if(i.isLeaf())s.actions.leaf(i,s);else{const t=new M(i,s.actions,s.pos,s.refSeq,s.clientId,s.context,s.start,s.end,0);e.push(t)}s.pos+=n,s.start-=n,s.end-=n,s.childindex++}else s.childindex===s.block.childCount&&(s.op===j.Go&&s.actions.post&&s.actions.post(s),e.pop())}}nodeMap(e,t,s,i,n,r,a,o){var c;let l=a,u=o,h=s;void 0===l&&(l=0),void 0===u&&(u=this.blockLength(e,i,n));let d=!0;if(t.pre&&(d=t.pre(e,h,i,n,l,u,r),!d))return!0;const m=e.children;for(let g=0;g<e.childCount;g++){const e=m[g],s=null!==(c=this.nodeLength(e,i,n))&&void 0!==c?c:0;if(d&&u>0&&s>0&&l<s&&(e.isLeaf()?t.leaf&&(d=t.leaf(e,h,i,n,l,u,r)):d&&(d=this.nodeMap(e,t,h,i,n,r,l,u))),!d)break;t.shift&&t.shift(e,h,i,n,l,u,r),h+=s,l-=s,u-=s}return d&&t.post&&(d=t.post(e,h,i,n,l,u,r)),d}walkAllSegments(e,t,s){let i=!0;const n=e.children;for(let r=0;i&&r<e.childCount;r++){const e=n[r];i=e.isLeaf()?t(e,s):this.walkAllSegments(e,t,s)}return i}nodeMapReverse(e,t,s,i,n){let r=!0;const a=e.children;for(let o=e.childCount-1;o>=0;o--){const e=a[o];if(r&&(e.isLeaf()?r=t(e,s,i,n,0,0,void 0):r&&(r=this.nodeMapReverse(e,t,s,i,n))),!r)break}return r}}_.zamboniSegmentsMaxCount=2,_.options={incrementalUpdate:!0,insertAfterRemovedSegs:!0,zamboniSegments:!0},_.theUnfinishedNode={childCount:-1}},18037:function(e,t,s){"use strict";s.d(t,"e",(function(){return i})),s.d(t,"d",(function(){return n})),s.d(t,"c",(function(){return r})),s.d(t,"a",(function(){return a})),s.d(t,"b",(function(){return o}));const i=0,n=-1,r=-2,a=-1,o=-2},18038:function(e,t,s){"use strict";s.d(t,"k",(function(){return n})),s.d(t,"j",(function(){return r})),s.d(t,"e",(function(){return a})),s.d(t,"d",(function(){return o})),s.d(t,"h",(function(){return c})),s.d(t,"f",(function(){return l})),s.d(t,"i",(function(){return u})),s.d(t,"g",(function(){return h})),s.d(t,"c",(function(){return d})),s.d(t,"b",(function(){return m})),s.d(t,"a",(function(){return g}));var i=s(18039);const n="referenceRangeLabels";function r(e,t){return 0!=(("number"==typeof e?e:e.refType)&t)}const a=e=>r(e,i.b.Tile)&&e.properties?e.properties.referenceTileLabels:void 0,o=e=>r(e,i.b.NestBegin|i.b.NestEnd)&&e.properties?e.properties[n]:void 0;function c(e,t){const s=a(e);if(s)for(const i of s)if(t===i)return!0;return!1}function l(e,t){const s=o(e);if(s)for(const i of s)if(t===i)return!0;return!1}function u(e){return void 0!==a(e)}function h(e){return void 0!==o(e)}function d(e,t){return g(e,t)<0?e:t}function m(e,t){return g(e,t)>0?e:t}function g(e,t){const s=e.getSegment(),i=t.getSegment();return s===i?e.getOffset()-t.getOffset():void 0===s||void 0!==i&&s.ordinal<i.ordinal?-1:1}},18039:function(e,t,s){"use strict";var i;s.d(t,"b",(function(){return i})),s.d(t,"a",(function(){return n})),function(e){e[e.Simple=0]="Simple",e[e.Tile=1]="Tile",e[e.NestBegin=2]="NestBegin",e[e.NestEnd=4]="NestEnd",e[e.RangeBegin=16]="RangeBegin",e[e.RangeEnd=32]="RangeEnd",e[e.SlideOnRemove=64]="SlideOnRemove",e[e.StayOnRemove=128]="StayOnRemove",e[e.Transient=256]="Transient"}(i||(i={}));const n={INSERT:0,REMOVE:1,ANNOTATE:2,GROUP:3}},18040:function(e,t,s){"use strict";s.d(t,"f",(function(){return i})),s.d(t,"d",(function(){return n})),s.d(t,"c",(function(){return a})),s.d(t,"a",(function(){return c})),s.d(t,"e",(function(){return h})),s.d(t,"b",(function(){return m}));class i{constructor(){this.items=[]}push(e){this.items.push(e)}empty(){return 0===this.items.length}top(){return this.items[this.items.length-1]}pop(){return this.items.pop()}}function n(e){if(void 0!==e&&!e.isHead)return e.next.prev=e.prev,e.prev.next=e.next,e}function r(e){return new o(!1,e)}function a(){return new o(!0,void 0)}class o{constructor(e,t){this.isHead=e,this.data=t,this.prev=this,this.next=this}clear(){this.isHead&&(this.prev=this,this.next=this)}add(e){const t=r(e);return this.prev.next=t,t.next=this,t.prev=this.prev,this.prev=t,t}dequeue(){if(!this.empty()){return n(this.next).data}}enqueue(e){return this.add(e)}walk(e){for(let t=this.next;!t.isHead;t=t.next)e(t.data,t)}some(e,t){const s=[];for(let i=t?this.prev:this.next;!i.isHead;i=t?i.prev:i.next){const n=i.data;e(n,i)&&(t?s.unshift(n):s.push(n))}return s}count(){let e,t;for(e=this.next,t=0;!e.isHead;t++)e=e.next;return t}first(){if(!this.empty())return this.next.data}last(){if(!this.empty())return this.prev.data}empty(){return this.next===this}push(e){this.unshift(e)}unshift(e){const t=r(e);t.data=e,t.isHead=!1,t.next=this.next,t.prev=this,this.next=t,t.next.prev=t}[Symbol.iterator](){let e=this;return{next(){for(;e&&!1===e.next.isHead;)if(e=e.next,void 0!==e.data)return{value:e.data,done:!1};return{value:void 0,done:!0}},[Symbol.iterator](){return this}}}}class c{constructor(e,t){this.comp=t,this.L=[t.min];for(let s=0,i=e.length;s<i;s++)this.add(e[s])}count(){return this.L.length-1}peek(){return this.L[1]}get(){const e=this.L[1];return this.L[1]=this.L[this.count()],this.L.pop(),this.fixDown(1),e}add(e){this.L.push(e),this.fixup(this.count())}fixup(e){let t=e;for(;t>1&&this.comp.compare(this.L[t>>1],this.L[t])>0;){const e=this.L[t>>1];this.L[t>>1]=this.L[t],this.L[t]=e,t>>=1}}fixDown(e){let t=e;for(;t<<1<=this.count();){let e=t<<1;if(e<this.count()&&this.comp.compare(this.L[e],this.L[e+1])>0&&e++,this.comp.compare(this.L[t],this.L[e])<=0)break;const s=this.L[t];this.L[t]=this.L[e],this.L[e]=s,t=e}}}const l=0,u=1;class h{constructor(e,t){this.compareKeys=e,this.aug=t}makeNode(e,t,s,i){return{key:e,data:t,color:s,size:i}}isRed(e){return!!e&&e.color===l}nodeSize(e){return e?e.size:0}size(){return this.nodeSize(this.root)}isEmpty(){return!this.root}get(e){if(void 0!==e)return this.nodeGet(this.root,e)}nodeGet(e,t){let s=e;for(;s;){const e=this.compareKeys(t,s.key);if(e<0)s=s.left;else{if(!(e>0))return s;s=s.right}}}contains(e){return this.get(e)}gather(e,t){const s=[];return void 0!==e&&this.nodeGather(this.root,s,e,t),s}nodeGather(e,t,s,i){e&&(i.continueSubtree(e.left,s)&&this.nodeGather(e.left,t,s,i),i.matchNode(e,s)&&t.push(e),i.continueSubtree(e.right,s)&&this.nodeGather(e.right,t,s,i))}walkExactMatchesForward(e,t,s,i){this.nodeWalkExactMatchesForward(this.root,e,t,s,i)}nodeWalkExactMatchesForward(e,t,s,i,n){if(!e)return;const r=t(e);i(r)&&this.nodeWalkExactMatchesForward(e.left,t,s,i,n),0===r&&s(e),n(r)&&this.nodeWalkExactMatchesForward(e.right,t,s,i,n)}walkExactMatchesBackward(e,t,s,i){this.nodeWalkExactMatchesBackward(this.root,e,t,s,i)}nodeWalkExactMatchesBackward(e,t,s,i,n){if(!e)return;const r=t(e);n(r)&&this.nodeWalkExactMatchesBackward(e.right,t,s,i,n),0===r&&s(e),i(r)&&this.nodeWalkExactMatchesBackward(e.left,t,s,i,n)}put(e,t,s){void 0!==e&&(void 0===t?this.remove(e):(this.root=this.nodePut(this.root,e,t,s),this.root.color=u))}nodePut(e,t,s,i){let n=e;if(n){const e=this.compareKeys(t,n.key);if(e<0)n.left=this.nodePut(n.left,t,s,i);else if(e>0)n.right=this.nodePut(n.right,t,s,i);else if(i){const e=i(t,n.key,s,n.data);e.key&&(n.key=e.key),e.data?n.data=e.data:n.data=s}else n.data=s;return this.isRed(n.right)&&!this.isRed(n.left)&&(n=this.rotateLeft(n)),this.isRed(n.left)&&this.isRed(n.left.left)&&(n=this.rotateRight(n)),this.isRed(n.left)&&this.isRed(n.right)&&this.flipColors(n),n.size=this.nodeSize(n.left)+this.nodeSize(n.right)+1,this.aug&&this.updateLocal(n),n}return this.makeNode(t,s,l,1)}updateLocal(e){this.aug&&(this.isRed(e.left)&&this.aug.update(e.left),this.isRed(e.right)&&this.aug.update(e.right),this.aug.update(e))}nodeRemoveMin(e){let t=e;if(t.left)return this.isRed(t.left)||this.isRed(t.left.left)||(t=this.moveRedLeft(t)),t.left=this.nodeRemoveMin(t.left),this.balance(t)}remove(e){if(void 0!==e){if(!this.contains(e))return;this.removeExisting(e)}}removeExisting(e){this.isRed(this.root.left)||this.isRed(this.root.right)||(this.root.color=l),this.root=this.nodeRemove(this.root,e)}nodeRemove(e,t){let s=e;if(this.compareKeys(t,s.key)<0)this.isRed(s.left)||this.isRed(s.left.left)||(s=this.moveRedLeft(s)),s.left=this.nodeRemove(s.left,t);else{if(this.isRed(s.left)&&(s=this.rotateRight(s)),0===this.compareKeys(t,s.key)&&!s.right)return;if(this.isRed(s.right)||this.isRed(s.right.left)||(s=this.moveRedRight(s)),0===this.compareKeys(t,s.key)){const e=this.nodeMin(s.right);s.key=e.key,s.data=e.data,s.right=this.nodeRemoveMin(s.right)}else s.right=this.nodeRemove(s.right,t)}return this.balance(s)}floor(e){if(!this.isEmpty())return this.nodeFloor(this.root,e)}nodeFloor(e,t){if(e){const s=this.compareKeys(t,e.key);if(0===s)return e;if(s<0)return this.nodeFloor(e.left,t);{const s=this.nodeFloor(e.right,t);return s||e}}}ceil(e){if(!this.isEmpty())return this.nodeCeil(this.root,e)}nodeCeil(e,t){if(e){const s=this.compareKeys(t,e.key);if(0===s)return e;if(s>0)return this.nodeCeil(e.right,t);{const s=this.nodeCeil(e.left,t);return s||e}}}min(){if(this.root)return this.nodeMin(this.root)}nodeMin(e){return e.left?this.nodeMin(e.left):e}max(){if(this.root)return this.nodeMax(this.root)}nodeMax(e){return e.right?this.nodeMax(e.right):e}rotateRight(e){const t=e.left;return e.left=t.right,t.right=e,t.color=t.right.color,t.right.color=l,t.size=e.size,e.size=this.nodeSize(e.left)+this.nodeSize(e.right)+1,this.aug&&(this.updateLocal(e),this.updateLocal(t)),t}rotateLeft(e){const t=e.right;return e.right=t.left,t.left=e,t.color=t.left.color,t.left.color=l,t.size=e.size,e.size=this.nodeSize(e.left)+this.nodeSize(e.right)+1,this.aug&&(this.updateLocal(e),this.updateLocal(t)),t}oppositeColor(e){return e===u?l:u}flipColors(e){e.color=this.oppositeColor(e.color),e.left.color=this.oppositeColor(e.left.color),e.right.color=this.oppositeColor(e.right.color)}moveRedLeft(e){let t=e;return this.flipColors(t),this.isRed(t.right.left)&&(t.right=this.rotateRight(t.right),t=this.rotateLeft(t),this.flipColors(t)),t}moveRedRight(e){let t=e;return this.flipColors(t),this.isRed(t.left.left)&&(t=this.rotateRight(t),this.flipColors(t)),t}balance(e){let t=e;return this.isRed(t.right)&&(t=this.rotateLeft(t)),this.isRed(t.left)&&this.isRed(t.left.left)&&(t=this.rotateRight(t)),this.isRed(t.left)&&this.isRed(t.right)&&this.flipColors(t),t.size=this.nodeSize(t.left)+this.nodeSize(t.right)+1,this.aug&&this.aug.update(t),t}mapRange(e,t,s,i){this.nodeMap(this.root,e,s,i)}map(e,t){this.nodeMap(this.root,e,t)}keys(){const e=[],t={showStructure:!0,infix:t=>(e.push(t.key),!0)};return this.walk(t),e}walk(e){this.nodeWalk(this.root,e)}walkBackward(e){this.nodeWalkBackward(this.root,e)}nodeWalk(e,t){let s=!0;return e&&(t.pre&&(t.showStructure||e.color===u)&&(s=t.pre(e)),e.left&&(s=this.nodeWalk(e.left,t)),s&&t.infix&&(t.showStructure||e.color===u)&&(s=t.infix(e)),s&&(s=this.nodeWalk(e.right,t)),s&&t.post&&(t.showStructure||e.color===u)&&(s=t.post(e))),s}nodeWalkBackward(e,t){let s=!0;return e&&(t.pre&&(t.showStructure||e.color===u)&&(s=t.pre(e)),e.right&&(s=this.nodeWalkBackward(e.right,t)),s&&t.infix&&(t.showStructure||e.color===u)&&(s=t.infix(e)),s&&(s=this.nodeWalkBackward(e.left,t)),s&&t.post&&(t.showStructure||e.color===u)&&(s=t.post(e))),s}nodeMap(e,t,s,i,n){let r=i,a=n;if(!e)return!0;void 0===r&&(r=this.nodeMin(e).key),void 0===a&&(a=this.nodeMax(e).key);const o=this.compareKeys(r,e.key),c=this.compareKeys(a,e.key);let l=!0;return o<0&&(l=this.nodeMap(e.left,t,s,r,a)),l&&o<=0&&c>=0&&(l=t(e,s)),l&&c>0&&(l=this.nodeMap(e.right,t,s,r,a)),l}}const d=(e,t)=>e.compare(t);class m{constructor(){this.intervals=new h(d,this)}remove(e){this.intervals.remove(e)}removeExisting(e){this.intervals.removeExisting(e)}put(e,t){let s;t&&(s=(e,s)=>({key:t(e,s)})),this.intervals.put(e,{minmax:e.clone()},s)}map(e){const t={infix:t=>(e(t.key),!0),showStructure:!0};this.intervals.walk(t)}mapUntil(e){const t={infix:t=>e(t.key),showStructure:!0};this.intervals.walk(t)}mapBackward(e){const t={infix:t=>(e(t.key),!0),showStructure:!0};this.intervals.walkBackward(t)}match(e){return this.intervals.gather(e,this)}matchNode(e,t){return!!e&&e.key.overlaps(t)}continueSubtree(e,t){return!!e&&e.data.minmax.overlaps(t)}update(e){e.left&&e.right?e.data.minmax=e.key.union(e.left.data.minmax.union(e.right.data.minmax)):e.left?e.data.minmax=e.key.union(e.left.data.minmax):e.right?e.data.minmax=e.key.union(e.right.data.minmax):e.data.minmax=e.key.clone()}}},18041:function(e,t,s){"use strict";function i(e,t,s,i){let n=t;switch(void 0===n&&(n=e.defaultValue),e.name){case"incr":n+=s,e.minValue&&n<e.minValue&&(n=e.minValue);break;case"consensus":if(void 0===n){n={value:s,seq:i}}else{const e=n;-1===e.seq&&(e.seq=i)}}return n}function n(e,t){if(e){if(!t)return!1;for(const s in e){if(void 0===t[s])return!1;if("object"==typeof t[s]){if(!n(e[s],t[s]))return!1}else if(t[s]!==e[s])return!1}for(const s in t)if(void 0===e[s])return!1}else if(t)return!1;return!0}function r(e,t,s,n){if(void 0!==t)for(const r in t){const a=t[r];null===a?delete e[r]:s&&"rewrite"!==s.name?e[r]=i(s,e[r],a,n):e[r]=a}return e}function a(e){if(void 0===e)return;const t=l();for(const s in e){const i=e[s];null!==i&&(t[s]=i)}return t}function o(e,t,s,i){let n=e;return(!n||s&&"rewrite"===s.name)&&(n=l()),r(n,t,s,i),n}function c(e,t){if(void 0!==t)for(const s in t)void 0===e[s]&&(e[s]=t[s]);return e}function l(){return Object.create(null)}s.d(t,"c",(function(){return i})),s.d(t,"g",(function(){return n})),s.d(t,"e",(function(){return r})),s.d(t,"b",(function(){return a})),s.d(t,"a",(function(){return o})),s.d(t,"f",(function(){return c})),s.d(t,"d",(function(){return l}))},18042:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));var i=s(18040);class n{constructor(e){this.segment=e,this.segmentGroups=Object(i.c)()}get size(){return this.segmentGroups.count()}get empty(){return this.segmentGroups.empty()}enqueue(e){this.segmentGroups.enqueue(e),e.segments.push(this.segment)}dequeue(){return this.segmentGroups.dequeue()}clear(){this.segmentGroups.clear()}copyTo(e){this.segmentGroups.walk(t=>e.segmentGroups.enqueue(t))}}},18043:function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));s(18044);class i{constructor(e){this.segment=e,this.trackingGroups=new Set}link(e){e&&(this.trackingGroups.has(e)||this.trackingGroups.add(e),e.has(this.segment)||e.link(this.segment))}unlink(e){e.has(this.segment)&&e.unlink(this.segment),this.trackingGroups.delete(e)}copyTo(e){this.trackingGroups.forEach(t=>e.trackingCollection.link(t))}get empty(){return 0===this.trackingGroups.size}matches(e){if(!e||this.trackingGroups.size!==e.trackingGroups.size)return!1;for(const t of this.trackingGroups.values())if(!e.trackingGroups.has(t))return!1;return!0}}},18044:function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));class i{constructor(){this.ordinalSortedItems=[]}get size(){return this.ordinalSortedItems.length}get items(){return this.ordinalSortedItems}addOrUpdate(e,t){const s=this.findOrdinalPosition(this.getOrdinal(e));s.exists?t&&t(this.ordinalSortedItems[s.index],e):this.ordinalSortedItems.splice(s.index,0,e)}remove(e){const t=this.findOrdinalPosition(this.getOrdinal(e));return!!t.exists&&(this.ordinalSortedItems.splice(t.index,1),!0)}has(e){return this.findOrdinalPosition(this.getOrdinal(e)).exists}getOrdinal(e){const t=e;if(null==t?void 0:t.segment)return t.segment.ordinal;return e.ordinal}findOrdinalPosition(e,t,s){if(0===this.ordinalSortedItems.length)return{exists:!1,index:0};if(void 0===t||void 0===s)return this.findOrdinalPosition(e,0,this.ordinalSortedItems.length-1);const i=t+Math.floor((s-t)/2);return this.getOrdinal(this.ordinalSortedItems[i])>e?t===i?{exists:!1,index:i}:this.findOrdinalPosition(e,t,i-1):this.getOrdinal(this.ordinalSortedItems[i])<e?i===s?{exists:!1,index:i+1}:this.findOrdinalPosition(e,i+1,s):{exists:!0,index:i}}}},18045:function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var i=s(17940),n=s(18037),r=s(18041);class a{constructor(){this.pendingRewriteCount=0}ackPendingProperties(e){var t,s;e.combiningOp&&"rewrite"===e.combiningOp.name&&this.pendingRewriteCount--;for(const n of Object.keys(e.props))void 0!==(null===(t=this.pendingKeyUpdateCount)||void 0===t?void 0:t[n])&&(Object(i.a)(this.pendingKeyUpdateCount[n]>0,92),this.pendingKeyUpdateCount[n]--,0===(null===(s=this.pendingKeyUpdateCount)||void 0===s?void 0:s[n])&&delete this.pendingKeyUpdateCount[n])}addProperties(e,t,s,i,a=!1){var o;if(this.pendingKeyUpdateCount||(this.pendingKeyUpdateCount=Object(r.d)()),this.pendingRewriteCount>0&&i!==n.d&&a)return;const c=s&&"rewrite"===s.name,l=c?void 0:s||void 0,u=e=>{var t;return!(i!==n.d&&void 0!==(null===(t=this.pendingKeyUpdateCount)||void 0===t?void 0:t[e])&&!l)},h={};if(c){a&&i===n.d&&this.pendingRewriteCount++;for(const s of Object.keys(e))!t[s]&&u(s)&&(h[s]=e[s],delete e[s])}for(const d of Object.keys(t)){if(a)if(i===n.d)void 0===(null===(o=this.pendingKeyUpdateCount)||void 0===o?void 0:o[d])&&(this.pendingKeyUpdateCount[d]=0),this.pendingKeyUpdateCount[d]++;else if(!u(d))continue;const s=e[d];let c;h[d]=void 0===s?null:s,c=l?Object(r.c)(l,s,c,i):t[d],null===c?delete e[d]:e[d]=c}return h}copyTo(e,t,s){if(e){if(t||(t=Object(r.d)()),!s)throw new Error("Must provide new PropertyManager");for(const s of Object.keys(e))t[s]=e[s];s.pendingRewriteCount=this.pendingRewriteCount,s.pendingKeyUpdateCount=Object(r.d)();for(const e of Object.keys(this.pendingKeyUpdateCount))s.pendingKeyUpdateCount[e]=this.pendingKeyUpdateCount[e]}return t}hasPendingProperties(){return this.pendingRewriteCount>0||Object.keys(this.pendingKeyUpdateCount).length>0}}},18046:function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));const i={APPEND:-1,SPLIT:-2,UNLINK:-3,ACKNOWLEDGED:-4}},18047:function(e,t,s){"use strict";s.d(t,"a",(function(){return l})),s.d(t,"b",(function(){return h}));var i=s(17940),n=s(17957),r=s(18040),a=s(18039),o=s(18041),c=s(18038);class l{constructor(e,t,s=0,i=a.b.Simple,r){this.client=e,this.offset=s,this.refType=i,function(e){let t=0;if(Object(c.j)(e,a.b.Transient)&&++t,Object(c.j)(e,a.b.SlideOnRemove)&&++t,Object(c.j)(e,a.b.StayOnRemove)&&++t,t>1)throw new n.f("Reference types can only be one of Transient, SlideOnRemove, and StayOnRemove")}(i),this.segment=t,this.properties=r}min(e){return Object(c.c)(this,e)}max(e){return Object(c.b)(this,e)}compare(e){return Object(c.a)(this,e)}toPosition(){return this.getClient().localReferencePositionToPosition(this)}hasTileLabels(){return Object(c.i)(this)}hasRangeLabels(){return Object(c.g)(this)}hasTileLabel(e){return Object(c.h)(this,e)}hasRangeLabel(e){return Object(c.f)(this,e)}getTileLabels(){return Object(c.e)(this)}getRangeLabels(){return Object(c.d)(this)}isLeaf(){return!1}addProperties(e,t){this.properties=Object(o.a)(this.properties,e,t)}getClient(){return this.client}getSegment(){return this.segment}getOffset(){return this.offset}getProperties(){return this.properties}}function u(e){Object(i.a)(e instanceof l,736)}l.DetachedPosition=-1;class h{constructor(e,t=new Array(e.cachedLength)){this.segment=e,this.hierRefCount=0,this.refCount=0,this.refsByOffset=t}static append(e,t){t.localRefs&&!t.localRefs.empty?(e.localRefs||(e.localRefs=new h(e)),Object(i.a)(e.localRefs.refsByOffset.length===e.cachedLength,702),e.localRefs.append(t.localRefs)):e.localRefs&&(e.localRefs.refsByOffset.length+=t.cachedLength)}[Symbol.iterator](){const e=[];for(const t of this.refsByOffset)t&&(t.before&&e.push(t.before[Symbol.iterator]()),t.at&&e.push(t.at[Symbol.iterator]()),t.after&&e.push(t.after[Symbol.iterator]()));return{next(){for(;e.length>0;){const t=e[0].next();if(!0!==t.done)return t;e.shift()}return{value:void 0,done:!0}},[Symbol.iterator](){return this}}}clear(){this.refCount=0,this.hierRefCount=0;const e=e=>{if(e)for(const t of e)t.segment===this.segment&&(t.segment=void 0)};for(let t=0;t<this.refsByOffset.length;t++){const s=this.refsByOffset[t];s&&(e(s.before),e(s.at),e(s.before),this.refsByOffset[t]=void 0)}}get empty(){return 0===this.refCount}createLocalRef(e,t,s,i){const n=new l(i,this.segment,e,t,s);return Object(c.j)(n,a.b.Transient)||this.addLocalRef(n),n}addLocalRef(e){var t,s;Object(i.a)(!Object(c.j)(e,a.b.Transient),735),u(e);const n=this.refsByOffset[e.offset]=null!==(t=this.refsByOffset[e.offset])&&void 0!==t?t:{at:Object(r.c)()};(n.at=null!==(s=n.at)&&void 0!==s?s:Object(r.c)()).enqueue(e),(Object(c.g)(e)||Object(c.i)(e))&&this.hierRefCount++,this.refCount++}removeLocalRef(e){u(e);const t=t=>{if(t){let s=t;do{if(s=s.next,s.data===e)return Object(r.d)(s),(Object(c.g)(e)||Object(c.i)(e))&&this.hierRefCount--,this.refCount--,e}while(!s.isHead)}},s=this.refsByOffset[e.offset];if(void 0!==s){let e=t(s.before);if(e)return e;if(e=t(s.at),e)return e;if(e=t(s.after),e)return e}}append(e){if(e&&!e.empty){this.hierRefCount+=e.hierRefCount,this.refCount+=e.refCount,e.hierRefCount=0;for(const t of e)t.segment=this.segment,t.offset+=this.refsByOffset.length;this.refsByOffset.push(...e.refsByOffset)}}split(e,t){if(this.empty)this.refsByOffset.length=e;else{const s=new h(t,this.refsByOffset.splice(e,this.refsByOffset.length-e));t.localRefs=s;for(const i of s)i.segment=t,i.offset-=e,(Object(c.g)(i)||Object(c.i)(i))&&(this.hierRefCount--,s.hierRefCount++),this.refCount--,s.refCount++}}addBeforeTombstones(...e){var t,s,i,n,o;const l=null!==(s=null===(t=this.refsByOffset[0])||void 0===t?void 0:t.before)&&void 0!==s?s:Object(r.c)();for(const r of e)for(const e of r)u(e),Object(c.j)(e,a.b.SlideOnRemove)?(l.push(e),e.segment=this.segment,e.offset=0,(Object(c.g)(e)||Object(c.i)(e))&&this.hierRefCount++,this.refCount++):e.segment=void 0;if(!l.empty()&&void 0===(null===(i=this.refsByOffset[0])||void 0===i?void 0:i.before)){const e=this.refsByOffset[0]=null!==(n=this.refsByOffset[0])&&void 0!==n?n:{before:l};e.before=null!==(o=e.before)&&void 0!==o?o:l}}addAfterTombstones(...e){var t,s,i,n,o;const l=this.refsByOffset.length-1,h=null!==(s=null===(t=this.refsByOffset[l])||void 0===t?void 0:t.after)&&void 0!==s?s:Object(r.c)();for(const r of e)for(const e of r)u(e),Object(c.j)(e,a.b.SlideOnRemove)?(h.push(e),e.segment=this.segment,e.offset=this.segment.cachedLength-1,(Object(c.g)(e)||Object(c.i)(e))&&this.hierRefCount++,this.refCount++):e.segment=void 0;if(!h.empty()&&void 0===(null===(i=this.refsByOffset[l])||void 0===i?void 0:i.after)){const e=this.refsByOffset[l]=null!==(n=this.refsByOffset[l])&&void 0!==n?n:{after:h};e.after=null!==(o=e.after)&&void 0!==o?o:h}}}},18048:function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var i=s(17940),n=s(18040),r=s(18037),a=s(18036);function o(e,t){let s=-1,i=0,n=e.length-1;for(;i<=n;){const r=i+Math.floor((n-i)/2);e[r].seq<=t?((s<0||e[s].seq<e[r].seq)&&(s=r),i=r+1):n=r-1}return s}class c{constructor(e){this.minSeq=e,this.minLength=0,this.segmentCount=0,this.partialLengths=[],this.clientSeqNumbers=[]}static combine(e,t,s,i=!1){return c.combineBranch(e,t,s,i)}static combineBranch(e,t,s,i=!1){let r,o=new c(s.minSeq);function l(e){if(!e)return;const t=new n.e(a.d);return e.map(e=>(t.put(e.data.clientId,Object.assign({},e.data)),!0)),t}function u(e){const t=e.seq;let s=0;if(r){if(r.seq===e.seq)return r.seglen+=e.seglen,r.len+=e.seglen,void function(e,t){const s=e.overlapRemoveClients;s?t.overlapRemoveClients&&t.overlapRemoveClients.map(e=>{const t=s.get(e.key);return t?t.data.seglen+=e.data.seglen:s.put(e.data.clientId,Object.assign({},e.data)),!0}):e.overlapRemoveClients=l(t.overlapRemoveClients)}(r,e);s=r.len,o.addClientSeqNumberFromPartial(r)}r={clientId:e.clientId,len:s+e.seglen,overlapRemoveClients:l(e.overlapRemoveClients),seglen:e.seglen,seq:t},o.partialLengths.push(r)}c.fromLeaves(o,t,s);const h=[];for(let n=0;n<t.childCount;n++){const r=t.children[n];if(!r.isLeaf()){const t=r;i&&(t.partialLengths=c.combine(e,t,s,!0)),h.push(t.partialLengths)}}let d=h.length;if(0!==d){o.partialLengths.length>0&&(h.push(o),d++,o=new c(s.minSeq));const e=new Array(d),t=new Array(d);for(let s=0;s<d;s++)e[s]=0,t[s]=h[s].partialLengths.length,o.minLength+=h[s].minLength,o.segmentCount+=h[s].segmentCount;let i,n=0;for(;n>=0;){n=-1;for(let s=0;s<d;s++)if(e[s]<t[s]){const t=h[s].partialLengths[e[s]];(n<0||t.seq<i.seq)&&(n=s,i=t)}n>=0&&(u(i),e[n]++)}r&&o.addClientSeqNumberFromPartial(r)}return c.options.zamboni&&o.zamboni(s),c.options.verify&&o.verify(),o}static fromLeaves(e,t,s){function i(e,t){return void 0!==e&&e!==r.d&&e<=t}e.minLength=0,e.segmentCount=t.childCount;for(let u=0;u<t.childCount;u++){const n=t.children[u];if(n.isLeaf()){const t=n;i(t.seq,s.minSeq)?e.minLength+=t.cachedLength:t.seq!==r.d&&c.insertSegment(e,t);const o=Object(a.f)(t);i(null==o?void 0:o.removedSeq,s.minSeq)?e.minLength-=t.cachedLength:void 0!==o&&o.removedSeq!==r.d&&c.insertSegment(e,t,o)}}const n=e.partialLengths,o=n.length;let l=0;for(let r=0;r<o;r++)n[r].len=l+n[r].seglen,l=n[r].len,e.addClientSeqNumberFromPartial(n[r]);c.options.verify&&e.verify()}static getOverlapClients(e,t){const s=new n.e(a.d);for(const i of e)s.put(i,{clientId:i,seglen:t});return s}static accumulateRemoveClientOverlap(e,t,s){if(e.overlapRemoveClients)for(const i of t){const t=e.overlapRemoveClients.get(i);t?t.data.seglen+=s:e.overlapRemoveClients.put(i,{clientId:i,seglen:s})}else e.overlapRemoveClients=c.getOverlapClients(t,s)}static insertSegment(e,t,s){let i,n=t.seq,r=t.cachedLength,a=t.clientId;s&&(n=s.removedSeq,r=-r,a=s.removedClientIds[0],i=s.removedClientIds.length>1?s.removedClientIds.slice(1):void 0);const o=e.partialLengths,l=o.length;let u=0;for(;u<l&&!(o[u].seq>=n);u++);if(u<l&&o[u].seq===n)o[u].seglen+=r,i&&c.accumulateRemoveClientOverlap(o[u],i,r);else{let e;if(i){e={seq:n,clientId:a,len:0,seglen:r,overlapRemoveClients:c.getOverlapClients(i,r)}}else e={seq:n,clientId:a,len:0,seglen:r};if(u<l){for(let e=l;e>u;e--)o[e]=o[e-1];o[u]=e}else o.push(e)}}static addSeq(e,t,s,i){let n,r,a=o(e,t);if(a>=0){const s=e[a];s.seq===t?(n=s,a=o(e,t-1),a>=0&&(r=e[a])):r=s}void 0===n?(n={clientId:i,seglen:s,seq:t},e.push(n)):n.seglen=s,n.len=void 0!==r?n.seglen+r.len:n.seglen}update(e,t,s,i,n){let r=0,l=0;for(let c=0;c<t.childCount;c++){const e=t.children[c];if(e.isLeaf()){const t=e,i=Object(a.f)(t);t.seq===s?(null==i?void 0:i.removedSeq)!==s&&(r+=t.cachedLength):(null==i?void 0:i.removedSeq)===s&&(r-=t.cachedLength),l++}else{const t=e.partialLengths,i=t.partialLengths,n=o(i,s);if(n>=0){const e=i[n];e.seq===s&&(r+=e.seglen)}l+=t.segmentCount}}this.segmentCount=l,c.addSeq(this.partialLengths,s,r,i),void 0===this.clientSeqNumbers[i]&&(this.clientSeqNumbers[i]=[]),c.addSeq(this.clientSeqNumbers[i],s,r),c.options.zamboni&&this.zamboni(n),c.options.verify&&this.verify()}getPartialLength(e,t){let s=this.minLength;const i=o(this.partialLengths,e),n=this.cliLatest(t),r=this.clientSeqNumbers[t];if(i>=0){if(s+=this.partialLengths[i].len,n>=0){const i=r[n];if(i.seq>e){s+=i.len;const n=this.cliLatestLEQ(t,e);n>=0&&(s-=r[n].len)}}}else if(n>=0){s+=r[n].len}return s}toString(e,t=0){let s="";for(const i of this.partialLengths)s+=`(${i.seq},${i.len}) `;for(const i in this.clientSeqNumbers)if(this.clientSeqNumbers[i].length>0){s+="Client ",s+=e?""+e(+i):""+i,s+="[";for(const e of this.clientSeqNumbers[i])s+=`(${e.seq},${e.len})`;s+="]"}return s=`min(seq ${this.minSeq}): ${this.minLength}; sc: ${this.segmentCount};${s}`,s}zamboni(e){function t(t){const s=o(t,e.minSeq);let i=0;if(s>=0){i=t[s].len;const e=t.length;if(s<=e-1){const n=e-s-1;for(let e=0;e<n;e++)t[e]=t[e+s+1],t[e].len-=i;t.length=n}}return i}this.minLength+=t(this.partialLengths);for(const s in this.clientSeqNumbers){const e=this.clientSeqNumbers[s];e&&t(e)}}addClientSeqNumber(e,t,s){void 0===this.clientSeqNumbers[e]&&(this.clientSeqNumbers[e]=[]);const i=this.clientSeqNumbers[e];let n=s;i.length>0&&(n+=i[i.length-1].len),i.push({seq:t,len:n,seglen:s})}addClientSeqNumberFromPartial(e){this.addClientSeqNumber(e.clientId,e.seq,e.seglen),e.overlapRemoveClients&&e.overlapRemoveClients.map(t=>(this.addClientSeqNumber(t.data.clientId,e.seq,t.data.seglen),!0))}cliLatestLEQ(e,t){const s=this.clientSeqNumbers[e];return s?o(s,t):-1}cliLatest(e){const t=this.clientSeqNumbers[e];return t&&t.length>0?t.length-1:-1}verifyPartialLengths(e,t){if(0===e.length)return 0;let s=0,n=0,r=0;for(const a of e)r++,Object(i.a)(this.minSeq<=a.seq,84),Object(i.a)(s<a.seq,85),s=a.seq,n+=a.seglen,n!==a.len&&Object(i.a)(!1,86),t||this.minLength+a.len<0&&Object(i.a)(!1,87),a.overlapRemoveClients&&(Object(i.a)(!t,88),r+=a.overlapRemoveClients.size());return r}verify(){if(this.clientSeqNumbers){let e=0;for(const s of this.clientSeqNumbers)s&&(e+=this.verifyPartialLengths(s,!0));Object(i.a)(!!this.partialLengths,89);const t=this.verifyPartialLengths(this.partialLengths,!1);Object(i.a)(t===e,90)}else Object(i.a)(!this.partialLengths,91)}}c.options={verify:!1,zamboni:!0}},18049:function(e,t,s){"use strict";s.d(t,"a",(function(){return y}));var i=s(17979),n=s(17983),r=s(17940),a=s(17944),o=s(17970),c=s(18050),l=s(18039),u=s(18041),h=s(18051),d=s(18047),m=s(17991),g=s(18061),p=s(17937),f=s(18033),b=s(18060),v=s(18058),S=s(18057);class y extends p.a{constructor(e,t,s,n){super(t,e,s,"fluid_sequence_"),this.dataStoreRuntime=e,this.id=t,this.segmentFromSpec=n,this.loadedDeferred=new i.a,this.loadedDeferredOutgoingOps=[],this.deferIncomingOps=!0,this.loadedDeferredIncomingOps=[],this.messagesSinceMSNChange=[],this.loadedDeferred.promise.catch(e=>{this.logger.sendErrorEvent({eventName:"SequenceLoadFailed"},e)}),this.client=new c.a(n,a.a.create(this.logger,"SharedSegmentSequence.MergeTreeClient"),e.options),super.on("newListener",e=>{switch(e){case"sequenceDelta":this.client.mergeTreeDeltaCallback||(this.client.mergeTreeDeltaCallback=(e,t)=>{this.emit("sequenceDelta",new S.a(e,t,this.client),this)});break;case"maintenance":this.client.mergeTreeMaintenanceCallback||(this.client.mergeTreeMaintenanceCallback=(e,t)=>{this.emit("maintenance",new S.b(t,e,this.client),this)})}}),super.on("removeListener",e=>{switch(e){case"sequenceDelta":0===super.listenerCount(e)&&(this.client.mergeTreeDeltaCallback=void 0);break;case"maintenance":0===super.listenerCount(e)&&(this.client.mergeTreeMaintenanceCallback=void 0)}}),this.intervalCollections=new v.a(this.serializer,this.handle,(e,t)=>this.submitLocalMessage(e,t),new b.a)}get loaded(){return this.loadedDeferred.promise}static createOpsFromDelta(e){var t,s;const i=[];for(const n of e.ranges)switch(e.deltaOperation){case l.a.ANNOTATE:{const e=i[i.length-1],r={};for(const i of Object.keys(n.propertyDeltas))r[i]=null!==(s=null===(t=n.segment.properties)||void 0===t?void 0:t[i])&&void 0!==s?s:null;e&&e.pos2===n.position&&Object(u.g)(e.props,r)?e.pos2+=n.segment.cachedLength:i.push(Object(h.b)(n.position,n.position+n.segment.cachedLength,r,void 0));break}case l.a.INSERT:i.push(Object(h.d)(n.position,n.segment.clone().toJSONObject()));break;case l.a.REMOVE:{const e=i[i.length-1];(null==e?void 0:e.pos1)===n.position?e.pos2+=n.segment.cachedLength:i.push(Object(h.f)(n.position,n.position+n.segment.cachedLength));break}}return i}removeRange(e,t){const s=this.client.removeRangeLocal(e,t);return s&&this.submitSequenceMessage(s),s}groupOperation(e){this.client.localTransaction(e),this.submitSequenceMessage(e)}getContainingSegment(e){return this.client.getContainingSegment(e)}getLength(){return this.client.getLength()}getPosition(e){return this.client.getPosition(e)}annotateRange(e,t,s,i){const n=this.client.annotateRangeLocal(e,t,s,i);n&&this.submitSequenceMessage(n)}getPropertiesAtPosition(e){return this.client.getPropertiesAtPosition(e)}getRangeExtentsOfPosition(e){return this.client.getRangeExtentsOfPosition(e)}createPositionReference(e,t,s){const i=new d.a(this.client,e,t,s);return s!==l.b.Transient&&this.addLocalReference(i),i}createLocalReferencePosition(e,t,s,i){return this.client.createLocalReferencePosition(e,t,s,i)}localRefToPos(e){return this.client.localReferencePositionToPosition(e)}localReferencePositionToPosition(e){return this.client.localReferencePositionToPosition(e)}resolveRemoteClientPosition(e,t,s){return this.client.resolveRemoteClientPosition(e,t,s)}submitSequenceMessage(e){if(!this.isAttached())return;const t=Object(f.b)(e,this.serializer,this.handle),s=this.client.peekPendingSegmentGroups(e.type===l.a.GROUP?e.ops.length:1);this.loadedDeferred.isCompleted?this.submitLocalMessage(t,s):this.loadedDeferredOutgoingOps.push([t,s])}addLocalReference(e){return this.client.addLocalReference(e)}removeLocalReference(e){return this.client.removeLocalReferencePosition(e)}removeLocalReferencePosition(e){return this.client.removeLocalReferencePosition(e)}posFromRelativePos(e){return this.client.posFromRelativePos(e)}walkSegments(e,t,s,i,n=!1){return this.client.walkSegments(e,t,s,i,n)}getStackContext(e,t){return this.client.getStackContext(e,t)}getCurrentSeq(){return this.client.getCurrentSeq()}insertAtReferencePosition(e,t){const s=this.client.insertAtReferencePositionLocal(e,t);s&&this.submitSequenceMessage(s)}async waitIntervalCollection(e){return this.intervalCollections.get(e)}getIntervalCollection(e){return this.intervalCollections.get(e)}getIntervalCollectionLabels(){return this.intervalCollections.keys()}summarizeCore(e,t){const s=new m.a;return this.intervalCollections.size>0&&s.addBlob("header",this.intervalCollections.serialize(e)),s.addWithStats("content",this.summarizeMergeTree(e)),s.getSummaryTree()}processGCDataCore(e){this.intervalCollections.size>0&&this.intervalCollections.serialize(e),this.client.serializeGCData(this.handle,e)}replaceRange(e,t,s){const i=Math.max(e,t),n=this.client.insertSegmentLocal(i,s);if(n)if(e<t){const s=this.client.removeRangeLocal(e,t);this.submitSequenceMessage(Object(h.c)(n,s))}else this.submitSequenceMessage(n)}onConnect(){this.client.startOrUpdateCollaboration(this.runtime.clientId)}onDisconnect(){}reSubmitCore(e,t){this.intervalCollections.tryResubmitMessage(e,t)||this.submitSequenceMessage(this.client.regeneratePendingOp(e,t))}async loadCore(e){var t;if(await e.contains("header")){const t=await e.readBlob("header"),s=Object(n.c)(t,"utf8");this.intervalCollections.populate(s)}try{const{catchupOpsP:s}=await this.client.load(this.runtime,new g.a(e,"content"),this.serializer),i=s.then(e=>{e.forEach(e=>{const t=this.client.getCollabWindow();if(e.minimumSequenceNumber<t.minSeq||e.referenceSequenceNumber<t.minSeq||e.sequenceNumber<=t.minSeq||e.sequenceNumber<=t.currentSeq)throw new Error("Invalid catchup operations in snapshot: "+JSON.stringify({op:{seq:e.sequenceNumber,minSeq:e.minimumSequenceNumber,refSeq:e.referenceSequenceNumber},collabWindow:{seq:t.currentSeq,minSeq:t.minSeq}}));this.processMergeTreeMsg(e)}),this.loadFinished()}).catch(e=>{this.loadFinished(e)});!0!==(null===(t=this.dataStoreRuntime.options)||void 0===t?void 0:t.sequenceInitializeFromHeaderOnly)&&await i}catch(s){this.loadFinished(s)}}processCore(e,t,s){if(this.deferIncomingOps)Object(r.a)(!t,114),this.loadedDeferredIncomingOps.push(e);else{Object(r.a)(e.type===o.a.Operation,115);this.intervalCollections.tryProcessMessage(e.contents,t,e,s)||this.processMergeTreeMsg(e,t)}}didAttach(){var e;this.isAttached()&&this.client.startOrUpdateCollaboration(null!==(e=this.runtime.clientId)&&void 0!==e?e:"attached")}initializeLocalCore(){super.initializeLocalCore(),this.loadFinished()}applyStashedOp(e){return this.client.applyStashedOp(e)}summarizeMergeTree(e){Object(r.a)(this.loadedDeferred.isCompleted,116);const t=this.runtime.deltaManager.minimumSequenceNumber;return this.processMinSequenceNumberChanged(t),this.messagesSinceMSNChange.forEach(e=>{e.minimumSequenceNumber=t}),this.client.summarize(this.runtime,this.handle,e,this.messagesSinceMSNChange)}processMergeTreeMsg(e,t){var s,i;const n=Object(f.c)(e,this.serializer),r=[];function a(e){r.push(...y.createOpsFromDelta(e))}const o=n.referenceSequenceNumber!==n.sequenceNumber-1;let c=n;!0!==(null===(s=this.runtime.options)||void 0===s?void 0:s.newMergeTreeSnapshotFormat)&&o&&this.on("sequenceDelta",a),this.client.applyMsg(n,t),!0!==(null===(i=this.runtime.options)||void 0===i?void 0:i.newMergeTreeSnapshotFormat)&&(o&&(this.removeListener("sequenceDelta",a),c=Object.assign(Object.assign({},n),{referenceSequenceNumber:c.sequenceNumber-1,contents:1!==r.length?Object(h.c)(...r):r[0]})),this.messagesSinceMSNChange.push(c),this.messagesSinceMSNChange.length>20&&this.messagesSinceMSNChange[20].sequenceNumber<n.minimumSequenceNumber&&this.processMinSequenceNumberChanged(n.minimumSequenceNumber))}processMinSequenceNumberChanged(e){let t=0;for(;t<this.messagesSinceMSNChange.length&&!(this.messagesSinceMSNChange[t].sequenceNumber>e);t++);0!==t&&(this.messagesSinceMSNChange=this.messagesSinceMSNChange.slice(t))}loadFinished(e){if(!this.loadedDeferred.isCompleted){if(this.initializeIntervalCollections(),e)throw this.loadedDeferred.reject(e),e;this.deferIncomingOps=!1;for(const e of this.loadedDeferredIncomingOps)this.processCore(e,!1,void 0);this.loadedDeferredIncomingOps.length=0,this.loadedDeferred.resolve();for(const[e,t]of this.loadedDeferredOutgoingOps)this.reSubmitCore(e,t);this.loadedDeferredOutgoingOps.length=0}}initializeIntervalCollections(){this.intervalCollections.eventEmitter.on("create",({key:e,previousValue:t},s)=>{const i=this.intervalCollections.get(e);i.attached||i.attachGraph(this.client,e),Object(r.a)(void 0===t,705),this.emit("createIntervalCollection",e,s,this)});for(const e of this.intervalCollections.keys()){this.intervalCollections.get(e).attachGraph(this.client,e)}}}},18050:function(e,t,s){"use strict";s.d(t,"a",(function(){return S}));var i=s(17970),n=s(18027),r=s(17940),a=s(17989),o=s(17945),c=s(18040),l=s(18037),u=s(18047),h=s(18036),d=s(18051),m=s(18039),g=s(18054),p=s(18056),f=s(18052),b=s(18053);function v(e){return 1e3*e.trace().duration}class S{constructor(e,t,s){this.specToSegment=e,this.logger=t,this.measureOps=!1,this.accumTime=0,this.localTime=0,this.localOps=0,this.accumWindowTime=0,this.accumWindow=0,this.accumOps=0,this.maxWindowTime=0,this.clientNameToIds=new c.e(h.e),this.shortClientIdMap=[],this.pendingConsensus=new Map,this.mergeTree=new h.c(s)}get mergeTreeDeltaCallback(){return this.mergeTree.mergeTreeDeltaCallback}set mergeTreeDeltaCallback(e){this.mergeTree.mergeTreeDeltaCallback=e}get mergeTreeMaintenanceCallback(){return this.mergeTree.mergeTreeMaintenanceCallback}set mergeTreeMaintenanceCallback(e){this.mergeTree.mergeTreeMaintenanceCallback=e}peekPendingSegmentGroups(e=1){var t,s;if(1===e)return null===(t=this.mergeTree.pendingSegments)||void 0===t?void 0:t.last();let i=0;return null===(s=this.mergeTree.pendingSegments)||void 0===s?void 0:s.some(()=>i<e&&(i++,!0),!0)}annotateMarkerNotifyConsensus(e,t,s){const i=this.annotateMarker(e,t,{name:"consensus"});if(i){const t={callback:s,marker:e};return this.pendingConsensus.set(e.getId(),t),i}}annotateMarker(e,t,s){const i=Object(d.a)(e,t,s);return this.applyAnnotateRangeOp({op:i})?i:void 0}annotateRangeLocal(e,t,s,i){const n=Object(d.b)(e,t,s,i);if(this.applyAnnotateRangeOp({op:n}))return n}removeRangeLocal(e,t){const s=Object(d.f)(e,t);if(this.applyRemoveRangeOp({op:s}))return s}insertSegmentLocal(e,t){if(t.cachedLength<=0)return;const s=Object(d.e)(e,t);return this.applyInsertOp({op:s})?s:void 0}insertAtReferencePositionLocal(e,t){const s=this.mergeTree.referencePositionToLocalPosition(e,this.getCurrentSeq(),this.getClientId());if(s===u.a.DetachedPosition)return;const i=Object(d.e)(s,t),r={op:i};let a;return this.measureOps&&(a=n.a.start()),this.mergeTree.insertAtReferencePosition(e,t,r),this.completeAndLogOp(r,this.getClientSequenceArgs(r),{start:i.pos1},a),i}walkSegments(e,t,s,i,n=!1){this.mergeTree.mapRange({leaf:e},this.getCurrentSeq(),this.getClientId(),i,t,s,n)}serializeGCData(e,t){this.mergeTree.walkAllSegments(this.mergeTree.root,s=>(void 0===s.removedSeq&&t.stringify(s.clone().toJSONObject(),e),!0))}getCollabWindow(){return this.mergeTree.getCollabWindow()}getPosition(e){return void 0===(null==e?void 0:e.parent)?-1:this.mergeTree.getPosition(e,this.getCurrentSeq(),this.getClientId())}addLocalReference(e){return this.mergeTree.addLocalReference(e)}removeLocalReference(e){return this.removeLocalReferencePosition(e)}createLocalReferencePosition(e,t,s,i){return this.mergeTree.createLocalReferencePosition(e,t,s,i,this)}removeLocalReferencePosition(e){return this.mergeTree.removeLocalReferencePosition(e)}localReferencePositionToPosition(e){return this.mergeTree.referencePositionToLocalPosition(e)}posFromRelativePos(e){return this.mergeTree.posFromRelativePos(e)}getMarkerFromId(e){return this.mergeTree.getMarkerFromId(e)}applyRemoveRangeOp(e){Object(r.a)(e.op.type===m.a.REMOVE,45);const t=e.op,s=this.getClientSequenceArgs(e),i=this.getValidOpRange(t,s);if(!i)return!1;let a;return this.measureOps&&(a=n.a.start()),this.mergeTree.markRangeRemoved(i.start,i.end,s.referenceSequenceNumber,s.clientId,s.sequenceNumber,!1,e),this.completeAndLogOp(e,s,i,a),!0}applyAnnotateRangeOp(e){Object(r.a)(e.op.type===m.a.ANNOTATE,46);const t=e.op,s=this.getClientSequenceArgs(e),i=this.getValidOpRange(t,s);if(!i)return!1;let a;return this.measureOps&&(a=n.a.start()),this.mergeTree.annotateRange(i.start,i.end,t.props,t.combiningOp,s.referenceSequenceNumber,s.clientId,s.sequenceNumber,e),this.completeAndLogOp(e,s,i,a),!0}applyInsertOp(e){Object(r.a)(e.op.type===m.a.INSERT,47);const t=e.op,s=this.getClientSequenceArgs(e),i=this.getValidOpRange(t,s);if(!i)return!1;let a,o;return t.seg&&(a=[this.specToSegment(t.seg)]),!(!a||0===a.length)&&(this.measureOps&&(o=n.a.start()),this.mergeTree.insertSegments(i.start,a,s.referenceSequenceNumber,s.clientId,s.sequenceNumber,e),this.completeAndLogOp(e,s,i,o),!0)}completeAndLogOp(e,t,s,i){e.sequencedMessage?(Object(r.a)(this.mergeTree.getCollabWindow().currentSeq<t.sequenceNumber,48),Object(r.a)(this.mergeTree.getCollabWindow().minSeq<=e.sequencedMessage.minimumSequenceNumber,49),i&&(this.accumTime+=v(i),this.accumOps++,this.accumWindow+=this.getCurrentSeq()-this.getCollabWindow().minSeq)):i&&(this.localTime+=v(i),this.localOps++)}getValidOpRange(e,t){let s=e.pos1;void 0===s&&e.relativePos1&&(s=this.mergeTree.posFromRelativePos(e.relativePos1,t.referenceSequenceNumber,t.clientId));let i=e.pos2;if(void 0===i&&e.relativePos2&&(i=this.mergeTree.posFromRelativePos(e.relativePos2,t.referenceSequenceNumber,t.clientId)),t.clientId===this.getClientId()){const t=this.getLength(),n=[];if((void 0===s||s<0||s>t||s===t&&e.type!==m.a.INSERT)&&n.push("start"),e.type===m.a.INSERT&&void 0===i||(void 0===i||i<=s)&&n.push("end"),n.length>0)throw new o.a("RangeOutOfBounds",{usageError:!0,end:i,invalidPositions:n.toString(),length:t,opPos1:e.pos1,opPos1Relative:void 0!==e.relativePos1,opPos2:e.pos2,opPos2Relative:void 0!==e.relativePos2,opType:e.type,start:s})}return{start:s,end:i}}getClientSequenceArgsForMessage(e){if(e)return{clientId:this.getOrAddShortClientId(e.clientId),referenceSequenceNumber:e.referenceSequenceNumber,sequenceNumber:e.sequenceNumber};{const e=this.getCollabWindow();return{clientId:e.clientId,referenceSequenceNumber:e.currentSeq,sequenceNumber:this.getLocalSequenceNumber()}}}getClientSequenceArgs(e){return this.getClientSequenceArgsForMessage(e.sequencedMessage)}ackPendingSegment(e){const t=e=>{let t;this.measureOps&&(t=n.a.start()),this.mergeTree.ackPendingSegment(e),e.op.type===m.a.ANNOTATE&&e.op.combiningOp&&"consensus"===e.op.combiningOp.name&&this.updateConsensusProperty(e.op,e.sequencedMessage),t&&(this.accumTime+=v(t),this.accumOps++,this.accumWindow+=this.getCurrentSeq()-this.getCollabWindow().minSeq)};if(e.op.type===m.a.GROUP)for(const s of e.op.ops)t({groupOp:e.op,op:s,sequencedMessage:e.sequencedMessage});else t(e)}cloneFromSegments(){const e=new S(this.specToSegment,this.logger,this.mergeTree.options),t=this.mergeTree.blockClone(this.mergeTree.root,[]);return e.mergeTree.root=t,e}getOrAddShortClientId(e){return this.clientNameToIds.get(e)||this.addLongClientId(e),this.getShortClientId(e)}getShortClientId(e){return this.clientNameToIds.get(e).data}getLongClientId(e){return e>=0?this.shortClientIdMap[e]:"original"}addLongClientId(e){this.clientNameToIds.put(e,this.shortClientIdMap.length),this.shortClientIdMap.push(e)}findReconnectionPosition(e,t){Object(r.a)(t<=this.mergeTree.collabWindow.localSeq,50);let s=0;return this.mergeTree.walkAllSegments(this.mergeTree.root,i=>i!==e&&((void 0===i.localSeq||i.localSeq<=t)&&(void 0===i.removedSeq||i.localRemovedSeq>t)&&(s+=i.cachedLength),!0)),s}rebasePosition(e,t,s){let i;Object(r.a)(s<=this.mergeTree.collabWindow.localSeq,768);let n=0,a=e;this.mergeTree.walkAllSegments(this.mergeTree.root,o=>(Object(r.a)(void 0!==o.seq||void 0!==o.localSeq,769),i=o,(e=>void 0!==e.seq&&e.seq!==l.d&&e.seq<=t||void 0!==e.localSeq&&e.localSeq<=s)(o)&&!(({removedSeq:e,localRemovedSeq:i})=>void 0!==e&&e!==l.d&&e<=t||void 0!==i&&i<=s)(o)&&(n+=o.cachedLength,a>=o.cachedLength&&(a-=o.cachedLength)),n<=e)),Object(r.a)(void 0!==i,770);const o=this.getCollabWindow().currentSeq;return(void 0!==i.removedSeq&&i.removedSeq!==l.d&&i.removedSeq<=o||void 0!==i.localRemovedSeq&&i.localRemovedSeq<=s)&&(a=0),Object(r.a)(0<=a&&a<i.cachedLength,771),this.findReconnectionPosition(i,s)+a}resetPendingDeltaToOps(e,t){var s,i;Object(r.a)(!!t,51);const n=null===(s=this.mergeTree.pendingSegments)||void 0===s?void 0:s.dequeue();Object(r.a)(t===n,52);const a=[];for(const o of t.segments.sort((e,t)=>e.ordinal<t.ordinal?-1:1)){const s=o.segmentGroups.dequeue();Object(r.a)(t===s,53);const n=this.findReconnectionPosition(o,t.localSeq);let c;switch(e.type){case m.a.ANNOTATE:Object(r.a)(!0===(null===(i=o.propertyManager)||void 0===i?void 0:i.hasPendingProperties()),54),void 0!==o.removedSeq&&void 0===o.localRemovedSeq||(c=Object(d.b)(n,n+o.cachedLength,e.props,e.combiningOp));break;case m.a.INSERT:Object(r.a)(o.seq===l.d,55);let t=o;"object"==typeof e.seg&&void 0!==e.seg.props&&(t=o.clone(),t.properties=e.seg.props),c=Object(d.e)(n,t);break;case m.a.REMOVE:void 0!==o.localRemovedSeq&&(c=Object(d.f)(n,n+o.cachedLength));break;default:throw new Error("Invalid op type")}if(c){const e={segments:[],localSeq:t.localSeq};o.segmentGroups.enqueue(e),this.mergeTree.pendingSegments.enqueue(e),a.push(c)}}return a}applyRemoteOp(e){const t=e.op,s=e.sequencedMessage;switch(this.getOrAddShortClientId(s.clientId),t.type){case m.a.INSERT:this.applyInsertOp(e);break;case m.a.REMOVE:this.applyRemoveRangeOp(e);break;case m.a.ANNOTATE:this.applyAnnotateRangeOp(e);break;case m.a.GROUP:for(const e of t.ops)this.applyRemoteOp({op:e,groupOp:t,sequencedMessage:s})}}applyStashedOp(e){let t;switch(e.type){case m.a.INSERT:this.applyInsertOp({op:e}),t=this.peekPendingSegmentGroups();break;case m.a.REMOVE:this.applyRemoveRangeOp({op:e}),t=this.peekPendingSegmentGroups();break;case m.a.ANNOTATE:this.applyAnnotateRangeOp({op:e}),t=this.peekPendingSegmentGroups();break;case m.a.GROUP:return e.ops.map(e=>this.applyStashedOp(e));default:Object(a.a)(e,"unrecognized op type")}return Object(r.a)(!!t,731),t}applyMsg(e,t=!1){var s;if(this.getOrAddShortClientId(e.clientId),e.type===i.a.Operation){const i={op:e.contents,sequencedMessage:e};(null===(s=i.sequencedMessage)||void 0===s?void 0:s.clientId)===this.longClientId||t?this.ackPendingSegment(i):this.applyRemoteOp(i)}this.updateSeqNumbers(e.minimumSequenceNumber,e.sequenceNumber)}updateSeqNumbers(e,t){const s=this.mergeTree.getCollabWindow();Object(r.a)(s.currentSeq<=t,56),s.currentSeq=t,Object(r.a)(e<=t,57),this.updateMinSeq(e)}resolveRemoteClientPosition(e,t,s){const i=this.getOrAddShortClientId(s);return this.mergeTree.resolveRemoteClientPosition(e,t,i)}regeneratePendingOp(e,t){const s=[];if(e.type===m.a.GROUP)if(Array.isArray(t)){Object(r.a)(e.ops.length===t.length,58);for(let i=0;i<e.ops.length;i++)s.push(...this.resetPendingDeltaToOps(e.ops[i],t[i]))}else Object(r.a)(1===e.ops.length,59),s.push(...this.resetPendingDeltaToOps(e.ops[0],t));else Object(r.a)(e.type!==m.a.GROUP,60),Object(r.a)(!Array.isArray(t),61),s.push(...this.resetPendingDeltaToOps(e,t));return 1===s.length?s[0]:Object(d.c)(...s)}createTextHelper(){return new f.a(this.mergeTree)}summarize(e,t,s,i){var n;const a=e.deltaManager,o=a.minimumSequenceNumber;if(this.updateSeqNumbers(o,a.lastSequenceNumber),Object(r.a)(this.getCollabWindow().minSeq===o,62),!0===(null===(n=this.mergeTree.options)||void 0===n?void 0:n.newMergeTreeSnapshotFormat)){Object(r.a)(void 0===i||0===i.length,63);const e=new b.a(this.mergeTree,this.logger,e=>this.getLongClientId(e));return e.extractSync(),e.emit(s,t)}{const e=new g.a(this.mergeTree,this.logger);return e.extractSync(),e.emit(i,s,t)}}async load(e,t,s){return new p.a(e,this,this.mergeTree,this.logger,s).initialize(t)}getStackContext(e,t){return this.mergeTree.getStackContext(e,this.getCollabWindow().clientId,t)}getLocalSequenceNumber(){return this.getCollabWindow().collaborating?l.d:l.e}localTransaction(e){for(const t of e.ops){const s={op:t,groupOp:e};switch(t.type){case m.a.INSERT:this.applyInsertOp(s);break;case m.a.ANNOTATE:this.applyAnnotateRangeOp(s);break;case m.a.REMOVE:this.applyRemoveRangeOp(s)}}}updateConsensusProperty(e,t){const s=e.relativePos1.id,i=this.pendingConsensus.get(s);i&&i.marker.addProperties(e.props,e.combiningOp,t.sequenceNumber),this.mergeTree.addMinSeqListener(t.sequenceNumber,()=>i.callback(i.marker))}updateMinSeq(e){let t;if(this.measureOps&&(t=n.a.start()),this.mergeTree.setMinSeq(e),t){const e=v(t);this.accumWindowTime+=e,e>this.maxWindowTime&&(this.maxWindowTime=e)}}getContainingSegment(e,t){const s=this.getClientSequenceArgsForMessage(t);return this.mergeTree.getContainingSegment(e,s.referenceSequenceNumber,s.clientId)}getSlideToSegment(e){return this.mergeTree._getSlideToSegment(e)}getPropertiesAtPosition(e){let t;const s=this.getContainingSegment(e).segment;return s&&(t=s.properties),t}getRangeExtentsOfPosition(e){let t,s;const i=this.getContainingSegment(e).segment;return i&&(t=this.getPosition(i),s=t+i.cachedLength),{posStart:t,posAfterEnd:s}}getCurrentSeq(){return this.getCollabWindow().currentSeq}getClientId(){return this.getCollabWindow().clientId}getLength(){return this.mergeTree.length}startOrUpdateCollaboration(e,t=0,s=0){if(void 0!==e)if(void 0===this.longClientId)this.longClientId=e,this.addLongClientId(this.longClientId),this.mergeTree.startCollaboration(this.getShortClientId(this.longClientId),t,s);else{const t=this.longClientId,s=this.clientNameToIds.get(t).data;this.longClientId=e,this.clientNameToIds.put(e,s),this.shortClientIdMap[s]=e}}findTile(e,t,s=!0){const i=this.getClientId();return this.mergeTree.findTile(e,i,t,s)}}},18051:function(e,t,s){"use strict";s.d(t,"a",(function(){return n})),s.d(t,"b",(function(){return r})),s.d(t,"f",(function(){return a})),s.d(t,"e",(function(){return o})),s.d(t,"d",(function(){return c})),s.d(t,"c",(function(){return l}));var i=s(18039);function n(e,t,s){const n=e.getId();if(n)return{combiningOp:s,props:t,relativePos1:{id:n,before:!0},relativePos2:{id:n},type:i.a.ANNOTATE}}function r(e,t,s,n){return{combiningOp:n,pos1:e,pos2:t,props:s,type:i.a.ANNOTATE}}function a(e,t){return{pos1:e,pos2:t,type:i.a.REMOVE}}function o(e,t){return c(e,t.toJSONObject())}function c(e,t){return{pos1:e,seg:t,type:i.a.INSERT}}function l(...e){return{ops:e,type:i.a.GROUP}}},18052:function(e,t,s){"use strict";s.d(t,"b",(function(){return r})),s.d(t,"a",(function(){return o}));var i=s(18036),n=s(18047);class r extends i.a{constructor(e){super(),this.text=e,this.type=r.type,this.cachedLength=e.length}static is(e){return e.type===r.type}static make(e,t){const s=new r(e);return t&&s.addProperties(t),s}static fromJSONObject(e){if("string"==typeof e)return new r(e);if(e&&"object"==typeof e&&"text"in e){const t=e;return r.make(t.text,t.props)}}toJSONObject(){return this.properties?{text:this.text,props:this.properties}:this.text}clone(e=0,t){const s=this.text.substring(e,t),i=r.make(s,this.properties);return this.cloneInto(i),i}canAppend(e){return!this.text.endsWith("\n")&&r.is(e)&&(this.cachedLength<=256||e.cachedLength<=256)}toString(){return this.text}append(e){if(!r.is(e))throw new Error("can only append text segment");n.b.append(this,e),this.text+=e.text,this.cachedLength=this.text.length}removeRange(e,t){let s="";const i=this.text.length;return e>0&&(s+=this.text.substring(0,e)),t<i&&(s+=this.text.substring(t)),this.text=s,this.cachedLength=s.length,0===s.length}createSplitSegmentAt(e){if(e>0){const t=this.text.substring(e);this.text=this.text.substring(0,e),this.cachedLength=this.text.length;return new r(t)}}}function a(e){return!0===e.parallelArrays}r.type="TextSegment";class o{constructor(e){this.mergeTree=e,this.gatherText=(e,t,s,i,n,o,c)=>{var l,u;let h=n;if(r.is(e)){let t="",s="";if(a(c)){const i=[],n=[];(null===(l=e.properties)||void 0===l?void 0:l["font-weight"])&&i.push("b"),(null===(u=e.properties)||void 0===u?void 0:u["text-decoration"])&&i.push("u");const r=[];if(i.length>0){for(const e of i)c.tagsInProgress.includes(e)||(t+=`<${e}>`,n.push(e));for(const e of c.tagsInProgress)i.includes(e)||(s+=`</${e}>`,r.push(e));for(const e of n.reverse())c.tagsInProgress.push(e)}else for(const e of c.tagsInProgress)s+=`</${e}>`,r.push(e);for(const e of r){const t=c.tagsInProgress.indexOf(e);t>=0&&c.tagsInProgress.splice(t,1)}}c.textSegment.text+=s,c.textSegment.text+=t,h<=0&&o>=e.text.length?c.textSegment.text+=e.text:(h<0&&(h=0),o>=e.text.length?c.textSegment.text+=e.text.substring(h):c.textSegment.text+=e.text.substring(h,o))}else if(c.placeholder&&c.placeholder.length>0)if("*"===c.placeholder){const t=e;c.textSegment.text+="\n"+t.toString()}else for(let r=0;r<e.cachedLength;r++)c.textSegment.text+=c.placeholder;else if(a(c)){const t=e;t.hasTileLabel(c.parallelMarkerLabel)&&(c.parallelMarkers.push(t),c.parallelText.push(c.textSegment.text),c.textSegment.text="")}return!0}}getTextAndMarkers(e,t,s,i,n){const a=this.getValidRange(i,n,e,t),o={parallelArrays:!0,parallelMarkerLabel:s,parallelMarkers:[],parallelText:[],tagsInProgress:[],textSegment:new r("")};return this.mergeTree.mapRange({leaf:this.gatherText},e,t,o,a.start,a.end),{parallelText:o.parallelText,parallelMarkers:o.parallelMarkers}}getText(e,t,s="",i,n){const a=this.getValidRange(i,n,e,t),o={textSegment:new r(""),placeholder:s};return this.mergeTree.mapRange({leaf:this.gatherText},e,t,o,a.start,a.end),o.textSegment.text}getValidRange(e,t,s,i){return{end:null!=t?t:this.mergeTree.getLength(s,i),start:null!=e?e:0}}}},18053:function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var i=s(17940),n=s(17983),r=s(17944),a=s(17991),o=s(18037),c=s(18041),l=s(18055),u=s(18054);class h{constructor(e,t,s,i,n){var a,o;this.mergeTree=e,this.getLongClientId=s,this.filename=i,this.onCompletion=n,this.logger=r.a.create(t,"Snapshot"),this.chunkSize=null!==(o=null===(a=null==e?void 0:e.options)||void 0===a?void 0:a.mergeTreeSnapshotChunkSize)&&void 0!==o?o:h.chunkSize;const{currentSeq:c,minSeq:l}=e.getCollabWindow();this.header={minSequenceNumber:l,sequenceNumber:c,orderedChunkMetadata:[],totalLength:0,totalSegmentCount:0},this.segments=[],this.segmentLengths=[]}getSeqLengthSegs(e,t,s,i=0){const n=[];let r=0,a=0;for(;r<s&&i+a<e.length;){const s=e[i+a];n.push(s),r+=t[i+a],a++}return{version:"1",segmentCount:a,length:r,segments:n,startindex:i,headerMetadata:void 0}}emit(e,t){const s=[];this.header.totalSegmentCount=0,this.header.totalLength=0;do{const e=this.getSeqLengthSegs(this.segments,this.segmentLengths,this.chunkSize,this.header.totalSegmentCount);s.push(e),this.header.totalSegmentCount+=e.segmentCount,this.header.totalLength+=e.length}while(this.header.totalSegmentCount<this.segments.length);const i=s.shift();i.headerMetadata=this.header,i.headerMetadata.orderedChunkMetadata=[{id:u.a.header}];const n=[];s.forEach((s,i)=>{const r=`${u.a.body}_${i}`;this.header.orderedChunkMetadata.push({id:r}),n.push([r,Object(l.b)(r,s,this.logger,this.mergeTree.options,e,t)])});const r=new a.a;return r.addBlob(u.a.header,Object(l.b)(u.a.header,i,this.logger,this.mergeTree.options,e,t)),n.forEach(e=>{r.addBlob(e[0],e[1])}),r.getSummaryTree()}extractSync(){const e=this.mergeTree,t=this.header.minSequenceNumber,s=(e,t)=>{this.segments.push(e),this.segmentLengths.push(t)},n=e=>{e&&s(e.toJSONObject(),e.cachedLength)};let r;return e.walkAllSegments(e.root,e=>{var a;if(e.seq===o.d||e.removedSeq<=t)return!0;if(e.seq<=t&&(void 0===e.removedSeq||e.removedSeq===o.d))r?r.canAppend(e)&&Object(c.g)(r.properties,e.properties)?(r=r.clone(),r.append(e.clone())):(n(r),r=e):r=e;else{n(r),r=void 0;const c={json:e.toJSONObject()};e.seq>t&&(c.seq=e.seq,c.client=this.getLongClientId(e.clientId)),void 0!==e.removedSeq&&(Object(i.a)(e.removedSeq!==o.d&&e.removedSeq>t,101),c.removedSeq=e.removedSeq,c.removedClient=void 0!==e.removedClientIds?this.getLongClientId(e.removedClientIds[0]):void 0,c.removedClientIds=null===(a=e.removedClientIds)||void 0===a?void 0:a.map(e=>this.getLongClientId(e))),Object(i.a)(void 0!==c.seq&&void 0!==c.client||void 0!==c.removedSeq&&void 0!==c.removedClient,102),s(c,e.cachedLength)}return!0},this),n(r),this.segments}static async loadChunk(e,t,s,i,r){const a=await e.readBlob(t),o=Object(n.c)(a,"utf8");return h.processChunk(t,o,s,i,r)}static processChunk(e,t,s,i,n){const r=n?n.parse(t):JSON.parse(t);return Object(l.d)(e,r,s,i)}}h.chunkSize=1e4},18054:function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var i=s(17940),n=s(17944),r=s(17991),a=s(18037),o=s(18041),c=s(18055);class l{constructor(e,t,s,i){var r,a;this.mergeTree=e,this.filename=s,this.onCompletion=i,this.logger=n.a.create(t,"Snapshot"),this.chunkSize=null!==(a=null===(r=null==e?void 0:e.options)||void 0===r?void 0:r.mergeTreeSnapshotChunkSize)&&void 0!==a?a:l.sizeOfFirstChunk}getSeqLengthSegs(e,t,s,i=0){const n=[];let r=0,a=0;for(;r<s&&i+a<e.length;){const s=e[i+a];n.push(s),r+=t[i+a],a++}return{version:void 0,chunkStartSegmentindex:i,chunkSegmentCount:a,chunkLengthChars:r,totalLengthChars:this.header.segmentsTotalLength,totalSegmentCount:e.length,chunkSequenceNumber:this.header.seq,segmentTexts:n}}emit(e,t,s){var n,a;const o=this.getSeqLengthSegs(this.segments,this.segmentLengths,this.chunkSize);let u=o.chunkLengthChars,h=o.chunkSegmentCount;const d=new r.a;if(d.addBlob(l.header,Object(c.c)(l.header,o,this.logger,this.mergeTree.options,t,s)),o.chunkSegmentCount<o.totalSegmentCount){const e=this.getSeqLengthSegs(this.segments,this.segmentLengths,this.header.segmentsTotalLength,o.chunkSegmentCount);u+=e.chunkLengthChars,h+=e.chunkSegmentCount,d.addBlob(l.body,Object(c.c)(l.body,e,this.logger,this.mergeTree.options,t,s))}return Object(i.a)(u===this.header.segmentsTotalLength,93),Object(i.a)(h===o.totalSegmentCount,94),void 0!==e&&e.length>0&&d.addBlob(null!==(a=null===(n=this.mergeTree.options)||void 0===n?void 0:n.catchUpBlobName)&&void 0!==a?a:l.catchupOps,t?t.stringify(e,s):JSON.stringify(e)),d.getSummaryTree()}extractSync(){const e=this.mergeTree.getCollabWindow();this.seq=e.minSeq,this.header={segmentsTotalLength:this.mergeTree.getLength(this.mergeTree.collabWindow.minSeq,a.b),seq:this.mergeTree.collabWindow.minSeq};const t=[];let s;this.mergeTree.map({leaf:(e,i,n,r,c,l)=>(e.seq!==a.d&&e.seq<=this.seq&&(void 0===e.removedSeq||e.removedSeq===a.d||e.removedSeq>this.seq)&&((null==s?void 0:s.canAppend(e))&&Object(o.g)(s.properties,e.properties)?(s=s.clone(),s.append(e.clone())):(s&&t.push(s),s=e)),!0)},this.seq,a.b,void 0),s&&t.push(s),this.segments=[],this.segmentLengths=[];let i=0;return t.map(e=>{i+=e.cachedLength,this.segments.push(e.toJSONObject()),this.segmentLengths.push(e.cachedLength)}),this.header.segmentsTotalLength!==i&&(this.logger.sendErrorEvent({eventName:"SegmentsTotalLengthMismatch",totalLength:i,segmentsTotalLength:this.header.segmentsTotalLength}),this.header.segmentsTotalLength=i),this.segments}}l.header="header",l.body="body",l.catchupOps="catchupOps",l.sizeOfFirstChunk=1e4},18055:function(e,t,s){"use strict";s.d(t,"a",(function(){return n})),s.d(t,"c",(function(){return r})),s.d(t,"b",(function(){return a})),s.d(t,"d",(function(){return o}));var i=s(18054);function n(e){return!!e&&"object"==typeof e&&"json"in e}function r(e,t,s,n,r,a){let o;switch(void 0!==t.version&&s.send({eventName:"MergeTreeChunk:serializeAsMinSupportedVersion",category:"generic",fromChunkVersion:t.version,toChunkVersion:void 0}),t.version){case void 0:o=t,o.headerMetadata=c(e,o,n);break;case"1":const s=t,r=e===i.a.header?s.headerMetadata:void 0;o={version:void 0,chunkStartSegmentindex:s.startindex,chunkLengthChars:s.length,chunkSegmentCount:s.segmentCount,segmentTexts:s.segments,totalLengthChars:null==r?void 0:r.totalLength,totalSegmentCount:null==r?void 0:r.totalSegmentCount,chunkSequenceNumber:null==r?void 0:r.sequenceNumber,chunkMinSequenceNumber:null==r?void 0:r.minSequenceNumber,headerMetadata:r};break;default:throw new Error(`Unsupported chunk path: ${e} version: ${t.version}`)}return r.stringify(o,a)}function a(e,t,s,i,n,r){const a=o(e,t,s,i);return n.stringify(a,r)}function o(e,t,s,i){switch(t.version){case void 0:{const s=t;return{version:"1",length:s.chunkLengthChars,segmentCount:s.chunkSegmentCount,headerMetadata:c(e,s,i),segments:s.segmentTexts,startindex:s.chunkStartSegmentindex}}case"1":return t;default:throw new Error(`Unsupported chunk path: ${e} version: ${t.version}`)}}function c(e,t,s){if(e===i.a.header){if(void 0!==t.headerMetadata)return t.headerMetadata;const e=[{id:i.a.header}];return t.chunkLengthChars<t.totalLengthChars&&e.push({id:i.a.body}),{orderedChunkMetadata:e,minSequenceNumber:t.chunkMinSequenceNumber,sequenceNumber:t.chunkSequenceNumber,totalLength:t.totalLengthChars,totalSegmentCount:t.totalSegmentCount}}}},18056:function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var i=s(17940),n=s(17983),r=s(17944),a=s(17959),o=s(18037),c=s(18055),l=s(18053),u=s(18054);class h{constructor(e,t,s,i,n){this.runtime=e,this.client=t,this.mergeTree=s,this.serializer=n,this.specToSegment=e=>{var t;let s;return Object(c.a)(e)?(s=this.client.specToSegment(e.json),s.clientId=void 0!==e.client?this.client.getOrAddShortClientId(e.client):o.b,s.seq=void 0!==e.seq?e.seq:o.e,void 0!==e.removedSeq&&(s.removedSeq=e.removedSeq),void 0!==e.removedClient&&(s.removedClientIds=[this.client.getOrAddShortClientId(e.removedClient)]),void 0!==e.removedClientIds&&(s.removedClientIds=null===(t=e.removedClientIds)||void 0===t?void 0:t.map(e=>this.client.getOrAddShortClientId(e)))):(s=this.client.specToSegment(e),s.seq=o.e,s.clientId=o.b),s},this.logger=r.a.create(i,"SnapshotLoader")}async initialize(e){const t=e.readBlob(u.a.header).then(e=>(Object(i.a)(!!e,95),this.loadHeader(Object(n.c)(e,"utf8")))),s=this.loadBodyAndCatchupOps(t,e);return s.catch(e=>this.logger.sendErrorEvent({eventName:"CatchupOpsLoadFailure"},e)),await t,{catchupOpsP:s}}async loadBodyAndCatchupOps(e,t){const s=t.list(""),n=await e;await this.loadBody(n,t);const r=await s;if(r.length===n.headerMetadata.orderedChunkMetadata.length+1)return n.headerMetadata.orderedChunkMetadata.forEach(e=>r.splice(r.indexOf(e.id),1)),Object(i.a)(1===r.length,96),this.loadCatchupOps(t.readBlob(r[0]));if(r.length!==n.headerMetadata.orderedChunkMetadata.length)throw new Error("Unexpected blobs in snapshot");return[]}loadHeader(e){var t;const s=l.a.processChunk(u.a.header,e,this.logger,this.mergeTree.options,this.serializer),i=s.segments.map(this.specToSegment);if(this.mergeTree.reloadFromSegments(i),void 0===s.headerMetadata)throw new Error("header metadata not available");return this.runtime.attachState!==a.a.Detached&&this.client.startOrUpdateCollaboration(null!==(t=this.runtime.clientId)&&void 0!==t?t:"snapshot",void 0!==s.headerMetadata.minSequenceNumber?s.headerMetadata.minSequenceNumber:s.headerMetadata.sequenceNumber,s.headerMetadata.sequenceNumber),s}async loadBody(e,t){if(Object(i.a)(e.length<=e.headerMetadata.totalLength,97),Object(i.a)(e.segmentCount<=e.headerMetadata.totalSegmentCount,98),e.segmentCount===e.headerMetadata.totalSegmentCount)return;const s=[];let n=e.length;for(let i=1;i<e.headerMetadata.orderedChunkMetadata.length;i++){const r=await l.a.loadChunk(t,e.headerMetadata.orderedChunkMetadata[i].id,this.logger,this.mergeTree.options,this.serializer);n+=r.length,s.push(...r.segments.map(this.specToSegment))}Object(i.a)(n===e.headerMetadata.totalLength,99),Object(i.a)(e.segmentCount+s.length===e.headerMetadata.totalSegmentCount,100);const r=this.mergeTree,a=(e,t,s)=>{r.insertSegments(r.root.cachedLength,e,o.e,t,s,void 0)},c=[],u=()=>{c.length>0&&a(c,o.b,o.e)};for(const i of s){const e=i.clientId,t=i.seq;e===o.b&&t===o.e?c.push(i):(u(),a([i],e,t))}u()}async loadCatchupOps(e){return JSON.parse(Object(n.c)(await e,"utf8"))}}},18057:function(e,t,s){"use strict";s.d(t,"a",(function(){return a})),s.d(t,"b",(function(){return o}));var i=s(17940),n=s(18044);class r{constructor(e,t){this.deltaArgs=e,this.mergeTreeClient=t,Object(i.a)(e.deltaSegments.length>0,728),this.isEmpty=!1,this.deltaOperation=e.operation,this.sortedRanges=new c(()=>{const e=new n.a;return this.deltaArgs.deltaSegments.forEach(t=>{const s={operation:this.deltaArgs.operation,position:this.mergeTreeClient.getPosition(t.segment),propertyDeltas:t.propertyDeltas,segment:t.segment};e.addOrUpdate(s)}),e}),this.pFirst=new c(()=>this.sortedRanges.value.items[0]),this.pLast=new c(()=>this.sortedRanges.value.items[this.sortedRanges.value.size-1])}get ranges(){return this.sortedRanges.value.items}get clientId(){return this.mergeTreeClient.longClientId}get first(){return this.pFirst.value}get last(){return this.pLast.value}}class a extends r{constructor(e,t,s){super(t,s),this.opArgs=e,this.isLocal=void 0===e.sequencedMessage}}class o extends r{constructor(e,t,s){super(t,s),this.opArgs=e}}class c{constructor(e){this.valueGenerator=e,this.pEvaluated=!1}get evaluated(){return this.pEvaluated}get value(){return this.pEvaluated||(this.pEvaluated=!0,this.pValue=this.valueGenerator()),this.pValue}}},18058:function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var i=s(18032),n=s(18033),r=s(17939),a=s(17940),o=s(18059);class c{constructor(e,t,s,i,n=new r.a){this.serializer=e,this.handle=t,this.submitMessage=s,this.type=i,this.eventEmitter=n,this.messageHandlers=new Map,this.data=new Map,this.messageHandlers=this.getMessageHandlers()}get size(){return this.data.size}keys(){return this.data.keys()}entries(){const e=this.data.entries();return{next(){const t=e.next();return t.done?{value:void 0,done:!0}:{value:[t.value[0],t.value[1].value],done:!1}},[Symbol.iterator](){return this}}}values(){const e=this.data.values();return{next(){const t=e.next();return t.done?{value:void 0,done:!0}:{value:t.value.value,done:!1}},[Symbol.iterator](){return this}}}[Symbol.iterator](){return this.entries()}forEach(e){this.data.forEach((t,s,i)=>{e(t.value,s,i)})}get(e){var t;return(null!==(t=this.data.get(e))&&void 0!==t?t:this.createCore(e,!0)).value}has(e){return this.data.has(e)}getSerializedStorage(e){const t={};return this.data.forEach((s,i)=>{t[i]=s.makeSerialized(e,this.handle)}),t}getSerializableStorage(e){const t={};return this.data.forEach((s,i)=>{t[i]=Object(o.b)(s,e,this.handle)}),t}serialize(e){return JSON.stringify(this.getSerializableStorage(e))}populateFromSerializable(e){for(const[t,s]of Object.entries(e)){if(s.type===i.a[i.a.Plain]||s.type===i.a[i.a.Shared])continue;const e={key:t.startsWith("intervalCollections/")?t.substring(20):t,value:this.makeLocal(t,s)};this.data.set(e.key,e.value)}}populate(e){this.populateFromSerializable(JSON.parse(e))}tryResubmitMessage(e,t){const s=e.type,i=this.messageHandlers.get(s);return void 0!==i&&(i.resubmit(e,t),!0)}tryGetStashedOpLocalMetadata(e){const t=e.type;if(this.messageHandlers.has(t))return this.messageHandlers.get(t).getStashedOpLocalMetadata(e);throw new Error("no apply stashed op handler")}tryProcessMessage(e,t,s,i){const n=this.messageHandlers.get(e.type);return void 0!==n&&(n.process(e,t,s,i),!0)}createCore(e,t){const s=new o.a(this.type.factory.load(this.makeMapValueOpEmitter(e),void 0),this.type),i=this.data.get(e);this.data.set(e,s);const n={key:e,previousValue:i};return this.eventEmitter.emit("create",n,t,this.eventEmitter),s}makeLocal(e,t){Object(a.a)(t.type!==i.a[i.a.Plain]&&t.type!==i.a[i.a.Shared],737),t.value=Object(n.c)(t.value,this.serializer);const s=this.type.factory.load(this.makeMapValueOpEmitter(e),t.value);return new o.a(s,this.type)}getMessageHandlers(){const e=new Map;return e.set("act",{process:(e,t,s,i)=>{var r;const a=null!==(r=this.data.get(e.key))&&void 0!==r?r:this.createCore(e.key,t),o=a.getOpHandler(e.value.opName),c=a.value,l=Object(n.c)(e.value.value,this.serializer);o.process(c,l,t,s,i);const u={key:e.key,previousValue:c};this.eventEmitter.emit("valueChanged",u,t,s,this.eventEmitter)},submit:(e,t)=>{this.submitMessage(e,t)},resubmit:(e,t)=>{const s=this.data.get(e.key),i=s.getOpHandler(e.value.opName),{rebasedOp:n,rebasedLocalOpMetadata:r}=i.rebase(s.value,e.value,t);this.submitMessage(Object.assign(Object.assign({},e),{value:n}),r)},getStashedOpLocalMetadata:e=>{Object(a.a)(!1,22)}}),e}makeMapValueOpEmitter(e){return{emit:(t,s,i,r)=>{const a=Object(n.b)(i,this.serializer,this.handle),o={key:e,type:"act",value:{opName:t,value:a}};this.submitMessage(o,r);const c={key:e,previousValue:s};this.eventEmitter.emit("valueChanged",c,!0,null,this.eventEmitter)}}}}},18059:function(e,t,s){"use strict";s.d(t,"b",(function(){return n})),s.d(t,"a",(function(){return r}));var i=s(18033);function n(e,t,s){const i=e.makeSerialized(t,s);return{type:i.type,value:i.value&&JSON.parse(i.value)}}class r{constructor(e,t){this.value=e,this.valueType=t}get type(){return this.valueType.name}makeSerialized(e,t){const s=this.valueType.factory.store(this.value),n=Object(i.d)(s,e,t);return{type:this.type,value:n}}getOpHandler(e){const t=this.valueType.ops.get(e);if(!t)throw new Error("Unknown type message");return t}}},18060:function(e,t,s){"use strict";s.d(t,"a",(function(){return T}));var i=s(17940),n=s(17939),r=s(17957),a=s(18038),o=s(18045),c=s(18041),l=s(18039),u=s(18047),h=s(18040),d=s(18037),m=s(17945),g=s(17946),p=function(e,t){var s={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(s[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(i=Object.getOwnPropertySymbols(e);n<i.length;n++)t.indexOf(i[n])<0&&Object.prototype.propertyIsEnumerable.call(e,i[n])&&(s[i[n]]=e[i[n]])}return s};var f;!function(e){e[e.Simple=0]="Simple",e[e.Nest=1]="Nest",e[e.SlideOnRemove=2]="SlideOnRemove",e[e.Transient=4]="Transient"}(f||(f={}));class b{constructor(e,t,s){this.start=e,this.end=t,this.propertyManager=new o.a,this.properties={},s&&this.addProperties(s)}getIntervalId(){var e;const t=null===(e=this.properties)||void 0===e?void 0:e.intervalId;if(void 0!==t)return""+t}getAdditionalPropertySets(){return this.auxProps}addPropertySet(e){void 0===this.auxProps&&(this.auxProps=[]),this.auxProps.push(e)}serialize(e){let t=0;e&&(t=e.getCurrentSeq());const s={end:this.end,intervalType:0,sequenceNumber:t,start:this.start};return this.properties&&(s.properties=this.properties),s}clone(){return new b(this.start,this.end,this.properties)}compare(e){const t=this.compareStart(e);if(0===t){const t=this.compareEnd(e);if(0===t){const t=this.getIntervalId();if(t){const s=e.getIntervalId();return s?t>s?1:t<s?-1:0:0}return 0}return t}return t}compareStart(e){return this.start-e.start}compareEnd(e){return this.end-e.end}overlaps(e){return this.start<=e.end&&this.end>=e.start}union(e){return new b(Math.min(this.start,e.start),Math.max(this.end,e.end),this.properties)}getProperties(){return this.properties}addProperties(e,t=!1,s,i){if(e)return this.initializeProperties(),this.propertyManager.addProperties(this.properties,e,i,s,t)}modify(e,t,s,i){const n=null!=t?t:this.start,r=null!=s?s:this.end;if(this.start===n&&this.end===r)return;const a=new b(n,r);return this.properties&&(a.initializeProperties(),this.propertyManager.copyTo(this.properties,a.properties,a.propertyManager)),a}initializeProperties(){this.propertyManager||(this.propertyManager=new o.a),this.properties||(this.properties=Object(c.d)())}}class v{constructor(e,t,s,i){this.start=e,this.end=t,this.intervalType=s,this.propertyManager=new o.a,this.properties={},i&&this.addProperties(i)}addPositionChangeListeners(e,t){var s,i,n,r;if(void 0===this.callbacks){this.callbacks={beforePositionChange:e,afterPositionChange:t};const a=null!==(s=(n=this.start).callbacks)&&void 0!==s?s:n.callbacks={},o=null!==(i=(r=this.end).callbacks)&&void 0!==i?i:r.callbacks={};a.beforeSlide=o.beforeSlide=e,a.afterSlide=o.afterSlide=t}}removePositionChangeListeners(){this.callbacks&&(this.callbacks=void 0,this.start.callbacks=void 0,this.end.callbacks=void 0)}serialize(e){const t=this.start.toPosition(),s={end:this.end.toPosition(),intervalType:this.intervalType,sequenceNumber:e.getCurrentSeq(),start:t};return this.properties&&(s.properties=this.properties),s}clone(){return new v(this.start,this.end,this.intervalType,this.properties)}compare(e){const t=this.compareStart(e);if(0===t){const t=this.compareEnd(e);if(0===t){const t=this.getIntervalId();if(t){const s=e.getIntervalId();return s?t>s?1:t<s?-1:0:0}return 0}return t}return t}compareStart(e){return this.start.compare(e.start)}compareEnd(e){return this.end.compare(e.end)}overlaps(e){return this.start.compare(e.end)<=0&&this.end.compare(e.start)>=0}getIntervalId(){var e;const t=null===(e=this.properties)||void 0===e?void 0:e.intervalId;if(void 0!==t)return""+t}union(e){return new v(this.start.min(e.start),this.end.max(e.end),this.intervalType)}addProperties(e,t=!1,s,i){return this.initializeProperties(),this.propertyManager.addProperties(this.properties,e,i,s,t)}overlapsPos(e,t){const s=this.start.toPosition();return this.start.toPosition()>e&&s<t}modify(e,t,s,i){const n=e=>{let t=e;return void 0===i&&(t&=~l.b.SlideOnRemove,t|=l.b.StayOnRemove),t};let r=this.start;void 0!==t&&(r=y(this.start.getClient(),t,n(this.start.refType),i),r.addProperties(this.start.properties));let a=this.end;void 0!==s&&(a=y(this.end.getClient(),s,n(this.end.refType),i),a.addProperties(this.end.properties)),r.pairedRef=a,a.pairedRef=r;const o=new v(r,a,this.intervalType);return this.properties&&(o.initializeProperties(),this.propertyManager.copyTo(this.properties,o.properties,o.propertyManager)),o}initializeProperties(){this.propertyManager||(this.propertyManager=new o.a),this.properties||(this.properties=Object(c.d)())}}function S(e,t,s,i){if(t.segment){return e.createLocalReferencePosition(t.segment,t.offset,s,void 0)}if(!i&&!Object(a.j)(s,l.b.Transient))throw new r.f("Non-transient references need segment");return new u.a(e,void 0,0,s)}function y(e,t,s,n){let r;return n?(Object(i.a)(0!=(s&l.b.SlideOnRemove),757),r=e.getContainingSegment(t,n),r=e.getSlideToSegment(r)):(Object(i.a)(0==(s&l.b.SlideOnRemove),758),r=e.getContainingSegment(t)),S(e,r,s,n)}function C(e,t,s,i,n,r){let o=l.b.RangeBegin,c=l.b.RangeEnd;n===f.Transient?(o=l.b.Transient,c=l.b.Transient):(n===f.Nest&&(o=l.b.NestBegin,c=l.b.NestEnd),r?(o|=l.b.SlideOnRemove,c|=l.b.SlideOnRemove):(o|=l.b.StayOnRemove,c|=l.b.StayOnRemove));const u=y(i,t,o,r),h=y(i,s,c,r);u.pairedRef=h,h.pairedRef=u;const d={[a.k]:[e]};u.addProperties(d),h.addProperties(d);return new v(u,h,n,d)}class O{constructor(e,t,s,i){this.client=e,this.label=t,this.helpers=s,this.onPositionChange=i,this.intervalTree=new h.b,this.intervalIdMap=new Map,this.endIntervalTree=new h.e(s.compareEnds)}addConflictResolver(e){this.conflictResolver=e,this.endConflictResolver=(t,s)=>{const i=e(t,s);return{data:i,key:i}}}map(e){this.intervalTree.map(e)}createLegacyId(e,t){return`${O.legacyIdPrefix}${e}-${t}`}ensureSerializedId(e){var t;let s=null===(t=e.properties)||void 0===t?void 0:t.intervalId;if(void 0===s){s=this.createLegacyId(e.start,e.end);const t={intervalId:s};e.properties=Object(c.a)(e.properties,t)}return Object.defineProperty(e.properties,"intervalId",{configurable:!1,enumerable:!0,writable:!1}),s}mapUntil(e){this.intervalTree.mapUntil(e)}gatherIterationResults(e,t,s,i){if(!this.intervalTree.intervals.isEmpty())if(void 0===s&&void 0===i)t?this.intervalTree.map(t=>{e.push(t)}):this.intervalTree.mapBackward(t=>{e.push(t)});else{const n=this.helpers.create("transient",s,i,this.client,f.Transient);if(void 0===s)t?this.intervalTree.map(t=>{0===n.compareEnd(t)&&e.push(t)}):this.intervalTree.mapBackward(t=>{0===n.compareEnd(t)&&e.push(t)});else{const s=void 0===i?e=>n.compareStart(e.key):e=>n.compare(e.key),r=e=>e<=0,a=e=>e>=0,o=t=>{e.push(t.key)};t?this.intervalTree.intervals.walkExactMatchesForward(s,o,r,a):this.intervalTree.intervals.walkExactMatchesBackward(s,o,r,a)}}}findOverlappingIntervals(e,t){if(t<e||this.intervalTree.intervals.isEmpty())return[];const s=this.helpers.create("transient",e,t,this.client,f.Transient);return this.intervalTree.match(s).map(e=>e.key)}previousInterval(e){const t=this.helpers.create("transient",e,e,this.client,f.Transient),s=this.endIntervalTree.floor(t);if(s)return s.data}nextInterval(e){const t=this.helpers.create("transient",e,e,this.client,f.Transient),s=this.endIntervalTree.ceil(t);if(s)return s.data}removeInterval(e,t){const s=this.helpers.create("transient",e,t,this.client,f.Transient);return this.intervalTree.remove(s),this.endIntervalTree.remove(s),s}removeIntervalFromindex(e){this.intervalTree.removeExisting(e),this.endIntervalTree.remove(e);const t=e.getIntervalId();Object(i.a)(void 0!==t,785),this.intervalIdMap.delete(t)}removeExistingInterval(e){this.removeIntervalFromindex(e),this.removeIntervalListeners(e)}createInterval(e,t,s,i){return this.helpers.create(this.label,e,t,this.client,s,i)}addInterval(e,t,s,i,n){const r=this.createInterval(e,t,s,n);return r&&(r.properties||(r.properties=Object(c.d)()),i&&r.addProperties(i),void 0===r.properties.intervalId&&(r.properties.intervalId=Object(g.a)()),this.add(r)),r}addIntervalToindex(e){const t=e.getIntervalId();Object(i.a)(void 0!==t,704),Object.defineProperty(e.properties,"intervalId",{configurable:!1,enumerable:!0,writable:!1}),this.intervalTree.put(e,this.conflictResolver),this.endIntervalTree.put(e,e,this.endConflictResolver),this.intervalIdMap.set(t,e)}add(e){this.addIntervalToindex(e),this.addIntervalListeners(e)}getIntervalById(e){return this.intervalIdMap.get(e)}changeInterval(e,t,s,i){const n=e.modify(this.label,t,s,i);return n&&(this.removeExistingInterval(e),this.add(n)),n}serialize(){const e=this.client,t=this.intervalTree.intervals.keys();return{label:this.label,intervals:t.map(t=>function(e){const{start:t,end:s,sequenceNumber:i,intervalType:n,properties:r}=e;return[t,s,i,n,Object.assign(Object.assign({},r),{[a.k]:void 0})]}(t.serialize(e))),version:2}}addIntervalListeners(e){e instanceof v&&e.addPositionChangeListeners(()=>this.removeIntervalFromindex(e),()=>{var t;this.addIntervalToindex(e),null===(t=this.onPositionChange)||void 0===t||t.call(this,e)})}removeIntervalListeners(e){e instanceof v&&e.removePositionChangeListeners()}}O.legacyIdPrefix="legacy";const w=(e,t)=>e.end.compare(t.end);class T{get name(){return T.Name}get factory(){return T._factory}get ops(){return T._ops}}T.Name="sharedStringIntervalCollection",T._factory=new class{load(e,t=[]){return new R({compareEnds:w,create:C},!0,e,t)}store(e){return e.serializeInternal()}},T._ops=M();const k=(e,t)=>e.end-t.end;function N(e,t,s,i){const n={};return e&&e.length>0&&(n[a.k]=[e]),new b(t,s,n)}class j{get name(){return j.Name}get factory(){return j._factory}get ops(){return j._ops}}function M(){const e=(e,t,s)=>{const{localSeq:i}=s,n=e.rebaseLocalInterval(t.opName,t.value,i);return{rebasedOp:Object.assign(Object.assign({},t),{value:n}),rebasedLocalOpMetadata:s}};return new Map([["add",{process:(e,t,s,i)=>{e.ackAdd(t,s,i)},rebase:e}],["delete",{process:(e,t,s,i)=>{e.ackDelete(t,s,i)},rebase:(e,t,s)=>({rebasedOp:t,rebasedLocalOpMetadata:s})}],["change",{process:(e,t,s,i)=>{e.ackChange(t,s,i)},rebase:e}]])}j.Name="sharedIntervalCollection",j._factory=new class{load(e,t=[]){const s=new R({compareEnds:k,create:N},!1,e,t);return s.attachGraph(void 0,""),s}store(e){return e.serializeInternal()}},j._ops=M();class q{constructor(e,t=!0,s,i){this.results=[],this.index=0,e.gatherIterationResults(this.results,t,s,i)}next(){let e,t=!0;return this.index<this.results.length&&(e=this.results[this.index++],t=!1),{value:e,done:t}}}class R extends n.a{constructor(e,t,s,i){super(),this.helpers=e,this.requiresClient=t,this.emitter=s,this.pendingChangesStart=new Map,this.pendingChangesEnd=new Map,Array.isArray(i)?this.savedSerializedIntervals=i:this.savedSerializedIntervals=i.intervals.map(e=>{return t=e,s=i.label,{start:t[0],end:t[1],sequenceNumber:t[2],intervalType:t[3],properties:Object.assign(Object.assign({},t[4]),{[a.k]:s})};var t,s})}get attached(){return!!this.localCollection}attachGraph(e,t){if(this.attached)throw new m.a("Only supports one Sequence attach");if(void 0===e&&this.requiresClient)throw new m.a("Client required for this collection");if(this.client=e,this.localCollection=new O(e,t,this.helpers,e=>this.emit("changeInterval",e,!0,void 0)),this.savedSerializedIntervals)for(const s of this.savedSerializedIntervals)this.localCollection.ensureSerializedId(s),this.localCollection.addInterval(s.start,s.end,s.intervalType,s.properties);this.savedSerializedIntervals=void 0}getNextLocalSeq(){return++this.client.getCollabWindow().localSeq}getIntervalById(e){if(!this.attached)throw new m.a("attach must be called before accessing intervals");return this.localCollection.getIntervalById(e)}add(e,t,s,i){var n,r;if(!this.attached)throw new m.a("attach must be called prior to adding intervals");if(s&f.Transient)throw new m.a("Can not add transient intervals");const a=this.localCollection.addInterval(e,t,s,i);if(a){const i={end:t,intervalType:s,properties:a.properties,sequenceNumber:null!==(r=null===(n=this.client)||void 0===n?void 0:n.getCurrentSeq())&&void 0!==r?r:0,start:e};this.emitter.emit("add",void 0,i,{localSeq:this.getNextLocalSeq()})}return this.emit("addInterval",a,!0,void 0),a}deleteExistingInterval(e,t,s){this.localCollection.removeExistingInterval(e),e&&(t?this.emitter.emit("delete",void 0,e.serialize(this.client),{localSeq:this.getNextLocalSeq()}):this.onDeserialize&&this.onDeserialize(e)),this.emit("deleteInterval",e,t,s)}removeIntervalById(e){const t=this.localCollection.getIntervalById(e);return t&&this.deleteExistingInterval(t,!0,void 0),t}changeProperties(e,t){if(!this.attached)throw new m.a("Attach must be called before accessing intervals");if("string"!=typeof e)throw new m.a("Change API requires an ID that is a string");if(!t)throw new m.a("changeProperties should be called with a property set");const s=this.getIntervalById(e);if(s){const e=s.addProperties(t,!0,d.d),i=s.serialize(this.client);i.start=void 0,i.end=void 0,i.properties=t,i.properties.intervalId=s.getIntervalId(),this.emitter.emit("change",void 0,i,{localSeq:this.getNextLocalSeq()}),this.emit("propertyChanged",s,e)}this.emit("changeInterval",s,!0,void 0)}change(e,t,s){if(!this.attached)throw new m.a("Attach must be called before accessing intervals");if("string"!=typeof e)throw new m.a("Change API requires an ID that is a string");const i=this.getIntervalById(e);if(i){const n=this.localCollection.changeInterval(i,t,s),r=i.serialize(this.client);return r.start=t,r.end=s,r.properties={intervalId:i.getIntervalId()},this.emitter.emit("change",void 0,r,{localSeq:this.getNextLocalSeq()}),this.addPendingChange(e,r),this.emit("changeInterval",n,!0,void 0),n}}addPendingChange(e,t){void 0!==t.start&&this.addPendingChangeHelper(e,this.pendingChangesStart,t),void 0!==t.end&&this.addPendingChangeHelper(e,this.pendingChangesEnd,t)}addPendingChangeHelper(e,t,s){let i=t.get(e);i||(i=[],t.set(e,i)),i.push(s)}removePendingChange(e){var t;const s=null===(t=e.properties)||void 0===t?void 0:t.intervalId;void 0!==e.start&&this.removePendingChangeHelper(s,this.pendingChangesStart,e),void 0!==e.end&&this.removePendingChangeHelper(s,this.pendingChangesEnd,e)}removePendingChangeHelper(e,t,s){const i=t.get(e);if(i){const n=i.shift();if(0===i.length&&t.delete(e),(null==n?void 0:n.start)!==s.start||(null==n?void 0:n.end)!==s.end)throw new m.a("Mismatch in pending changes")}}hasPendingChangeStart(e){const t=this.pendingChangesStart.get(e);return t&&0!==t.length}hasPendingChangeEnd(e){const t=this.pendingChangesEnd.get(e);return t&&0!==t.length}changeInterval(e,t,s){return this.ackChange(e,t,s)}ackChange(e,t,s){var i,n,r,a;if(!this.attached)throw new m.a("Attach must be called before accessing intervals");let o;if(t){this.removePendingChange(e);const t=null===(i=e.properties)||void 0===i?void 0:i.intervalId;o=this.getIntervalById(t),o&&(null===(n=o.propertyManager)||void 0===n||n.ackPendingProperties({type:l.a.ANNOTATE,props:null!==(r=e.properties)&&void 0!==r?r:{}}),this.ackInterval(o,s))}else{const t=e.properties,i="intervalId",n=t[i],r=p(t,["symbol"==typeof i?i:i+""]);if(o=this.getIntervalById(n),o){let t,i;this.hasPendingChangeStart(n)||(t=e.start),this.hasPendingChangeEnd(n)||(i=e.end),void 0===t&&void 0===i||(o=null!==(a=this.localCollection.changeInterval(o,t,i,s))&&void 0!==a?a:o);const c=o.addProperties(r,!0,s.sequenceNumber);this.onDeserialize&&this.onDeserialize(o),this.emit("propertyChanged",o,c)}}o&&this.emit("changeInterval",o,t,s)}addConflictResolver(e){if(!this.attached)throw new m.a("attachSequence must be called");this.localCollection.addConflictResolver(e)}attachDeserializer(e){e&&(this.onDeserialize=e,this.localCollection.map(t=>{e(t)}))}rebaseLocalInterval(e,t,s){var i,n;if(!this.attached)throw new m.a("attachSequence must be called");const{start:r,end:a,intervalType:o,properties:c,sequenceNumber:l}=t,u=void 0===r?void 0:this.client.rebasePosition(r,l,s),h=void 0===a?void 0:this.client.rebasePosition(a,l,s),d=null==c?void 0:c.intervalId,g={start:u,end:h,intervalType:o,sequenceNumber:null!==(n=null===(i=this.client)||void 0===i?void 0:i.getCurrentSeq())&&void 0!==n?n:0,properties:c};return"change"===e&&(this.hasPendingChangeStart(d)||this.hasPendingChangeEnd(d))&&(this.removePendingChange(t),this.addPendingChange(d,g)),g}getSlideToSegment(e){const t={segment:e.segment,offset:e.offset},s=this.client.getSlideToSegment(t);return t.segment===s.segment&&t.offset===s.offset?void 0:s}setSlideOnRemove(e){let t=e.refType;t&=~l.b.StayOnRemove,t|=l.b.SlideOnRemove,e.refType=t}ackInterval(e,t){if(!(e instanceof v))return;if(!Object(a.j)(e.start,l.b.StayOnRemove)&&!Object(a.j)(e.end,l.b.StayOnRemove))return;const s=this.getSlideToSegment(e.start),i=this.getSlideToSegment(e.end),n=e.properties.intervalId,r=this.hasPendingChangeStart(n),o=this.hasPendingChangeEnd(n);r||this.setSlideOnRemove(e.start),o||this.setSlideOnRemove(e.end);const c=void 0!==s&&!r,u=void 0!==i&&!o;if(c||u){if(this.localCollection.removeExistingInterval(e),c){const i=e.start.properties;this.client.removeLocalReferencePosition(e.start),e.start=S(this.client,s,e.start.refType,t),i&&e.start.addProperties(i)}if(u){const s=e.end.properties;this.client.removeLocalReferencePosition(e.end),e.end=S(this.client,i,e.end.refType,t),s&&e.end.addProperties(s)}this.localCollection.add(e)}}addInternal(e,t,s){return this.ackAdd(e,t,s)}ackAdd(e,t,s){var i;if(t){const t=null===(i=e.properties)||void 0===i?void 0:i.intervalId,n=this.getIntervalById(t);return void(n&&this.ackInterval(n,s))}if(!this.attached)throw new m.a("attachSequence must be called");this.localCollection.ensureSerializedId(e);const n=this.localCollection.addInterval(e.start,e.end,e.intervalType,e.properties,s);return n&&this.onDeserialize&&this.onDeserialize(n),this.emit("addInterval",n,t,s),n}deleteInterval(e,t,s){return this.ackDelete(e,t,s)}ackDelete(e,t,s){if(t)return;if(!this.attached)throw new m.a("attach must be called prior to deleting intervals");const i=this.localCollection.ensureSerializedId(e),n=this.localCollection.getIntervalById(i);n&&this.deleteExistingInterval(n,t,s)}serializeInternal(){if(!this.attached)throw new m.a("attachSequence must be called");return this.localCollection.serialize()}[Symbol.iterator](){return new q(this)}CreateForwardIteratorWithStartPosition(e){return new q(this,!0,e)}CreateBackwardIteratorWithStartPosition(e){return new q(this,!1,e)}CreateForwardIteratorWithEndPosition(e){return new q(this,!0,void 0,e)}CreateBackwardIteratorWithEndPosition(e){return new q(this,!1,void 0,e)}gatherIterationResults(e,t,s,i){this.attached&&this.localCollection.gatherIterationResults(e,t,s,i)}findOverlappingIntervals(e,t){if(!this.attached)throw new m.a("attachSequence must be called");return this.localCollection.findOverlappingIntervals(e,t)}map(e){if(!this.attached)throw new m.a("attachSequence must be called");this.localCollection.map(e)}previousInterval(e){if(!this.attached)throw new m.a("attachSequence must be called");return this.localCollection.previousInterval(e)}nextInterval(e){if(!this.attached)throw new m.a("attachSequence must be called");return this.localCollection.nextInterval(e)}}},18061:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));var i=s(17940);class n{constructor(e,t){this.storage=e,this.path=t,Object(i.a)(!t.endsWith("/"),412)}async readBlob(e){return this.storage.readBlob(`${this.path}/${e}`)}async contains(e){return this.storage.contains(`${this.path}/${e}`)}async list(e){return this.storage.list(`${this.path}/${e}`)}}},18062:function(e,t,s){"use strict";s.d(t,"c",(function(){return u})),s.d(t,"b",(function(){return h})),s.d(t,"a",(function(){return d}));var i=s(18052),n=s(18036),r=s(18064),a=s(18065),o=s(18034),c=s(18035),l=s(18063);class u{static segmentFromSpec(e){const t=i.b.fromJSONObject(e);if(t)return t;const s=n.b.fromJSONObject(e);return s||void 0}get type(){return u.Type}get attributes(){return u.Attributes}async load(e,t,s,i){const n=new l.a(e,t,i);return await n.load(s),n}create(e,t){const s=new l.a(e,t,this.attributes);return s.initializeLocal(),s}}u.Type="https://graph.microsoft.com/types/mergeTree",u.Attributes={type:u.Type,snapshotFormatVersion:"0.1",packageVersion:r.a};class h{static segmentFromSpec(e){const t=e;if(t.items){const e=new c.b(t.items);return t.props&&e.addProperties(t.props),e}}get type(){return h.Type}get attributes(){return h.Attributes}async load(e,t,s,i){const n=new o.a(e,t,i);return await n.load(s),n}create(e,t){const s=new o.a(e,t,this.attributes);return s.initializeLocal(),s}}h.Type="https://graph.microsoft.com/types/mergeTree/object-sequence",h.Attributes={type:h.Type,snapshotFormatVersion:"0.1",packageVersion:r.a};class d{static segmentFromSpec(e){const t=e;if(t.items){const e=new c.b(t.items);return t.props&&e.addProperties(t.props),e}}get type(){return d.Type}get attributes(){return d.Attributes}async load(e,t,s,i){const n=new a.a(e,t,i);return await n.load(s),n}create(e,t){const s=new a.a(e,t,this.attributes);return s.initializeLocal(),s}}d.Type="https://graph.microsoft.com/types/mergeTree/number-sequence",d.Attributes={type:d.Type,snapshotFormatVersion:"0.1",packageVersion:r.a}},18063:function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var i=s(18036),n=s(18052),r=s(18049),a=s(18062);class o extends r.a{constructor(e,t,s){super(e,t,s,a.c.segmentFromSpec),this.id=t,this.mergeTreeTextHelper=this.client.createTextHelper()}static create(e,t){return e.createChannel(t,a.c.Type)}static getFactory(){return new a.c}get ISharedString(){return this}insertMarkerRelative(e,t,s){const n=new i.b(t);s&&n.addProperties(s);const r=this.posFromRelativePos(e),a=this.client.insertSegmentLocal(r,n);a&&this.submitSequenceMessage(a)}insertMarker(e,t,s){const n=new i.b(t);s&&n.addProperties(s);const r=this.client.insertSegmentLocal(e,n);return r&&this.submitSequenceMessage(r),r}insertTextRelative(e,t,s){const i=new n.b(t);s&&i.addProperties(s);const r=this.posFromRelativePos(e),a=this.client.insertSegmentLocal(r,i);a&&this.submitSequenceMessage(a)}insertText(e,t,s){const i=new n.b(t);s&&i.addProperties(s);const r=this.client.insertSegmentLocal(e,i);r&&this.submitSequenceMessage(r)}replaceText(e,t,s,i){this.replaceRange(e,t,n.b.make(s,i))}removeText(e,t){return this.removeRange(e,t)}annotateMarkerNotifyConsensus(e,t,s){const i=this.client.annotateMarkerNotifyConsensus(e,t,s);i&&this.submitSequenceMessage(i)}annotateMarker(e,t,s){const i=this.client.annotateMarker(e,t,s);i&&this.submitSequenceMessage(i)}findTile(e,t,s=!0){return this.client.findTile(e,t,s)}getTextAndMarkers(e){const t=this.client.getCollabWindow();return this.mergeTreeTextHelper.getTextAndMarkers(t.currentSeq,t.clientId,e)}getText(e,t){const s=this.client.getCollabWindow();return this.mergeTreeTextHelper.getText(s.currentSeq,s.clientId,"",e,t)}getTextWithPlaceholders(){const e=this.client.getCollabWindow();return this.mergeTreeTextHelper.getText(e.currentSeq,e.clientId," ")}getTextRangeWithPlaceholders(e,t){const s=this.client.getCollabWindow();return this.mergeTreeTextHelper.getText(s.currentSeq,s.clientId," ",e,t)}getTextRangeWithMarkers(e,t){const s=this.client.getCollabWindow();return this.mergeTreeTextHelper.getText(s.currentSeq,s.clientId,"*",e,t)}getMarkerFromId(e){return this.client.getMarkerFromId(e)}}},18064:function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));const i="1.3.1"},18065:function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var i=s(18062),n=s(18035);class r extends n.a{constructor(e,t,s){super(e,t,s,i.a.segmentFromSpec),this.id=t}static create(e,t){return e.createChannel(t,i.a.Type)}static getFactory(){return new i.a}getRange(e,t){return this.getItems(e,t)}}},18066:function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var i=s(17970),n=s(17982),r=s(17937),a=s(18033),o=s(18067);class c extends r.a{constructor(e,t,s){super(e,t,s,"fluid_counter_"),this._value=0}static create(e,t){return e.createChannel(t,o.a.Type)}static getFactory(){return new o.a}get value(){return this._value}increment(e){if(e%1!=0)throw new Error("Must increment by a whole number");const t={type:"increment",incrementAmount:e};this.incrementCore(e),this.submitLocalMessage(t)}incrementCore(e){this._value+=e,this.emit("incremented",e,this._value)}summarizeCore(e){const t={value:this.value};return Object(a.a)("header",JSON.stringify(t))}async loadCore(e){const t=await Object(n.a)(e,"header");this._value=t.value}onDisconnect(){}processCore(e,t,s){if(e.type===i.a.Operation&&!t){const t=e.contents;switch(t.type){case"increment":this.incrementCore(t.incrementAmount);break;default:throw new Error("Unknown operation")}}}applyStashedOp(){throw new Error("not implemented")}}},18067:function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var i=s(18066),n=s(18068);class r{get type(){return r.Type}get attributes(){return r.Attributes}async load(e,t,s,n){const r=new i.a(t,e,n);return await r.load(s),r}create(e,t){const s=new i.a(t,e,this.attributes);return s.initializeLocal(),s}}r.Type="https://graph.microsoft.com/types/counter",r.Attributes={type:r.Type,snapshotFormatVersion:"0.1",packageVersion:n.a}},18068:function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));const i="1.3.1"},18069:function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var i=s(17940),n=s(17970),r=s(17982),a=s(17937),o=s(18033),c=s(18070);class l extends a.a{constructor(e,t,s){super(e,t,s,"fluid_cell_"),this.messageId=-1,this.messageIdObserved=-1}static create(e,t){return e.createChannel(t,c.a.Type)}static getFactory(){return new c.a}get(){return this.data}set(e){const t={value:this.serializer.encode(e,this.handle)};if(this.setCore(e),!this.isAttached())return;const s={type:"setCell",value:t};this.submitLocalMessage(s,++this.messageId)}delete(){if(this.deleteCore(),!this.isAttached())return;this.submitLocalMessage({type:"deleteCell"},++this.messageId)}empty(){return void 0===this.data}summarizeCore(e){const t={value:this.data};return Object(o.a)("header",e.stringify(t,this.handle))}async loadCore(e){const t=await Object(r.a)(e,"header");this.data=this.decode(t)}initializeLocalCore(){this.data=void 0}onDisconnect(){}applyInnerOp(e){switch(e.type){case"setCell":this.setCore(this.decode(e.value));break;case"deleteCell":this.deleteCore();break;default:throw new Error("Unknown operation")}}processCore(e,t,s){if(this.messageId===this.messageIdObserved){if(e.type===n.a.Operation&&!t){const t=e.contents;this.applyInnerOp(t)}}else if(t){const e=s;Object(i.a)(void 0!==e&&e<=this.messageId,12),this.messageIdObserved=s}}setCore(e){this.data=e,this.emit("valueChanged",e)}deleteCore(){this.data=void 0,this.emit("delete")}decode(e){const t=e.value;return this.serializer.decode(t)}applyStashedOp(e){const t=e;return this.applyInnerOp(t),++this.messageId,this.messageId}}},18070:function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var i=s(18069),n=s(18071);class r{get type(){return r.Type}get attributes(){return r.Attributes}async load(e,t,s,n){const r=new i.a(t,e,n);return await r.load(s),r}create(e,t){const s=new i.a(t,e,this.attributes);return s.initializeLocal(),s}}r.Type="https://graph.microsoft.com/types/cell",r.Attributes={type:r.Type,snapshotFormatVersion:"0.1",packageVersion:n.a}},18071:function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));const i="1.3.1"},18072:function(e,t,s){"use strict";var i;s.d(t,"a",(function(){return i})),function(e){e[e.Disconnected=0]="Disconnected",e[e.EstablishingConnection=3]="EstablishingConnection",e[e.Connecting=1]="Connecting",e[e.CatchingUp=1]="CatchingUp",e[e.Connected=2]="Connected"}(i||(i={}))}}]);
//# sourceMappingURL=https://sourcemaps.powerapps.com/srcmaps/static/js/module/106.f485a0cd.chunk.js.map